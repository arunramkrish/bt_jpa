<!DOCTYPE html>
<!-- saved from url=(0060)https://en.wikibooks.org/wiki/Java_Persistence/Print_version -->
<html lang="en" dir="ltr" class="client-js ve-not-available"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<title>Java Persistence/Print version - Wikibooks, open books for an open world</title>
<meta name="generator" content="MediaWiki 1.26wmf13">
<link rel="alternate" type="application/x-wiki" title="Edit" href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&action=edit">
<link rel="edit" title="Edit" href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&action=edit">
<link rel="shortcut icon" href="https://en.wikibooks.org/static/favicon/wikibooks.ico">
<link rel="search" type="application/opensearchdescription+xml" href="https://en.wikibooks.org/w/opensearch_desc.php" title="Wikibooks (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://en.wikibooks.org/w/api.php?action=rsd">
<link rel="alternate" hreflang="x-default" href="./JPA_Wikibooks_files/JPA_Wikibooks.html">
<link rel="copyright" href="https://creativecommons.org/licenses/by-sa/3.0/">
<link rel="alternate" type="application/atom+xml" title="Wikibooks Atom feed" href="https://en.wikibooks.org/w/index.php?title=Special:RecentChanges&feed=atom">
<link rel="canonical" href="./JPA_Wikibooks_files/JPA_Wikibooks.html">
<link rel="stylesheet" href="https://en.wikibooks.org/w/load.php?debug=false&lang=en&modules=ext.flaggedRevs.basic%7Cext.pygments%2Cwikihiero%7Cext.uls.nojs%7Cext.visualEditor.viewPageTarget.noscript%7Cmediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.sectionAnchor%7Cmediawiki.skinning.interface%7Cmediawiki.ui.button%7Cskins.vector.styles%7Cwikibase.client.init&only=styles&skin=vector&*">
<style>
@-webkit-keyframes centralAuthPPersonalAnimation{0%{opacity:0;-webkit-transform:translateY(-20px)}100%{opacity:1;-webkit-transform:translateY(0)}}@-moz-keyframes centralAuthPPersonalAnimation{0%{opacity:0;-moz-transform:translateY(-20px)}100%{opacity:1;-moz-transform:translateY(0)}}@-o-keyframes centralAuthPPersonalAnimation{0%{opacity:0;-o-transform:translateY(-20px)}100%{opacity:1;-o-transform:translateY(0)}}@keyframes centralAuthPPersonalAnimation{0%{opacity:0;transform:translateY(-20px)}100%{opacity:1;transform:translateY(0)}}.centralAuthPPersonalAnimation{-webkit-animation-duration:1s;-moz-animation-duration:1s;-o-animation-duration:1s;animation-duration:1s;-webkit-animation-fill-mode:both;-moz-animation-fill-mode:both;-o-animation-fill-mode:both;animation-fill-mode:both;-webkit-animation-name:centralAuthPPersonalAnimation;-moz-animation-name:centralAuthPPersonalAnimation;-o-animation-name:centralAuthPPersonalAnimation;animation-name:centralAuthPPersonalAnimation}
/* cache key: global:resourceloader:filter:minify-css:7:0dcacc990dd02e7db9669ab3090b80f1 */
.ve-activated #toc,.ve-activated #siteNotice,.ve-activated .mw-indicators, .ve-active #bodyContent > :not(#siteSub):not(#contentSub):not(.ve-ui-mwTocWidget),.ve-activated #t-print,.ve-activated #t-permalink,.ve-activated #p-coll-print_export,.ve-activated #t-cite,.ve-activating .ve-ui-surface,.ve-deactivating .ve-ui-surface{display:none}.ve-activated #bodyContent,.ve-activated #firstHeading,.ve-activated #siteSub,.ve-activated #contentSub{opacity:0.6;pointer-events:none}.ve-activated #firstHeading{cursor:default} .ve-activated #content{position:relative}.ve-init-mw-viewPageTarget-loading-overlay{position:absolute;left:0;right:0;z-index:1;margin-top:-0.5em}.ve-init-mw-viewPageTarget-progress{border:1px solid #347bff;background:#fff;height:0.75em;border-radius:2px;overflow:hidden;margin:0 25%}.ve-init-mw-viewPageTarget-progress-bar{width:0;height:0.75em;background:#347bff} .mw-editsection{white-space:nowrap; unicode-bidi:-moz-isolate;unicode-bidi:-webkit-isolate;unicode-bidi:isolate}.mw-editsection-divider{color:#555}.ve-tabmessage-appendix{font-size:0.7em;vertical-align:top;line-height:1.43em;padding-left:0.5em; background-image:none !important;display:inline !important}
/* cache key: global:resourceloader:filter:minify-css:7:98428ddb6d82ef9bb6dcf1d1c4437f25 */
.uls-menu a{cursor:pointer}.uls-menu.callout .caret-before{border-top:20px solid transparent;border-right:20px solid #C9C9C9;border-bottom:20px solid transparent;display:inline-block;left:-21px;top:30px;position:absolute}.uls-menu.callout .caret-after{border-top:20px solid transparent;border-right:20px solid #FCFCFC;border-bottom:20px solid transparent;display:inline-block;left:-20px;top:30px;position:absolute}.uls-ui-languages button{width:23%;text-overflow:ellipsis;margin-right:4%}button.uls-more-languages{width:auto}.settings-title{font-size:11pt}.settings-text{color:#555555;font-size:9pt}div.display-settings-block:hover .settings-text{color:#252525}
/* cache key: global:resourceloader:filter:minify-css:7:22d1681fa868b4ff4fbcb1ec1e58a9ea */
.tipsy{padding:5px;position:absolute;z-index:100000;cursor:default}.tipsy-inner{padding:5px 8px 4px 8px; background-color:#ffffff;border:solid 1px #a7d7f9;color:black;max-width:15em;border-radius:4px; }.tipsy-arrow{position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALAgMAAADUwp+1AAAACVBMVEX5+fmn1/n///9s6BFKAAAAAXRSTlMAQObYZgAAACpJREFUCB1jZBD4wMiQMoeRcUU4I9uSaYxSE54xZjn8AtMgPkgcJA9UBwAeDw1Qrb3pVAAAAABJRU5ErkJggg==) no-repeat top left;background:url(//en.wikibooks.org/static/1.26wmf13/resources/src/jquery.tipsy/images/tipsy.png?2015-07-07T18:33:20Z) no-repeat top left!ie;width:11px;height:6px} .tipsy-n .tipsy-arrow{top:0px;left:50%;margin-left:-5px} .tipsy-nw .tipsy-arrow{top:1px;left:10px} .tipsy-ne .tipsy-arrow{top:1px;right:10px} .tipsy-s .tipsy-arrow{bottom:0px;left:50%;margin-left:-5px;background-position:bottom left} .tipsy-sw .tipsy-arrow{bottom:0px;left:10px;background-position:bottom left} .tipsy-se .tipsy-arrow{bottom:0px;right:10px;background-position:bottom left} .tipsy-e .tipsy-arrow{top:50%;margin-top:-5px;right:1px;width:5px;height:11px;background-position:top right} .tipsy-w .tipsy-arrow{top:50%;margin-top:-5px;left:0px;width:6px;height:11px} .tipsy{font-size:0.8em}
/* cache key: global:resourceloader:filter:minify-css:7:335111cfba7a35c1904f136c33882f78 */
@media print{#centralNotice{display:none}}
/* cache key: global:resourceloader:filter:minify-css:7:ddb0c98a055632ae8e349c9cf48ac703 */
.postedit-container{margin:0 auto;position:fixed;top:0;height:0;left:50%;z-index:1000;font-size:13px}.postedit-container:hover{cursor:pointer}.postedit{position:relative;top:0.6em;left:-50%;padding:.6em 3.6em .6em 1.1em;line-height:1.5625em;color:#626465;background-color:#f4f4f4;border:1px solid #dcd9d9;text-shadow:0 0.0625em 0 rgba(255,255,255,0.5);border-radius:5px;box-shadow:0 2px 5px 0 #ccc;-webkit-transition:all 0.25s ease-in-out;-moz-transition:all 0.25s ease-in-out;-ms-transition:all 0.25s ease-in-out;-o-transition:all 0.25s ease-in-out;transition:all 0.25s ease-in-out}.skin-monobook .postedit{top:6em !important}.postedit-faded{opacity:0}.postedit-icon{padding-left:41px;  line-height:25px;background-repeat:no-repeat;background-position:8px 50%}.postedit-icon-checkmark{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAABblBMVEUAAAD///////9PfTf///80aRdTgjn///9Feij///////////9Rfzf///////////9PfjZRgDh1o1xOfTb///////+bwYqLtnj///////9PfTa82K////9WhT6YxIL///9QgDdTgzr////////j7uDl7eLq8efi693k7OH///////9UhjuBr2rp9uRUhjr///9YljVKgir///9WiTlYjT3////9/v57vFlbkT5PjC9dlD/5/fhuq09stUTs9uhxuElctCpfnT1huDFloEZloUZmpENmvDZpvDxpvTxqvjxrvT5rvT9rwTxsqktswD5uwkBvuUdxw0NztFBztU9ztVBzwkp0tlJ1xkd2t1R3uVR4w1F4xk54x014yE15uVZ5v1R5xVB6v1R7yFJ8wVh9xVl9yFR9yVd9ylN+xVh+yFd/x1l/yFeAylmEx1+Ny2uY0Hqe04Wj1Ymv3Ze33qLD47TJ5L3O6cPU7Mrq9eb2+/Q4j37OAAAAQHRSTlMAAQIEBAUFBQwPFB4fJCUoKiosQEhJS01RUlZZXmdydXaChYuSlJSWmJmoq6uur8LExcvM19fg5ejt8fX2+Pr7SljgewAAAKpJREFUGBkFwQNCAwAAAMDLtl3LtrG4rWXbtvX77gAgZ6grFwC0bhwNVgKgdPZx8b0dgLi+s7Wn0VoAqpfOI9+BNADZI7fLrz2pSEwGHZuH+78lSK8ZLkLezF3ooyUG3VPXq2USei9WngeyoG195yBYWDF3E/2pAhl1e9Gr8bGT+bfOFCC2fnvh4X7rcqIAQNNu+HT6sxkAjceTL/2ZAIhv+PorBwBJxfkA//dFHSCBy/UTAAAAAElFTkSuQmCC);background-image:url(//en.wikibooks.org/static/1.26wmf13/resources/src/mediawiki.action/images/green-checkmark.png?2015-07-07T18:33:20Z)!ie;background-position:left}.postedit-close{position:absolute;padding:0 .8em;right:0;top:0;font-size:1.25em;font-weight:bold;line-height:2.3em;color:black;text-shadow:0 0.0625em 0 white;text-decoration:none;opacity:0.2;filter:alpha(opacity=20)}.postedit-close:hover{color:black;text-decoration:none;opacity:0.4;filter:alpha(opacity=40)}
/* cache key: global:resourceloader:filter:minify-css:7:833b2a7f8771adff865d40ce539feeb9 */
.mw-collapsible-toggle{float:right;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none}  .mw-content-ltr .mw-collapsible-toggle,.mw-content-rtl .mw-content-ltr .mw-collapsible-toggle{float:right} .mw-content-rtl .mw-collapsible-toggle,.mw-content-ltr .mw-content-rtl .mw-collapsible-toggle{float:left}.mw-customtoggle,.mw-collapsible-toggle{cursor:pointer} caption .mw-collapsible-toggle,.mw-content-ltr caption .mw-collapsible-toggle,.mw-content-rtl caption .mw-collapsible-toggle,.mw-content-rtl .mw-content-ltr caption .mw-collapsible-toggle,.mw-content-ltr .mw-content-rtl caption .mw-collapsible-toggle{float:none} li .mw-collapsible-toggle,.mw-content-ltr li .mw-collapsible-toggle,.mw-content-rtl li .mw-collapsible-toggle,.mw-content-rtl .mw-content-ltr li .mw-collapsible-toggle,.mw-content-ltr .mw-content-rtl li .mw-collapsible-toggle{float:none} .mw-collapsible-toggle-li{list-style:none}
/* cache key: global:resourceloader:filter:minify-css:7:e1ffd603cbaaa5f1a36e0d13fe843535 */
.suggestions{overflow:hidden;position:absolute;top:0;left:0;width:0;border:none;z-index:1099;padding:0;margin:-1px 0 0 0}.suggestions-special{position:relative;background-color:white;cursor:pointer;border:solid 1px #aaaaaa;padding:0;margin:0;margin-top:-2px;display:none;padding:0.25em 0.25em;line-height:1.25em}.suggestions-results{background-color:white;cursor:pointer;border:solid 1px #aaaaaa;padding:0;margin:0}.suggestions-result{color:black;margin:0;line-height:1.5em;padding:0.01em 0.25em;text-align:left; overflow:hidden;-o-text-overflow:ellipsis; text-overflow:ellipsis;white-space:nowrap}.suggestions-result-current{background-color:#4C59A6;color:white}.suggestions-special .special-label{color:gray;text-align:left}.suggestions-special .special-query{color:black;font-style:italic;text-align:left}.suggestions-special .special-hover{background-color:silver}.suggestions-result-current .special-label,.suggestions-result-current .special-query{color:white}.highlight{font-weight:bold}
/* cache key: global:resourceloader:filter:minify-css:7:f8d0c6895ce3ae14434c16b8fca59432 */
.mw-ui-icon{position:relative;min-height:1.5em;min-width:1.5em}.mw-ui-icon.mw-ui-icon-element{text-indent:-999px;overflow:hidden;width:3.5em;min-width:3.5em;max-width:3.5em}.mw-ui-icon.mw-ui-icon-element:before{left:0;right:0;position:absolute;margin:0 1em}.mw-ui-icon.mw-ui-icon-before:before,.mw-ui-icon.mw-ui-icon-element:before{background-position:50% 50%;float:left;display:block;background-repeat:no-repeat;background-size:100% auto;min-height:1.5em;content:''}.mw-ui-icon.mw-ui-icon-before:before{position:relative;width:1.5em;margin-right:1em}
/* cache key: global:resourceloader:filter:minify-css:7:24d8bd1da9a9fde17cbfe215d057ec52 */
#p-lang .uls-settings-trigger{background:transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAgCAQAAACI54EcAAAAAnNCSVQICFXsRgQAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAZdEVYdFNvZnR3YXJlAHd3dy5pbmtzY2FwZS5vcmeb7jwaAAABWklEQVQoz42RwWrCQBBAc/PkyXiQfpEXobKzEsipCkKh5CBUhBBmaWrw6j/oIQr6VeaSXzDpZDbZ1CWVMhBm5zGT2X1O6fwdv1L0saTwLajmar0d4JHh6XuEofqooVpiQcU7ozbeGWJklXVEGrrcWWKOCUXOeYEuQeXhQaNdv/rPrl/jFH3HjEnM1klTa2FsYNzCBV45zfa9Cu17mPH5gm903A7rhW60d0Rf7opf9D03nVf50jCwyjxHrZvnCzCkR0sZndFVK/y0Hl7NGC46rTxV9hRKH0oope0T5nL9OhDHCsJpOhKhaHyKJRRUvDMyIbRPiB7LdWifnsudJeSQUOScF17lU3pw0GjCPid9jWUqfceMMT6pu6610PiE2ECxgCun2Zh9jnuQ8fkiK58wrBe60d4RfXWf9ik2XVeR2icEFuA5svEJgQinI5kyOnuuWAnbJ8z42f7r8wfhovZYX3llNQAAAABJRU5ErkJggg==) no-repeat right top;background:transparent url(//en.wikibooks.org/static/1.26wmf13/extensions/UniversalLanguageSelector/resources/css/../images/cog-sprite.png?2015-07-07T18:38:20Z) no-repeat right top!ie;background-image:-webkit-linear-gradient(transparent,transparent),url(data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20width%3D%2214%22%20height%3D%2232%22%3E%3Cdefs%3E%3Cpath%20d%3D%22M14%209.3V6.73l-1.575-.264c-.117-.44-.292-.848-.496-1.2l.93-1.285-1.81-1.84-1.31.908c-.38-.205-.79-.38-1.196-.497L8.284%201H5.716l-.263%201.578c-.437.117-.816.293-1.196.497L2.975%202.17%201.137%203.98l.934%201.287c-.2.38-.376.79-.493%201.228L0%206.73V9.3l1.575.264c.117.438.292.818.496%201.198l-.93%201.315L2.95%2013.89l1.312-.938c.38.205.787.38%201.224.497L5.746%2015h2.566l.263-1.578c.408-.117.817-.293%201.196-.497l1.315.935%201.81-1.812-.935-1.315c.203-.38.38-.76.495-1.2L14%209.303zm-7%201.404c-1.488%200-2.683-1.2-2.683-2.69S5.542%205.327%207%205.327c1.458%200%202.683%201.198%202.683%202.69%200%201.49-1.195%202.688-2.683%202.688z%22%20id%3D%22a%22%2F%3E%3C%2Fdefs%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20fill%3D%22%23808080%22%2F%3E%3Cuse%20transform%3D%22translate%280%2016%29%22%20xlink%3Ahref%3D%22%23a%22%20fill%3D%22%23555%22%2F%3E%3C%2Fsvg%3E%0A);background-image:-webkit-linear-gradient(transparent,transparent),url(//en.wikibooks.org/static/1.26wmf13/extensions/UniversalLanguageSelector/resources/css/../images/cog-sprite.svg?2015-07-07T18:38:20Z)!ie;background-image:linear-gradient(transparent,transparent),url(data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20width%3D%2214%22%20height%3D%2232%22%3E%3Cdefs%3E%3Cpath%20d%3D%22M14%209.3V6.73l-1.575-.264c-.117-.44-.292-.848-.496-1.2l.93-1.285-1.81-1.84-1.31.908c-.38-.205-.79-.38-1.196-.497L8.284%201H5.716l-.263%201.578c-.437.117-.816.293-1.196.497L2.975%202.17%201.137%203.98l.934%201.287c-.2.38-.376.79-.493%201.228L0%206.73V9.3l1.575.264c.117.438.292.818.496%201.198l-.93%201.315L2.95%2013.89l1.312-.938c.38.205.787.38%201.224.497L5.746%2015h2.566l.263-1.578c.408-.117.817-.293%201.196-.497l1.315.935%201.81-1.812-.935-1.315c.203-.38.38-.76.495-1.2L14%209.303zm-7%201.404c-1.488%200-2.683-1.2-2.683-2.69S5.542%205.327%207%205.327c1.458%200%202.683%201.198%202.683%202.69%200%201.49-1.195%202.688-2.683%202.688z%22%20id%3D%22a%22%2F%3E%3C%2Fdefs%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20fill%3D%22%23808080%22%2F%3E%3Cuse%20transform%3D%22translate%280%2016%29%22%20xlink%3Ahref%3D%22%23a%22%20fill%3D%22%23555%22%2F%3E%3C%2Fsvg%3E%0A);background-image:linear-gradient(transparent,transparent),url(//en.wikibooks.org/static/1.26wmf13/extensions/UniversalLanguageSelector/resources/css/../images/cog-sprite.svg?2015-07-07T18:38:20Z)!ie;height:16px;width:14px;float:right;cursor:pointer}.skin-vector #p-lang .uls-settings-trigger{ margin-top:3px}#p-lang .uls-settings-trigger:hover{background-position:right -16px}
/* cache key: global:resourceloader:filter:minify-css:7:43f162f37934097ef20be1921d617e6d */</style><style>
.suggestions a.mw-searchSuggest-link,.suggestions a.mw-searchSuggest-link:hover,.suggestions a.mw-searchSuggest-link:active,.suggestions a.mw-searchSuggest-link:focus{color:black;text-decoration:none}.suggestions-result-current a.mw-searchSuggest-link,.suggestions-result-current a.mw-searchSuggest-link:hover,.suggestions-result-current a.mw-searchSuggest-link:active,.suggestions-result-current a.mw-searchSuggest-link:focus{color:white}.suggestions a.mw-searchSuggest-link .special-query{ overflow:hidden;-o-text-overflow:ellipsis; text-overflow:ellipsis;white-space:nowrap}
/* cache key: global:resourceloader:filter:minify-css:7:ae3fa4570b5ac0c6cf7b3776c8ae4d6f */
.mw-mmv-overlay{position:fixed;top:0px;left:0px;right:0px;bottom:0px;z-index:1000;background-color:#000000}body.mw-mmv-lightbox-open{overflow-y:auto}body.mw-mmv-lightbox-open #mw-page-base,body.mw-mmv-lightbox-open #mw-head-base,body.mw-mmv-lightbox-open #mw-navigation,body.mw-mmv-lightbox-open #content,body.mw-mmv-lightbox-open #footer,body.mw-mmv-lightbox-open #globalWrapper // monobook{ display:none}body.mw-mmv-lightbox-open > *{ display:none}body.mw-mmv-lightbox-open > .mw-mmv-overlay,body.mw-mmv-lightbox-open > .mw-mmv-wrapper{display:block}.mw-mmv-filepage-buttons{margin-top:5px}.mw-mmv-filepage-buttons .mw-mmv-view-expanded,.mw-mmv-filepage-buttons .mw-mmv-view-config{display:block}.mw-mmv-filepage-buttons .mw-mmv-view-expanded.mw-ui-icon:before{background-image:url(data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%20standalone%3D%22no%22%3F%3E%0A%3C%21--%20Created%20with%20Inkscape%20%28http%3A%2F%2Fwww.inkscape.org%2F%29%20--%3E%0A%0A%3Csvg%0A%20%20%20xmlns%3Adc%3D%22http%3A%2F%2Fpurl.org%2Fdc%2Felements%2F1.1%2F%22%0A%20%20%20xmlns%3Acc%3D%22http%3A%2F%2Fcreativecommons.org%2Fns%23%22%0A%20%20%20xmlns%3Ardf%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2F02%2F22-rdf-syntax-ns%23%22%0A%20%20%20xmlns%3Asvg%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%0A%20%20%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%0A%20%20%20version%3D%221.1%22%0A%20%20%20width%3D%22100%25%22%0A%20%20%20height%3D%22100%25%22%0A%20%20%20viewBox%3D%220%200%201024%20768%22%0A%20%20%20id%3D%22Layer_1%22%0A%20%20%20xml%3Aspace%3D%22preserve%22%3E%3Cmetadata%0A%20%20%20%20%20id%3D%22metadata17%22%3E%3Crdf%3ARDF%3E%3Ccc%3AWork%0A%20%20%20%20%20%20%20%20%20rdf%3Aabout%3D%22%22%3E%3Cdc%3Aformat%3Eimage%2Fsvg%2Bxml%3C%2Fdc%3Aformat%3E%3Cdc%3Atype%0A%20%20%20%20%20%20%20%20%20%20%20rdf%3Aresource%3D%22http%3A%2F%2Fpurl.org%2Fdc%2Fdcmitype%2FStillImage%22%20%2F%3E%3Cdc%3Atitle%3E%3C%2Fdc%3Atitle%3E%3C%2Fcc%3AWork%3E%3C%2Frdf%3ARDF%3E%3C%2Fmetadata%3E%3Cdefs%0A%20%20%20%20%20id%3D%22defs15%22%20%2F%3E%3Cg%0A%20%20%20%20%20id%3D%22g3%22%3E%3Cpolygon%0A%20%20%20%20%20%20%20points%3D%22851.2%2C71.6%20690.7%2C232.1%20650.6%2C191.8%20641%2C356.6%20805.8%2C347.3%20765.5%2C306.9%20926%2C146.4%20984.5%2C204.9%20997.6%2C0%20792.7%2C13.1%20%22%0A%20%20%20%20%20%20%20id%3D%22polygon5%22%0A%20%20%20%20%20%20%20style%3D%22fill%3A%23777777%22%20%2F%3E%3Cpolygon%0A%20%20%20%20%20%20%20points%3D%22769.6%2C89.3%20611.9%2C89.3%20682.8%2C160.1%20690.7%2C167.6%20%22%0A%20%20%20%20%20%20%20id%3D%22polygon7%22%0A%20%20%20%20%20%20%20style%3D%22fill%3A%23777777%22%20%2F%3E%3Cpath%0A%20%20%20%20%20%20%20d%3D%22m%20643.6%2C402.2%20-51.2%2C3%203%2C-51.2%209.4%2C-164.4%205.8%2C-100.3%20H%2026.4%20V%20768%20H%20909.5%20V%20387%20l%20-100.9%2C5.8%20-165%2C9.4%20z%20M%20813.9%2C678%20H%20113.6%20l%20207.2%2C-270.2%2031.5%2C-12.9%20195.7%2C204.9%20105.9%2C-63.2%20159.8%2C140.8%200.2%2C0.6%200%2C0%20z%22%0A%20%20%20%20%20%20%20id%3D%22path9%22%0A%20%20%20%20%20%20%20style%3D%22fill%3A%23777777%22%20%2F%3E%3Cpolygon%0A%20%20%20%20%20%20%20points%3D%22909.5%2C386.1%20909.5%2C228%20830.4%2C306.9%20838.2%2C314.8%20%22%0A%20%20%20%20%20%20%20id%3D%22polygon11%22%0A%20%20%20%20%20%20%20style%3D%22fill%3A%23777777%22%20%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E);background-image:url(//en.wikibooks.org/static/1.26wmf13/extensions/MultimediaViewer/resources/mmv/img/expand.svg?2015-07-07T18:36:40Z)!ie}.mw-mmv-filepage-buttons .mw-mmv-view-config.mw-ui-icon:before{background-image:url(data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%20standalone%3D%22no%22%3F%3E%0A%3C%21--%20Created%20with%20Inkscape%20%28http%3A%2F%2Fwww.inkscape.org%2F%29%20--%3E%0A%0A%3Csvg%0A%20%20%20xmlns%3Adc%3D%22http%3A%2F%2Fpurl.org%2Fdc%2Felements%2F1.1%2F%22%0A%20%20%20xmlns%3Acc%3D%22http%3A%2F%2Fcreativecommons.org%2Fns%23%22%0A%20%20%20xmlns%3Ardf%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2F02%2F22-rdf-syntax-ns%23%22%0A%20%20%20xmlns%3Asvg%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%0A%20%20%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%0A%20%20%20version%3D%221.1%22%0A%20%20%20width%3D%22100%25%22%0A%20%20%20height%3D%22100%25%22%0A%20%20%20viewBox%3D%220%200%201024%20768%22%0A%20%20%20id%3D%22Layer_1%22%0A%20%20%20xml%3Aspace%3D%22preserve%22%3E%3Cmetadata%0A%20%20%20%20%20id%3D%22metadata9%22%3E%3Crdf%3ARDF%3E%3Ccc%3AWork%0A%20%20%20%20%20%20%20%20%20rdf%3Aabout%3D%22%22%3E%3Cdc%3Aformat%3Eimage%2Fsvg%2Bxml%3C%2Fdc%3Aformat%3E%3Cdc%3Atype%0A%20%20%20%20%20%20%20%20%20%20%20rdf%3Aresource%3D%22http%3A%2F%2Fpurl.org%2Fdc%2Fdcmitype%2FStillImage%22%20%2F%3E%3Cdc%3Atitle%3E%3C%2Fdc%3Atitle%3E%3C%2Fcc%3AWork%3E%3C%2Frdf%3ARDF%3E%3C%2Fmetadata%3E%3Cdefs%0A%20%20%20%20%20id%3D%22defs7%22%20%2F%3E%3Cpath%0A%20%20%20%20%20d%3D%22M%20897%2C454.6%20V%20313.4%20L%20810.4%2C299%20c%20-6.4%2C-23.3%20-16%2C-45.7%20-27.3%2C-65.8%20L%20833.6%2C161.8%20734.2%2C61.6%20662.8%2C112.1%20C%20641.9%2C100.9%20620.3%2C91.2%20597%2C84.8%20L%20582.6%2C-1%20H%20441.4%20L%20427%2C85.6%20c%20-23.3%2C6.4%20-45.7%2C16%20-65.8%2C27.3%20L%20289.8%2C62.4%20189.5%2C161.9%20240%2C233.3%20c%20-11.2%2C20.9%20-20.9%2C42.5%20-27.3%2C66.6%20L%20127%2C313.4%20v%20141.2%20l%2085.8%2C14.4%20c%206.4%2C23.3%2016%2C45.7%2027.3%2C66.6%20l%20-50.5%2C71.4%2099.5%2C99.5%2071.4%2C-50.5%20c%2020.9%2C11.2%2042.5%2C20.9%2066.6%2C27.3%20l%2014.4%2C85.8%20h%20141.2%20l%2014.4%2C-86.6%20c%2023.3%2C-6.4%2045.7%2C-16%2065.8%2C-27.3%20l%2071.4%2C50.5%2099.5%2C-99.5%20-50.5%2C-71.4%20c%2011.2%2C-20.9%2020.9%2C-42.5%2027.3%2C-66.6%20L%20897%2C454.6%20z%20m%20-385%2C77%20C%20430.2%2C531.6%20364.4%2C465%20364.4%2C384%20364.4%2C302.2%20431%2C236.4%20512%2C236.4%20c%2081%2C0%20147.6%2C65.8%20147.6%2C147.6%200%2C81.8%20-65.8%2C147.6%20-147.6%2C147.6%20z%22%0A%20%20%20%20%20id%3D%22path3%22%0A%20%20%20%20%20style%3D%22fill%3A%23777777%22%20%2F%3E%3C%2Fsvg%3E);background-image:url(//en.wikibooks.org/static/1.26wmf13/extensions/MultimediaViewer/resources/mmv/img/gear_gray.svg?2015-07-07T18:36:40Z)!ie;opacity:0.75}.mw-mmv-filepage-buttons .mw-mmv-view-config.mw-ui-icon:before:hover{opacity:1}
/* cache key: global:resourceloader:filter:minify-css:7:a916d9abe5674e3c73c905b935850da3 */</style><style>
.cite-accessibility-label{position:absolute !important; top:-99999px;clip:rect(1px 1px 1px 1px); clip:rect(1px,1px,1px,1px);padding:0 !important;border:0 !important;height:1px !important;width:1px !important;overflow:hidden}
/* cache key: global:resourceloader:filter:minify-css:7:6989008023386f50501783f5c5ff5345 */</style><meta name="ResourceLoaderDynamicStyles" content="">
<link rel="stylesheet" href="https://en.wikibooks.org/w/load.php?debug=false&lang=en&modules=site&only=styles&skin=vector&*">
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: global:resourceloader:filter:minify-css:7:de1ab5287c9076b96eedd3f97a84a7b6 */</style>
<script src="./JPA_Wikibooks_files/load.php"></script><style type="text/css"></style><script src="./JPA_Wikibooks_files/load(1).php"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Java_Persistence/Print_version","wgTitle":"Java Persistence/Print version","wgCurRevisionId":2503078,"wgRevisionId":2503078,"wgArticleId":203612,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Java Persistence","Java Persistence/What is Java persistence","Java Persistence/Persistence Products","Java Persistence/Mapping","Java Persistence/Runtime"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Java_Persistence/Print_version","wgRelevantArticleId":203612,"wgIsProbablyEditable":true,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgMediaViewerOnClick":true,"wgMediaViewerEnabledByDefault":true,"wgPoweredByHHVM":true,"wgWikiEditorEnabledModules":{"toolbar":true,"dialogs":true,"hidesig":true,"preview":false,"publish":false},"wgBetaFeaturesFeatures":[],"wgVisualEditor":{"pageLanguageCode":"en","pageLanguageDir":"ltr","usePageImages":false,"usePageDescriptions":true},"wgULSAcceptLanguageList":["en-us","en","ta","hi"],"wgULSCurrentAutonym":"English","wgFlaggedRevsParams":{"tags":{"value":{"levels":3,"quality":2,"pristine":3}}},"wgStableRevisionId":2503078,"wgCategoryTreePageCategoryOptions":"{\"mode\":0,\"hideprefix\":20,\"showcount\":true,\"namespaces\":false}","wgNoticeProject":"wikibooks"});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function($,jQuery){mw.user.options.set({"variant":"en"});});
/* cache key: global:resourceloader:filter:minify-js:7:b2706269305541eba923c165462b22c4 */
}</script>
<script>if(window.mw){
mw.loader.implement("user.tokens",function($,jQuery){mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\"});});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax","ext.centralauth.centralautologin","mmv.head","ext.imageMetrics.head","ext.visualEditor.viewPageTarget.init","ext.uls.init","ext.uls.interface","ext.centralNotice.bannerController","skins.vector.js"]);
}</script>
<link rel="dns-prefetch" href="https://meta.wikimedia.org/">
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/w/static/1.26wmf13/skins/Vector/csshover.min.htc")}</style><![endif]-->
<link rel="stylesheet" href="https://en.wikibooks.org/w/index.php?title=MediaWiki:Common.css/Java_Persistence&action=raw&ctype=text/css"><script src="./JPA_Wikibooks_files/index.php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(1).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(2).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(3).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(4).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(5).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(6).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(7).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(8).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(9).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(10).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(11).php" type="text/javascript"></script><script src="./JPA_Wikibooks_files/index(12).php" type="text/javascript"></script><link rel="stylesheet" href="https://en.wikibooks.org/w/index.php?title=MediaWiki:Perbook/Java_Persistence.css&action=raw&ctype=text/css"><script src="./JPA_Wikibooks_files/index(13).php" type="text/javascript"></script></head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Java_Persistence_Print_version skin-vector action-view">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>

							<div id="siteNotice"><div id="centralNotice"></div><!-- CentralNotice --></div>
						<div class="mw-indicators">
</div>
			<h1 id="firstHeading" class="firstHeading" lang="en">Java Persistence/Print version</h1>
									<div id="bodyContent" class="mw-body-content">
									<div id="siteSub">From Wikibooks, open books for an open world</div>
								<div id="contentSub"><span class="subpages">&lt; <a href="https://en.wikibooks.org/wiki/Java_Persistence" title="Java Persistence">Java Persistence</a></span><div id="mw-fr-revisiontag" class="flaggedrevs_basic plainlinks noprint"><img class="flaggedrevs-icon" src="./JPA_Wikibooks_files/1.png" alt="Unreviewed changes are displayed on this page" title="Unreviewed changes are displayed on this page">The <a class="external text" href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&stable=1">latest reviewed version</a> was <a class="external text" href="https://en.wikibooks.org/w/index.php?title=Special:Log&type=review&page=Java_Persistence/Print_version">checked</a> on <i>18 March 2013</i>. There are <a class="external text" href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&oldid=2503078&diff=cur&diffonly=0">template/file changes</a> awaiting review.</div>
</div>
												<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#mw-head">navigation</a>, 					<a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#p-search">search</a>
				</div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><p><br></p>
<p><br></p>
<table class="metadata plainlinks ambox ambox-notice" style="">
<tbody><tr>
<td class="mbox-image">
<div style="width: 52px;"><a href="https://commons.wikimedia.org/wiki/File:Printer.svg" class="image"><img alt="Printer.svg" src="./JPA_Wikibooks_files/40px-Printer.svg.png" width="40" height="40" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/2/23/Printer.svg/60px-Printer.svg.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/2/23/Printer.svg/80px-Printer.svg.png 2x" data-file-width="48" data-file-height="48"></a></div>
</td>
<td class="mbox-text" style=""><b>This is the <a href="https://en.wikibooks.org/wiki/Help:Print_versions" title="Help:Print versions">print version</a> of <a href="https://en.wikibooks.org/wiki/Java_Persistence" title="Java Persistence">Java Persistence</a></b><br>
You won't see this message or any elements not part of the book's content when you print or <a class="external text" href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&action=purge&printable=yes">preview</a> this page.</td>
</tr>
</tbody></table>
<p><a href="https://en.wikibooks.org/wiki/File:Java-persistence.PNG" class="image"><img alt="Java-persistence.PNG" src="./JPA_Wikibooks_files/Java-persistence.PNG" width="490" height="215" data-file-width="490" data-file-height="215"></a></p>
<p>A book relating to the Java programming language.</p>
<h2><span class="mw-headline" id="Contents">Contents</span></h2>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Preface">Preface</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#What_is_Java_persistence.3F">What is Java persistence?</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#What_is_Java.3F">What is Java?</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#What_is_a_database.3F">What is a database?</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#What_is_JPA.3F">What is JPA?</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#What_is_new_in_JPA_2.0.3F">What is new in JPA 2.0?</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Other_Persistence_Specs">Other Persistence Specs</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Why_use_JPA_or_ORM.3F">Why use JPA or ORM?</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Persistence_Products">Persistence Products, Which to Use?</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#EclipseLink">EclipseLink (Eclipse)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#TopLink">TopLink (Oracle)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Hibernate">Hibernate (RedHat)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#TopLink_Essentials.2F">TopLink Essentials (Glassfish)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Kodo">Kodo (Oracle)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Open_JPA">Open JPA (Apache)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Ebean">Ebean (SourceForge)</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Mapping">Mapping, Round Pegs into Square Holes</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Tables">Tables</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Identity">Identity, Primary Keys and Sequencing</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Inheritance">Inheritance</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Embeddables">Embeddables (Aggregates, Composite or Component Objects)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Locking">Locking and Concurrency</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Basics">Basic Attributes</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Relationships">Relationships</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#OneToOne">OneToOne</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#ManyToOne">ManyToOne</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#OneToMany">OneToMany</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#ManyToMany">ManyToMany</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Embeddables">Embedded</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Relationships">Advanced Mappings</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#ElementCollection">ElementCollection (Embeddable Collections, Basic Collections)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Variable_Relationships">Variable Relationships</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Advanced_Topics">Advanced Topics</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Views">Views</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Stored_Procedures">Stored Procedures</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Structured_Object-Relational_Data_Types">Structured Object-Relational Data Types</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#XML_Data_Types">XML Data Types</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Filters">Filters</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#History">History</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Logical_Deletes">Logical Deletes</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Auditing">Auditing</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Replication">Replication</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Runtime">Runtime, Doing the Hokey Pokey (EntityManager)</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Querying">Querying</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#JPQL_BNF">JPQL</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Persisting">Persisting (Inserting, Updating, Merging)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Transactions">Transactions</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Caching">Caching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Java_Enterprise_Edition">EJB</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Security">Security (User Authentication, Proxy Connections, VPD)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Servlets_and_JSPs">Servlets and JSPs</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Spring">Spring</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#WebServices">WebServices</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Packaging_and_Deploying">Packaging and Deploying</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Java_Enterprise_Edition">Java EE</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Weblogic">Oracle Weblogic</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Websphere">IBM Websphere</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#JBoss">Redhat JBoss</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Spring">Spring</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Tomcat">Tomcat</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Clustering">Clustering</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Databases">Databases</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Oracle">Oracle</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#PostgreSQL">PostgreSQL</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#MySQL">MySQL</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#DB2">DB2</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#SQL_Server">SQL Server</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Debugging">Debugging</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Performance">Performance</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Tools">Tools</a>
<ol>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Dali">Eclipse JPA (Dali)</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#TopLink_Mapping_Workbench">TopLink Mapping Workbench</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Testing">Testing</a></li>
</ol>
<hr>
<h1><span class="mw-headline" id="Preface">Preface</span></h1>
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Vraagteken.svg" class="image"><img alt="Vraagteken.svg" src="./JPA_Wikibooks_files/15px-Vraagteken.svg.png" width="15" height="25" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/0/02/Vraagteken.svg/23px-Vraagteken.svg.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/0/02/Vraagteken.svg/30px-Vraagteken.svg.png 2x" data-file-width="128" data-file-height="214"></a></div>
<h3><span class="mw-headline" id="What_is_this_book_about.3F">What is this book about?</span></h3>
<p>This book is meant to cover Java persistence, that is, storing stuff in the Java programming language to a persistent storage medium. Specifically using the Java Persistence API (JPA) to store Java objects to relational databases, but I would like it to have a somewhat wider scope than just JPA and concentrate more on general persistence patterns and use cases, after all JPA is just the newest of many failed Java persistence standards, this book should be able to evolve beyond JPA when it is replaced by the next persistence standard. I do not want this to be just a regurgitation of the JPA Spec, nor a User Manual to using one of the JPA products, but more focused on real-world use cases of users and applications trying to make use of JPA (or other Java persistence solution) and the patterns they evolved and pitfalls they made.</p>
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Crystal_Clear_app_Community_Help.png" class="image"><img alt="Crystal Clear app Community Help.png" src="./JPA_Wikibooks_files/25px-Crystal_Clear_app_Community_Help.png" width="25" height="25" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/6/64/Crystal_Clear_app_Community_Help.png/38px-Crystal_Clear_app_Community_Help.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/6/64/Crystal_Clear_app_Community_Help.png/50px-Crystal_Clear_app_Community_Help.png 2x" data-file-width="128" data-file-height="128"></a></div>
<h3><span class="mw-headline" id="Intended_Audience">Intended Audience</span></h3>
<p>This book is intended to be useful for or to anyone learning to, or developing Java applications that require persisting data to a database. It is mainly intended for Java developers intending to persist Java objects through the Java Persistence API (JPA) standard to a relational database. Please don't just read this book, if you're learning or developing with JPA please contribute your experiences to this book.</p>
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Crystal_Clear_app_kcoloredit.png" class="image"><img alt="Crystal Clear app kcoloredit.png" src="./JPA_Wikibooks_files/25px-Crystal_Clear_app_kcoloredit.png" width="25" height="25" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/7/70/Crystal_Clear_app_kcoloredit.png/38px-Crystal_Clear_app_kcoloredit.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/7/70/Crystal_Clear_app_kcoloredit.png/50px-Crystal_Clear_app_kcoloredit.png 2x" data-file-width="128" data-file-height="128"></a></div>
<h3><span class="mw-headline" id="Style">Style</span></h3>
<p>This book is meant to be written in a casual manner. The goal is avoid sounding dry, overly technical or impersonal. The book should sound casual, like a co-worker explaining to you how to use something, or a fellow consultant relating their latest engagement to another. Please refrain from being overly critical of any product, ranting about bugs, or marketing your own product or services.</p>
<hr>
<h1><span class="mw-headline" id="What_is_Java_persistence.3F"><b>What is Java persistence?</b></span></h1>
<p><b><a href="https://en.wikipedia.org/wiki/Persistence_(computer_science)" class="extiw" title="w:Persistence (computer science)" target="_blank">Persistence</a></b>, in computer science, is an adjective describing data that outlives the process that created it. Java persistence could be defined as storing anything to any level of persistence using the Java programming language, but obviously this would be too broad a definition to cover in a single book. That is why this book is more focused on storing Java <a href="https://en.wikipedia.org/wiki/Object_(computer_science)" class="extiw" title="wikipedia:Object (computer science)" target="_blank">objects</a> to <a href="https://en.wikipedia.org/wiki/Relational_databases" class="extiw" title="wikipedia:Relational databases" target="_blank">relational databases</a>. In particular using the <a href="https://en.wikipedia.org/wiki/Java_Persistence_API" class="extiw" title="wikipedia:Java Persistence API" target="_blank">Java Persistence API</a> (JPA).</p>
<p>There are many ways to make data persist in Java, including (to name a few): <a href="https://en.wikipedia.org/wiki/JDBC" class="extiw" title="wikipedia:JDBC" target="_blank">JDBC</a>, <a href="https://en.wikipedia.org/wiki/Serialization" class="extiw" title="wikipedia:Serialization" target="_blank">serialization</a>, file IO, <a href="https://en.wikipedia.org/wiki/J2EE_Connector_Architecture" class="extiw" title="wikipedia:J2EE Connector Architecture" target="_blank">JCA</a>, <a href="https://en.wikipedia.org/wiki/Object_databases" class="extiw" title="wikipedia:Object databases" target="_blank">object databases</a>, and <a href="https://en.wikipedia.org/wiki/XML_database" class="extiw" title="wikipedia:XML database" target="_blank">XML databases</a>. However, the majority of data is persisted in databases, specifically relational databases. Most things that you do on a computer or web site that involve storing data, involve accessing a relational database. Relational databases are the standard mode of persistent storage for most industries, from banking to manufacturing.</p>
<p>There are many things that can be stored in databases with Java. Java data includes strings, numbers, date and byte arrays, images, XML, and Java objects. Many Java applications use Java objects to model their application data. Because Java is an <a href="https://en.wikipedia.org/wiki/Object_Oriented" class="extiw" title="wikipedia:Object Oriented" target="_blank">Object Oriented</a> language, storing Java objects is a natural and common approach to persisting data from Java.</p>
<p>There are many ways to access a relational database from Java, JPA is just the latest of many different specifications, but it seems to be the direction that most programmers are heading.</p>
<h1><span class="mw-headline" id="What_is_Java.3F">What is Java?</span></h1>
<p><a href="https://en.wikipedia.org/wiki/Java_(programming_language)" class="extiw" title="wikipedia:Java (programming language)" target="_blank">Java</a> is an <a href="https://en.wikipedia.org/wiki/object_oriented" class="extiw" title="wikipedia:object oriented" target="_blank">object oriented</a> programming language first released by <a href="https://en.wikipedia.org/wiki/Sun_Microsystems" class="extiw" title="wikipedia:Sun Microsystems" target="_blank">Sun Microsystems</a> in 1995. It blended concepts from existing languages such as <a href="https://en.wikipedia.org/wiki/C%2B%2B" class="extiw" title="wikipedia:C++" target="_blank">C++</a> and <a href="https://en.wikipedia.org/wiki/Smalltalk" class="extiw" title="wikipedia:Smalltalk" target="_blank">Smalltalk</a> into a new programming language. It achieved its success over the many rival languages of the day because it was associated with this newish thing called the "Internet" in allowing Java applets to be embedded in web pages and run using Netscape. Its other main reason for success was unlike many of its competitors it was open, "free", and not embedded with a integrated development environment (IDE). Java also included the source code to its class library. This enabled Java to be adopted by many different companies producing their own Java development environments but sharing the same language, this open model fostered the growth in the Java language and continues today with the open sourcing of Java.</p>
<p>Java quickly moved from allowing developers to build dinky applets to being the standard server-side language running much of the Internet today. The Enterprise Edition (JEE) of Java was defined to provide an open model for server application to be written and portable across any compliant JEE platform provider. The JEE standard is basically a basket of other Java specifications brought together under one umbrella and has major providers including IBM WebSphere, RedHat JBoss, Sun Glassfish, BEA WebLogic, Oracle AS and many others.</p>
<h2><span class="mw-headline" id="Google_Trends">Google Trends</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="http://www.google.com/trends?q=c%23%2C+php%2C+java%2C+c%2B%2B%2C+perl&ctab=0&geo=all&date=all&sort=0" target="_blank">Programming Languages</a><sup id="cite_ref-1" class="reference"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_note-1">[1]</a></sup></li>
<li><a rel="nofollow" class="external text" href="http://www.google.com/trends?q=websphere%2C+weblogic%2C+jboss%2C+glassfish%2C+geronimo+apache&ctab=0&geo=all&date=all&sort=0" target="_blank">JEE Servers</a><sup id="cite_ref-2" class="reference"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_note-2">[2]</a></sup></li>
</ul>
<ol class="references">
<li id="cite_note-1"><span class="mw-cite-backlink"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_ref-1"><span class="cite-accessibility-label">Jump up </span>↑</a></span> <span class="reference-text">Unfortunately hard to seperate Java island from Java language.</span></li>
<li id="cite_note-2"><span class="mw-cite-backlink"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_ref-2"><span class="cite-accessibility-label">Jump up </span>↑</a></span> <span class="reference-text">Could not include Oracle because of Oracle database hits.</span></li>
</ol>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Programming" title="Java Programming">Java Programming</a></li>
</ul>
<h1><span class="mw-headline" id="What_is_a_database.3F">What is a database?</span></h1>
<p>A <a href="https://en.wikipedia.org/wiki/database" class="extiw" title="wikipedia:database" target="_blank">database</a> is a program that stores data. There are many types of databases: flat-file, hierarchical, relational, object-relational, object-oriented, xml, and others. The original databases were mainly proprietary and non-standardized.</p>
<p>Relational databases were the first databases to achieve great success and standardization. Relational databases are characterized by the <a href="https://en.wikipedia.org/wiki/SQL" class="extiw" title="wikipedia:SQL" target="_blank">SQL</a> (structured query language) standard to query and modify the database, their <a href="https://en.wikipedia.org/wiki/client/server" class="extiw" title="wikipedia:client/server" target="_blank">client/server</a> architecture, and relational table storage structure. Relational databases achieved great success because their standardization allowed many different vendors such as <a href="https://en.wikipedia.org/wiki/Oracle_Corporation" class="extiw" title="wikipedia:Oracle Corporation" target="_blank">Oracle</a>, <a href="https://en.wikipedia.org/wiki/IBM" class="extiw" title="wikipedia:IBM" target="_blank">IBM</a>, and <a href="https://en.wikipedia.org/wiki/Sybase" class="extiw" title="wikipedia:Sybase" target="_blank">Sybase</a> to produce interoperable products giving users the flexibility to switch their vendor and avoid vendor lock-in to a proprietary solution. Their client/server architecture allows the client programming language to be decoupled from the server, allowing the database server to support interface APIs into multiple different programming languages and clients.</p>
<p>Although relational databases are relatively old technology, they still dominate the industry. There have been many attempts to replace the relational model, first with object-oriented databases, then with object-relational databases, and finally with XML databases, but none of the new database models achieved much success and relational databases remain the overwhelmingly dominant database model.</p>
<p>The main relational databases used today are: <a href="https://en.wikipedia.org/wiki/Oracle_database" class="extiw" title="w:Oracle database" target="_blank">Oracle</a>, <a href="https://en.wikipedia.org/wiki/MySQL" class="extiw" title="w:MySQL" target="_blank">MySQL</a> (Oracle), <a href="https://en.wikipedia.org/wiki/PostgreSQL" class="extiw" title="w:PostgreSQL" target="_blank">PostgreSQL</a>, <a href="https://en.wikipedia.org/wiki/DB2" class="extiw" title="w:DB2" target="_blank">DB2</a> (IBM), <a href="https://en.wikipedia.org/wiki/Microsoft_SQL_Server" class="extiw" title="w:Microsoft SQL Server" target="_blank">SQL Server</a> (Microsoft).</p>
<ul>
<li><a rel="nofollow" class="external text" href="http://www.google.com/trends/explore#q=%2Fm%2F01vw9z%2C%2Fm%2F0120vr%2C%2Fm%2F04y3k%2C%2Fm%2F05ynw%2C%2Fm%2F01c6q7&cmpt=q&tz=" target="_blank">Google trend for databases</a></li>
</ul>
<h1><span class="mw-headline" id="What_is_JPA.3F">What is JPA?</span></h1>
<p>The Java Persistence API (<a href="https://en.wikipedia.org/wiki/Java_Persistence_API" class="extiw" title="wikipedia:Java Persistence API" target="_blank">JPA</a>) is a Java specification for accessing, persisting, and managing data between Java objects / classes and a relational database. JPA was defined as part of the <a href="https://en.wikipedia.org/wiki/EJB" class="extiw" title="wikipedia:EJB" target="_blank">EJB</a> 3.0 specification as a replacement for the EJB 2 CMP Entity Beans specification. JPA is now considered the standard industry approach for Object to Relational Mapping (ORM) in the Java Industry.</p>
<p>JPA itself is just a specification, not a product; it cannot perform persistence or anything else by itself. JPA is just a set of interfaces, and requires an implementation. There are open-source and commercial JPA implementations to choose from and any Java EE 5 application server should provide support for its use. JPA also requires a database to persist to.</p>
<p>JPA allows <a href="https://en.wikipedia.org/wiki/POJO" class="extiw" title="wikipedia:POJO" target="_blank">POJO</a> (Plain Old Java Objects) to be easily persisted without requiring the classes to implement any interfaces or methods as the EJB 2 CMP specification required. JPA allows an object's object-relational mappings to be defined through standard annotations or XML defining how the Java class maps to a relational database table. JPA also defines a runtime EntityManager API for processing queries and transaction on the objects against the database. JPA defines an object-level query language, JPQL, to allow querying of the objects from the database.</p>
<p>JPA is the latest of several Java persistence specifications. The first was the OMG persistence service Java binding, which was never very successful; I'm not sure of any commercial products supporting it. Next came EJB 1.0 CMP Entity Beans, which was very successful in being adopted by the big Java EE providers (BEA, IBM), but there was a backlash against the spec by some users who thought the spec requirements on the Entity Beans were overly complex and the overhead and performance were poor. EJB 2.0 CMP tried to reduce some of the complexity of Entity Beans through introducing local interfaces, but the majority of the complexity remained. EJB 2.0 also lacked portability, in that the deployment descriptors defining the object-relational mapping were not specified and were all proprietary.</p>
<p>This backlash in part led to the creation of another Java persistence specification, <a href="https://en.wikipedia.org/wiki/Java_Data_Objects" class="extiw" title="wikipedia:Java Data Objects" target="_blank">JDO</a> (Java Data Objects). JDO obtained somewhat of a "cult" following of several independent vendors such as Kodo JDO, and several open-source implementations, but never had much success with the big Java EE vendors.</p>
<p>Despite the two competing Java persistence standards of EJB CMP and JDO, the majority of users continued to prefer proprietary api solutions, mainly <a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> (which had been around for some time and had its own POJO API) and <a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a> (which was a relatively new open-source product that also had its own POJO API and was quickly becoming the open-source industry standard). The TopLink product formerly owned by WebGain was also acquired by Oracle, increasing its influence on the Java EE community.</p>
<p>The EJB CMP backlash was only part of a backlash against all of Java EE which was seen as too complex in general and prompted such products as the Spring container. This led the EJB 3.0 specification to have a main goal of reducing the complexity, which led the spec committee down the path of JPA. JPA was meant to unify the EJB 2 CMP, JDO, Hibernate, and TopLink APIs and products, and seems to have been very successful in doing so.</p>
<p>Currently most of the persistence vendors have released implementations of JPA confirming its adoption by the industry and users. These include Hibernate (acquired by JBoss, acquired by Red Hat), TopLink (acquired by Oracle), and Kodo JDO (acquired by BEA, acquired by Oracle). Other products that have added support for JPA include Cocobase (owned by Thought Inc.) and JPOX.</p>
<ul>
<li><a rel="nofollow" class="external text" href="https://jcp.org/en/jsr/detail?id=338" target="_blank">JSR 338: Java Persistence API version 2.1</a></li>
<li><a rel="nofollow" class="external text" href="http://xmlns.jcp.org/xml/ns/persistence" target="_blank">Java Persistence API: XML Schemas</a></li>
<li><a rel="nofollow" class="external text" href="http://docs.oracle.com/javaee/7/api/index.html?javax/persistence/package-summary.html" target="_blank">JPA JavaDoc</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/JPQL_BNF" title="Java Persistence/JPQL BNF">JPQL BNF</a></li>
</ul>
<h1><span class="mw-headline" id="What_is_new_in_JPA_2.0.3F">What is new in JPA 2.0?</span></h1>
<p>The JPA 2.0 specification adds several enhancements to the JPA 1.0 specification including:</p>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Map_Key_Columns_.28JPA_2.0.29" title="Java Persistence/Relationships">Extended Map support</a> - Support for maintaining a key column for a <code>Basic</code>, <code>Embeddable</code>, or <code>Entity</code> key value in any collection relationship using a <code>Map</code>.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Identity_and_Sequencing#JPA_2.0" title="Java Persistence/Identity and Sequencing">Derived Identifiers</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Embeddables#Nesting" title="Java Persistence/Embeddables">Nested embedding</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ElementCollection" title="Java Persistence/ElementCollection">New collection mappings</a> - Support for collections of <code>Basic</code> or <code>Embeddable</code> types.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany#Undirectional_OneToMany.2C_No_Inverse_ManyToOne.2C_No_Join_Table_.28JPA_2.0.29" title="Java Persistence/OneToMany">Undirectional OneToMany</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Order_Column_.28JPA_2.0.29" title="Java Persistence/Relationships">Ordered List mappings</a> - Support for maintaining an index column in any collection relationship using a <code>List</code>.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Orphan_Removal_.28JPA_2.0.29" title="Java Persistence/Relationships">Orphan removal</a> - Automatic deletion of objects removed from relationships.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Locking#Pessimistic_Locking" title="Java Persistence/Locking">Pessimistic Locking</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Persisting" title="Java Persistence/Persisting">EntityManager API updates</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Caching#JPA_2.0_Cache_APIs" title="Java Persistence/Caching">Cache APIs</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Runtime#Java_Standard_Edition" title="Java Persistence/Runtime">Standard Properties</a></li>
<li>Metadata</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Querying#Criteria_API_.28JPA_2.0.29" title="Java Persistence/Querying">Criteria API</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/JPQL_BNF#New_in_JPA_2.0" title="Java Persistence/JPQL BNF">JPQL enhancements</a></li>
</ul>
<h3><span class="mw-headline" id="Resources">Resources</span></h3>
<ul>
<li><a rel="nofollow" class="external text" href="http://jcp.org/en/jsr/detail?id=317" target="_blank">JPA 2.0 Spec</a></li>
<li><a rel="nofollow" class="external text" href="http://www.eclipse.org/eclipselink" target="_blank">JPA 2.0 Reference Implementation (EclipseLink)</a></li>
<li><a rel="nofollow" class="external text" href="http://www.eclipse.org/org/press-release/20080317_Eclipselink.php" target="_blank">Eclipse EclipseLink to be JPA 2.0 Reference Implementation</a></li>
<li><a rel="nofollow" class="external text" href="http://wiki.eclipse.org/EclipseLink/Examples/JPA#JPA_2.0" target="_blank">JPA 2.0 Examples</a></li>
</ul>
<h1><span class="mw-headline" id="Other_Persistence_Specs">Other Persistence Specs</span></h1>
<p>There are many specifications related to persistence in Java. The following table summarises the latest version of each specification.<sup id="cite_ref-3" class="reference"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_note-3">[1]</a></sup></p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr style="background:#ffdead">
<th>Spec</th>
<th>Version</th>
<th>-</th>
</tr>
<tr>
<td><a href="https://en.wikipedia.org/wiki/JDBC" class="extiw" title="wikipedia:JDBC" target="_blank">JDBC</a> (Java DataBase Connectivity)</td>
<td>
<center>4.2</center>
</td>
<td>
<center>2014</center>
</td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikipedia.org/wiki/Java_Data_Objects" class="extiw" title="wikipedia:Java Data Objects" target="_blank">JDO</a> (Java Data Objects)</td>
<td>
<center>3.1</center>
</td>
<td>
<center>2015</center>
</td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikipedia.org/wiki/Java_Persistence_API" class="extiw" title="wikipedia:Java Persistence API" target="_blank">JPA</a> (Java Persistence API)</td>
<td>
<center>2.1</center>
</td>
<td>
<center>2013</center>
</td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikipedia.org/wiki/Java_EE_Connector_Architecture" class="extiw" title="wikipedia:Java EE Connector Architecture" target="_blank">JCA</a> (Java EE Connector Architecture)</td>
<td>
<center>1.6</center>
</td>
<td>
<center>2009</center>
</td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikipedia.org/wiki/Service_Data_Objects" class="extiw" title="wikipedia:Service Data Objects" target="_blank">SDO</a> (Service Data Objects)</td>
<td>
<center>2.1</center>
</td>
<td>
<center>2006</center>
</td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikipedia.org/wiki/EJB" class="extiw" title="wikipedia:EJB" target="_blank">EJB CMP</a> (Enterprise Java Beans, Container Managed Persistence)</td>
<td>
<center>2.1 (EJB)</center>
</td>
<td>
<center>2003</center>
</td>
<td></td>
</tr>
</tbody></table>
<ol class="references">
<li id="cite_note-3"><span class="mw-cite-backlink"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_ref-3"><span class="cite-accessibility-label">Jump up </span>↑</a></span> <span class="reference-text">Last updated 2015-07-09</span></li>
</ol>
<h1><span class="mw-headline" id="Why_use_JPA_or_ORM.3F">Why use JPA or ORM?</span></h1>
<p>This is an intriguing question. There are many reasons to use an ORM framework or persistence product, and many reasons to use JPA in particular.</p>
<h4><span class="mw-headline" id="Reasons_for_ORM">Reasons for ORM</span></h4>
<ul>
<li>Eliminates all of the 'hand' mapping in Java from a SQL ResultSet to a Java POJO greatly reducing the amount of mapping work.</li>
<li>Reduces the amount of work required to the persistence code base with a domain data model and/or relational data model change.</li>
<li>Leverages large persistence library to avoid developing solutions to problems that others have already solved.</li>
<li>Avoids low level JDBC and SQL code.</li>
<li>Leverages object oriented programming and object model usage.</li>
<li>Provides database and schema independence.</li>
<li>Most ORM products are free and open source.</li>
<li>Many enterprise corporations provide support and services for ORM products.</li>
<li>Provides high end performance features such as caching and sophisticated database and query optimizations.</li>
</ul>
<h4><span class="mw-headline" id="Reasons_for_JPA">Reasons for JPA</span></h4>
<ul>
<li>It is a standard and part of EJB3 and Java EE.</li>
<li>Many free and open source products with enterprise level support.</li>
<li>Portability across application servers and persistence products (avoids vendor lock-in).</li>
<li>A usable and functional specification.</li>
<li>Supports both Java EE and Java SE.</li>
</ul>
<p>ORM can be a hot topic for some people, and there are many ORM camps. There are those that endorse a particular standard or product. There are those that don't believe in ORM or even objects in general and prefer JDBC. There are those that still believe that object databases are the way to go. Personally I would recommend you use whatever technology you are most comfortable with, but if you have never used ORM or JPA, perhaps give it a try and see if you like it. The below list provides several discussions on why or why not to use JPA and ORM.</p>
<h4><span class="mw-headline" id="Discussions_on_JPA_and_ORM_Usage">Discussions on JPA and ORM Usage</span></h4>
<ul>
<li><a rel="nofollow" class="external text" href="http://saloon.javaranch.com/cgi-bin/ubb/ultimatebb.cgi?ubb=get_topic&f=78&t=003738" target="_blank">Why do we need anything other than JDBC? (Java Ranch)</a></li>
</ul>
<ul>
<li><a rel="nofollow" class="external text" href="http://www.theserverside.com/news/thread.tss?thread_id=44526" target="_blank">JPA Explained (The Server Side)</a></li>
<li><a rel="nofollow" class="external text" href="http://www.theserverside.com/news/thread.tss?thread_id=40965" target="_blank">JPA vs JDO (The Server Side)</a></li>
</ul>
<hr>
<h1><span class="mw-headline" id="Persistence_Products"><b>Persistence Products</b></span></h1>
<p>There are many persistence products to choose from. Most persistence products now support a JPA interface, although there still are some exceptions. Which product you use depends on your preference, but most people would recommend you use the JPA standard whichever product you choose. This gives you the flexibility to switch persistence providers, or port your application to another server platform which may use a different persistence provider.</p>
<p>Determining which persistence product to use involves many criteria. Valid things to consider include:</p>
<ul>
<li>Which persistence product does your server platform support and integrate with?</li>
<li>What is the cost of the product, is it free and open source, can you purchase enterprise level support and services?</li>
<li>Do you have an existing relationship with the company producing the product?</li>
<li>Is the product active and does it have a large user base?</li>
<li>How does the product perform and scale?</li>
<li>Does the product integrate with your database platform?</li>
<li>Does the product have active and open forums, do questions receive useful responses?</li>
<li>Is the product JPA compliant, what functionality does the product offer beyond the JPA specification?</li>
</ul>
<h2><span class="mw-headline" id="Existing_Persistence_Products">Existing Persistence Products</span></h2>
<p>The following table summarises existing persistence products.<sup id="cite_ref-4" class="reference"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_note-4">[1]</a></sup></p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr style="background:#ffdead">
<th>Product</th>
<th>JPA 1.0</th>
<th>JPA 2.0</th>
<th>JPA 2.1</th>
<th>JDO 2.0</th>
<th>JDO 3.0</th>
<th>CMP 2.1</th>
<th>Version</th>
<th>Year of Last Release</th>
<th>Open Source</th>
<th>Application Servers<sup id="cite_ref-5" class="reference"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_note-5">[2]</a></sup></th>
</tr>
<tr>
<td><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a> (Red Hat)</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td></td>
<td></td>
<td></td>
<td>
<center>4.3.1</center>
</td>
<td>
<center>2014</center>
</td>
<td>Yes</td>
<td>JBoss AS/Wildfly</td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a> (Eclipse)</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td></td>
<td></td>
<td></td>
<td>
<center>2.5.2</center>
</td>
<td>
<center>2014</center>
</td>
<td>Yes</td>
<td>Oracle Weblogic (12c), Glassfish (v3)</td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> (Oracle)</td>
<td>Yes</td>
<td>Yes</td>
<td></td>
<td></td>
<td></td>
<td>Yes</td>
<td>
<center>12c (12.1.2)</center>
</td>
<td>
<center>2011</center>
</td>
<td></td>
<td>Oracle Weblogic (12c), OracleAS (10.1.3)</td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikibooks.org/wiki/Java_Persistence/Open_JPA" title="Java Persistence/Open JPA">OpenJPA</a> (Apache)</td>
<td>Yes</td>
<td>Yes</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>
<center>2.2.2</center>
</td>
<td>
<center>2013</center>
</td>
<td>Yes</td>
<td>Geronimo, WebSphere Application Server (8.0)</td>
<td></td>
</tr>
<tr>
<td><a rel="nofollow" class="external text" href="http://www.datanucleus.org/" target="_blank">DataNucleus</a> (DataNucleus)</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td></td>
<td>
<center>4.0.4</center>
</td>
<td>
<center>2014</center>
</td>
<td>Yes</td>
<td></td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink_Essentials" title="Java Persistence/TopLink Essentials">TopLink Essentials</a> (java.net)</td>
<td>Yes</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>
<center>2.0</center>
</td>
<td>
<center>2007</center>
</td>
<td>Yes</td>
<td>Glassfish (v2), SunAS (9), OracleAS (10.1.3)</td>
<td></td>
</tr>
<tr>
<td><a href="https://en.wikibooks.org/wiki/Java_Persistence/Kodo" title="Java Persistence/Kodo">Kodo</a> (Oracle)</td>
<td>Yes</td>
<td></td>
<td></td>
<td>Yes</td>
<td></td>
<td></td>
<td>
<center>4.1</center>
</td>
<td>
<center>2007</center>
</td>
<td></td>
<td>Oracle WebLogic (10.3)</td>
<td></td>
</tr>
</tbody></table>
<ol class="references">
<li id="cite_note-4"><span class="mw-cite-backlink"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_ref-4"><span class="cite-accessibility-label">Jump up </span>↑</a></span> <span class="reference-text">Last updated 2014-04-17</span></li>
<li id="cite_note-5"><span class="mw-cite-backlink"><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#cite_ref-5"><span class="cite-accessibility-label">Jump up </span>↑</a></span> <span class="reference-text">Application server that includes the product as their JPA implementation</span></li>
</ol>
<h1><span class="mw-headline" id="EclipseLink">EclipseLink</span></h1>
<p><a href="https://en.wikipedia.org/wiki/EclipseLink" class="extiw" title="w:EclipseLink" target="_blank">EclipseLink</a> is the open source Eclipse Persistence Services Project from the Eclipse Foundation. The product provides an extensible framework that allows Java developers to interact with various data services, including databases, XML, and Enterprise Information Systems (EIS). EclipseLink supports a number of persistence standards including the Java Persistence API (JPA), Java API for XML Binding (JAXB), Java Connector Architecture (JCA), and Service Data Objects (SDO).</p>
<p>EclipseLink is based on the <a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> product, which <a href="https://en.wikipedia.org/wiki/Oracle_Corporation" class="extiw" title="w:Oracle Corporation" target="_blank">Oracle</a> contributed the source code from to create the EclipseLink project. The original contribution was from TopLink's 11g code base, and the entire code-base/feature set was contributed, with only EJB 2 CMP and some minor Oracle AS specific integration removed. This differs from the TopLink Essentials Glassfish contribution, which did not include some key enterprise features. The package names were changed and some of the code was moved around.</p>
<p>The TopLink Mapping Workbench UI has also been contributed to the project.</p>
<p>EclipseLink is the intended path forward for persistence for Oracle and TopLink. It is intended that the next major release of Oracle TopLink will include EclipseLink as well as the next major release of Oracle AS.</p>
<p>EclipseLink supports usage in an <a href="https://en.wikipedia.org/wiki/OSGi" class="extiw" title="w:OSGi" target="_blank">OSGi</a> environment.</p>
<p>EclipseLink was announced to be the JPA 2.0 reference implementation, and announced to be the JPA provider for Glassfish v3.</p>
<ul>
<li><a rel="nofollow" class="external text" href="http://www.eclipse.org/eclipselink/" target="_blank">EclipseLink Home</a></li>
<li><a rel="nofollow" class="external text" href="http://www.eclipse.org/newsportal/thread.php?group=eclipse.technology.eclipselink" target="_blank">EclipseLink Newsgroup</a></li>
<li><a rel="nofollow" class="external text" href="http://wiki.eclipse.org/EclipseLink" target="_blank">EclipseLink Wiki</a></li>
</ul>
<h1><span class="mw-headline" id="TopLink">TopLink</span></h1>
<p><a href="https://en.wikipedia.org/wiki/TopLink" class="extiw" title="w:TopLink" target="_blank">TopLink</a> is one of the leading Java persistence products and JPA implementations. TopLink is produced by <a href="https://en.wikipedia.org/wiki/Oracle_Corporation" class="extiw" title="w:Oracle Corporation" target="_blank">Oracle</a> and part of Oracle's OracleAS, WebLogic, and OC4J servers.</p>
<p>As of TopLink 11g, TopLink bundles the open source project <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a> for most of its functionality.</p>
<p>The TopLink 11g release supports the JPA 1.0 specification. TopLink 10.1.3 also supports EJB CMP and is the persistence provider for OracleAS OC4J 10.1.3 for both JPA and EJB CMP. TopLink provides advanced object-relational mapping functionality beyond the JPA specification, as well as providing persistence for object-relational data-types, and Enterprise Information Systems (EIS/mainframes). TopLink includes sophisticated object caching and performance features. TopLink provides a Grid extension that integrate with Oracle Coherence. TopLink provides object-XML mapping support and provides a JAXB implementation and web service integration. TopLink provides a Service Data Object (SDO) implementation.</p>
<p>TopLink provides a rich user interface through the TopLink Mapping Workbench. The Mapping Workbench allows for graphical mapping of an object model to a data model, as allows for generation of a data model from an object model, and generation of an object model from a data model, and auto-mapping of an existing object and data model. The TopLink Mapping Workbench functionality is also integrated with Oracle's JDeveloper IDE.</p>
<p>TopLink contributed part of its source code to become the JPA 1.0 reference implementation under the Sun java.net Glassfish project. This open-source product is called TopLink Essentials, and despite a different package name (oracle.toplink.essentials) it is basically a branch of the source code of the TopLink product with some advanced functionality stripped out.</p>
<p>TopLink contributed practically its entire source code to the Eclipse Foundation EclipseLink product. This is an open source product currently in incubation that represents the path forward for TopLink. The package name is different (org.eclipse.persistence) but the source code it basically a branch of the TopLink 11g release. Oracle also contributed its Mapping Workbench source code to the project. The TopLink Mapping Workbench developers also were major contributors to the Eclipse Dali project for JPA support.</p>
<p>TopLink was first developed in Smalltalk and ported to Java in the 90's, and has over 15 years worth of object persistence solutions. TopLink originally provided a proprietary POJO persistence API, when EJB was first released TopLink provided one of the most popular EJB CMP implementations, although it continued to recommend its POJO solution. TopLink also provided a JDO 1.0 implementation for a few releases, but this was eventually deprecated and removed once the JPA specification had been formed. Oracle and TopLink have been involved in each of the EJB, JDO and EJB3/JPA expert groups, and Oracle was the co-lead for the EJB3/JPA specification.</p>
<ul>
<li><a rel="nofollow" class="external text" href="http://www.oracle.com/technology/products/ias/toplink/index.html" target="_blank">Oracle TopLink Home</a></li>
<li><a rel="nofollow" class="external text" href="http://forums.oracle.com/forums/forum.jspa?forumID=48" target="_blank">Oracle TopLink Forum</a></li>
<li><a rel="nofollow" class="external text" href="http://wiki.oracle.com/page/TopLink" target="_blank">Oracle TopLink Wiki</a></li>
</ul>
<p>TopLink Resources</p>
<ul>
<li><a rel="nofollow" class="external text" href="http://docs.sun.com/app/docs/doc/819-3672/gbwmk?a=view" target="_blank">TopLink Automatic Schema Generation Options</a></li>
</ul>
<h1><span class="mw-headline" id="Hibernate">Hibernate</span></h1>
<p><a href="https://en.wikipedia.org/wiki/Hibernate_(Java)" class="extiw" title="w:Hibernate (Java)" target="_blank">Hibernate</a> was an open source project developed by a team of Java software developers around the world led by Gavin King. JBoss, Inc. (now part of Red Hat) later hired the lead Hibernate developers and worked with them in supporting Hibernate.</p>
<p>The current version of Hibernate is Version 4.2.x. Hibernate provides both a proprietary POJO API, and JPA support.</p>
<h1><span class="mw-headline" id="TopLink_Essentials">TopLink Essentials</span></h1>
<p><a href="https://en.wikipedia.org/wiki/TopLink" class="extiw" title="w:TopLink" target="_blank">TopLink Essentials</a> is an open source project from the Sun java.net Glassfish community. It is the EJB3 JPA 1.0 reference implementation, and is the JPA provider for the Sun Glassfish v1 application server.</p>
<p>TopLink Essentials was based on the <a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> product, which <a href="https://en.wikipedia.org/wiki/Oracle_Corporation" class="extiw" title="w:Oracle Corporation" target="_blank">Oracle</a> contributed some of the source code from to create the TopLink Essentials project. The original contribution was from TopLink's 10.1.3 code base, only some of the TopLink product source code was contributed, which did not include some key enterprise features. The package names were changed and some of the code was moved around.</p>
<p>TopLink Essentials has been replaced by the <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a> project. EclipseLink will be the JPA 2.0 reference implementation and be part of Sun Glassfish v3.</p>
<ul>
<li><a rel="nofollow" class="external text" href="https://glassfish.dev.java.net/javaee5/persistence/index.html" target="_blank">TopLink Essentials Home</a></li>
<li><a rel="nofollow" class="external text" href="http://www.nabble.com/java.net---glassfish-persistence-f13455.html" target="_blank">TopLink Essentials Forum</a></li>
<li><a rel="nofollow" class="external text" href="http://wiki.glassfish.java.net/Wiki.jsp?page=TopLinkEssentials" target="_blank">TopLink Essentials Wiki</a></li>
</ul>
<h1><span class="mw-headline" id="Kodo">Kodo</span></h1>
<p><a rel="nofollow" class="external text" href="http://www.bea.com/kodo/" target="_blank">Kodo</a>, was originally developed as an Java Data Objects (JDO) implementation, by SolarMetric. BEA Systems acquired SolarMetric in 2005, where Kodo was expanded to be an implementation of both the JDO and JPA specifications. In 2006, BEA donated a large part of the Kodo source code to the Apache Software Foundation under the name OpenJPA. BEA (and Kodo) were acquired by Oracle. Kodo development is now stopped and users are referred to EclipseLink</p>
<h1><span class="mw-headline" id="Open_JPA">Open JPA</span></h1>
<p><a href="https://en.wikipedia.org/wiki/OpenJPA" class="extiw" title="w:OpenJPA" target="_blank">OpenJPA</a> is an Apache project for supporting the JPA specification. Its source code was originally donated from (part of) BEA's Kodo product.</p>
<h1><span class="mw-headline" id="Ebean">Ebean</span></h1>
<p><a rel="nofollow" class="external text" href="http://www.avaje.org/" target="_blank">Ebean</a> is a Java ORM based on the JPA specification.</p>
<p>The goal of Ebean is to provide <a href="https://en.wikibooks.org/wiki/Java_Persistence/Mapping" title="Java Persistence/Mapping">mapping</a> compatible with JPA while providing a simpler API to use and learn.</p>
<h2><span class="mw-headline" id="Index">Index</span></h2>
<ol>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Why_Ebean&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Why Ebean (does not exist)">Why Ebean</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Example_Model&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Example Model (does not exist)">Example Model</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Quick_Start_-_examples&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Quick Start - examples (does not exist)">Quick Start - examples</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Mapping_via_JPA_Annotations&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Mapping via JPA Annotations (does not exist)">Mapping via JPA Annotations</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Query&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Query (does not exist)">Query</a>
<ol>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Basics&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Basics (does not exist)">Basics</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Future_-_Asychronous_query_execution&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Future - Asychronous query execution (does not exist)">Future - Asychronous query execution</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/PagingList&action=edit&redlink=1" class="new" title="Java Persistence/Print version/PagingList (does not exist)">PagingList</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Aggregation_-_Group_By&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Aggregation - Group By (does not exist)">Aggregation - Group By</a></li>
</ol>
</li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Save_and_Delete&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Save and Delete (does not exist)">Save and Delete</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Transactions&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Transactions (does not exist)">Transactions</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Caching&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Caching (does not exist)">Caching</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/Using_raw_SQL&action=edit&redlink=1" class="new" title="Java Persistence/Print version/Using raw SQL (does not exist)">Using raw SQL</a></li>
</ol>
<hr>
<h1><span class="mw-headline" id="Mapping"><b>Mapping</b></span></h1>
<h1><span class="mw-headline" id="Mapping_2">Mapping</span></h1>
<p>The first thing that you need to do to persist something in Java is define how it is to be persisted. This is called the mapping process (<a class="external text" href="http://en.wikipedia.org/wiki/Object-Relational_impedance_mismatch" target="_blank">details</a>). There have been many different solutions to the mapping process over the years, including some object databases that didn't require you map anything but let you persist anything directly. Object-relational mapping tools that would generate an object model for a data model that included the mapping and persistence logic in it. ORM products that provided mapping tools to allow the mapping of an existing object model to an existing data model and stored this mapping meta-data in flat files, database tables, XML and finally annotations.</p>
<p>In JPA, mappings can either be stored through Java annotations, or in XML files. One significant aspect of JPA is that only the minimal amount of mapping is required. JPA implementations are required to provide defaults for almost all aspects of mapping an object.</p>
<p>The minimum requirement to mapping an object in JPA is to define which objects can be persisted. This is done through either marking the class with the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Entity.html" target="_blank">@Entity</a></code> annotation, or adding an <code>&lt;entity&gt;</code> tag for the class in the persistence unit's ORM XML file. Also the primary key, or unique identifier attribute(s) must be defined for the class. This is done through marking one of the class' fields or properties (get method) with the <code>@Id</code> annotation, or adding an <code>&lt;id&gt;</code> tag for the class' attribute in the <a rel="nofollow" class="external text" href="http://java.sun.com/xml/ns/persistence/orm_1_0.xsd" target="_blank">ORM XML</a> file.</p>
<p>The JPA implementation will default all other mapping information, including defaulting the table name, column names for all defined fields or properties, cardinality and mapping of relationships, all SQL and persistence logic for accessing the objects. Most JPA implementations also provide the option of generating the database tables at runtime, so very little work is required by the developer to rapidly develop a persistent JPA application.</p>
<h3><span class="mw-headline" id="Example_object_model">Example object model</span></h3>
<p><a href="https://en.wikibooks.org/wiki/File:Employee-model.PNG" class="image"><img alt="Employee-model.PNG" src="./JPA_Wikibooks_files/Employee-model.PNG" width="780" height="528" data-file-width="780" data-file-height="528"></a></p>
<h3><span class="mw-headline" id="Example_data_model">Example data model</span></h3>
<p><a href="https://en.wikibooks.org/wiki/File:Employee-schema.PNG" class="image"><img alt="Employee-schema.PNG" src="./JPA_Wikibooks_files/Employee-schema.PNG" width="750" height="500" data-file-width="750" data-file-height="500"></a></p>
<h3><span class="mw-headline" id="Example_of_a_persistent_entity_mapping_in_annotations">Example of a persistent entity mapping in annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kn">import</span> <span class="nn">javax.persistence.*</span><span class="o">;</span>
<span class="o">...</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Employee</span> <span class="n">manager</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">managedEmployees</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_persistent_entity_mapping_in_XML">Example of a persistent entity mapping in XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;entity-mappings</span> <span class="na">version=</span><span class="s">"1.0"</span>
        <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/persistence/orm"</span>
        <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/persistence/orm orm_1_0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;description&gt;</span>The minimal mappings for a persistent entity in XML.<span class="nt">&lt;/description&gt;</span>
    <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;attributes&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/attributes&gt;</span>
    <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/entity-mappings&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Access_Type">Access Type</span></h2>
<p>JPA allows annotations to be placed on either the class field, or on the <code>get</code> method for the property. This defines the <i>access type</i> of the class, which is either <code>FIELD</code> or <code>PROPERTY</code>. Either all annotations must be on the fields, or all annotations on the <code>get</code> methods, but not both (unless the <code>@AccessType</code> annotation is used). JPA does not define a default access type (oddly enough), so the default may depend on the JPA provider. The default is assumed to occur based on where the <code>@Id</code> annotation is placed, if placed on a field, then the class is using <code>FIELD</code> access, if placed on a <code>get</code> method, then the class is using <code>PROPERTY</code> access. The access type can also be defined through XML on the <code>&lt;entity&gt;</code> element. The access type can be configured using the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/AccessType.html" target="_blank"><code>@AccessType</code></a> annotation or <code>access-type</code> XML attribute.</p>
<p>For <code>FIELD</code> access the class field value will be accessed directly to store and load the value from the database. This is normally done either through reflection, or through generated byte code, but depends on the JPA provider and configuration. The field can be <code>private</code> or any other access type. <code>FIELD</code> is normally safer, as it avoids any unwanted side-affect code that may occur in the application <code>get</code>/<code>set</code> methods.</p>
<p>For <code>PROPERTY</code> access the class <code>get</code> and <code>set</code> methods will be used to store and load the value from the database. This is normally done either through reflection, or through generated byte code, but depends on the JPA provider and configuration. <code>PROPERTY</code> has the advantage of allowing the application to perform conversion of the database value when storing it in the object. The user should be careful to not put any side-affects in the <code>get</code>/<code>set</code> methods that could interfere with persistence.</p>
<p>JPA 2.0 allows the access type to also be set on a specific field or <code>get</code> method. This allows for the class to use one default access mechanism, but for one attribute to use a different access type. This can be used for attributes that need to be converted through a set of database specific <code>get</code>, <code>set</code>, or allow a specific attribute to avoid side-affects in its <code>get</code>, <code>set</code> methods. This is done through specifying the <code>@AccessType</code> annotation or XML attribute on the mapped attribute. You may also need to mark the field/property as <code>@Transient</code> if it has a different attribute name than the mapped attribute.</p>
<p>JPA allows for a persistence unit default <code>&lt;access-type&gt;</code> element to be set in <code>persistence-unit-defaults</code> or entity default in <code>entity-mappings</code>.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Default to using <code>FIELD</code> access. If weaving is enabled, and field access is used the fields are accessed directly using generated byte-code. If not using weaving, or using property access, reflection is used. EclipseLink also supports a third access type <code>VIRTUAL</code>, which can be used from the ORM XML to map dynamic properties stored in a properties Map.</dd>
</dl>
<h3><span class="mw-headline" id="Access_type_example">Access type example</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Access</span><span class="o">(</span><span class="n">AccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="nd">@Transient</span>
    <span class="kd">private</span> <span class="n">Money</span> <span class="n">salary</span><span class="o">;</span>
    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Employee</span> <span class="n">manager</span><span class="o">;</span>

    <span class="nd">@Access</span><span class="o">(</span><span class="n">AccessType</span><span class="o">.</span><span class="na">PROPERTY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="nf">getBDSalary</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">salary</span><span class="o">.</span><span class="na">toNumber</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setBDSalary</span><span class="o">(</span><span class="n">BigDecimal</span> <span class="n">salary</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">salary</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Money</span><span class="o">(</span><span class="n">salary</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Money</span> <span class="nf">getSalary</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">salary</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setSalary</span><span class="o">(</span><span class="n">Money</span> <span class="n">salary</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">salary</span> <span class="o">=</span> <span class="n">salary</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Common_Problems">Common Problems</span></h2>
<h4><span class="mw-headline" id="My_annotations_are_ignored"><i>My annotations are ignored</i></span></h4>
<dl>
<dd>This typically occurs when you annotate both the fields and methods (properties) of the class. You must choose either field or property access, and be consistent. Also when annotating properties you must put the annotation on the get method, not the set method. Also ensure that you have not defined the same mappings in XML, which may be overriding the annotations. You may also have a classpath issue, such as having an old version of the class on the classpath.</dd>
</dl>
<h4><span class="mw-headline" id="Odd_behavior"><i>Odd behavior</i></span></h4>
<dl>
<dd>There are many reasons that odd behavior can occur with persistence. One common issue that can cause odd behavior is using property access and putting <i>side effects</i> in your get or set methods. For this reason it is generally recommended to use field access in mapping, i.e. putting your annotations on your variables not your get methods.</dd>
</dl>
<dl>
<dd>For example consider:</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPhones</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">Phone</span> <span class="n">phone</span> <span class="o">:</span> <span class="n">phones</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">phone</span><span class="o">.</span><span class="na">setOwner</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">this</span><span class="o">.</span><span class="na">phones</span> <span class="o">=</span> <span class="n">phones</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<dl>
<dd>This may look innocent, but these side effects can have unexpected consequences. For example if the relationship was <code>lazy</code> this would have the effect of always instantiating the collection when set from the database. It could also have consequences with certain JPA implementations for persisting, merging and other operations, causing duplicate inserts, missed updates, or a corrupt object model.</dd>
</dl>
<dl>
<dd>I have also seen simply incorrect property methods, such as a get method that always returns a new object, or a copy, or set methods that don't actually set the value.</dd>
</dl>
<dl>
<dd>In general if you are going to use property access, ensure your property methods are free of side effects. Perhaps even use different property methods than your application uses.</dd>
</dl>
<h1><span class="mw-headline" id="Tables">Tables</span></h1>
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:EMPLOYEE_Table_(Database).PNG" class="image"><img alt="EMPLOYEE Table (Database).PNG" src="./JPA_Wikibooks_files/EMPLOYEE_Table_(Database).PNG" width="141" height="125" data-file-width="141" data-file-height="125"></a></div>
<p>A <a href="https://en.wikipedia.org/wiki/Table_(database)" class="extiw" title="w:Table (database)" target="_blank">table</a> is the basic persist structure of a relational database. A table contains a list of columns which define the table's structure, and a list of rows that define the table's data. Each column has a specific type and generally size. The standard set of relational types are limited to basic types including numeric, character, date-time, and binary (although most modern databases have additional types and typing systems). Tables can also have constraints that define the rules which restrict the row data, such as primary key, foreign key, and unique constraints. Tables also have other artifacts such as indexes, partitions and triggers.</p>
<p>A typical mapping of a persist class will map the class to a single table. In JPA this is defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Table.html" target="_blank">@Table</a></code> annotation or <code>&lt;table&gt;</code> XML element. If no table annotation is present, the JPA implementation will auto assign a table for the class. The JPA default table name is the name of the class (minus the package) with the first letter capitalized. Each attribute of the class will be stored in a column in the table.</p>
<h3><span class="mw-headline" id="Example_mapping_annotations_for_an_entity_with_a_single_table">Example mapping annotations for an entity with a single table</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMPLOYEE"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_mapping_XML_for_an_entity_with_a_single_table">Example mapping XML for an entity with a single table</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"EMPLOYEE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h1><span class="mw-headline" id="Advanced">Advanced</span></h1>
<p>Although in the ideal case each class would map to a single table, this is not always possible. Other scenarios include:</p>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Multiple_tables">Multiple tables</a>&nbsp;: One class maps to 2 or multiple tables.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#Filters" title="Java Persistence/Advanced Topics">Sharing tables</a>&nbsp;: 2 or multiple classes are stored in the same table.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Inheritance" title="Java Persistence/Inheritance">Inheritance</a>&nbsp;: A class is involved in inheritance and has an inherited and local table.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#Views" title="Java Persistence/Advanced Topics">Views</a>&nbsp;: A class maps to a view.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#Stored_procedures" title="Java Persistence/Advanced Topics">Stored procedures</a>&nbsp;: A class maps to a set of stored procedures.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#Partitioning" title="Java Persistence/Advanced Topics">Partitioning</a>&nbsp;: Some instances of a class map to one table, and other instances to another table.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#Replication" title="Java Persistence/Advanced Topics">Replication</a>&nbsp;: A class's data is replicated to multiple tables.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#History" title="Java Persistence/Advanced Topics">History</a>&nbsp;: A class has historical data.</li>
</ul>
<p>These are all advanced cases, some are handled by the JPA Spec and many are not. The following sections investigate each of these scenarios further and include what is supported by the JPA spec, what can be done to workaround the issue within the spec, and how to use some JPA implementations extensions to handle the scenario.</p>
<h2><span class="mw-headline" id="Multiple_tables">Multiple tables</span></h2>
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Emp_Tables_(Database).PNG" class="image"><img alt="Emp Tables (Database).PNG" src="./JPA_Wikibooks_files/Emp_Tables_(Database).PNG" width="383" height="129" data-file-width="383" data-file-height="129"></a></div>
<p>Sometimes a class maps to multiple tables. This typically occurs on legacy or existing data models where the object model and data model do not match. It can also occur in inheritance when subclass data is stored in additional tables. Multiple tables may also be used for performance, partitioning or security reasons.</p>
<p>JPA allows multiple tables to be assigned to a single class. The <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/SecondaryTable.html" target="_blank">@SecondaryTable</a></code> and SecondaryTables annotations or <code>&lt;secondary-table&gt;</code> elements can be used. By default the <code>@Id</code> column(s) are assumed to be in both tables, such that the secondary table's <code>@Id</code> column(s) are the primary key of the secondary table and a foreign key to the first table. If the first table's <code>@Id</code> column(s) are not named the same the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/PrimaryKeyJoinColumn.html" target="_blank">@PrimaryKeyJoinColumn</a></code> or <code>&lt;primary-key-join-column&gt;</code> can be used to define the foreign key join condition.</p>
<p>In a multiple table entity, each mapping must define which table the mapping's columns are from. This is done using the <code>table</code> attribute of the <code>@Column</code> or <code>@JoinColumn</code> annotations or XML elements. By default the primary table of the class is used, so you only need to set the table for secondary tables. For inheritance the default table is the primary table of the subclass being mapped.</p>
<h3><span class="mw-headline" id="Example_mapping_annotations_for_an_entity_with_multiple_tables">Example mapping annotations for an entity with multiple tables</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMPLOYEE"</span><span class="o">)</span>
<span class="nd">@SecondaryTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_DATA"</span><span class="o">,</span>
                <span class="n">pkJoinColumns</span> <span class="o">=</span> <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
               <span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"YEAR_OF_SERV"</span><span class="o">,</span> <span class="n">table</span><span class="o">=</span><span class="s">"EMP_DATA"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">yearsOfService</span><span class="o">;</span>

    <span class="nd">@OneToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"MGR_ID"</span><span class="o">,</span> <span class="n">table</span><span class="o">=</span><span class="s">"EMP_DATA"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Employee</span> <span class="n">manager</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_mapping_XML_for_an_entity_with_multiple_tables">Example mapping XML for an entity with multiple tables</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"EMPLOYEE"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;secondary-table</span> <span class="na">name=</span><span class="s">"EMP_DATA"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;primary-key-join-column</span> <span class="na">name=</span><span class="s">"EMP_ID"</span> <span class="na">referenced-column-name=</span><span class="s">"ID"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/secondary-table&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        ...
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"yearsOfService"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"YEAR_OF_SERV"</span> <span class="na">table=</span><span class="s">"EMP_DATA"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
        <span class="nt">&lt;one-to-one</span> <span class="na">name=</span><span class="s">"manager"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"MGR_ID"</span> <span class="na">table=</span><span class="s">"EMP_DATA"</span> <span class="na">referenced-column-name=</span><span class="s">"ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/one-to-one&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<p>With the <code>@PrimaryKeyJoinColumn</code> the name refers to the foreign key column in the secondary table and the referencedColumnName refers to the primary key column in the first table. If you have multiple secondary tables, they must always refer to the first table. When defining the table's schema typically you will define the join columns in the secondary table as the primary key of the table, and a foreign key to the first table. Depending how you have defined your foreign key constraints, the order of the tables can be important, the order will typically match the order that the JPA implementation will insert into the tables, so ensure the table order matches your constraint dependencies.</p>
<p>For relationships to a class that has multiple tables the foreign key (join column) always maps to the primary table of the target. JPA does not allow having a foreign key map to a table other than the target object's primary table. Normally this is not an issue as foreign keys almost always map to the id/primary key of the primary table, but in some advanced scenarios this may be an issue. Some JPA products allow the column or join column to use the qualified name of the column (i.e. <code>@JoinColumn(referenceColumnName="EMP_DATA.EMP_NUM")</code>, to allow this type of relationship. Some JPA products may also support this through their own API, annotations or XML.</p>
<h2><span class="mw-headline" id="Multiple_tables_with_foreign_keys">Multiple tables with foreign keys</span></h2>
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Emp_Add_Tables_(Database).PNG" class="image"><img alt="Emp Add Tables (Database).PNG" src="./JPA_Wikibooks_files/Emp_Add_Tables_(Database).PNG" width="384" height="130" data-file-width="384" data-file-height="130"></a></div>
<p>Sometimes you may have a secondary table that is referenced through a foreign key from the primary table to the secondary table instead of a foreign key from the secondary table to the primary table. You may even have a foreign key between two of the secondary tables. Consider having an <code>EMPLOYEE</code> and <code>ADDRESS</code> table where <code>EMPLOYEE</code> refers to <code>ADDRESS</code> through an <code>ADDRESS_ID</code> foreign key, and (for some strange reason) you only want a single Employee class that has the data from both tables. The JPA spec does not cover this directly, so if you have this scenario the first thing to consider, if you have the flexibility, is to change your data model to stay within the confines of the spec. You could also change your object model to define a class for each table, in this case an Employee class and an Address class, which is typically the best solution. You should also check with you JPA implementation to see what extensions it supports in this area.</p>
<p>One way to solve the issue is simply to swap your primary and secondary tables. This will result in having the secondary table referencing the primary tables primary key and is within the spec. This however will have side-effects, one being that you now changed the primary key of your object from <code>EMP_ID</code> to <code>ADDRESS_ID</code>, and may have other mapping and querying implications. If you have more than 2 tables this also may not work.</p>
<p>Another option is to just use the foreign key column in the <code>@PrimaryKeyJoinColumn</code>, this will technically be backward, and perhaps not supported by the spec, but may work for some JPA implementations. However this will result in the table insert order not matching the foreign key constraints, so the constraints will need to be removed, or deferred.</p>
<p>It is also possible to map the scenario through a database view. A view could be defined joining the two tables and the class could be mapped to the view instead of the tables. Views are read-only on some databases, but many also allow writes, or allow triggers to be used to handle writes.</p>
<p>Some JPA implementations provide extensions to handle this scenarios.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Provides a proprietary API for its mapping model <code>ClassDescriptor.addForeignKeyFieldNameForMultipleTable()</code> that allows for arbitrary complex foreign keys relationships to be defined among the secondary tables. This can be configured through using a <code>@DescriptorCustomizer</code> annotation and <code>DescriptorCustomizer</code> class.</dd>
</dl>
<h2><span class="mw-headline" id="Multiple_table_joins">Multiple table joins</span></h2>
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Emp_Adds_Tables_(Database).PNG" class="image"><img alt="Emp Adds Tables (Database).PNG" src="./JPA_Wikibooks_files/Emp_Adds_Tables_(Database).PNG" width="383" height="145" data-file-width="383" data-file-height="145"></a></div>
<p>Occasionally the data model and object model do not get along very well at all. The database could be a legacy model and not fit very well with the new application model, or the DBA or object architect may be a little crazy. In these cases you may require advanced multiple table joins.</p>
<p>Examples of these include having two tables related not by their primary or foreign keys, but through some constant or computation. Consider having an <code>EMPLOYEE</code> table and an <code>ADDRESS</code> table, the <code>ADDRESS</code> table has an <code>EMP_ID</code> foreign key to the <code>EMPLOYEE</code> table, but there are several addresses for each employee and only the address with the <code>TYPE</code> of <code>"HOME"</code> is desired. In this case data from both of the tables is desired to be mapped in the <code>Employee</code> object. A join expression is required where the foreign key matches and the constant matches.</p>
<p>Again this scenario could be handled through redesigning the data or object model, or through using a view. Some JPA implementations provide extensions to handle this scenarios.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Provides a proprietary API for its mapping model <code>DescriptorQueryManager.setMultipleTableJoinExpression()</code> that allows for arbitrary complex multiple table joins to be defined. This can be configured through using a <code>@DescriptorCustomizer</code> annotation and <code>DescriptorCustomizer</code> class.</dd>
</dl>
<h2><span class="mw-headline" id="Multiple_table_outer_joins">Multiple table outer joins</span></h2>
<p>Another perversion of multiple table mapping is to desire to outer join the secondary table. This may be desired if the secondary may or may not have a row defined for the object. Typically the object should be read-only if this is to be attempted, as writing to a row that may or may not be there can be tricky.</p>
<p>This is not directly supported by JPA, and it is best to reconsider the data model or object model design if faced with this scenario. Again it is possible to map this through a database view, where an outer join is used to join the tables in the view.</p>
<p>Some JPA implementation support using outer joins for multiple tables.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a>&nbsp;: This can be accomplished through using the Hibernate <code>@Table</code> annotation and set its <code>optional</code> attribute to <code>true</code>. This will configure Hibernate to use an outer join to read the table, and will not write to the table if all of the attributes mapping to the table are null.</dd>
</dl>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: If the database supports usage of outer join syntax in the where clause (Oracle, Sybase, SQL Server), then the multiple table join expression could be used to configure an outer join to be used to read the table.</dd>
</dl>
<h2><span class="mw-headline" id="Tables_with_special_characters_and_mixed_case">Tables with special characters and mixed case</span></h2>
<p>Some JPA providers may have issues with table and column names with special characters, such as spaces. In general it is best to use standard characters, no spaces, and all uppercase names. International languages should be ok, as long as the database and JDBC driver supports the character set.</p>
<p>It may be required to "quote" table and column names with special characters or in some cases with mixed case. For example if the table name had a space it could be defined as the following:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre>  <span class="nd">@Table</span><span class="o">(</span><span class="s">"\"Employee Data\""</span><span class="o">)</span>
</pre></div>
<p>Some databases support mixed case table and column names, and others are case insensitive. If your database is case insensitive, or you wish your data model to be portable, it is best to use all uppercase names. This is normally not a big deal with JPA where you rarely use the table and column names directly from your application, but can be an issue in certain cases if using native SQL queries.</p>
<h2><span class="mw-headline" id="Table_qualifiers.2C_schemas.2C_or_creators">Table qualifiers, schemas, or creators</span></h2>
<p>A database table may require to be prefixed with a table qualifier, such as the table's creator, or its' namespace, schema, or catalog. Some databases also support linking a table on other database, so the link name can also be a table qualifier.</p>
<p>In JPA a table qualifier can be set on a table through the <code>schema</code> or <code>catalog</code> attribute. Generally it does not matter which attribute is used as both just result in prefixing the table name. Technically you could even include the full name "schema.table" as the table's name and it would work. The benefit of setting the prefix in the schema or catalog is a <i>default</i> table qualifier can be set for the entire persistence unit, also not setting the real table name may impact native SQL queries.</p>
<p>If all of your tables require the same table qualifier, you can set the default in the orm.xml.</p>
<h3><span class="mw-headline" id="Example_mapping_annotations_for_an_entity_with_a_qualified_table">Example mapping annotations for an entity with a qualified table</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMPLOYEE"</span><span class="o">,</span> <span class="n">schema</span><span class="o">=</span><span class="s">"ACME"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_mapping_XML_for_default_.28entire_persistence_unit.29_table_qualifier">Example mapping XML for default (entire persistence unit) table qualifier</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity-mappings&gt;</span>
    <span class="nt">&lt;persistence-unit-metadata&gt;</span>
        <span class="nt">&lt;persistence-unit-defaults&gt;</span>
            <span class="nt">&lt;schema</span> <span class="na">name=</span><span class="s">"ACME"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/persistence-unit-defaults&gt;</span>
    <span class="nt">&lt;/persistence-unit-metadata&gt;</span>
    ....
<span class="nt">&lt;/entity-mappings&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Example_mapping_XML_for_default_.28orm_file.29_table_qualifier">Example mapping XML for default (orm file) table qualifier</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity-mappings&gt;</span>
    <span class="nt">&lt;schema</span> <span class="na">name=</span><span class="s">"ACME"</span><span class="nt">/&gt;</span>
    ...
<span class="nt">&lt;/entity-mappings&gt;</span>
</pre></div>
<h1><span class="mw-headline" id="Identity"><a href="https://commons.wikimedia.org/wiki/File:Crystal_Clear_app_password.png" class="image"><img alt="Crystal Clear app password.png" src="./JPA_Wikibooks_files/25px-Crystal_Clear_app_password.png" width="25" height="25" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/4/43/Crystal_Clear_app_password.png/38px-Crystal_Clear_app_password.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/4/43/Crystal_Clear_app_password.png/50px-Crystal_Clear_app_password.png 2x" data-file-width="128" data-file-height="128"></a>Identity</span></h1>
<p>An object id (OID) is something that uniquely identifies an object. Within a VM this is typically the object's pointer. In a relational database table, a row is uniquely identified in its table by its <a href="https://en.wikipedia.org/wiki/Primary_key" class="extiw" title="w:Primary key" target="_blank">primary key</a>. When persisting objects to a database you need a unique identifier for the objects, this allows you to query the object, define relationships to the object, and update and delete the object. In JPA the object id is defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Id.html" target="_blank">@Id</a></code> annotation or <code>&lt;id&gt;</code> element and should correspond to the primary key of the object's table.</p>
<p><br></p>
<h3><span class="mw-headline" id="Example_id_annotation">Example id annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_id_XML">Example id XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Common_Problems_2">Common Problems</span></h4>
<h5><span class="mw-headline" id="Strange_behavior.2C_unique_constraint_violation."><i>Strange behavior, unique constraint violation.</i></span></h5>
<dl>
<dd>You must never change the id of an object. Doing so will cause errors, or strange behavior depending on your JPA provider. Also do not create two objects with the same id, or try persisting an object with the same id as an existing object. If you have an object that may be existing use the <code>EntityManager</code> <code>merge()</code> API, do not use <code>persist()</code> for an existing object, and avoid relating an un-managed existing object to other managed objects.</dd>
</dl>
<h5><span class="mw-headline" id="No_primary_key."><i>No primary key.</i></span></h5>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#No_Primary_Key">No Primary Key</a>.</dd>
</dl>
<h1><span class="mw-headline" id="Sequencing">Sequencing</span></h1>
<p>An object id can either be a natural id or a generated id. A natural id is one that occurs in the object and has some meaning in the application. Examples of natural ids include email addresses, phone numbers, and social insurance numbers. A generated id (also known as a surrogate id) is one that is generated by the system. A sequence number in JPA is a sequential id generated by the JPA implementation and automatically assigned to new objects. The benefits of using sequence numbers are that they are guaranteed to be unique, allow all other data of the object to change, are efficient values for querying and indexes, and can be efficiently assigned. The main issue with natural ids is that everything always changes at some point; even a person's social insurance number can change. Natural ids can also make querying, foreign keys and indexing less efficient in the database.</p>
<p>In JPA an <code>@Id</code> can be easily assigned a generated sequence number through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/GeneratedValue.html" target="_blank">@GeneratedValue</a></code> annotation, or <code>&lt;generated-value&gt;</code> element.</p>
<h3><span class="mw-headline" id="Example_generated_id_annotation">Example generated id annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_generated_id_XML">Example generated id XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;generated-value/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Sequence_Strategies">Sequence Strategies</span></h2>
<p>There are several strategies for generating unique ids. Some strategies are database agnostic and others make use of built-in databases support.</p>
<p>JPA provides support for several strategies for id generation defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/GenerationType.html" target="_blank">GenerationType</a></code> enum values: TABLE, SEQUENCE and IDENTITY.</p>
<p>The choice of which sequence strategy to use is important as it affects performance, concurrency and portability.</p>
<h3><span class="mw-headline" id="Table_sequencing">Table sequencing</span></h3>
<p>Table sequencing uses a table in the database to generate unique ids. The table has two columns, one stores the name of the sequence, the other stores the last id value that was assigned. There is a row in the sequence table for each sequence object. Each time a new id is required the row for that sequence is incremented and the new id value is passed back to the application to be assigned to an object. This is just one example of a sequence table schema, for other table sequencing schemas see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Customizing">Customizing</a>.</p>
<p>Table sequencing is the most portable solution because it just uses a regular database table, so unlike sequence and identity can be used on any database. Table sequencing also provides good performance because it allows for sequence pre-allocation, which is extremely important to insert performance, but can have potential <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Concurrency_and_Deadlocks">concurrency issues</a>.</p>
<p>In JPA the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/TableGenerator.html" target="_blank">@TableGenerator</a></code> annotation or <code>&lt;table-generator&gt;</code> element is used to define a sequence table. The TableGenerator defines a <code>pkColumnName</code> for the column used to store the name of the sequence, <code>valueColumnName</code> for the column used to store the last id allocated, and <code>pkColumnValue</code> for the value to store in the name column (normally the sequence name).</p>
<h4><span class="mw-headline" id="Example_sequence_table">Example sequence table</span></h4>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#deadff" align="center">
<td colspan="2">SEQUENCE_TABLE</td>
</tr>
<tr style="background:#aabbcc">
<td>&nbsp;&nbsp;<i><b>SEQ_NAME</b></i>&nbsp;&nbsp;</td>
<td>&nbsp;&nbsp;<i><b>SEQ_COUNT</b></i> &nbsp;&nbsp;</td>
</tr>
<tr>
<td>EMP_SEQ</td>
<td>123</td>
</tr>
<tr>
<td>PROJ_SEQ</td>
<td>550</td>
</tr>
</tbody></table>
<h4><span class="mw-headline" id="Example_table_generator_annotation">Example table generator annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@TableGenerator</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"TABLE_GEN"</span><span class="o">,</span> <span class="n">table</span><span class="o">=</span><span class="s">"SEQUENCE_TABLE"</span><span class="o">,</span> <span class="n">pkColumnName</span><span class="o">=</span><span class="s">"SEQ_NAME"</span><span class="o">,</span>
        <span class="n">valueColumnName</span><span class="o">=</span><span class="s">"SEQ_COUNT"</span><span class="o">,</span> <span class="n">pkColumnValue</span><span class="o">=</span><span class="s">"EMP_SEQ"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">GenerationType</span><span class="o">.</span><span class="na">TABLE</span><span class="o">,</span> <span class="n">generator</span><span class="o">=</span><span class="s">"TABLE_GEN"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_table_generator_XML">Example table generator XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;generated-value</span> <span class="na">strategy=</span><span class="s">"TABLE"</span> <span class="na">generator=</span><span class="s">"EMP_SEQ"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;table-generator</span> <span class="na">name=</span><span class="s">"EMP_SEQ"</span> <span class="na">table=</span><span class="s">"SEQUENCE_TABLE"</span> <span class="na">pk-column-name=</span><span class="s">"SEQ_NAME"</span>
                <span class="na">value-column-name=</span><span class="s">"SEQ_COUNT"</span> <span class="na">pk-column-value=</span><span class="s">"EMP_SEQ"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Common_Problems_3">Common Problems</span></h4>
<h5><span class="mw-headline" id="Error_when_allocating_a_sequence_number."><i>Error when allocating a sequence number.</i></span></h5>
<dl>
<dd>Errors such as <i>"table not found"</i>, <i>"invalid column"</i> can occur if you do not have a SEQUENCE table defined in your database, or its schema does not match what you have configured, or what your JPA provider is expecting by default. Ensure you create the sequence table correctly, or configure your <code>@TableGenerator</code> to match the table that you created, or let your JPA provider create you tables for you (most JPA provider support schema creation). You may also get an error such as <i>"sequence not found"</i>, this means you did not create a row in the table for your sequence. You must insert an initial row in the sequence table for your sequence with the initial id (i.e. <code>INSERT INTO SEQUENCE_TABLE (SEQ_NAME, SEQ_COUNT) VALUES ("EMP_SEQ", 0)</code>), or let your JPA provider create your schema for you.</dd>
</dl>
<h5><span class="mw-headline" id="Deadlock_or_poor_concurrency_in_the_sequence_table."><i>Deadlock or poor concurrency in the sequence table.</i></span></h5>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Concurrency_and_Deadlocks">concurrency issues</a>.</dd>
</dl>
<h3><span class="mw-headline" id="Sequence_objects">Sequence objects</span></h3>
<p>Sequence objects use special database objects to generate ids. Sequence objects are only supported in some databases, such as Oracle, DB2, and Postgres. Usually, a SEQUENCE object has a name, an INCREMENT, and other database object settings. Each time the <code>&lt;sequence&gt;.NEXTVAL</code> is selected the sequence is incremented by the INCREMENT.</p>
<p>Sequence objects provide the optimal sequencing option, as they are the most efficient and have the best concurrency, however they are the least portable as most databases do not support them. Sequence objects support sequence preallocation through setting the INCREMENT on the database sequence object to the sequence preallocation size.</p>
<p>In JPA the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/SequenceGenerator.html" target="_blank">@SequenceGenerator</a></code> annotation or <code>&lt;sequence-generator&gt;</code> element is used to define a sequence object. The SequenceGenerator defines a <code>sequenceName</code> for the name of the database sequence object, and an <code>allocationSize</code> for the sequence preallocation size or sequence object INCREMENT.</p>
<h4><span class="mw-headline" id="Example_sequence_generator_annotation">Example sequence generator annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">,</span> <span class="n">generator</span><span class="o">=</span><span class="s">"EMP_SEQ"</span><span class="o">)</span>
    <span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_SEQ"</span><span class="o">,</span> <span class="n">sequenceName</span><span class="o">=</span><span class="s">"EMP_SEQ"</span><span class="o">,</span> <span class="n">allocationSize</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_sequence_generator_XML">Example sequence generator XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;generated-value</span> <span class="na">strategy=</span><span class="s">"SEQUENCE"</span> <span class="na">generator=</span><span class="s">"EMP_SEQ"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;sequence-generator</span> <span class="na">name=</span><span class="s">"EMP_SEQ"</span> <span class="na">sequence-name=</span><span class="s">"EMP_SEQ"</span> <span class="na">allocation-size=</span><span class="s">"100"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Common_Problems_4">Common Problems</span></h4>
<h5><span class="mw-headline" id="Error_when_allocating_a_sequence_number._2"><i>Error when allocating a sequence number.</i></span></h5>
<dl>
<dd>Errors such as <i>"sequence not found"</i>, can occur if you do not have a SEQUENCE object defined in your database. Ensure you create the sequence object, or let your JPA provider create your schema for you (most JPA providers support schema creation). When creating your sequence object, ensure the sequence's <code>INCREMENT</code> matches your <code>SequenceGenerator</code>'s <code>allocationSize</code>. The DDL to create a sequence object depends on the database, for Oracle it is, <code>CREATE SEQUENCE EMP_SEQ INCREMENT BY 100 START WITH 100</code>.</dd>
</dl>
<h5><span class="mw-headline" id="Invalid.2C_duplicate_or_negative_sequence_numbers."><i>Invalid, duplicate or negative sequence numbers.</i></span></h5>
<dl>
<dd>This can occur if your sequence object's <code>INCREMENT</code> does not match your <code>allocationSize</code>. This results in the JPA provider thinking it got back more sequences than it really did, and ends up duplicating values, or with negative numbers. This can also occur on some JPA providers if your sequence object's <code>STARTS WITH</code> is 0 instead of a value equal or greater to the <code>allocationSize</code>.</dd>
</dl>
<h3><span class="mw-headline" id="Identity_sequencing">Identity sequencing</span></h3>
<p>Identity sequencing uses special IDENTITY columns in the database to allow the database to automatically assign an id to the object when its row is inserted. Identity columns are supported in many databases, such as MySQL, DB2, SQL Server, Sybase, and PostgreSQL. Oracle does not support IDENTITY columns but its is possible to simulate them using sequence objects and triggers.</p>
<p>Although identity sequencing seems like the easiest method to assign an id, they have several issues. One is that since the id is not assigned by the database until the row is inserted the id cannot be obtained in the object until after commit or after a flush call. Identity sequencing also does not allow for sequence preallocation, so can require a select for each object that is inserted, potentially causing a major performance problem, so in general are not recommended.</p>
<p>In JPA there is no annotation or element for identity sequencing as there is no additional information to specify. Only the <code>GeneratedValue</code>'s strategy needs to be set to <code>IDENTITY</code>.</p>
<h4><span class="mw-headline" id="Example_identity_annotation">Example identity annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_identity_XML">Example identity XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;generated-value</span> <span class="na">strategy=</span><span class="s">"IDENTITY"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="PostgreSQL_Serial_Columns">PostgreSQL Serial Columns</span></h4>
<p>Sequence objects are database constructs and can be instantiated as distinct objects as needed. They provide incremental values when their "next" method is called. Note that the increments can be values greater than one, for example incremented by two's, three's etc. An 'on insert' trigger can be constructed for each table that calls a sequence object created for that specific table primary key asking for the next value and inserting it into the table with the new record. Identity datatypes in products like MySQL or SQL Server are encapsulated types that do the same thing without requiring the set up of triggers and sequences (although PostgreSQL at least has automated much of this with its Serial and Big Serial <i>pseudo</i> datatypes (these actually create an int/bigint column and run a "macro" creating the sequence and 'on insert' trigger when the CREATE TABLE statement is executed.)).</p>
<h4><span class="mw-headline" id="Common_Problems_5">Common Problems</span></h4>
<h5><span class="mw-headline" id="null_is_inserted_into_the_database.2C_or_error_on_insert."><i>null is inserted into the database, or error on insert.</i></span></h5>
<dl>
<dd>This typically occurs because the @Id was not configured to use an @GeneratedValue(strategy=GenerationType.IDENTITY). Ensure it is configured correctly. It could also be that your JPA provider does not support identity sequencing on the database platform that you are using, or you have not configured your database platform. Most providers require that you set the database platform through a persistence.xml property, most provider also allow you to customize your own platform if it is not directly supported. It may also be that you did not set your primary key column in your table to be an identity type.</dd>
</dl>
<h5><span class="mw-headline" id="Object.27s_id_is_not_assigned_after_persist."><i>Object's id is not assigned after persist.</i></span></h5>
<dl>
<dd>Identity sequencing requires the insert to occur before the id can be assigned, so it is not assigned on persist like other types of sequencing. You must either call <code>commit()</code> on the current transaction, or call <code>flush()</code> on the <code>EntityManager</code>. It may also be that you did not set your primary key column in your table to be an identity type.</dd>
</dl>
<h5><span class="mw-headline" id="Child.27s_id_is_not_assigned_from_parent_on_persist."><i>Child's id is not assigned from parent on persist.</i></span></h5>
<dl>
<dd>A common issue is that the generated <code>Id</code> is part of a child object's <code>Id</code> through a <code>OneToOne</code> or <code>ManyToOne</code> mapping. In this case, because JPA requires that the child define a duplicate <code>Basic</code> mapping for the <code>Id</code>, its <code>Id</code> will be inserted as null. One solution to this is to mark the <code>Column</code> on the <code>Id</code> mapping in the child as <code>insertable=false, updateable=false</code>, and define the <code>OneToOne</code> or <code>ManyToOne</code> using a normal <code>JoinColumn</code> this will ensure the foreign key field is populated by the <code>OneToOne</code> or <code>ManyToOne</code> not the <code>Basic</code>. Another option is to first persist the parent, then call <code>flush()</code> before persisting the child.</dd>
</dl>
<h5><span class="mw-headline" id="Poor_insert_performance."><i>Poor insert performance.</i></span></h5>
<dl>
<dd>Identity sequencing does not support sequence preallocation, so requires a select after each insert, in some cases doubling the insert cost. Consider using a sequence table, or sequence object to allow sequence preallocation.</dd>
</dl>
<h5><span class="mw-headline" id="Lost_latest_free_id."><i>Lost latest free id.</i></span></h5>
<dl>
<dd>MySQL bug <a rel="nofollow" class="external text" href="http://bugs.mysql.com/bug.php?id=199" target="_blank">199</a> causes its autoincrement counter to be lost on restart. So if the last entity is removed and the MySQL server restarted, the same id will be re-used and thus not be unique.</dd>
</dl>
<h1><span class="mw-headline" id="Advanced_2">Advanced</span></h1>
<h2><span class="mw-headline" id="Composite_Primary_Keys">Composite Primary Keys</span></h2>
<p>A composite primary key is one that is made up of several columns in the table. A composite primary key can be used if no single column in the table is unique. It is generally more efficient and simpler to have a one-column primary key, such as a generated sequence number, but sometimes a composite primary key is desirable and unavoidable.</p>
<p><a href="https://commons.wikimedia.org/wiki/File:Cascaded-keys.PNG" class="image"><img alt="Cascaded-keys.PNG" src="./JPA_Wikibooks_files/Cascaded-keys.PNG" width="506" height="295" data-file-width="506" data-file-height="295"></a></p>
<p>Composite primary keys are common in legacy database schemas, where <i>cascaded keys</i> can sometimes be used. This refers to a model where dependent objects' key definitions include their parents' primary key; for example, <code>COMPANY</code>'s primary key is <code>COMPANY_ID</code>, <code>DEPARTMENT</code>'s primary key is composed of a <code>COMPANY_ID</code> and a <code>DEP_ID</code>, <code>EMPLOYEE</code>'s primary key is composed of <code>COMPANY_ID</code>, <code>DEP_ID</code>, and <code>EMP_ID</code>, and so on. Although this generally does not match object-oriented design principles, some DBA's prefer this model. Difficulties with the model include the restriction that employees cannot switch departments, that foreign-key relationships become more complex, and that all primary-key operations (including queries, updates, and deletes) are less efficient. However, each department has control over its own employee IDs, and if needed the database <code>EMPLOYEE</code> table can be partitioned based on the <code>COMPANY_ID</code> or <code>DEP_ID</code>, as these are included in every query.</p>
<p>Other common usages of composite primary keys include many-to-many relationships where the join table has additional columns, so the table itself is mapped to an object whose primary key consists of the pair of foreign-key columns and dependent or aggregate one-to-many relationships where the child object's primary key consists of its parent's primary key and a locally unique field.</p>
<p>There are two methods of declaring a composite primary key in JPA, <code>IdClass</code> and <code>EmbeddedId</code>.</p>
<h3><span class="mw-headline" id="Id_Class">Id Class</span></h3>
<p>An <code>IdClass</code> defines a separate Java class to represent the primary key. It is defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/IdClass.html" target="_blank">@IdClass</a></code> annotation or <code>&lt;id-class&gt;</code> XML element. The <code>IdClass</code> must define an attribute (field/property) that mirrors each <code>Id</code> attribute in the entity. It must have the same attribute name and type. When using an <code>IdClass</code> you still require to mark each <code>Id</code> attribute in the entity with <code>@Id</code>.</p>
<p>The main purpose of the <code>IdClass</code> is to be used as the structure passed to the <code>EntityManager</code> <code>find()</code> and <code>getReference()</code> API. Some JPA products also use the <code>IdClass</code> as a cache key to track an object's identity. Because of this, it is required (depending on JPA product) to implement an <code>equals()</code> and <code>hashCode()</code> method on the <code>IdClass</code>. Ensure that the <code>equals()</code> method checks each part of the primary key, and correctly uses <code>equals</code> for objects and <code>==</code> for primitives. Ensure that the <code>hashCode()</code> method will return the same value for two equal objects.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Do not require the implementation of <code>equals()</code> or <code>hashCode()</code> in the id class.</dd>
</dl>
<h4><span class="mw-headline" id="Example_id_class_annotation">Example id class annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="nd">@IdClass</span><span class="o">(</span><span class="n">EmployeePK</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">employeeId</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">companyId</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">departmentId</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_id_class_XML">Example id class XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id-class</span> <span class="na">class=</span><span class="s">"org.acme.EmployeePK"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"employeeId"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"companyId"</span><span class="nt">/&gt;</span>
       <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"departmentId"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Example_id_class">Example id class</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeePK</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">employeeId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">companyId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">departmentId</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">EmployeePK</span><span class="o">(</span><span class="kt">long</span> <span class="n">employeeId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">companyId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">departmentId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">employeeId</span>   <span class="o">=</span> <span class="n">employeeId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">companyId</span>    <span class="o">=</span> <span class="n">companyId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">departmentId</span> <span class="o">=</span> <span class="n">departmentId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="k">instanceof</span> <span class="n">EmployeePK</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">EmployeePK</span> <span class="n">pk</span> <span class="o">=</span> <span class="o">(</span><span class="n">EmployeePK</span><span class="o">)</span><span class="n">object</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">employeeId</span> <span class="o">==</span> <span class="n">pk</span><span class="o">.</span><span class="na">employeeId</span> <span class="o">&amp;&amp;</span> <span class="n">companyId</span> <span class="o">==</span> <span class="n">pk</span><span class="o">.</span><span class="na">companyId</span> <span class="o">&amp;&amp;</span> <span class="n">departmentId</span> <span class="o">==</span> <span class="n">pk</span><span class="o">.</span><span class="na">departmentId</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">employeeId</span> <span class="o">+</span> <span class="n">companyId</span> <span class="o">+</span> <span class="n">departmentId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Embedded_Id">Embedded Id</span></h3>
<p>An <code>EmbeddedId</code> defines a separate <code>Embeddable</code> Java class to contain the entities primary key. It is defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EmbeddedId.html" target="_blank">@EmbeddedId</a></code> annotation or <code>&lt;embedded-id&gt;</code> XML element. The <code>EmbeddedId</code>'s <code>Embeddable</code> class must define each id attribute for the entity using <code>Basic</code> mappings. All attributes in the <code>EmbeddedId</code>'s <code>Embeddable</code> are assumed to be part of the primary key.</p>
<p>The <code>EmbeddedId</code> is also used as the structure passed to the <code>EntityManager</code> <code>find()</code> and <code>getReference()</code> API. Some JPA products also use the <code>EmbeddedId</code> as a cache key to track an object's identity. Because of this, it is required (depending on JPA product) to implement an <code>equals()</code> and <code>hashCode()</code> method on the <code>EmbeddedId</code>. Ensure that the <code>equals()</code> method checks each part of the primary key, and correctly uses <code>equals</code> for objects and <code>==</code> for primitives. Ensure that the <code>hashCode()</code> method will return the same value for two equal objects.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Do not require the implementation of <code>equals()</code> or <code>hashCode()</code> in the id class.</dd>
</dl>
<h4><span class="mw-headline" id="Example_embedded_id_annotation">Example embedded id annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="nd">@EmbeddedId</span>
    <span class="kd">private</span> <span class="n">EmployeePK</span> <span class="n">id</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_embedded_id_XML">Example embedded id XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;embedded-id</span> <span class="na">class=</span><span class="s">"org.acme.EmployeePK"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
<span class="nt">&lt;embeddable</span> <span class="na">name=</span><span class="s">"EmployeePK"</span> <span class="na">class=</span><span class="s">"org.acme.EmployeePK"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"employeeId"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"companyId"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"departmentId"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;embeddable/&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Example_embedded_id_class">Example embedded id class</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeePK</span> <span class="o">{</span>
    <span class="nd">@Basic</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">employeeId</span>

    <span class="nd">@Basic</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">companyId</span>

    <span class="nd">@Basic</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">departmentId</span>
        
    <span class="kd">public</span> <span class="nf">EmployeePK</span><span class="o">(</span><span class="kt">long</span> <span class="n">employeeId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">companyId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">departmentId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">employeeId</span> <span class="o">=</span> <span class="n">employeeId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">companyId</span> <span class="o">=</span> <span class="n">companyId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">departmentId</span> <span class="o">=</span> <span class="n">departmentId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="k">instanceof</span> <span class="n">EmployeePK</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">EmployeePK</span> <span class="n">pk</span> <span class="o">=</span> <span class="o">(</span><span class="n">EmployeePK</span><span class="o">)</span><span class="n">object</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">employeeId</span> <span class="o">==</span> <span class="n">pk</span><span class="o">.</span><span class="na">employeeId</span> <span class="o">&amp;&amp;</span> <span class="n">companyId</span> <span class="o">==</span> <span class="n">pk</span><span class="o">.</span><span class="na">companyId</span> <span class="o">&amp;&amp;</span> <span class="n">departmentId</span> <span class="o">==</span> <span class="n">pk</span><span class="o">.</span><span class="na">departmentId</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">employeeId</span> <span class="o">+</span> <span class="n">companyId</span> <span class="o">+</span> <span class="n">departmentId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Primary_Keys_through_OneToOne_and_ManyToOne_Relationships">Primary Keys through OneToOne and ManyToOne Relationships</span></h2>
<p>A common model is to have a dependent object share the primary key of its parent. In the case of a <code>OneToOne</code> the child's primary key is the same as the parent, and in the case of a <code>ManyToOne</code> the child's primary key is composed of the parent's primary key and another locally unique field.</p>
<p>JPA 1.0 does not allow <code>@Id</code> on a <code>OneToOne</code> or <code>ManyToOne</code>, but JPA 2.0 does.</p>
<p>One of the biggest pitfalls when working with composite primary keys comes with the implementation of associations to entity classes whose tables have multi-column primary keys (using the @JoinColumns annotation). Many JPA implementations may throw seemingly inconsistent exceptions when not specifying referencedColumnName for <em>every</em> @JoinColumn annotation, which JPA requires (even if all referenced column names are equal to the ones in the referencing table). See <a rel="nofollow" class="external free" href="http://download.oracle.com/javaee/5/api/javax/persistence/JoinColumns.html" target="_blank">http://download.oracle.com/javaee/5/api/javax/persistence/JoinColumns.html</a></p>
<h3><span class="mw-headline" id="JPA_1.0">JPA 1.0</span></h3>
<p>Unfortunately JPA 1.0 does not handle this model well, and things become complicated, so to make your life a little easier you may consider defining a generated unique id for the child. JPA 1.0 requires that all <code>@Id</code> mappings be <code>Basic</code> mappings, so if your <code>Id</code> comes from a foreign key column through a <code>OneToOne</code> or <code>ManyToOne</code> mapping, you must also define a <code>Basic</code> <code>@Id</code> mapping for the foreign key column. The reason for this is in part that the <code>Id</code> must be a simple object for identity and caching purposes, and for use in the <code>IdClass</code> or the <code>EntityManager</code> <code>find()</code> API.</p>
<p>Because you now have two mappings for the same foreign key column you must define which one will be written to the database (it must be the <code>Basic</code> one), so the <code>OneToOne</code> or <code>ManyToOne</code> foreign key must be defined to be read-only. This is done through setting the <code>JoinColumn</code> attributes <code>insertable</code> and <code>updatable</code> to false, or by using the <code>@PrimaryKeyJoinColumn</code> instead of the <code>@JoinColumn</code>.</p>
<p>A side effect of having two mappings for the same column is that you now have to keep the two in synch. This is typically done through having the set method for the <code>OneToOne</code> attribute also set the <code>Basic</code> attribute value to the target object's id. This can become very complicated if the target object's primary key is a <code>GeneratedValue</code>, in this case you must ensure that the target object's id has been assigned <i>before</i> relating the two objects.</p>
<p>Some times I think that JPA primary keys would be much simpler if they were just defined on the entity using a collection of <code>Column</code>s instead of mixing them up with the attribute mapping. This would leave you free to map the primary key field in any manner you desired. A generic <code>List</code> could be used to pass the primary key to <code>find()</code> methods, and it would be the JPA provider's responsibility for hashing and comparing the primary key correctly instead of the user's <code>IdClass</code>. But perhaps for simple singleton primary key models the JPA model is more straight forward.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Allow the primary key to be specified as a list of columns instead of using <code>Id</code> mappings. This allows <code>OneToOne</code> and <code>ManyToOne</code> mapping foreign keys to be used as the primary key without requiring a duplicate mapping. It also allows the primary key to be defined through any other mapping type. This is set through using a <code>DescriptorCustomizer</code> and the <code>ClassDescriptor</code> <code>addPrimaryKeyFieldName</code> API.</dd>
</dl>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/Open_JPA" title="Java Persistence/Open JPA">Open JPA</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a> (as of 1.2): Allows the <code>@Id</code> annotation to be used on a <code>OneToOne</code> or <code>ManyToOne</code> mapping.</dd>
</dl>
<h4><span class="mw-headline" id="Example_OneToOne_id_annotation">Example OneToOne id annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">ownerId</span><span class="o">;</span>
    
    <span class="nd">@OneToOne</span>
    <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
    <span class="o">...</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOwner</span><span class="o">(</span><span class="n">Employee</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ownerId</span> <span class="o">=</span> <span class="n">owner</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_OneToOne_id_XML">Example OneToOne id XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Address"</span> <span class="na">class=</span><span class="s">"org.acme.Address"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"ownerId"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;one-to-one</span> <span class="na">name=</span><span class="s">"owner"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;primary-key-join-column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span> <span class="na">referencedColumnName=</span><span class="s">"EMP_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/one-to-one&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Example_ManyToOne_id_annotation">Example ManyToOne id annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="nd">@IdClass</span><span class="o">(</span><span class="n">PhonePK</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">ownerId</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
    
    <span class="nd">@ManyToOne</span>
    <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
    <span class="o">...</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOwner</span><span class="o">(</span><span class="n">Employee</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ownerId</span> <span class="o">=</span> <span class="n">owner</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_ManyToOne_id_XML">Example ManyToOne id XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Phone"</span> <span class="na">class=</span><span class="s">"org.acme.Phone"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id-class</span> <span class="na">class=</span><span class="s">"org.acme.PhonePK"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"ownerId"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"type"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">name=</span><span class="s">"owner"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;primary-key-join-column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span> <span class="na">referencedColumnName=</span><span class="s">"EMP_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/many-to-one&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="JPA_2.0">JPA 2.0</span></h3>
<p>Defining an <code>Id</code> for a <code>OneToOne</code> or <code>ManyToOne</code> in JPA 2.0 is much simpler. The <code>@Id</code> annotation or <code>id</code> XML attribute can be added to a <code>OneToOne</code> or <code>ManyToOne</code> mapping. The <code>Id</code> used for the object will be derived from the target object's <code>Id</code>. If the <code>Id</code> is a single value, then the source object's <code>Id</code> is the same as the target object's <code>Id</code>. If it is a composite <code>Id</code>, then the <code>IdClass</code> will contain the <code>Basic</code> <code>Id</code> attributes, and the target object's <code>Id</code> as the relationship value. If the target object also has a composite <code>Id</code>, then the source object's <code>IdClass</code> will contain the target object's <code>IdClass</code>.</p>
<h4><span class="mw-headline" id="Example_JPA_2.0_ManyToOne_id_annotation">Example JPA 2.0 ManyToOne id annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="nd">@Entity</span>
<span class="nd">@IdClass</span><span class="o">(</span><span class="n">PhonePK</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
    
    <span class="nd">@ManyToOne</span>
    <span class="nd">@Id</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
    <span class="o">...</span><span class="c1">//getters and setters</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_JPA_2.0_ManyToOne_id_XML">Example JPA 2.0 ManyToOne id XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Address"</span> <span class="na">class=</span><span class="s">"org.acme.Address"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id-class</span> <span class="na">class=</span><span class="s">"org.acme.PhonePK"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"type"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">name=</span><span class="s">"owner"</span> <span class="na">id=</span><span class="s">"true"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span> <span class="na">referencedColumnName=</span><span class="s">"EMP_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/many-to-one&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Example_JPA_2.0_id_class">Example JPA 2.0 id class</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhonePK</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">owner</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">PhonePK</span><span class="o">()</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="nf">PhonePK</span><span class="o">(</span><span class="n">String</span> <span class="n">type</span><span class="o">,</span> <span class="kt">long</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="k">instanceof</span> <span class="n">PhonePK</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">PhonePK</span> <span class="n">pk</span> <span class="o">=</span> <span class="o">(</span><span class="n">PhonePK</span><span class="o">)</span><span class="n">object</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pk</span><span class="o">.</span><span class="na">type</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">owner</span> <span class="o">==</span> <span class="n">pk</span><span class="o">.</span><span class="na">owner</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">type</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">+</span> <span class="n">owner</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="c1">//getter and setters with names matching the properties with many-to-one relationships</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Advanced_Sequencing">Advanced Sequencing</span></h2>
<h4><span class="mw-headline" id="Concurrency_and_Deadlocks">Concurrency and Deadlocks</span></h4>
<p>One issue with table sequencing is that the sequence table can become a concurrency bottleneck, even causing deadlocks. If the sequence ids are allocated in the same transaction as the insert, this can cause poor concurrency, as the sequence row will be locked for the duration of the transaction, preventing any other transaction that needs to allocate a sequence id. In some cases the entire sequence table or the table page could be locked causing even transactions allocating other sequences to wait or even deadlock. If a large sequence pre-allocation size is used this becomes less of an issue, because the sequence table is rarely accessed. Some JPA providers use a separate (non-JTA) connection to allocate the sequence ids in, avoiding or limiting this issue. In this case, if you use a JTA data-source connection, it is important to also include a non-JTA data-source connection in your persistence.xml.</p>
<h4><span class="mw-headline" id="Guaranteeing_Sequential_Ids">Guaranteeing Sequential Ids</span></h4>
<p>Table sequencing also allows for truly sequential ids to be allocated. Sequence and identity sequencing are non-transactional and typically cache values on the database, leading to large gaps in the ids that are allocated. Typically this is not an issue and desired to have good performance, however if performance and concurrency are less of a concern, and true sequential ids are desired then a table sequence can be used. By setting the <code>allocationSize</code> of the sequence to 1 and ensuring the sequence ids are allocated in the same transaction of the insert, you can guarantee sequence ids without gaps (but generally it is much better to live with the gaps and have good performance).</p>
<h3><span class="mw-headline" id="Running_Out_of_Numbers">Running Out of Numbers</span></h3>
<p>One paranoid delusional fear that programmers frequently have is running out of sequence numbers. Since most sequence strategies just keep incrementing a number it is unavoidable that you will eventually run out. However as long a large enough numeric precision is used to store the sequence id this is not an issue. For example if you stored your id in a NUMBER(5) column, this would allow 99,999 different ids, which on most systems would eventually run out. However if you store your id in a NUMBER(10) column, which is more typical, this would store 9,999,999,999 ids, or one id each second for about 300 years (longer than most databases exist). But perhaps your system will process a lot of data, and (hopefully) be around a very long time. If you store your id in a NUMBER(20) this would be 99,999,999,999,999,999,999 ids, or one id each millisecond for about 3,000,000,000 years, which is pretty safe.</p>
<p>But you also need to store this id in Java. If you store the id in a Java int, this would be a 32 bit number , which is 4,294,967,296 different ids (well actually 2,147,483,648 positive ids), or one id each second for about 100 years. If you instead use a long, this would be a 64 bit number, which is 9,223,372,036,854,775,808 different ids, or one id each millisecond for about 300,000,000 years, which is pretty safe. I would recommend using a long vs an int however, as I have seen int ids run out on large databases before (what happens is they become negative until they wrap around to 0 and start getting constraint errors).</p>
<h3><span class="mw-headline" id="Customizing">Customizing</span></h3>
<p>JPA supports three different strategies for generating ids, however there are many other methods. Normally the JPA strategies are sufficient, so you would only use a different method in a legacy situation.</p>
<p>Sometimes the application has an application specific strategy for generating ids, such as prefixing ids with the country code, or branch number. There are several ways to integrate a customize ids generation strategy, the simplest is just define the id as a normal id and have the application assign the id value when the object is created.</p>
<p>Some JPA products provide additional sequencing and id generation options, and configuration hooks.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Several additional sequencing options are provided. A <code>UnaryTableSequence</code> allows a single column table to be used. A <code>QuerySequence</code> allows for custom SQL or stored procedures to be used. An API also exists to allow a user to supply their own code for allocating ids.</dd>
</dl>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a>&nbsp;: A GUID id generation options is provided through the <code>@GenericGenerator</code> annotation.</dd>
</dl>
<h2><span class="mw-headline" id="Primary_Keys_through_Triggers">Primary Keys through Triggers</span></h2>
<p>A database table can be defined to have a trigger that automatically assign its' primary key. Generally this is normally not a good idea (although some DBAs may think it is), and it is better to use a JPA provider generated sequence id, or assign the id in the application. The main issue with the id being assigned in a trigger is that the application and object require this value back. For non-primary key values assigned through triggers it is possible to refresh the object after committing or flushing the object to obtain the values back. However this is not possible for the id, as the id is required to refresh an object.</p>
<p>If you have an alternative way to select the id generated by the trigger, such as selecting the object's row using another unique field, you could issue this <code>SQL</code> select after the insert to obtain the id and set it back in the object. You could perform this select in a JPA <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/PostPersist.html" target="_blank"><code>@PostPersist</code></a> event. Some JPA providers may not allow/like a query execution during an event, they also may not pick up a change to an object during an event callback, so there may be issues with doing this. Also some JPA providers may not allow the primary key to be un-assigned/null when not using a <code>GeneratedValue</code>, so you may have issues. Some JPA providers have built-in support for returning values assigned in a trigger (or stored procedure) back into the object.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Provide a <code>ReturningPolicy</code> that allows for any field values including the primary key to be returned from the database after an insert or update. This is defined through the <code>@ReturnInsert</code>, <code>@ReturnUpdate</code> annotations, or the <code>&lt;return-insert&gt;</code>, <code>&lt;return-update&gt;</code> XML elements in the eclipselink-orm.xml.</dd>
</dl>
<h2><span class="mw-headline" id="Primary_Keys_through_Events">Primary Keys through Events</span></h2>
<p>If the application generates its' own id instead of using a JPA <code>GeneratedValue</code>, it is sometimes desirable to perform this id generation in a JPA event, instead of the application code having to generate and set the id. In JPA this can be done through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/PrePersist.html" target="_blank"><code>@PrePersist</code></a> event.</p>
<h2><span class="mw-headline" id="No_Primary_Key">No Primary Key</span></h2>
<p>Sometimes your object or table has no primary key. The best solution in this case is normally to add a generated id to the object and table. If you do not have this option, sometimes there is a column or set of columns in the table that make up a unique value. You can use this unique set of columns as your id in JPA. The JPA <code>Id</code> does not always have to match the database table primary key constraint, nor is a primary key or a unique constraint required.</p>
<p>If your table truly has no unique columns, then use all of the columns as the id. Typically when this occurs the data is read-only, so even if the table allows duplicate rows with the same values, the objects will be the same anyway, so it does not matter that JPA thinks they are the same object. The issue with allowing updates and deletes is that there is no way to uniquely identify the object's row, so all of the matching rows will be updated or deleted.</p>
<p>If your object does not have an id, but its' table does, this is fine. Make the object an <code>Embeddable</code> object, embeddable objects do not have ids. You will need a <code>Entity</code> that contains this <code>Embeddable</code> to persist and query it.</p>
<div class="thumb tright">
<div class="thumbinner" style="width:282px;"><a href="https://en.wikibooks.org/wiki/File:Inheritance.PNG" class="image"><img alt="" src="./JPA_Wikibooks_files/Inheritance.PNG" width="280" height="251" class="thumbimage" data-file-width="280" data-file-height="251"></a>
<div class="thumbcaption">An example of inheritance. SmallProject and LargeProject inherit the properties of their common parent, Project.</div>
</div>
</div>
<p>Inheritance is a fundamental concept of object-oriented programming and Java. Relational databases have no concept of inheritance, so persisting inheritance in a database can be tricky. Because relational databases have no concept of inheritance, there is no standard way of implementing inheritance in database, so the hardest part of persisting inheritance is choosing how to represent the inheritance in the database.</p>
<p>JPA defines several inheritance mechanisms, mainly defined though the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Inheritance.html" target="_blank">@Inheritance</a></code> annotation or the <code>&lt;inheritance&gt;</code> element. There are three inheritance strategies defined from the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/InheritanceType.html" target="_blank">InheritanceType</a></code> enum, <code>SINGLE_TABLE</code>, <code>TABLE_PER_CLASS</code> and <code>JOINED</code>.</p>
<p><i>Single table</i> inheritance is the default, and <i>table per class</i> is an <i>optional</i> feature of the JPA spec, so not all providers may support it. JPA also defines a mapped superclass concept defined though the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/MappedSuperclass.html" target="_blank">@MappedSuperclass</a></code> annotation or the <code>&lt;mapped-superclass&gt;</code> element. A mapped superclass is not a persistent class, but allow common mappings to be defined for its subclasses.</p>
<h2><span class="mw-headline" id="Single_Table_Inheritance">Single Table Inheritance</span></h2>
<p>Single table inheritance is the simplest and typically the best performing and best solution. In single table inheritance a single table is used to store all of the instances of the entire inheritance hierarchy. The table will have a column for <i>every</i> attribute of <i>every</i> class in the hierarchy. A discriminator column is used to determine which class the particular row belongs to, each class in the hierarchy defines its own unique discriminator value.</p>
<h3><span class="mw-headline" id="Example_single_table_inheritance_table_in_database">Example single table inheritance table in database</span></h3>
<p>PROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>PROJ_TYPE</td>
<td>NAME</td>
<td>BUDGET</td>
</tr>
<tr>
<td>1</td>
<td>L</td>
<td>Accounting</td>
<td>50000</td>
</tr>
<tr>
<td>2</td>
<td>S</td>
<td>Legal</td>
<td>null</td>
</tr>
</tbody></table>
<p><br></p>
<h3><span class="mw-headline" id="Example_single_table_inheritance_annotations">Example single table inheritance annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PROJ_TYPE"</span><span class="o">)</span>
<span class="nd">@ForceDiscriminator</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PROJECT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Project</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"L"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LargeProject</span> <span class="kd">extends</span> <span class="n">Project</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">budget</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"S"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmallProject</span> <span class="kd">extends</span> <span class="n">Project</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_single_table_inheritance_XML">Example single table inheritance XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Project"</span> <span class="na">class=</span><span class="s">"org.acme.Project"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"PROJECT"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;inheritance/&gt;</span>
    <span class="nt">&lt;discriminator-column</span> <span class="na">name=</span><span class="s">"PROJ_TYPE"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        ...
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"LargeProject"</span> <span class="na">class=</span><span class="s">"org.acme.LargeProject"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;discriminator-value&gt;</span>L<span class="nt">&lt;/discriminator-value&gt;</span>
    ...
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"SmallProject"</span> <span class="na">class=</span><span class="s">"org.acme.SmallProject"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;discriminator-value&gt;</span>S<span class="nt">&lt;/discriminator-value&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Common_Problems_6">Common Problems</span></h3>
<h4><span class="mw-headline" id="No_class_discriminator_column"><i>No class discriminator column</i></span></h4>
<dl>
<dd>If you are mapping to an existing database schema, your table may not have a class discriminator column. Some JPA providers do not require a class discriminator when using a <i>joined</i> inheritance strategy, so this may be one solution. Otherwise you need some way to determine the class for a row. Sometimes the inherited value can be computed from several columns, or there is an discriminator but not a one to one mapping from value to class. Some JPA providers provide extended support for this. Another option is to create a database view that manufactures the discriminator column, and then map your hierarchy to this view instead of the table. In general the best solution is just to add a discriminator column to the table (truth be told, ALTER TABLE is your best friend in ORM).</dd>
</dl>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support computing the inheritance discriminator through Java code. This can be done through using a <code>DescriptorCustomizer</code> and the <code>ClassDescriptor</code>'s <code>InheritancePolicy</code>'s <code>setClassExtractor()</code> method.</dd>
</dl>
</dd>
</dl>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a>&nbsp;: This can be accomplished through using the Hibernate <code>@DiscriminatorFormula</code> annotation. This allows database specific SQL or functions to be used to compute the discriminator value.</dd>
</dl>
</dd>
</dl>
<h4><span class="mw-headline" id="Non_nullable_attributes"><i>Non nullable attributes</i></span></h4>
<dl>
<dd>Subclasses cannot define attributes as not allowing null, as the other subclasses must insert null into those columns. A workaround to this issue is instead of defining a not null constraint on the column, define a table constraint that check the discriminator value and the not nullable value. In general the best solution is to just live without the constraint (odds are you have enough constraints in your life to deal with as it is).</dd>
</dl>
<h2><span class="mw-headline" id="Joined.2C_Multiple_Table_Inheritance">Joined, Multiple Table Inheritance</span></h2>
<p>Joined inheritance is the most logical inheritance solution because it mirrors the object model in the data model. In joined inheritance a table is defined for <i>each</i> class in the inheritance hierarchy to store <i>only</i> the local attributes of that class. Each table in the hierarchy must also store the object's id (primary key), which is <i>only</i> defined in the root class. All classes in the hierarchy must share the same id attribute. A discriminator column is used to determine which class the particular row belongs to, each class in the hierarchy defines its own unique discriminator value.</p>
<p>Some JPA providers support joined inheritance with or without a discriminator column, some required the discriminator column, and some do not support the discriminator column. So joined inheritance does not seem to be fully standardized yet.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a>: A discriminator column on joined inheritance is supported but not required.<a rel="nofollow" class="external autonumber" href="https://hibernate.atlassian.net/browse/HHH-6911" target="_blank">[1]</a></dd>
</dl>
<h3><span class="mw-headline" id="Example_joined_inheritance_tables_in_database">Example joined inheritance tables in database</span></h3>
<p>PROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>PROJ_TYPE</td>
<td>NAME</td>
</tr>
<tr>
<td>1</td>
<td>L</td>
<td>Accounting</td>
</tr>
<tr>
<td>2</td>
<td>S</td>
<td>Legal</td>
</tr>
</tbody></table>
<p>SMALLPROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
</tr>
<tr>
<td>2</td>
</tr>
</tbody></table>
<p>LARGEPROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>BUDGET</td>
</tr>
<tr>
<td>1</td>
<td>50000</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_joined_inheritance_annotations">Example joined inheritance annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">InheritanceType</span><span class="o">.</span><span class="na">JOINED</span><span class="o">)</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PROJ_TYPE"</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PROJECT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Project</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"L"</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"LARGEPROJECT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LargeProject</span> <span class="kd">extends</span> <span class="n">Project</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">budget</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"S"</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"SMALLPROJECT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmallProject</span> <span class="kd">extends</span> <span class="n">Project</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_joined_inheritance_XML">Example joined inheritance XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Project"</span> <span class="na">class=</span><span class="s">"org.acme.Project"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"PROJECT"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;inheritance</span> <span class="na">strategy=</span><span class="s">"JOINED"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;discriminator-column</span> <span class="na">name=</span><span class="s">"PROJ_TYPE"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        ...
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"LargeProject"</span> <span class="na">class=</span><span class="s">"org.acme.LargeProject"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"LARGEPROJECT"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;discriminator-value&gt;</span>L<span class="nt">&lt;/discriminator-value&gt;</span>
    ...
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"SmallProject"</span> <span class="na">class=</span><span class="s">"org.acme.SmallProject"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"SMALLPROJECT"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;discriminator-value&gt;</span>S<span class="nt">&lt;/discriminator-value&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Common_Problems_7">Common Problems</span></h3>
<h4><span class="mw-headline" id="Poor_query_performance"><i>Poor query performance</i></span></h4>
<dl>
<dd>The main disadvantage to the joined model is that to query any class join queries are required. Querying the root or branch classes is even more difficult as either multiple queries are required, or outer joins or unions are required. One solution is to use single table inheritance instead, this is good if the classes have a lot in common, but if it is a big hierarchy and the subclasses have little in common this may not be desirable. Another solution is to remove the inheritance and instead use a <code>MappedSuperclass</code>, but this means that you can no longer query or have relationships to the class.</dd>
</dl>
<dl>
<dd>The poorest performing queries will be those to the root or branch classes. Avoiding queries and relationships to the root and branch classes will help to alleviate this burden. If you must query the root or branch classes there are two methods that JPA providers use, one is to outer join all of the subclass tables, the second is to first query the root table, then query only the required subclass table directly. The first method has the advantage of only requiring one query, the second has the advantage of avoiding outer joins which typically have poor performance in databases. You may wish to experiment with each to determine which mechanism is more efficient in your application and see if your JPA provider supports that mechanism. Typically the multiple query mechanism is more efficient, but this generally depends on the speed of your database connection.</dd>
</dl>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support both querying mechanisms. The multiple query mechanism is used by default. Outer joins can be used instead through using a <code>DescriptorCustomizer</code> and the <code>ClassDescriptor</code>'s <code>InheritancePolicy</code>'s <code>setShouldOuterJoinSubclasses()</code> method.</dd>
</dl>
</dd>
</dl>
<h4><span class="mw-headline" id="Do_not_have.2Fwant_a_table_for_every_subclass"><i>Do not have/want a table for every subclass</i></span></h4>
<dl>
<dd>Most inheritance hierarchies do not fit with either the <i>joined</i> or the <i>single table</i> inheritance strategy. Typically the desired strategy is somewhere in between, having joined tables in some subclasses and not in others. Unfortunately JPA does not directly support this. One workaround is to map your inheritance hierarchy as single table, but them add the additional tables in the subclasses, either through defining a <code>Table</code> or <code>SecondaryTable</code> in each subclass as required. Depending on your JPA provider, this may work (don't forget to sacrifice the chicken). If it does not work, then you may need to use a JPA provider specific solution if one exists for your provider, otherwise live within the constraints of having either a single table or one per subclass. You could also change your inheritance hierarchy so it matches your data model, so if the subclass does not have a table, then collapse its class into its superclass.</dd>
</dl>
<h4><span class="mw-headline" id="No_class_discriminator_column_2"><i>No class discriminator column</i></span></h4>
<dl>
<dd>If you are mapping to an existing database schema, your table may not have a class discriminator column. Some JPA providers do not require a class discriminator when using a <i>joined</i> inheritance strategy, so this may be one solution. Otherwise you need some way to determine the class for a row. Sometimes the inherited value can be computed from several columns, or there is an discriminator but not a one to one mapping from value to class. Some JPA providers provide extended support for this. Another option is to create a database view that manufactures the discriminator column, and then map your hierarchy to this view instead of the table.</dd>
</dl>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support computing the inheritance discriminator through Java code. This can be done through using a <code>DescriptorCustomizer</code> and the <code>ClassDescriptor</code>'s <code>InheritancePolicy</code>'s <code>setClassExtractor()</code> method.</dd>
</dl>
</dd>
</dl>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a>&nbsp;: This can be accomplished through using the Hibernate <code>@DiscriminatorFormula</code> annotation. This allows database specific SQL or functions to be used to compute the discriminator value.</dd>
</dl>
</dd>
</dl>
<h1><span class="mw-headline" id="Advanced_3">Advanced</span></h1>
<h2><span class="mw-headline" id="Table_Per_Class_Inheritance">Table Per Class Inheritance</span></h2>
<p>Table per class inheritance allows inheritance to be used in the object model, when it does not exist in the data model. In table per class inheritance a table is defined for <i>each</i> concrete class in the inheritance hierarchy to store <i>all</i> the attributes of that class and <i>all</i> of its superclasses. Be cautious using this strategy as it is optional in the JPA spec, and querying root or branch classes can be very difficult and inefficient.</p>
<h3><span class="mw-headline" id="Example_table_per_class_inheritance_tables_in_database">Example table per class inheritance tables in database</span></h3>
<p>SMALLPROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>NAME</td>
</tr>
<tr>
<td>2</td>
<td>Legal</td>
</tr>
</tbody></table>
<p>LARGEPROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>NAME</td>
<td>BUDGET</td>
</tr>
<tr>
<td>1</td>
<td>Accounting</td>
<td>50000</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_table_per_class_inheritance_annotations">Example table per class inheritance annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">InheritanceType</span><span class="o">.</span><span class="na">TABLE_PER_CLASS</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Project</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"LARGEPROJECT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LargeProject</span> <span class="kd">extends</span> <span class="n">Project</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">budget</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"SMALLPROJECT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmallProject</span> <span class="kd">extends</span> <span class="n">Project</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_table_per_class_inheritance_XML">Example table per class inheritance XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Project"</span> <span class="na">class=</span><span class="s">"org.acme.Project"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;inheritance</span> <span class="na">strategy=</span><span class="s">"TABLE_PER_CLASS"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        ...
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"LargeProject"</span> <span class="na">class=</span><span class="s">"org.acme.LargeProject"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"LARGEPROJECT"</span><span class="nt">/&gt;</span>
    ...
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"SmallProject"</span> <span class="na">class=</span><span class="s">"org.acme.SmallProject"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"SMALLPROJECT"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Common_Problems_8">Common Problems</span></h3>
<h4><span class="mw-headline" id="Poor_query_performance_2"><i>Poor query performance</i></span></h4>
<dl>
<dd>The main disadvantage to the table per class model is queries or relationships to the root or branch classes become expensive. Querying the root or branch classes require multiple queries, or unions. One solution is to use single table inheritance instead, this is good if the classes have a lot in common, but if it is a big hierarchy and the subclasses have little in common this may not be desirable. Another solution is to remove the table per class inheritance and instead use a <code>MappedSuperclass</code>, but this means that you can no longer query or have relationships to the class.</dd>
</dl>
<h4><span class="mw-headline" id="Issues_with_ordering_and_joins"><i>Issues with ordering and joins</i></span></h4>
<dl>
<dd>Because table per class inheritance requires multiple queries, or unions, you cannot join to, fetch join, or traverse them in queries. Also when ordering is used the results will be ordered by class, then by the ordering. These limitations depend on your JPA provider, some JPA provider may have other limitations, or not support table per class at all as it is optional in the JPA spec.</dd>
</dl>
<h2><span class="mw-headline" id="Mapped_Superclasses">Mapped Superclasses</span></h2>
<p>Mapped superclass inheritance allows inheritance to be used in the object model, when it does not exist in the data model. It is similar to table per class inheritance, but does not allow querying, persisting, or relationships to the superclass. Its main purpose is to allow mappings information to be inherited by its subclasses. The subclasses are responsible for defining the table, id and other information, and can modify any of the inherited mappings. A common usage of a mapped superclass is to define a common <code>PersistentObject</code> for your application to define common behavior and mappings such as the id and version. A mapped superclass normally should be an abstract class. A mapped superclass is <i>not</i> an <code>Entity</code> but is instead defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/MappedSuperclass.html" target="_blank">@MappedSuperclass</a></code> annotation or the <code>&lt;mapped-superclass&gt;</code> element.</p>
<h3><span class="mw-headline" id="Example_mapped_superclass_tables_in_database">Example mapped superclass tables in database</span></h3>
<p>SMALLPROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>NAME</td>
</tr>
<tr>
<td>2</td>
<td>Legal</td>
</tr>
</tbody></table>
<p>LARGEPROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>PROJECT_NAME</td>
<td>BUDGET</td>
</tr>
<tr>
<td>1</td>
<td>Accounting</td>
<td>50000</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_mapped_superclass_annotations">Example mapped superclass annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@MappedSuperclass</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Project</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"NAME"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"LARGEPROJECT"</span><span class="o">)</span>
<span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"name"</span><span class="o">,</span> <span class="n">column</span><span class="o">=</span><span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PROJECT_NAME"</span><span class="o">))</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LargeProject</span> <span class="kd">extends</span> <span class="n">Project</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">budget</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">"SMALLPROJECT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmallProject</span> <span class="kd">extends</span> <span class="n">Project</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_mapped_superclass_XML">Example mapped superclass XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;mapped-superclass</span> <span class="na">class=</span><span class="s">"org.acme.Project"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"name"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"NAME"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
        ...
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/mapped-superclass&gt;</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"LargeProject"</span> <span class="na">class=</span><span class="s">"org.acme.LargeProject"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"LARGEPROJECT"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;attribute-override&gt;</span>
        <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"NAME"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attribute-override&gt;</span>
    ...
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"SmallProject"</span> <span class="na">class=</span><span class="s">"org.acme.SmallProject"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">name=</span><span class="s">"SMALLPROJECT"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Common_Problems_9">Common Problems</span></h3>
<h4><span class="mw-headline" id="Cannot_query.2C_persist.2C_or_have_relationships"><i>Cannot query, persist, or have relationships</i></span></h4>
<dl>
<dd>The main disadvantage of mapped superclasses is that they cannot be queried or persisted. You also cannot have a relationship to a mapped superclass. If you require any of these then you must use another inheritance model, such as table per class, which is virtually identical to a mapped superclass except it (may) not have these limitations. Another alternative is to change your model such that your classes do not have relationships to the superclass, such as changing the relationship to a subclass, or removing the relationship and instead querying for its value by querying each possible subclass and collecting the results in Java.</dd>
</dl>
<h4><span class="mw-headline" id="Subclass_does_not_want_to_inherit_mappings"><i>Subclass does not want to inherit mappings</i></span></h4>
<dl>
<dd>Sometimes you have a subclass that needs to be mapped differently than its parent, or is similar to its' parent but does not have one of the fields, or uses it very differently. Unfortunately it is very difficult not to inherit everything from your parent in JPA, you can override a mapping, but you cannot remove one, or change the type of mapping, or the target class. If you define your mappings as properties (get methods), or through XML, you may be able to attempt to override or mark the inherited mapping as <code>Transient</code>, this may work depending on your JPA provider (don't forget to sacrifice a chicken).</dd>
</dl>
<dl>
<dd>Another solution is to actually fix your inheritance in your object model. If you inherit <code>foo</code> from <code>Bar</code> but don't want to inherit it, then remove it from <code>Bar</code>, if the other subclasses need it, either add it to each, or create a <code>FooBar</code> subclass of <code>Bar</code> that has the <code>foo</code> and have the other subclasses extend this.</dd>
</dl>
<dl>
<dd>Some JPA providers may provide ways to be less stringent on inheritance.</dd>
</dl>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Allow a subclass remove a mapping, redefine a mapping, or be entirely independent of its superclass. This can be done through using a <code>DescriptorCustomizer</code> and removing the <code>ClassDescriptor</code>'s mapping, or adding a mapping with the same attribute name, or removing the <code>InheritancePolicy</code>.</dd>
</dl>
</dd>
</dl>
<h1><span class="mw-headline" id="Embeddables">Embeddables</span></h1>
<p><a href="https://en.wikibooks.org/wiki/File:Embeddable.PNG" class="image"><img alt="Embeddable.PNG" src="./JPA_Wikibooks_files/Embeddable.PNG" width="600" height="400" data-file-width="600" data-file-height="400"></a></p>
<p>In an application object model some objects are considered independent, and others are considered dependent parts of other objects. In UML a relationship to a dependent object is considerd an aggregate or composite association. In a relational database this kind of relationship could be modeled in two ways, the dependent object could have its own table, or its data could be <i>embedded</i> in the independent objects table.</p>
<p>In JPA a relationship where the target object's data is embedded in the source object's table is considered an embedded relationship, and the target object is considered an Embeddable object. Embeddable objects have different requirements and restrictions than Entity objects and are defined by the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Embeddable.html" target="_blank">@Embeddable</a></code> annotation or <code>&lt;embeddable&gt;</code> element.</p>
<p>An embeddable object cannot be directly persisted, or <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Querying">queried</a>, it can only be persisted or queried in the context of its parent. An embeddable object does not have an id or table. The JPA spec does not support embeddable objects having <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Inheritance">inheritance</a>, although some JPA providers may allow this. <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Relationships">Relationships</a> from embeddable objects are supported in JPA 2.0.</p>
<p>Relationships to embeddable objects are defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Embedded.html" target="_blank">@Embedded</a></code> annotation or <code>&lt;embedded&gt;</code> element. The JPA 2.0 spec also supports <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Collections">collection</a> relationships to embeddable objects.</p>
<h3><span class="mw-headline" id="Example_of_an_Embeddable_object_annotations">Example of an Embeddable object annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Embeddable</span> 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmploymentPeriod</span> <span class="o">{</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"START_DATE"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Date</span> <span class="n">startDate</span><span class="o">;</span>

  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"END_DATE"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Date</span> <span class="n">endDate</span><span class="o">;</span>
  <span class="o">....</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_an_Embeddable_object_XML">Example of an Embeddable object XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;embeddable</span> <span class="na">class=</span><span class="s">"org.acme.EmploymentPeriod"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"startDate"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"START_DATE"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"endDate"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"END_DATE"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/embeddable&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_an_embedded_relationship_annotations">Example of an embedded relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@Embedded</span>
  <span class="kd">private</span> <span class="n">EmploymentPeriod</span> <span class="n">period</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_an_embedded_relationship_XML">Example of an embedded relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;embedded</span> <span class="na">name=</span><span class="s">"period"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h1><span class="mw-headline" id="Advanced_4">Advanced</span></h1>
<h2><span class="mw-headline" id="Sharing">Sharing</span></h2>
<p>An embeddable object can be shared between multiple classes. Consider a <code>Name</code> object, that both an <code>Employee</code> and a <code>User</code> contain. Both <code>Employee</code> and a <code>User</code> have their own tables, with different column names that they desire to store their name in. Embeddables support this through allowing each embedded mapping to override the columns used in the embeddable. This is done through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/AttributeOverride.html" target="_blank">@AttributeOverride</a> annotation or <code>&lt;attribute-override&gt;</code> element.</p>
<p>Note that an embeddable cannot be shared between multiple instances. If you desire to share an embeddable object instance, then you must make it an independent object with its own table.</p>
<h3><span class="mw-headline" id="Example_shared_embeddable_annotations">Example shared embeddable annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@Embedded</span>
  <span class="nd">@AttributeOverrides</span><span class="o">({</span>
    <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"startDate"</span><span class="o">,</span> <span class="n">column</span><span class="o">=</span><span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"START_DATE"</span><span class="o">)),</span>
    <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"endDate"</span><span class="o">,</span> <span class="n">column</span><span class="o">=</span><span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"END_DATE"</span><span class="o">))</span>
  <span class="o">})</span>
  <span class="kd">private</span> <span class="n">Period</span> <span class="n">employmentPeriod</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@Embedded</span>
  <span class="nd">@AttributeOverrides</span><span class="o">({</span>
    <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"startDate"</span><span class="o">,</span> <span class="n">column</span><span class="o">=</span><span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"SDATE"</span><span class="o">)),</span>
    <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"endDate"</span><span class="o">,</span> <span class="n">column</span><span class="o">=</span><span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EDATE"</span><span class="o">))</span>
  <span class="o">})</span>
  <span class="kd">private</span> <span class="n">Period</span> <span class="n">period</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_shared_embeddable_XML">Example shared embeddable XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;embedded</span> <span class="na">name=</span><span class="s">"employmentPeriod"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;attribute-override</span> <span class="na">name=</span><span class="s">"startDate"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"START_DATE"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/attribute-override&gt;</span>
            <span class="nt">&lt;attribute-override</span> <span class="na">name=</span><span class="s">"endDate"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"END_DATE"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/attribute-override&gt;</span>
        <span class="nt">&lt;/embedded&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"User"</span> <span class="na">class=</span><span class="s">"org.acme.User"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;embedded</span> <span class="na">name=</span><span class="s">"period"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;attribute-override</span> <span class="na">name=</span><span class="s">"startDate"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"SDATE"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/attribute-override&gt;</span>
            <span class="nt">&lt;attribute-override</span> <span class="na">name=</span><span class="s">"endDate"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"EDATE"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/attribute-override&gt;</span>
        <span class="nt">&lt;/embedded&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Embedded_Ids">Embedded Ids</span></h2>
<p>An <code>EmbeddedId</code> is an embeddable object that contains the <code>Id</code> for an entity.</p>
<p>See: <a href="https://en.wikibooks.org/wiki/Java_Persistence/Identity_and_Sequencing#Embedded_Id" title="Java Persistence/Identity and Sequencing">Embedded Id</a></p>
<h2><span class="mw-headline" id="Nulls">Nulls</span></h2>
<p>An embeddable object's data is contained in several columns in its parent's table. Since there is no single field value, there is no way to know if a parent's reference to the embeddable is <code>null</code>. One could assume that if every field value of the embeddable is <code>null</code>, then the reference should be <code>null</code>, but then there is no way to represent an embeddable with all <code>null</code> values. JPA does not allow embeddables to be <code>null</code>, but some JPA providers may support this.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support an embedded reference being <code>null</code>. This is set through using a <code>DescriptorCustomizer</code> and the <code>AggregateObjectMapping</code> <code>setIsNullAllowed</code> API.</dd>
</dl>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a>&nbsp;: When loading an entity, embedded references are set to <code>null</code> if all of the columns in the embeddable are null.</dd>
</dl>
<h2><span class="mw-headline" id="Nesting">Nesting</span></h2>
<p>A nested embeddable is a relationship to an embeddable object from another embeddable. The JPA 1.0 spec only allows <code>Basic</code> relationships in an embeddable object, so nested embeddables are not supported, however some JPA products may support them. Technically there is nothing preventing the <code>@Emdedded</code> annotation being used in an embeddable object, so this may just work depending on your JPA provider (cross your fingers).</p>
<p>JPA 2.0 supports nested embeddable objects.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support embedded mappings from embeddables. The existing <code>@Embedded</code> annotation or <code>&lt;embedded&gt;</code> element can be used.</dd>
</dl>
<p>A workaround to having a nested embeddable, and for embeddables in general is to use property access, and add get/set methods for all of the attributes of the nested embeddable object.</p>
<h4><span class="mw-headline" id="Example_of_using_properties_to_define_a_nested_embeddable">Example of using properties to define a nested embeddable</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmploymentDetails</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">EmploymentPeriod</span> <span class="n">period</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">yearsOfService</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">fullTime</span><span class="o">;</span>
  <span class="o">....</span>
  <span class="kd">public</span> <span class="nf">EmploymentDetails</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">period</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmploymentPeriod</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="nd">@Transient</span>
  <span class="kd">public</span> <span class="n">EmploymentPeriod</span> <span class="nf">getEmploymentPeriod</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">period</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Basic</span>
  <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getStartDate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">getEmploymentPeriod</span><span class="o">().</span><span class="na">getStartDate</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStartDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">startDate</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getEmploymentPeriod</span><span class="o">().</span><span class="na">setStartDate</span><span class="o">(</span><span class="n">startDate</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Basic</span>
  <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getEndDate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">getEmploymentPeriod</span><span class="o">().</span><span class="na">getEndDate</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEndDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">endDate</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getEmploymentPeriod</span><span class="o">().</span><span class="na">setEndDate</span><span class="o">(</span><span class="n">endDate</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="o">....</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Inheritance">Inheritance</span></h2>
<p>Embeddable inheritance is when one embeddable class subclasses another embeddable class. The JPA spec does not allow inheritance in embeddable objects, however some JPA products may support this. Technically there is nothing preventing the <code>@DiscriminatorColumn</code> annotation being used in an embeddable object, so this may just work depending on your JPA provider (cross your fingers). Inheritance in embeddables is always <i>single table</i> as an embeddable must live within its' parent's table. Generally attempting to mix inheritance between embeddables and entities is not a good idea, but may work in some cases.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support inheritance with embeddables. This is set through using a <code>DescriptorCustomizer</code> and the <code>InheritancePolicy</code>.</dd>
</dl>
<h2><span class="mw-headline" id="Relationships">Relationships</span></h2>
<p>A relationship is when an embeddable has a <code>OneToOne</code> or other such mapping to an entity. The JPA 1.0 spec only allows <code>Basic</code> mappings in an embeddable object, so relationships from embeddables are not supported, however some JPA products may support them. Technically there is nothing preventing the <code>@OneToOne</code> annotation or other relationships from being used in an embeddable object, so this may just work depending on your JPA provider (cross your fingers).</p>
<p>JPA 2.0 supports all relationship types from an embeddable object.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support relationship mappings from embeddables. The existing relationship annotations or XML elements can be used.</dd>
</dl>
<p>Relationships to embeddable objects from entities other than the embeddable's parent are typically not a good idea, as an embeddable is a private dependent part of its parent. Generally relationships should be to the embeddable's parent, not the embeddable. Otherwise, it would normally be a good idea to make the embeddable an independent entity with its own table. If an embeddable has a bi-directional relationship, such as a <code>OneToMany</code> that requires an inverse <code>ManyToOne</code> the inverse relationship should be to the embeddable's parent.</p>
<p>A workaround to having a relationship from an embeddable is to define the relationship in the embeddable's parent, and define property get/set methods for the relationship that set the relationship into the embeddable.</p>
<h4><span class="mw-headline" id="Example_of_setting_a_relationship_in_an_embeddable_from_its_parent">Example of setting a relationship in an embeddable from its parent</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="o">....</span>
  <span class="kd">private</span> <span class="n">EmploymentDetails</span> <span class="n">details</span><span class="o">;</span>
  <span class="o">....</span>
  <span class="nd">@Embedded</span>
  <span class="kd">public</span> <span class="n">EmploymentDetails</span> <span class="nf">getEmploymentDetails</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">details</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@OneToOne</span>
  <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getEmploymentAddress</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">getEmploymentDetails</span><span class="o">().</span><span class="na">getAddress</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmploymentAddress</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getEmploymentDetails</span><span class="o">().</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>One special relationship that is sometimes desired in an embeddable is a relationship to its parent. JPA does not support this, but some JPA providers may.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a>&nbsp;: Supports a <code>@Parent</code> annotation in embeddables to define a relationship to its parent.</dd>
</dl>
<p>A workaround to having a parent relationship from an embeddable is to set the parent in the property set method.</p>
<h4><span class="mw-headline" id="Example_of_setting_a_relationship_in_an_embeddable_to_its_parent">Example of setting a relationship in an embeddable to its parent</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="o">....</span>
  <span class="kd">private</span> <span class="n">EmploymentDetails</span> <span class="n">details</span><span class="o">;</span>
  <span class="o">....</span>
  <span class="nd">@Embedded</span>
  <span class="kd">public</span> <span class="n">EmploymentDetails</span> <span class="nf">getEmploymentDetails</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">details</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmploymentDetails</span><span class="o">(</span><span class="n">EmploymentDetails</span> <span class="n">details</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">details</span> <span class="o">=</span> <span class="n">details</span><span class="o">;</span>
    <span class="n">details</span><span class="o">.</span><span class="na">setParent</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Collections">Collections</span></h2>
<p>A collection of embeddable objects is similar to a <code>OneToMany</code> except the target objects are embeddables and have no <code>Id</code>. This allows for a <code>OneToMany</code> to be defined without a inverse <code>ManyToOne</code>, as the parent is responsible for storing the foreign key in the target object's table. JPA 1.0 did not support collections of embeddable objects, but some JPA providers support this.</p>
<p>JPA 2.0 does support collections of embeddable objects through the <code>ElementCollection</code> mapping. See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/ElementCollection" title="Java Persistence/ElementCollection">ElementCollection</a>.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a> (as of 1.2)&nbsp;: Supports the JPA 2.0 <code>ElementCollection</code> mapping.</dd>
</dl>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support collections of embeddables. This is set through using a <code>DescriptorCustomizer</code> and the <code>AggregateCollectionMapping</code>.</dd>
</dl>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a>&nbsp;: Supports collections of embeddables through the <code>@CollectionOfElements</code> annotation and JPA 2.0 <code>ElementCollection</code> mapping.</dd>
</dl>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/DataNucleus" title="Java Persistence/DataNucleus">DataNucleus</a>&nbsp;: Supports the JPA 2.0 <code>ElementCollection</code> mapping.</dd>
</dl>
<p>Typically the primary key of the target table will be composed of the parent's primary key, and some unique field in the embeddable object. The embeddable should have a unique field within its parent's collection, but does not need to be unique for the entire class. It could still have a unique id and still use sequencing, or if it has no unique fields, its id could be composed of all of its fields. The embeddable collection object will be different than a typical embeddable object as it will not be stored in the parent's table, but in its own table. Embeddables are strictly privately owned objects, deletion of the parent will cause deletion of the embeddables, and removal from the embeddable collection should cause the embeddable to be deleted. Embeddables cannot be queried directly, and are not independent objects as they have no <code>Id</code>.</p>
<h2><span class="mw-headline" id="Querying">Querying</span></h2>
<p>Embeddable objects cannot be queried directly, but they can be queried in the context of their parent. Typically it is best to select the parent, and access the embeddable from the parent. This will ensure the embeddable is registered with the persistence context. If the embeddable is selected in a query, the resulting objects will be detached, and changes will not be tracked.</p>
<h4><span class="mw-headline" id="Example_of_querying_an_embeddable">Example of querying an embeddable</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">employee</span><span class="p">.</span><span class="n">period</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">employee</span> <span class="k">where</span> <span class="n">employee</span><span class="p">.</span><span class="n">period</span><span class="p">.</span><span class="n">endDate</span> <span class="o">=</span> <span class="p">:</span><span class="n">param</span>
</pre></div>
<h1><span class="mw-headline" id="Locking">Locking</span></h1>
<p>Locking is perhaps the most ignored persistence consideration. Most applications tend to ignore thinking about concurrency issues during development, and then smush in a locking mechanism before going into production. Considering the large percentage of software projects that fail or are canceled, or never achieve a large user base, perhaps this is logical. However, locking and concurrency is a critical or at least a very important issue for most applications, so probably should be something considered earlier in the development cycle.</p>
<p>If the application will have concurrent writers to the same objects, then a locking strategy is critical so that data corruption can be prevented. There are two strategies for preventing concurrent modification of the same object/row; <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Optimistic_Locking">optimistic</a> and <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Pessimistic_Locking">pessimistic</a> locking. Technically there is a third strategy, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#No_Locking_a.k.a_Ostrich_Locking"><i>ostrich</i></a> locking, or no locking, which means put your head in the sand and ignore the issue.</p>
<p>There are various ways to implement both optimistic and pessimistic locking. JPA has support for version optimistic locking, but some JPA providers support other methods of optimistic locking, as well as pessimistic locking.</p>
<p>Locking and concurrency can be a confusing thing to consider, and there are a lot of misconcepts out there. Correctly implementing locking in your application typically involves more than setting some JPA or database configuration option (although that is all many applications that <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Common_Locking_Mistakes.2C_Questions_and_Problems"><i>think</i></a> they are using locking do). Locking may also involve application level changes, and ensuring other applications accessing the database also do so correctly for the locking policy being used.</p>
<h2><span class="mw-headline" id="Optimistic_Locking">Optimistic Locking</span></h2>
<p>Optimistic locking assumes that the data will not be modified between when you read the data until you write the data. This is the most common style of locking used and recommended in today's persistence solutions. The strategy involves checking that one or more values from the original object read, are still the same when updating it. This verifies that the object has not changed by another user in between the read and the write.</p>
<p>JPA supports using an optimistic locking version field that gets updated on each update. The field can either be numeric or a timestamp value. A numeric value is recommended as a numeric value is more precise, portable, performant and easier to deal with than a timestamp.</p>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Version.html" target="_blank"><code>@Version</code></a> annotation or <code>&lt;version&gt;</code> element is used to define the optimistic lock version field. The annotation is defined on the version field or property for the object, similar to an <code>Id</code> mapping. The object must contain an attribute to store the version field.</p>
<p>The object's version attribute is automatically updated by the JPA provider, and should not normally be modified by the application. The one exception is if the application reads the object in one transaction, sends the object to a client, and updates/merges the object in another transaction. In this case the application must ensure that the original object version is used, otherwise any changes in between the read and write will not be detected. The <code>EntityManager</code> <code>merge()</code> API will always merge the version, so the application is only responsible for this if manually merging.</p>
<p>When a locking contention is detected an <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/OptimisticLockException.html" target="_blank"><code>OptimisticLockException</code></a> will be thrown. This could be wrapped inside a RollbackException, or other exceptions if using JTA, but it should be set as the <code>cause</code> of the exception. The application can handle the exception, but should normally report the error to the user, and let them determine what to do.</p>
<h4><span class="mw-headline" id="Example_of_Version_annotation">Example of Version annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Employee</span><span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="nd">@Version</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_Version_XML">Example of Version XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;version</span> <span class="na">name=</span><span class="s">"version"</span><span class="nt">/&gt;</span>
        ...
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;entity/&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Common_Locking_Mistakes.2C_Questions_and_Problems">Common Locking Mistakes, Questions and Problems</span></h3>
<h4><span class="mw-headline" id="Not_sending_version_to_client.2C_only_locking_on_the_server"><i>Not sending version to client, only locking on the server</i></span></h4>
<dl>
<dd>Probably the most common mistake in locking in general is locking the wrong section of code. This is true no matter what form of locking is used, whether it be optimistic or pessimistic. The basic scenario is:
<ol>
<li>User requests some data, the server reads the data from the database and sends it to the user in their client (doesn't matter if the client is html, rmi, web service).</li>
<li>The user edits the data in the client.</li>
<li>The user submits the data back to the server.</li>
<li>The server begins a transaction, reads the object, merges the data and commits the transaction.</li>
</ol>
</dd>
<dd>The issues is that the original data was read in step 1, but the lock was not obtained until step 4, so any changes made to the object in between steps 1 and 4 would not result in a conflict. This means there is little point to using any locking.</dd>
</dl>
<dl>
<dd>A key point is that when using database pessimistic locking or database transaction isolation, this will always be the case, the database locks will only occur in step 4, and any conflicts will not be detected. This is the main reason why using database locking does not scale to web applications, for the locking to be valid, the database transaction must be started at step 1 and not committed until step 4. This means that a live database connection and transaction must be held open while waiting for the web client, as well as locks, since there is no guarantee that the web client will not sit on the data for hours, go to lunch, or disappear of the face of the earth, holding database resources and locking data for all other users can be very undesirable.</dd>
</dl>
<dl>
<dd>For optimistic locking the solution is relatively simple, the object's version must be sent to the client along with the data (or kept in the http session). When the user submits the data back, the original version must be merged into the object read from the database, to ensure that any changes made between step 1 and 4 will be detected.</dd>
</dl>
<h4><span class="mw-headline" id="Handling_optimistic_lock_exceptions"><i>Handling optimistic lock exceptions</i></span></h4>
<dl>
<dd>Unfortunately programmers can frequently be too clever for their own good. The first issue that comes up when using optimistic locking is what to do when an <code>OptimisticLockException</code> occurs. The typical response of the friendly neighborhood super programmer, is to automatically handle the exception. They will just create a new transaction, refresh the object to reset its version, and merge the data back into the object and re-commit it. Presto problem solved, or is it?</dd>
</dl>
<dl>
<dd>This actually defeats the whole point of locking in the first place. If this is what you desire, you may as well use no locking. Unfortunately, the <code>OptimisticLockException</code> should rarely be automatically handled, and you really need to bother the user about the issue. You should report the conflict to the user, and either say "your sorry but an edit conflict occurred and they are going to have to redo their work", or in the best case, refresh the object and present the user with the current data and the data that they submitted and help them merge the two if appropriate.</dd>
</dl>
<dl>
<dd>Some automated merge tools will compare the two conflicting versions of the data and if none of the individual fields conflict, then the data will just be automatically merged without the user's aid. This is what most software version control systems do. Unfortunately the user is typically better able to decide when something is a conflict than the program, just because two versions of the .java file did not change the same line of code does not mean there was no conflict, the first user could have deleted a method that the other user added a method to reference, and several other possible issues that cause the typically nightly build to break every so often.</dd>
</dl>
<h4><span class="mw-headline" id="Paranoid_Delusionment"><i>Paranoid Delusionment</i></span></h4>
<dl>
<dd>Locking can prevent most concurrency issues, but be careful of going overboard in over analyzing to death every possible hypothetical occurrence. Sometimes in an concurrent application (or any software application) bad stuff can happen. Users are pretty used to this by now, and I don't think anyone out there thinks computers are perfect.</dd>
</dl>
<dl>
<dd>A good example is a source code control system. Allowing users to overwrite each other changes is a bad thing; so most systems avoid this through versioning the source files. If a user submits changes to a file that originated from a older version than the current version, the source code control system will raise a conflict and make the user merge the two files. This is essentially optimistic locking. But what if one user removes, or renames a method in one file, then another user adds a new method or call in another file to that old method. No source code control system that I know of will detect this issue, it is a conflict and will cause the build to break. The solution to this is to start locking or checking the lock on every file in the system (or at least every possible related file). Similar to using optimistic read locking on every possible related object, or pessimistically locking every possible related object. This could be done, but would probably be very expensive, and more importantly would now raise possible conflicts every time a user checked in, so would be entirely useless.</dd>
</dl>
<dl>
<dd>So, in general be careful of being too paranoid, such that you sacrifice the usability of your system.</dd>
</dl>
<h4><span class="mw-headline" id="Other_applications_accessing_same_data"><i>Other applications accessing same data</i></span></h4>
<dl>
<dd>Any form of locking that is going to work requires that all applications accessing the same data follow the same rules. If you use optimistic locking in one application, but no locking in another accessing the same data, they will still conflict. One fake solution is to configure an update trigger to always increment the version value (unless incremented in the update). This will allow the new application to avoid overwriting the old application's changes, but the old application will still be able to overwrite the new application's changes. This still may be better than no locking at all, and perhaps the old application will eventually go away.</dd>
</dl>
<dl>
<dd>One common misconception is that if you use pessimistic locking, instead of adding a version field, you will be ok. Again pessimistic locking requires that all applications accessing the same data use the same form of locking. The old application can still read data (without locking), then update the data after the new application reads, locks, and updates the same data, overwriting its changes.</dd>
</dl>
<h4><span class="mw-headline" id="Isn.27t_database_transaction_isolation_all_I_need.3F"><i>Isn't database transaction isolation all I need?</i></span></h4>
<dl>
<dd>Possibly, but most likely not. Most databases default to <i>read committed</i> transaction isolation. This means that you will never see uncommitted data, but this does not prevent concurrent transactions from overwriting the same data.</dd>
</dl>
<dl>
<dd>
<ol>
<li>Transaction A reads row x.</li>
<li>Transaction B reads row x.</li>
<li>Transaction A writes row x.</li>
<li>Transaction B writes row x (and overwrites A's changes).</li>
<li>Both commit successfully.</li>
</ol>
</dd>
</dl>
<dl>
<dd>This is the case with <i>read committed</i>, but with <i>serializable</i> this conflict would not occur. With serializable either Transaction B would lock on the select for B and wait (perhaps a long time) until Transaction A commits. In some databases Transaction A may not wait, but would fail on commit. However, even with serializable isolation the typical web application would still have a conflict. This is because each server request operates in a different database transaction. The web client reads the data in one transaction, then updates it in another transaction. So optimistic locking is really the only viable locking option for the typical web application. Even if the read and write occurs in the same transaction, serializable is normally not the solution because of concurrency implications and deadlock potential.</dd>
</dl>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Serializable_Transaction_Isolation">Serializable Transaction Isolation</a></dd>
</dl>
<h4><span class="mw-headline" id="What_happens_if_I_merge_an_object_that_was_deleted_by_another_user.3F"><i>What happens if I merge an object that was deleted by another user?</i></span></h4>
<dl>
<dd>What <i>should</i> happen is the merge should trigger an <code>OptimisticLockException</code> because the object has a version that is not null and greater than 0, and the object does not exist. But this is probably JPA provider specific, some may re-insert the object (this would occur without locking), or throw a different exception.</dd>
</dl>
<dl>
<dd>If you called <code>persist</code> instead of merge, then the object would be re-inserted.</dd>
</dl>
<h4><span class="mw-headline" id="What_if_my_table_doesn.27t_have_a_version_column.3F"><i>What if my table doesn't have a version column?</i></span></h4>
<dl>
<dd>The best solution is probably just to add one. Field locking is another solution, as well as pessimistic locking in some cases.</dd>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Field_Locking">Field Locking</a></dd>
</dl>
<h4><span class="mw-headline" id="What_about_relationships.3F"><i>What about relationships?</i></span></h4>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Cascaded_Locking">Cascaded Locking</a></dd>
</dl>
<h4><span class="mw-headline" id="Can_I_use_a_timestamp.3F"><i>Can I use a timestamp?</i></span></h4>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Timestamp_Locking">Timestamp Locking</a></dd>
</dl>
<h4><span class="mw-headline" id="Do_I_need_a_version_in_each_table_for_inheritance_or_multiple_tables.3F"><i>Do I need a version in each table for inheritance or multiple tables?</i></span></h4>
<dl>
<dd>The short answer is no, only in the root table.</dd>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Multiple_Versions">Multiple Versions</a></dd>
</dl>
<h2><span class="mw-headline" id="Advanced_5">Advanced</span></h2>
<h3><span class="mw-headline" id="Timestamp_Locking">Timestamp Locking</span></h3>
<p>Timestamp version locking is supported by JPA and is configured the same as numeric version locking, except the attribute type will be a <code>java.sql.Timestamp</code> or other date/time type. Be cautious in using timestamp locking as timestamps have different levels of precision in different databases, and some database do not store a timestamp's milliseconds, or do not store them precisely. In general timestamp locking is less efficient than numeric version locking, so numeric version locking is recommended.</p>
<p>Timestamp locking is frequently used if the table already has a <i>last updated</i> timestamp column, and is also a convenient way to auto update a <i>last updated</i> column. The timestamp version value can be more useful than a numeric version, as it includes the relevant information on when the object was last updated.</p>
<p>The timestamp value in timestamp version locking can either come from the database, or from Java (mid-tier). JPA does not allow this to be configured, however some JPA providers may provide this option. Using the database's current timestamp can be very expensive, as it requires a database call to the server.</p>
<h3><span class="mw-headline" id="Multiple_Versions">Multiple Versions</span></h3>
<p>An object can only have one version in JPA. Even if the object maps to multiple tables, only the primary table will have the version. If any fields in any of the tables changes, the version will be updated. If you desire multiple versions, you may need to map multiple version attributes in your object and manually maintain the duplicate versions, perhaps through events. Technically there is nothing preventing you from annotating multiple attributes with <code>@Version</code>, and potentially some JPA providers may support this.</p>
<h3><span class="mw-headline" id="Cascaded_Locking">Cascaded Locking</span></h3>
<p>Locking objects is different than locking rows in the database. An object can be more complex than a simple row; an object can span multiple tables, have inheritance, have relationships, and have dependent objects. So determining when an object has <i>changed</i> and needs to update its version can be more difficult than determining when a row has changed.</p>
<p>JPA does define that when any of the object's tables changes the version is updated. However it is less clear on relationships. If <code>Basic</code>, <code>Embedded</code>, or a foreign key relationship (<code>OneToOne</code>, <code>ManyToOne</code>) changes, the version will be updated. But what about <code>OneToMany</code>, <code>ManyToMany</code>, and a target foreign key <code>OneToOne</code>? For changes to these relationships the update to the version may depend on the JPA provider.</p>
<p>What about changes made to dependent objects? JPA does not have a cascade option for locking, and has no direct concept of dependent objects, so this is not an option. Some JPA providers may support this. One way to simulate this is to use <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Read_and_Write_Locking">write locking</a>. JPA defines the EntityManager <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#lock(java.lang.Object,%20javax.persistence.LockModeType)" target="_blank">lock()</a> API. You can define a version only in your root parent objects, and when a child (or relationship) is changed, you can call the lock API with the parent to cause a <code>WRITE</code> lock. This will cause the parent version to be updated. You may also be able to automate this through persistence events.</p>
<p>Usage of cascaded locking depends on your application. If in your application you consider one user updating one dependent part of an object, and another user updating another part of the object to be a locking contention, then this is what you want. If your application does not consider this to be a problem, then you do not want cascaded locking. One of the advantages of cascaded locking is you have fewer version fields to maintain, and only the update to the root object needs to check the version. This can make a difference in optimizations such as batch writing, as the dependent objects may not be able to be batched if they have their own version that must be checked.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support cascaded locking through their <code>@OptimisticLocking</code> and <code>@PrivateOwned</code> annotations and XML.</dd>
</dl>
<h3><span class="mw-headline" id="Field_Locking">Field Locking</span></h3>
<p>If you do not have a version field in your table, optimistic field locking is another solution. Field locking involves comparing certain fields in the object when updating. If those fields have changed, then the update will fail. JPA does not support field locking, but some JPA providers do support it.</p>
<p>Field locking can also be used when a finer level of locking is desired. For example if one user changes the object's name and another changes the objects address, you may desire for these updates to not conflict, and only desire optimistic lock errors when users change the same fields. You may also only be concerned about conflicts in changes to certain fields, and not desire lock errors from conflicts in the other fields.</p>
<p>Field locking can also be used on legacy schemas, where you cannot add a version column, or to integrate with other applications accessing the same data which are not using optimistic locking (note if the other applications are not also using field locking, you can only detect conflicts in one direction).</p>
<p>There are several types of field locking:</p>
<ul>
<li>All fields compared in the update - This can lead to a very big where clause, but will detect any conflicts.</li>
<li>Selected fields compared in the update - This is useful if conflicts in only certain fields are desired.</li>
<li>Changed fields compared in the update - This is useful if only changes to the same fields are considered to be conflicts.</li>
</ul>
<p>If your JPA provider does not support field locking, it is difficult to simulate, as it requires changes to the update SQL. Your JPA provider may allow overriding the update SQL, in which case, <code>All</code> or <code>Selected</code> field locking may be possible (if you have access to the original values), but <code>Changed</code> field locking is more difficult because the update must be dynamic. Another way to simulate field locking is to <code>flush</code> you changes, then refresh the object using a separate <code>EntityManager</code> and connection and compare the current values with your original object.</p>
<p>When using field locking it is important to keep the original object that was read. If you read the object in one transaction and send it to a client, then update in another, you are not really locking. Any changes made between the read and write will not be detected. You must keep the original object read managed in an <code>EntityManager</code> for your locking to have any effect.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support field locking through their <code>@OptimisticLocking</code> annotation and XML.</dd>
</dl>
<h3><span class="mw-headline" id="Read_and_Write_Locking">Read and Write Locking</span></h3>
<p>It is sometimes desirable to lock something that you did not change. Normally this is done when making a change to one object, that is based on the state of another object, and you wish to ensure that the other object represents the current state of the database at the point of the commit. This is what serializable transaction isolation gives you, but optimistic read and write locking allow this requirement to be met declaratively and optimistically (and without deadlock, concurrency, and open transaction issues).</p>
<p>JPA supports read and write locks through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#lock(java.lang.Object,%20javax.persistence.LockModeType)" target="_blank"><code>EntityManager.lock()</code></a> API. The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/LockModeType.html" target="_blank"><code>LockModeType</code></a> argument can either be <code>READ</code> or <code>WRITE</code>. A <code>READ</code> lock will ensure that the state of the object does not change on commit. A <code>WRITE</code> lock will ensure that this transaction conflicts with any other transaction changing or locking the object. Essentially the <code>READ</code> lock check the optimistic version field, and the <code>WRITE</code> checks and increments it.</p>
<h4><span class="mw-headline" id="Example_of_Using_the_Lock_API">Example of Using the Lock API</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="n">employee</span><span class="o">.</span><span class="na">setSalary</span><span class="o">(</span><span class="n">employee</span><span class="o">.</span><span class="na">getManager</span><span class="o">().</span><span class="na">getSalary</span><span class="o">()</span> <span class="o">/</span> <span class="mi">2</span><span class="o">);</span>
<span class="n">entityManager</span><span class="o">.</span><span class="na">lock</span><span class="o">(</span><span class="n">employee</span><span class="o">.</span><span class="na">getManager</span><span class="o">(),</span> <span class="n">LockModeType</span><span class="o">.</span><span class="na">READ</span><span class="o">);</span>
</pre></div>
<p>Write locking can also be used to provide object-level locks. If you desire for a change to a dependent object to conflict with any change to the parent object, or any other of its dependent objects, this can be done through write locking. This can also be used to lock relationships, when you change a OneToMany or ManyToMany relationship you can also force the parent's version to be incremented.</p>
<h4><span class="mw-headline" id="Example_of_Using_the_Lock_API_for_Cascaded_Locks">Example of Using the Lock API for Cascaded Locks</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="n">employee</span><span class="o">.</span><span class="na">getAddress</span><span class="o">().</span><span class="na">setCity</span><span class="o">(</span><span class="s">"Ottawa"</span><span class="o">);</span>
<span class="n">entityManager</span><span class="o">.</span><span class="na">lock</span><span class="o">(</span><span class="n">employee</span><span class="o">,</span> <span class="n">LockModeType</span><span class="o">.</span><span class="na">WRITE</span><span class="o">);</span>
</pre></div>
<h3><span class="mw-headline" id="No_Locking_a.k.a_Ostrich_Locking">No Locking a.k.a <i>Ostrich Locking</i></span></h3>
<p>Conceptually people may scoff and be alarmed at the thought of no locking, but it is probably the most common form of locking in use. Some call it Ostrich locking as the strategy is to stick your head in the sand and ignore the issue. Most prototypes or small applications frequently do not have the requirement or in most cases the need for locking, and handling what to do when a locking contention does occur is beyond the scope of the application, so best to just ignore the issue.</p>
<p>In general it is probably best in JPA to enable optimistic locking always, as it is fairly simple to do, as least in concept, but what does occur on a conflict without any form of locking? Essentially it is last in wins, so if two users edit the same object, at the same time, the last one to commit will have their changes reflected in the database. This is true, at least for users editing the same fields, but if two users edit different fields in the same object, it depends on the JPA implementation. Some JPA providers only update exactly the fields that were changed, where as other update all fields in the object. So in one case the first user's changes would be overridden, but in the second they would not.</p>
<h3><span class="mw-headline" id="Pessimistic_Locking">Pessimistic Locking</span></h3>
<p>Pessimistic locking means acquiring a lock on the object before you begin to edit the object, to ensure that no other users are editing the object. Pessimistic locking is typically implemented through using database row locks, such as through the <code>SELECT ... FOR UPDATE</code> SQL syntax. The data is read and locked, the changes are made and the transaction is committed, releasing the locks.</p>
<p>JPA 1.0 did not support pessimistic locking, but some JPA 1.0 providers do. <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#JPA_2.0_Locking">JPA 2.0</a> supports pessimistic locking. It is also possible to use JPA native SQL queries to issue <code>SELECT ... FOR UPDATE</code> and use pessimistic locking. When using pessimistic locking you must ensure that the object is refreshed when it is locked, locking a potentially stale object is of no use. The SQL syntax for pessimistic locking is database specific, and different databases have different syntax and levels of support, so ensure your database properly supports your locking requirements.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a> (as of 1.2)&nbsp;: Supports JPA 2.0 pessimistic locking.</dd>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support pessimistic locking through the <code>"eclipselink.pessimistic-lock"</code> query hint.</dd>
</dl>
<p>The main issues with pessimistic locking is they use database resources, so require a database transaction and connection to be held open for the duration of the edit. This is typically not desirable for interactive web applications. Pessimistic locking can also have concurrency issues and cause deadlocks. The main advantages of pessimistic locking is that once the lock is obtained, it is fairly certain that the edit will be successful. This can be desirable in highly concurrent applications, where optimistic locking may cause too many optimistic locking errors.</p>
<p>There are other ways to implement pessimistic locking, it could be implemented at the application level, or through <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Serializable_Transaction_Isolation">serializable transaction</a> isolation.</p>
<p>Application level pessimistic locking can be implemented through adding a <i>locked</i> field to your object. Before an edit you must update the field to locked (and commit the change). Then you can edit the object, and set the locked field back to false. To avoid conflicts in acquiring the lock, you should also use optimistic locking, to ensure the lock field is not updated to true by another user at the same time.</p>
<h3><span class="mw-headline" id="JPA_2.0_Locking">JPA 2.0 Locking</span></h3>
<p>JPA 2.0 adds support for pessimistic locking, as well as other locking options. A lock can be acquired using the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/EntityManager.html#lock(java.lang.Object,%20javax.persistence.LockModeType)" target="_blank"><code>EntityManager.lock()</code></a> API, or passing a <code>LockModeType</code> to an <code>EntityManager</code> <code>find()</code> or <code>refresh()</code> operation, or setting the <code>lockMode</code> of a <code>Query</code> or <code>NamedQuery</code>.</p>
<p>The JPA 2.0 lock modes are defined in the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/LockModeType.html" target="_blank">LockModeType</a> enum:</p>
<ul>
<li>OPTIMISTIC (was READ in JPA 1.0) - The Entity will have its optimistic lock version checked on commit, to ensure no other transaction updated the object.</li>
<li>OPTIMISTIC_FORCE_INCREMENT (was WRITE in JPA 1.0) - The Entity will have its optimistic lock version incremented on commit, to ensure no other transaction updated (or READ locked) the object.</li>
<li>PESSIMISTIC_READ - The Entity is locked on the database, prevents any other transaction from acquiring a PESSIMISTIC_WRITE lock.</li>
<li>PESSIMISTIC_WRITE - The Entity is locked on the database, prevents any other transaction from acquiring a PESSIMISTIC_READ or PESSIMISTIC_WRITE lock.</li>
<li>PESSIMISTIC_FORCE_INCREMENT - The Entity is locked on the database, prevents any other transaction from acquiring a PESSIMISTIC_READ or PESSIMISTIC_WRITE lock, and the Entity will have its optimistic lock version incremented on commit. This is unusual as it does both an optimistic and pessimistic lock, normally an application would only use one locking model.</li>
<li>NONE - No lock is acquired, this is the default to any find, refresh or query operation.</li>
</ul>
<p>JPA 2.0 also adds two new standard query hints. These can be passed to any <code>Query</code>, <code>NamedQuery</code>, or <code>find()</code>, <code>lock()</code> or <code>refresh()</code> operation.</p>
<ul>
<li>"javax.persistence.lock.timeout" - Number of milliseconds to wait on the lock before giving up and throwing a <code>PessimisticLockException</code>.</li>
<li>"javax.persistence.lock.scope" - The valid scopes are defined in <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/PessimisticLockScope.html" target="_blank">PessimisticLockScope</a>, either NORMAL or EXTENDED. EXTENDED will also lock the object's owned join tables and element collection tables.</li>
</ul>
<h3><span class="mw-headline" id="Serializable_Transaction_Isolation">Serializable Transaction Isolation</span></h3>
<p>Serializable transaction isolation guarantees that anything read in the transaction will not be updated by any other user. Through using serializable transaction isolation and ensuring the data being edited is read in the same transaction, you can achieve pessimistic locking. It is important to ensure the objects are refreshed from the database in the transaction, as editing cached or potentially stale data defeats the point of locking.</p>
<p>Serializable transaction isolation can typically be enabled on the database, some databases even have this as the default. It can also be set on the JDBC <code>Connection</code>, or through native SQL, but this is database specific and different databases have different levels of support. The main issues with serializable transaction isolation are the same as using <code>SELECT ... FOR UPDATE</code> (see above for the gory details), in addition everything read is locked, so you cannot decide to only lock certain objects at certain times, but lock everything all the time. This can be a major concurrency issue for transactions with common read-only data, and can lead to deadlocks.</p>
<p>How database implement serializable transaction isolation differs between databases. Some databases (such as Oracle) can perform serializable transaction isolation in more of an optimistic sense, than the typically pessimistic implementation. Instead of each transaction requiring locks on all the data as it is read, the row versions are not checked until the transaction is committed, if any of the data changed an exception is thrown and the transaction is not allowed to commit.</p>
<h1><span class="mw-headline" id="Basics">Basics</span></h1>
<p>A basic attribute is one where the attribute class is a simple type such as <code>String</code>, <code>Number</code>, <code>Date</code> or a primitive. A basic attribute's value can map directly to the column value in the database. The following table summarizes the basic types and the database types they map to.</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>Java type</td>
<td>Database type</td>
</tr>
<tr>
<td>String (char, char[])</td>
<td>VARCHAR (CHAR, VARCHAR2, CLOB, TEXT)</td>
</tr>
<tr>
<td>Number (BigDecimal, BigInteger, Integer, Double, Long, Float, Short, Byte)</td>
<td>NUMERIC (NUMBER, INT, LONG, FLOAT, DOUBLE)</td>
</tr>
<tr>
<td>int, long, float, double, short, byte</td>
<td>NUMERIC (NUMBER, INT, LONG, FLOAT, DOUBLE)</td>
</tr>
<tr>
<td>byte[]</td>
<td>VARBINARY (BINARY, BLOB)</td>
</tr>
<tr>
<td>boolean (Boolean)</td>
<td>BOOLEAN (BIT, SMALLINT, INT, NUMBER)</td>
</tr>
<tr>
<td>java.util.Date</td>
<td>TIMESTAMP (DATE, DATETIME)</td>
</tr>
<tr>
<td>java.sql.Date</td>
<td>DATE (TIMESTAMP, DATETIME)</td>
</tr>
<tr>
<td>java.sql.Time</td>
<td>TIME (TIMESTAMP, DATETIME)</td>
</tr>
<tr>
<td>java.sql.Timestamp</td>
<td>TIMESTAMP (DATETIME, DATE)</td>
</tr>
<tr>
<td>java.util.Calendar</td>
<td>TIMESTAMP (DATETIME, DATE)</td>
</tr>
<tr>
<td>java.lang.Enum</td>
<td>NUMERIC (VARCHAR, CHAR)</td>
</tr>
<tr>
<td>java.util.Serializable</td>
<td>VARBINARY (BINARY, BLOB)</td>
</tr>
</tbody></table>
<p><br>
In JPA a basic attribute is mapped through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Basic.html" target="_blank"><code>@Basic</code></a> annotation or the <code>&lt;basic&gt;</code> element. The types and conversions supported depend on the JPA implementation and database platform. Some JPA implementations may support conversion between many different data-types or additional types, or have extended type conversion support, see the <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Advanced">advanced</a> section for more details. Any basic attribute using a type that does not map directly to a database type can be serialized to a binary database type.</p>
<p>The easiest way to map a basic attribute in JPA is to do nothing. Any attributes that have no other annotations and do not reference other entities will be automatically mapped as basic, and even serialized if not a basic type. The column name for the attribute will be defaulted, named the same as the attribute name, as uppercase. Sometimes auto-mapping can be unexpected if you have an attribute in your class that you did not intend to have persisted. You must mark any such non-persistent fields using the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Transient.html" target="_blank"><code>@Transient</code></a> annotation or <code>&lt;transient&gt;</code> element.</p>
<p>Although auto-mapping makes rapid prototyping easy, you typically reach a point where you want control over your database schema. To specify the column name for a basic attribute the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Column.html" target="_blank"><code>@Column</code></a> annotation or <code>&lt;column&gt;</code> element is used. The column annotation also allows for other information to be specified such as the database type, size, and some constraints.</p>
<h3><span class="mw-headline" id="Example_of_basic_mapping_annotations">Example of basic mapping annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="c1">// Id mappings are also basic mappings.</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>       
  <span class="nd">@Basic</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"F_NAME"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="o">;</span>
  <span class="c1">// The @Basic is not required in general because it is the default.</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"L_NAME"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">;</span>
  <span class="c1">// Any un-mapped field will be automatically mapped as basic and column name defaulted.</span>
  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">salary</span><span class="o">;</span>       
  <span class="c1">// Non-persistent fields must be marked as transient.</span>
  <span class="nd">@Transient</span>
  <span class="kd">private</span> <span class="n">EmployeeService</span> <span class="n">service</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_basic_mapping_XML">Example of basic mapping XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"firstName"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"F_NAME"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"lastName"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"L_NAME"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
        <span class="nt">&lt;transient</span> <span class="na">name=</span><span class="s">"service"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Common_Problems_10">Common Problems</span></h2>
<h3><span class="mw-headline" id="Translating_Values"><i>Translating Values</i></span></h3>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Conversion">Conversion</a></dd>
</dl>
<h3><span class="mw-headline" id="Truncated_Data"><i>Truncated Data</i></span></h3>
<dl>
<dd>A common issue is that data, such as Strings, written from the object are truncated when read back from the database. This is normally caused by the column length not being large enough to handle the object's data. In Java there is no maximum size for a String, but in a database <code>VARCHAR</code> field, there is a maximum size. You must ensure that the length you set in your column when you create the table is large enough to handle any object value. For very large Strings <code>CLOB</code>s can be used, but in general <code>CLOB</code>s should not be over used, as they are less efficient than a <code>VARCHAR</code>.</dd>
</dl>
<dl>
<dd>If you use JPA to generate your database schema, you can set the column length through the <code>Column</code> annotation or element, see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Column_Definition_and_Schema_Generation">Column Definition and Schema Generation</a>.</dd>
</dl>
<h3><span class="mw-headline" id="How_to_map_timestamp_with_timezones.3F"><i>How to map timestamp with timezones?</i></span></h3>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Timezones">Timezones</a></dd>
</dl>
<h3><span class="mw-headline" id="How_to_map_XML_data-types.3F"><i>How to map XML data-types?</i></span></h3>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Custom_Types">Custom Types</a></dd>
</dl>
<h3><span class="mw-headline" id="How_to_map_Struct_and_Array_types.3F"><i>How to map Struct and Array types?</i></span></h3>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Custom_Types">Custom Types</a></dd>
</dl>
<h3><span class="mw-headline" id="How_to_map_custom_database_types.3F"><i>How to map custom database types?</i></span></h3>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Custom_Types">Custom Types</a></dd>
</dl>
<h3><span class="mw-headline" id="How_to_exclude_fields_from_INSERT_or_UPDATE_statements.2C_or_default_values_in_triggers.3F"><i>How to exclude fields from INSERT or UPDATE statements, or default values in triggers?</i></span></h3>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Insertable.2C_Updatable_.2F_Read_Only_Fields_.2F_Returning">Insertable, Updatable</a></dd>
</dl>
<h1><span class="mw-headline" id="Advanced_6">Advanced</span></h1>
<h2><span class="mw-headline" id="Temporal.2C_Dates.2C_Times.2C_Timestamps_and_Calendars">Temporal, Dates, Times, Timestamps and Calendars</span></h2>
<p>Dates, times, and timestamps are common types both in the database and in Java, so in theory mappings these types should be simple, right? Well sometimes this is the case and just a normal <code>Basic</code> mapping can be used, however sometimes it becomes more complex.</p>
<p>Some databases do not have <code>DATE</code> and <code>TIME</code> types, only <code>TIMESTAMP</code> fields, however some do have separate types, and some just have <code>DATE</code> and <code>TIMESTAMP</code>. Originally in Java 1.0, Java only had a <code>java.util.Date</code> type, which was both a date, time and milliseconds. In Java 1.1 this was expanded to support the common database types with <code>java.sql.Date</code>, <code>java.sql.Time</code>, and <code>java.sql.Timestamp</code>, then to support internationalization Java created the <code>java.util.Calendar</code> type and virtually deprecated (almost all of the methods) the old date types (which JDBC still uses).</p>
<p>If you map a Java <code>java.sql.Date</code> type to a database <code>DATE</code>, this is just a basic mapping and you should not have any issues (ignore Oracle's <code>DATE</code> type that is/was a timestamp for now). You can also map <code>java.sql.Time</code> to <code>TIME</code>, and <code>java.sql.Timestamp</code> to <code>TIMESTAMP</code>. However if you have a <code>java.util.Date</code> or <code>java.util.Calendar</code> in Java and wish to map it to a <code>DATE</code> or <code>TIME</code>, you may need to indicate that the JPA provider perform some sort of conversion for this. In JPA the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Temporal.html" target="_blank"><code>@Temporal</code></a> annotation or <code>&lt;temporal&gt;</code> element is used to map this. You can indicate that just the <code>DATE</code> or <code>TIME</code> portion of the date/time value be stored to the database. You could also use <code>Temporal</code> to map a <code>java.sql.Date</code> to a <code>TIMESTAMP</code> field, or any other such conversion.</p>
<h3><span class="mw-headline" id="Example_of_temporal_annotation">Example of temporal annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Basic</span>
    <span class="nd">@Temporal</span><span class="o">(</span><span class="n">DATE</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Calendar</span> <span class="n">startDate</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_temporal_XML">Example of temporal XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        ...
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"startDate"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;temporal&gt;</span>DATE<span class="nt">&lt;/temporal&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Milliseconds">Milliseconds</span></h3>
<p>The precision of milliseconds is different for different temporal classes and database types, and on different databases. The <code>java.util.Date</code> and <code>Calendar</code> classes support milliseconds. The <code>java.sql.Date</code> and <code>java.sql.Time</code> classes do not support milliseconds. The <code>java.sql.Timestamp</code> class supports nanoseconds.</p>
<p>On many databases the <code>TIMESTAMP</code> type supports milliseconds. On Oracle prior to Oracle 9, there was only a <code>DATE</code> type, which was a date and a time, but had no milliseconds. Oracle 9 added a <code>TIMESTAMP</code> type that has milliseconds (and nanoseconds), and now treats the old <code>DATE</code> type as only a date, so be careful using it as a timestamp. MySQL has <code>DATE</code>, <code>TIME</code> and <code>DATETIME</code> types. DB2 has a <code>DATE</code>, <code>TIME</code> and <code>TIMESTAMP</code> types, the <code>TIMESTAMP</code> supports microseconds. Sybase and SQL Server just have a <code>DATETIME</code> type which has milliseconds, but at least on some versions has precision issues, it seems to store an estimate of the milliseconds, not the exact value.</p>
<p>If you use timestamp version locking you need to be very careful of your milliseconds precision. Ensure your database supports milliseconds precisely otherwise you may have issues, especially if the value is assigned in Java, then differs what gets stored on the database, which will cause the next update to fail for the same object.</p>
<p>In general I would not recommend using a timestamp and as primary key or for version locking. There are too many database compatibility issues, as well as the obvious issue of not supporting two operations in the same millisecond.</p>
<h3><span class="mw-headline" id="Timezones">Timezones</span></h3>
<p>Temporals become a lot more complex when you start to consider time zones, internationalization, eras, locals, day-light savings time, etc. In Java only <code>Calendar</code> supports time zones. Normally a <code>Calendar</code> is assumed to be in the local time zone, and is stored and retrieved from the database with that assumption. If you then read that same <code>Calendar</code> on another computer in another time zone, the question is if you will have the same <code>Calendar</code> or will you have the <code>Calendar</code> of what the original time would have been in the new time zone? It depends on if the <code>Calendar</code> is stored as the GMT time, or the local time, and if the time zone was stored in the database.</p>
<p>Some databases support time zones, but most database types do not store the time zone. Oracle has two special types for timestamps with time zones, <code>TIMESTAMPTZ</code> (time zone is stored) and <code>TIMESTAMPLTZ</code> (local time zone is used). Some JPA providers may have extended support for storing <code>Calendar</code> objects and time zones.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support the Oracle <code>TIMESTAMPTZ</code> and <code>TIMESTAMPLTZ</code> types using the <code>@TypeConverter</code> annotation and XML.</dd>
</dl>
<p><b>Forum Posts</b></p>
<ul>
<li><a rel="nofollow" class="external text" href="http://old.nabble.com/MySQL%27s-datetime-and-time-zones--td21006801.html" target="_blank">Investigation of storing timezones in MySQL</a></li>
</ul>
<h3><span class="mw-headline" id="Joda-Time">Joda-Time</span></h3>
<p><a rel="nofollow" class="external text" href="http://joda-time.sourceforge.net/" target="_blank">Joda-Time</a> is a commonly used framework for date/time usage in Java. It replaces Java Calendars which many people find difficult to use and have poor performance. There is no standard Joda-Time support in JPA, but a <code>Converter</code> can be used to convert from Joda-Time classes and database types.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: The base product offers no specific Joda-Time support, but there is a custom converter provided by a third party library, <a rel="nofollow" class="external text" href="http://code.google.com/p/joda-time-eclipselink-integration/" target="_blank">joda-time-eclipselink-integration</a>.</dd>
</dl>
<h2><span class="mw-headline" id="Enums">Enums</span></h2>
<p>Java <a rel="nofollow" class="external text" href="https://java.sun.com/java/5/docs/api/java/lang/Enum.html" target="_blank"><code>Enums</code></a> are typically used as constants in an object model. For example an <code>Employee</code> may have a <code>gender</code> of enum type <code>Gender</code> (<code>MALE</code>, <code>FEMALE</code>).</p>
<p>By default in JPA an attribute of type Enum will be stored as a <code>Basic</code> to the database, using the integer Enum values as codes (i.e. <code>0</code>, <code>1</code>). JPA also defines an <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Enumerated.html" target="_blank">@Enumerated</a> annotation and <code>&lt;enumerated&gt;</code> element (on a <code>&lt;basic&gt;</code>) to define an Enum attribute. This can be used to store the Enum as the <code>STRING</code> value of its name (i.e. <code>"MALE"</code>, <code>"FEMALE"</code>).</p>
<p>For translating Enum types to values other than the integer or String name, such as character constants, see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Translating_Values">Translating Values</a>.</p>
<h3><span class="mw-headline" id="Example_of_enumerated_annotation">Example of enumerated annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kd">enum</span> <span class="n">Gender</span> <span class="o">{</span>
    <span class="n">MALE</span><span class="o">,</span>
    <span class="n">FEMALE</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Basic</span>
    <span class="nd">@Enumerated</span><span class="o">(</span><span class="n">EnumType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Gender</span> <span class="n">gender</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_enumerated_XML">Example of enumerated XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        ...
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"gender"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;enumerated&gt;</span>STRING<span class="nt">&lt;/enumerated&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="LOBs.2C_BLOBs.2C_CLOBs_and_Serialization">LOBs, BLOBs, CLOBs and Serialization</span></h2>
<p>A <code>LOB</code> is a Large OBject, such as a <code>BLOB</code> (Binary LOB), or a <code>CLOB</code> (Character LOB). It is a database type that can store a large binary or string value, as the normal <code>VARCHAR</code> or <code>VARBINARY</code> types typically have size limitations. A LOB is often stored as a locator in the database table, with the actual data stored outside of the table. In Java a <code>CLOB</code> will normally map to a <code>String</code>, and a <code>BLOB</code> will normally map to a <code>byte[]</code>, although a <code>BLOB</code> may also represent some serialized object.</p>
<p>By default in JPA any <code>Serializable</code> attribute that is not a relationship or a basic type (String, Number, temporal, primitive), will be serialized to a <code>BLOB</code> field.</p>
<p>JPA defines the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Lob.html" target="_blank">@Lob</a> annotation and <code>&lt;lob&gt;</code> element (on a <code>&lt;basic&gt;</code>) to define that an attribute maps to a <code>LOB</code> type in the database. The annotation is just a hint to the JPA implementation that this attribute will be stored in a LOB, as LOBs may need to be persisted specially. Sometimes just mapping the LOB as a normal <code>Basic</code> will work fine as well.</p>
<p>Various databases and JDBC drivers have various limits for LOB sizes. Some JDBC drivers have issues beyond 4k, 32k or 1meg. The Oracle thin JDBC drivers had a 4k limitation in some versions for binding LOB data. Oracle provided a workaround for this limitation, which some JPA providers support. For reading LOBs, some JDBC drivers prefer using streams, some JPA providers also support this option.</p>
<p>Typically the entire LOB will be read and written for the attribute. For very large LOBs reading the value always, or reading the entire value may not be desired. The fetch type of the <code>Basic</code> could be set to <code>LAZY</code> to avoid reading a LOB unless accessed. Support for <code>LAZY</code> fetching on <code>Basic</code> is optional in JPA, so some JPA providers may not support it. A workaround, which is often a good idea in general given the large performance cost of LOBs, is to store the LOB in a separate table and class and define a <code>OneToOne</code> to the LOB object instead of a <code>Basic</code>. If the entire LOB is never desired to be read, then it should not be mapped. It is best to use direct JDBC to access and stream the LOB in this case. In may be possible to map the LOB to a <code>java.sql.Blob</code>/<code>java.sql.Clob</code> in your object to avoid reading the entire LOB, but these require a live connection, so may have issues with detached objects.</p>
<h3><span class="mw-headline" id="Example_of_lob_annotation">Example of lob annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Basic</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@Lob</span>
    <span class="kd">private</span> <span class="n">ImageIcon</span> <span class="n">picture</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_lob_XML">Example of lob XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        ...
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"picture"</span> <span class="na">fetch=</span><span class="s">"LAZY"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;lob/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Lazy_Fetching">Lazy Fetching</span></h2>
<p>The <code>fetch</code> attribute can be set on a <code>Basic</code> mapping to use <code>LAZY</code> fetching. By default all <code>Basic</code> mappings are <code>EAGER</code>, which means the column is selected whenever the object is selected. By setting the <code>fetch</code> to <code>LAZY</code>, the column will not be selected with the object. If the attribute is accessed, then the attribute value will be selected in a separate database select. Support for <code>LAZY</code> is an optional feature of JPA, so some JPA providers may not support it. Typically support for lazy on basics will require some form of byte code weaving, or dynamic byte code generation, which may have issues in certain environments or JVMs, or may require preprocessing your application's persistence unit jar.</p>
<p>Only attributes that are rarely accessed should be marked lazy, as accessing the attribute causes a separate database select, which can hurt performance. This is especially true if a large number of objects is queried. The original query will require one database select, but if each object's lazy attribute is accessed, this will require <code>n</code> database selects, which can be a major performance issue.</p>
<p>Using lazy fetching on basics is similar to the concept of fetch groups. Lazy basics is basically support for a single default fetch group. Some JPA providers support fetch groups in general, which allow more sophisticated control over what attributes are fetched per query.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support lazy basics and fetch groups. Fetch groups can be configured through the EclipseLink API using the <code>FetchGroup</code> class.</dd>
</dl>
<h2><span class="mw-headline" id="Optional">Optional</span></h2>
<p>A <code>Basic</code> attribute can be <code>optional</code> if its value is allowed to be null. By default everything is assumed to be optional, except for an <code>Id</code>, which can not be optional. Optional is basically only a hint that applies to database schema generation, if the persistence provider is configured to generate the schema. It adds a <code>NOT NULL</code> constraint to the column if <code>false</code>. Some JPA providers also perform validation of the object for optional attributes, and will throw a validation error before writing to the database, but this is not required by the JPA specification. Optional is defined through the <code>optional</code> attribute of the <code>Basic</code> annotation or element.</p>
<h2><span class="mw-headline" id="Column_Definition_and_Schema_Generation">Column Definition and Schema Generation</span></h2>
<p>There are various attributes on the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Column.html" target="_blank"><code>Column</code></a> annotation and element for database schema generation. If you do not use JPA to generate your schema you can ignore these. Many JPA providers do provide the feature of auto generation of the database schema. By default the Java types of the object's attributes are mapped to their corresponding database type for the database platform you are using. You may require configuring your database platform with your provider (such as a persistence.xml property) to allow schema generation for your database, as many database use different type names.</p>
<p>The <code>columnDefinition</code> attribute of <code>Column</code> can be used to override the default database type used, or enhance the type definition with constraints or other such DDL. The <code>length</code>, <code>scale</code> and <code>precision</code> can also be set to override defaults. Since the defaults for the <code>length</code> are just defaults, it is normally a good idea to set these to be correct for your data model's expected data, to avoid data truncation. The <code>unique</code> attribute can be used to define a unique constraint on the column, most JPA providers will automatically define primary key and foreign key constraints based on the <code>Id</code> and relationship mappings.</p>
<p>JPA does not define any options to define an index. Some JPA providers may provide extensions for this. You can also create your own indexes through native queries</p>
<h3><span class="mw-headline" id="Example_of_column_annotations">Example of column annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"SSN"</span><span class="o">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"description"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">ssn</span><span class="o">;</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"F_NAME"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="o">;</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"L_NAME"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">200</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">;</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"SALARY"</span><span class="o">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="o">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">salary</span><span class="o">;</span>       
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"S_TIME"</span><span class="o">,</span> <span class="n">columnDefinition</span><span class="o">=</span><span class="s">"TIMESTAMPTZ"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Calendar</span> <span class="n">startTime</span><span class="o">;</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"E_TIME"</span><span class="o">,</span> <span class="n">columnDefinition</span> <span class="o">=</span><span class="s">"TIMESTAMPTZ"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Calendar</span> <span class="n">endTime</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_column_XML">Example of column XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"ssn"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"SSN"</span> <span class="na">unique=</span><span class="s">"true"</span> <span class="na">optional=</span><span class="s">"false"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"firstName"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"F_NAME"</span> <span class="na">length=</span><span class="s">"100"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"lastName"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"L_NAME"</span> <span class="na">length=</span><span class="s">"200"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"startTime"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"S_TIME"</span> <span class="na">columnDefinition=</span><span class="s">"TIMESTAMPTZ"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"endTime"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"E_TIME"</span> <span class="na">columnDefinition=</span><span class="s">"TIMESTAMPTZ"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<p>If using BigDecimal with Postgresql, JPA maps salary to a table column of type NUMERIC(38,0). You can adjust scale and precision for BigDecimal within the @Column annotation.</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre>   <span class="nd">@Column</span><span class="o">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">8</span><span class="o">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">2</span><span class="o">)</span>
   <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">salary</span><span class="o">;</span>
</pre></div>
<h2><span class="mw-headline" id="Insertable.2C_Updatable_.2F_Read_Only_Fields_.2F_Returning">Insertable, Updatable / Read Only Fields / Returning</span></h2>
<p>The <code>Column</code> annotation and XML element defines <code>insertable</code> and <code>updatable</code> options. These allow for this column, or foreign key field to be omitted from the SQL INSERT or UPDATE statement. These can be used if constraints on the table prevent insert or update operations. They can also be used if multiple attributes map to the same database column, such as with a foreign key field through a <code>ManyToOne</code> and <code>Id</code> or <code>Basic</code> mapping. Setting both <code>insertable</code> and <code>updatable</code> to false, effectively mark the attribute as read-only.</p>
<p><code>insertable</code> and <code>updatable</code> can also be used in the database table defaults, or auto assigns values to the column on insert or update. Be careful in doing this though, as this means that the object's values will be out of synch with the database, unless it is refreshed. For <code>IDENTITY</code> or auto assigned id columns a <code>GeneratedValue</code> should normally be used, instead of setting <code>insertable</code> to false. Some JPA providers also support returning auto assigned fields values from the database after insert or update operations. The cost of refreshing or returning fields back into the object can effect performance, so it is normally better to initialize field values in the object model, not in the database.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support returning insert and update values back into the object using the <code>ReturnInsert</code> and <code>ReturnUpdate</code> annotations and XML elements.</dd>
</dl>
<h2><span class="mw-headline" id="Converters_.28JPA_2.1.29">Converters (JPA 2.1)</span></h2>
<p>A common problem in storing values to the database is that the value desired in Java differs from the value used in the database. Common examples include using a <code>boolean</code> in Java and a <code>0</code>, <code>1</code> or a <code>'T'</code>, <code>'F'</code> in the database. Other examples are using a <code>String</code> in Java and a <code>DATE</code> in the database, or mapping custom Java types such as Joda-Time types, or a Money type.</p>
<p>JPA 2.1 defines the <code>@Converter</code>, <code>@Convert</code> annotations and <code>&lt;converter&gt;</code>, <code>&lt;convert&gt;</code> XML elements. A <code>Converter</code> is a user defined class that provides custom conversion routines in Java code. It must implement the <code>AttributeConverter</code> interface and be annotated with the <code>@Converter</code> annotation (or specified in XML). A <code>Converter</code> can be used in one of two ways. Normally it is specified on a mapping using the <code>@Convert</code> annotation or <code>&lt;convert&gt;</code> XML element. Another option, if converting a custom type, is to have the <code>Converter</code> applied to any mapped attribute that has that type. To define such as global converter the <code>autoApply</code> flag is added to the <code>@Converter</code> annotation. The <code>@Convert</code> <code>disableConversion</code> flag can be used to disable a global converter from being applied. The <code>@Convert</code> <code>attributeName</code> option can be used to override inherited or embeddable conversions.</p>
<h4><span class="mw-headline" id="Example_Converter">Example Converter</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Convert</span><span class="o">(</span><span class="n">converter</span><span class="o">=</span><span class="n">BooleanTFConverter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Boolean</span> <span class="n">isActive</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Converter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BooleanTFConverter</span> <span class="kd">implements</span> <span class="n">AttributeConverter</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">convertToDatabaseColumn</span><span class="o">(</span><span class="n">Boolean</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"T"</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"F"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">convertToEntityAttribute</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"T"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_global_Converter">Example global Converter</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">private</span> <span class="n">Boolean</span> <span class="n">isActive</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Converter</span><span class="o">(</span><span class="n">autoApply</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BooleanTFConverter</span> <span class="kd">implements</span> <span class="n">AttributeConverter</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">convertToDatabaseColumn</span><span class="o">(</span><span class="n">Boolean</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"T"</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"F"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">convertToEntityAttribute</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"T"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Conversion">Conversion</span></h3>
<p>Previous to JPA 2.1 there was no standard way to convert between a data-type and an object-type. One way to accomplish this was to translate the data through property get/set methods.</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isActive</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="nd">@Transient</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">getIsActive</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">isActive</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIsActive</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isActive</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">isActive</span> <span class="o">=</span> <span class="n">isActive</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Basic</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getIsActiveValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isActive</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"T"</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"F"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setIsActiveValue</span><span class="o">(</span><span class="n">String</span> <span class="n">isActive</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">isActive</span> <span class="o">=</span> <span class="s">"T"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">isActive</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Also for translating date/times see, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Temporal.2C_Dates.2C_Times.2C_Timestamps_and_Calendars">Temporals</a>.</p>
<p>As well some JPA providers have special conversion support.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support translation using the <code>@Convert</code>, <code>@Converter</code>, <code>@ObjectTypeConverter</code> and <code>@TypeConverter</code> annotations and XML.</dd>
</dl>
<h2><span class="mw-headline" id="Custom_Types">Custom Types</span></h2>
<p>JPA defines support for most common database types, however some databases and JDBC driver have additional types that may require additional support.</p>
<p>Some custom database types include:</p>
<ul>
<li>TIMESTAMPTZ, TIMESTAMPLTZ (Oracle)</li>
<li>TIMESTAMP WITH TIMEZONE (Postgres)</li>
<li>XMLTYPE (Oracle)</li>
<li>XML (DB2)</li>
<li>NCHAR, NVARCHAR, NCLOB (Oracle)</li>
<li>Struct (STRUCT Oracle)</li>
<li>Array (VARRAY Oracle)</li>
<li>BINARY_INTEGER, DEC, INT, NATURAL, NATURALN, BOOLEAN (Oracle)</li>
<li>POSITIVE, POSITIVEN, SIGNTYPE, PLS_INTEGER (Oracle)</li>
<li>RECORD, TABLE (Oracle)</li>
<li>SDO_GEOMETRY (Oracle)</li>
<li>LOBs (Oracle thin driver)</li>
</ul>
<p>To handle persistence to custom database types you may be able to use a <code>Converter</code> or special feature of your JPA provider. Otherwise you may need to mix raw JDBC code with your JPA objects. Some JPA provider provide custom support for many custom database types, some also provide custom hooks for adding your own JDBC code to support a custom database type.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support several custom database types including, TIMESTAMPTZ, TIMESTAMPLTZ, XMLTYPE, NCHAR, NVARCHAR, NCLOB, object-relational Struct and Array types, PLSQL types, SDO_GEOMETRY and LOBs.</dd>
</dl>
<h1><span class="mw-headline" id="Relationships_2">Relationships</span></h1>
<p>A relationship is a reference from one object to another. In Java, relationships are defined through object references (pointers) from a source object to the target object. Technically, in Java there is no difference between a relationship to another object and a "relationship" to a data attribute such as a <code>String</code> or <code>Date</code> (primitives are different), as both are pointers; however, logically and for the sake of persistence, data attributes are considered part of the object, and references to other persistent objects are considered relationships.</p>
<p>In a relational database relationships are defined through foreign keys. The source row contains the primary key of the target row to define the relationship (and sometimes the inverse). A query must be performed to read the target objects of the relationship using the foreign key and primary key information.</p>
<p>In Java, if a relationship is to a collection of other objects, a <code>Collection</code> or array type is used in Java to hold the contents of the relationship. In a relational database, collection relations are either defined by the target objects having a foreign key back to the source object's primary key, or by having an intermediate join table to store the relationship (both objects' primary keys).</p>
<p>All relationships in Java and JPA are unidirectional, in that if a source object references a target object there is no guarantee that the target object also has a relationship to the source object. This is different than a relational database, in which relationships are defined through foreign keys and querying such that the inverse query always exists.</p>
<h3><span class="mw-headline" id="JPA_Relationship_Types">JPA Relationship Types</span></h3>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToOne" title="Java Persistence/OneToOne">OneToOne</a> - A unique reference from one object to another, inverse of a <code>OneToOne</code>.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToOne" title="Java Persistence/ManyToOne">ManyToOne</a> - A reference from one object to another, inverse of a <code>OneToMany</code>.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany" title="Java Persistence/OneToMany">OneToMany</a> - A <code>Collection</code> or <code>Map</code> of objects, inverse of a <code>ManyToOne</code>.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToMany" title="Java Persistence/ManyToMany">ManyToMany</a> - A <code>Collection</code> or <code>Map</code> of objects, inverse of a <code>ManyToMany</code>.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Embeddables" title="Java Persistence/Embeddables">Embedded</a> - A reference to a object that shares the same table of the parent.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ElementCollection" title="Java Persistence/ElementCollection">ElementCollection</a> - JPA 2.0, a <code>Collection</code> or <code>Map</code> of <code>Basic</code> or <code>Embeddable</code> objects, stored in a separate table.</li>
</ul>
<p>This covers the majority of types of relationships that exist in most object models. Each type of relationship also covers multiple different implementations, such as OneToMany allowing either a join table, or foreign key in the target, and collection mappings also allow <code>Collection</code> types and <code>Map</code> types. There are also other possible complex relationship types, see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Advanced_Relationships">Advanced Relationships</a>.</p>
<h2><span class="mw-headline" id="Lazy_Fetching_2">Lazy Fetching</span></h2>
<p>The cost of retrieving and building an object's relationships far exceeds the cost of selecting the object. This is especially true for relationships such as <code>manager</code> or <code>managedEmployees</code> such that, if any employee were selected, it would trigger the loading of every employee through the relationship hierarchy. Obviously this is a bad thing, and yet having relationships in objects is very desirable.</p>
<p>The solution to this issue is lazy fetching (lazy loading). Lazy fetching allows the fetching of a relationship to be deferred until it is accessed. This is important not only to avoid the database access, but also to avoid the cost of building the objects if they are not needed.</p>
<p>In JPA lazy fetching can be set on any relationship using the <code>fetch</code> attribute. The <code>fetch</code> can be set to either <code>LAZY</code> or <code>EAGER</code> as defined in the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/FetchType.html" target="_blank">FetchType</a> enum. The default fetch type is <code>LAZY</code> for all relationships except for <code>OneToOne</code> and <code>ManyToOne</code>, but in general it is a good idea to make every relationship <code>LAZY</code>. The <code>EAGER</code> default for <code>OneToOne</code> and <code>ManyToOne</code> is for implementation reasons (more difficult to implement), not because it is a good idea. Technically in JPA <code>LAZY</code> is just a hint, and a JPA provider is not required to support it, however in reality all main JPA providers support it, and they would be pretty useless if they did not.</p>
<h3><span class="mw-headline" id="Example_of_a_lazy_one_to_one_relationship_annotations">Example of a lazy one to one relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ADDR_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_lazy_one_to_one_relationship_XML">Example of a lazy one to one relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-one</span> <span class="na">name=</span><span class="s">"address"</span> <span class="na">fetch=</span><span class="s">"LAZY"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"ADDR_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/one-to-one&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Magic">Magic</span></h3>
<p>Lazy fetching normally involves some sort of <i>magic</i> in the JPA provider to transparently fault in the relationships as they are accessed. The typical magic for collection relationships is for the JPA provider to set the relationships to its own <code>Collection</code>, <code>List</code>, <code>Set</code> or <code>Map</code> implementation. When any (or most) method is accessed on this collection proxy, it loads the real collection and forwards the method. This is why JPA requires that all collection relationships use one of the collection interfaces (although some JPA providers support collection implementations too).</p>
<p>For <code>OneToOne</code> and <code>ManyToOne</code> relationships the magic normally involves some sort of byte code manipulation of the entity class, or creation of a subclass. This allows the access to the field or get/set methods to be intercepted, and for the relationships to be first retrieved before allowing access to the value. Some JPA providers use different methods, such as wrapping the reference in a proxy object, although this can have issues with <code>null</code> values and primitive methods. To perform the byte code magic normally an agent or post-processor is required. Ensure that you correctly use your providers agent or post-processor otherwise lazy may not work. You may also notice additional variables when in a debugger, but in general debugging will still work as normal.</p>
<h3><span class="mw-headline" id="Basics_2">Basics</span></h3>
<p>A <code>Basic</code> attribute can also be made <code>LAZY</code>, but this is normally a different mechanism than lazy relationships, and should normally be avoided unless the attribute is rarely accessed.</p>
<p>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Basic_Attributes#Lazy_Fetching" title="Java Persistence/Basic Attributes">Basic Attributes : Lazy Fetching</a>.</p>
<h3><span class="mw-headline" id="Serialization.2C_and_Detaching">Serialization, and Detaching</span></h3>
<p>A major issue with lazy relationships is ensuring that the relationship is still available after the object has been detached or serialized. For most JPA providers, after serialization any lazy relationship that was not instantiated will be broken, and either throw an error when accessed or return null.</p>
<p>The naive solution is to make every relationship eager. Serialization suffers from the same issue as persistence, in that you can very easily serialize your entire database if you have no lazy relationships. So lazy relationships are just as necessary for serialization as they are for database access; however you need to ensure you have everything you will need after serialization instantiated upfront. You may mark only the relationships that you think you will need after serialization as <code>EAGER</code>; this will work, but there are probably many cases when you do not need these relationships.</p>
<p>A second solution is to access any relationship you will need before returning the object for serialization. This has the advantage of being use case specific, so different use cases can instantiate different relationships. For collection relationships sending <code>size()</code> is normally the best way to ensure a lazy relationship is instantiated. For <code>OneToOne</code> and <code>ManyToOne</code> relationships, normally just accessing the relationship is enough (i.e. <code>employee.getAddress()</code>), although for some JPA providers that use proxies you may need to send the object a message (i.e.<code>employee.getAddress().hashCode()</code>).</p>
<p>A third solution is to use the JPQL <code>JOIN FETCH</code> for the relationship when querying the objects. A join fetch will normally ensure the relationship has been instantiated. Some caution should be used with join fetch however, as it can become inefficient if used on collection relationships, especially multiple collection relationships as it requires an n^2 join on the database.</p>
<p>Some JPA providers may also provide certain query hints, or other such serialization options.</p>
<p>The same issue can occur without serialization, if a detached object is accessed after the end of the transaction. Some JPA providers allow lazy relationship access after the end of the transaction, or after the <code>EntityManager</code> has been closed, however some do not. If your JPA provider does not, then you may require that you ensure you have instantiated all the lazy relationships that you will need before ending the transaction.</p>
<h3><span class="mw-headline" id="Eager_Join_Fetching">Eager Join Fetching</span></h3>
<p>One common misconception is that <code>EAGER</code> means that the relationship should be join fetched, i.e. retrieved in the same SQL <code>SELECT</code> statement as the source object. Some JPA providers do implement eager this way. However, just because something is desired to be loaded does not mean that it should be join fetched. Consider <code>Employee</code> - <code>Phone</code>, a <code>Phone</code>'s employee reference is made <code>EAGER</code> as the employee is almost always loaded before the phone. However when loading the phone, you do not want to join the employee, the employee has already been read and is already in the cache or persistence context. Also just because you want two collection relationships loaded, does not mean you want them join fetch which would result in a very inefficient join that would return n^2 data.</p>
<p>Join fetching is something that JPA currently only provides through JPQL, which is normally the correct place for it, as each use case has different relationship requirements. Some JPA providers also provide a join fetch option at the mapping level to always join fetch a relationship, but this is normally not the same thing as <code>EAGER</code>. Join fetching is not normally the most efficient way to load a relationship anyway, normally batch reading a relationship is much more efficient when supported by your JPA provider.</p>
<p>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Join_Fetching">Join Fetching</a></p>
<p>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Batch_Fetching">Batch Reading</a></p>
<h2><span class="mw-headline" id="Cascading">Cascading</span></h2>
<p>Relationship mappings have a <code>cascade</code> option that allows the relationship to be cascaded for common operations. <code>cascade</code> is normally used to model dependent relationships, such as <code>Order</code> -&gt; <code>OrderLine</code>. Cascading the <code>orderLines</code> relationship allows for the <code>Order</code>'s -&gt; <code>OrderLine</code>s to be persisted, removed, merged along with their parent.</p>
<p>The following operations can be cascaded, as defined in the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/CascadeType.html" target="_blank">CascadeType</a> enum:</p>
<ul>
<li><code>PERSIST</code> - Cascaded the <code>EntityManager.persist()</code> operation. If <code>persist()</code> is called on the parent, and the child is also new, it will also be persisted. If it is existing, nothing will occur, although calling <code>persist()</code> on an existing object will still cascade the persist operation to its dependents. If you persist an object, and it is related to a new object, and the relationship does not cascade persist, then an exception will occur. This may require that you first call persist on the related object before relating it to the parent. General it may seem odd, or be desirable to always cascade the persist operation, if a new object is related to another object, then it should probably be persisted. There is most likely not a major issue with always cascading persist on every relationship, although it may have an impact on performance. Calling persist on a related object is not required, on commit any related object whose relationship is cascade persist will automatically be persisted. The advantage of calling persist up front is that any generated ids will (unless using identity) be assigned, and the <code>prePersist</code> event will be raised.</li>
<li><code>REMOVE</code> - Cascaded the <code>EntityManager.remove()</code> operation. If <code>remove()</code> is called on the parent then the child will also be removed. This should only be used for dependent relationships. Note that only the <code>remove()</code> operation is cascaded, if you remove a dependent object from a <code>OneToMany</code> collection it will not be deleted, JPA requires that you explicitly call <code>remove()</code> on it. Some JPA providers may support an option to have objects removed from dependent collection deleted, JPA 2.0 also defines an option for this.</li>
<li><code>MERGE</code> - Cascaded the <code>EntityManager.merge()</code> operation. If <code>merge()</code> is called on the parent, then the child will also be merged. This should normally be used for dependent relationships. Note that this only affects the cascading of the merge, the relationship reference itself will always be merged. This can be a major issue if you use <code>transient</code> variables to limit serialization, you may need to manually merge, or reset transient relationships in this case. Some JPA providers provide additional <code>merge</code> operations.</li>
<li><code>REFRESH</code> - Cascaded the <code>EntityManager.refresh()</code> operation. If <code>refresh()</code> is called on the parent then the child will also be refreshed. This should normally be used for dependent relationships. Be careful enabling this for all relationships, as it could cause changes made to other objects to be reset.</li>
<li><code>ALL</code> - Cascaded all the above operations.</li>
</ul>
<h3><span class="mw-headline" id="Example_of_a_cascaded_one_to_one_relationship_annotations">Example of a cascaded one to one relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">})</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ADDR_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_cascaded_one_to_one_relationship_XML">Example of a cascaded one to one relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-one</span> <span class="na">name=</span><span class="s">"address"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"ADDR_ID"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;cascade&gt;</span>
                <span class="nt">&lt;cascade-all/&gt;</span>
            <span class="nt">&lt;/cascade&gt;</span>
        <span class="nt">&lt;/one-to-one&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Orphan_Removal_.28JPA_2.0.29">Orphan Removal (JPA 2.0)</span></h2>
<p>Cascading of the <code>remove</code> operation only occurs when the remove is called on the object. This is not normally what is desired on a dependent relationship. If the related objects cannot exist without the source, then it is normally desired to have them deleted when the source is deleted, but also have them deleted when they are no longer referenced from the source. JPA 1.0 did not provide an option for this, so when a dependent object was removed from the source relationship, it had to be explicitly removed from the <code>EntityManager</code>. JPA 2.0 provides a <code>orphanRemoval</code> option on the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/OneToMany.html" target="_blank">OneToMany</a> and <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/OneToMany.html" target="_blank">OneToOne</a> annotations and XML. Orphan removal will ensure that any object no longer referenced from the relationship is deleted from the database.</p>
<h3><span class="mw-headline" id="Example_of_an_orphan_removal_one_to_many_relationship_annotations">Example of an orphan removal one to many relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">orphanRemoval</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span> <span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">})</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PhoneNumbers</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_an_orphan_removal_one_to_many_relationship_XML">Example of an orphan removal one to many relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phones"</span> <span class="na">orphan-removal=</span><span class="s">"true"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;cascade&gt;</span>
                <span class="nt">&lt;cascade-all/&gt;</span>
            <span class="nt">&lt;/cascade&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Target_Entity">Target Entity</span></h2>
<p>Relationship mappings have a <code>targetEntity</code> attribute that allows the reference class (target) of the relationship to be specified. This is normally not required to be set as it is defaulted from the field type, get method return type, or collection's generic type.</p>
<p>This can also be used if your field uses a public interface type, for example field is interface <code>Address</code>, but the mapping needs to be to implementation class <code>AddressImpl</code>. Another usage is if your field is a superclass type, but you want to map the relationship to a subclass.</p>
<h3><span class="mw-headline" id="Example_of_a_target_entity_relationship_annotations">Example of a target entity relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">targetEntity</span><span class="o">=</span><span class="n">Phone</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_target_entity_relationship_XML">Example of a target entity relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phones"</span> <span class="na">target-entity=</span><span class="s">"org.acme.Phone"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Collections_2">Collections</span></h2>
<p>Collection mappings include <a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany" title="Java Persistence/OneToMany">OneToMany</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToMany" title="Java Persistence/ManyToMany">ManyToMany</a>, and in JPA 2.0 <a href="https://en.wikibooks.org/wiki/Java_Persistence/ElementCollection" title="Java Persistence/ElementCollection">ElementCollection</a>. JPA requires that the type of the collection field or get/set methods be one of the Java collection interfaces, <code>Collection</code>, <code>List</code>, <code>Set</code>, or <code>Map</code>.</p>
<h3><span class="mw-headline" id="Collection_Implementations">Collection Implementations</span></h3>
<p>Your field should not be of a collection implementation type, such as <code>ArrayList</code>. Some JPA providers may support using collection implementations, many support <code>EAGER</code> collection relationships to use the implementation class. You can set any implementation as the instance value of the collection, but when reading an object from the database, if it is <code>LAZY</code> the JPA provider will normally put in a special <code>LAZY</code> collection.</p>
<h3><span class="mw-headline" id="Duplicates">Duplicates</span></h3>
<p>A <code>List</code> in Java supports duplicate entries, and a <code>Set</code> does not. In the database, duplicates are generally not supported. Technically it could be possible if a <code>JoinTable</code> is used, but JPA does not require duplicates to be supported, and most providers do not.</p>
<p>If you require duplicate support, you may need to create an object that represents and maps to the join table. This object would still require a unique <code>Id</code>, such as a <code>GeneratedValue</code>. See <a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToMany#Mapping_a_Join_Table_with_Additional_Columns" title="Java Persistence/ManyToMany">Mapping a Join Table with Additional Columns</a>.</p>
<h3><span class="mw-headline" id="Ordering">Ordering</span></h3>
<p>JPA allows the collection values to be ordered by the database when retrieved. This is done through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/OrderBy.html" target="_blank"><code>@OrderBy</code></a> annotation or <code>&lt;order-by&gt;</code> XML element.</p>
<p>The value of the <code>OrderBy</code> is a JPQL <a href="https://en.wikibooks.org/wiki/Java_Persistence/JPQL_BNF#Order_By" title="Java Persistence/JPQL BNF"><code>ORDER BY</code></a> string. The can be an attribute name followed by <code>ASC</code> or <code>DESC</code> for ascending or descending ordering. You could also use a path or nested attribute, or a "," for multiple attributes. If no <code>OrderBy</code> value is given it is assumed to be the <code>Id</code> of the target object.</p>
<p>The <code>OrderBy</code> value must be a mapped attribute of the target object. If you want to have an ordered <code>List</code> you need to add an <i>index</i> attribute to your target object and an <i>index</i> column to its table. You will also have to ensure you set the index values. JPA 2.0 will have extended support for an ordered <code>List</code> using an <code>OrderColumn</code>.</p>
<p>Note that using an <code>OrderBy</code> does not ensure the collection is ordered in memory. You are responsible for adding to the collection in the correct order. Java does define a <code>SortedSet</code> interface and <code>TreeSet</code> collection implementation that does maintain an order. JPA does not specifically support <code>SortedSet</code>, but some JPA providers may allow you to use a <code>SortedSet</code> or <code>TreeSet</code> for your collection type, and maintain the correct ordering. By default these require your target object to implement the <code>Comparable</code> interface, or set a <code>Comparator</code>. You can also use the <code>Collections.sort()</code> method to sort a <code>List</code> when required. One option to sort in memory is to use property access and in your set and add methods call <code>Collections.sort()</code>.</p>
<h4><span class="mw-headline" id="Example_of_a_collection_order_by_annotation">Example of a collection order by annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span>
  <span class="nd">@OrderBy</span><span class="o">(</span><span class="s">"areaCode"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_a_collection_order_by_XML">Example of a collection order by XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phones"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;order-by&gt;</span>areaCode<span class="nt">&lt;/order-by&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Order_Column_.28JPA_2.0.29">Order Column (JPA 2.0)</span></h3>
<p>JPA 2.0 adds support for an <code>OrderColumn</code>. An <code>OrderColumn</code> can be used to define an order <code>List</code> on any collection mapping. It is defined through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/OrderColumn.html" target="_blank"><code>@OrderColumn</code></a> annotation or <code>&lt;order-column&gt;</code> XML element.</p>
<p>The <code>OrderColumn</code> is maintained by the mapping and should not be an attribute of the target object. The table for the <code>OrderColumn</code> depends on the mapping. For a <code>OneToMany</code> mapping it will be in the target object's table. For a <code>ManyToMany</code> mapping or a <code>OneToMany</code> using a <code>JoinTable</code> it will be in the join table. For an <code>ElementCollection</code> mapping it will be in the target table.</p>
<h4><span class="mw-headline" id="Example_of_a_collection_order_column_database">Example of a collection order column database</span></h4>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
<td>SALARY</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
<td>60000</td>
</tr>
</tbody></table>
<p>EMPLOYEE_PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMPLOYEE_ID</td>
<td>PHONE_ID</td>
<td>INDEX</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>4</td>
<td>1</td>
</tr>
</tbody></table>
<p>PHONE(table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>AREACODE</td>
<td>NUMBER</td>
</tr>
<tr>
<td>1</td>
<td>613</td>
<td>792-7777</td>
</tr>
<tr>
<td>2</td>
<td>416</td>
<td>798-6666</td>
</tr>
<tr>
<td>3</td>
<td>613</td>
<td>792-9999</td>
</tr>
<tr>
<td>4</td>
<td>416</td>
<td>798-5555</td>
</tr>
</tbody></table>
<h4><span class="mw-headline" id="Example_of_a_collection_order_column_annotation">Example of a collection order column annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span>
  <span class="nd">@OrderColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"INDEX"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_a_collection_order_column_XML">Example of a collection order column XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phones"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;order-column</span> <span class="na">name=</span><span class="s">"INDEX"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Common_Problems_11">Common Problems</span></h2>
<h4><span class="mw-headline" id="Object_corruption.2C_one_side_of_the_relationship_is_not_updated_after_updating_the_other_side"><i>Object corruption, one side of the relationship is not updated after updating the other side</i></span></h4>
<p>A common problem with bi-directional relationships is the application updates one side of the relationship, but the other side does not get updated, and becomes out of sync. In JPA, as in Java in general, it is the responsibility of the application or the object model to maintain relationships. If your application adds to one side of a relationship, then it must add to the other side.</p>
<p>This is commonly resolved through <code>add</code> or <code>set</code> methods in the object model that handle both sides of the relationships, so the application code does not need to worry about it. There are two ways to go about this: you can either add the relationship maintenance code to only one side of the relationship, and only use the setter from that side (such as making the other side protected), or add it to both sides and ensure you avoid an infinite loop.</p>
<p>For example:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">List</span> <span class="n">phones</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addPhone</span><span class="o">(</span><span class="n">Phone</span> <span class="n">phone</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">phones</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">phone</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">phone</span><span class="o">.</span><span class="na">getOwner</span><span class="o">()</span> <span class="o">!=</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">phone</span><span class="o">.</span><span class="na">setOwner</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOwner</span><span class="o">(</span><span class="n">Employee</span> <span class="n">employee</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">employee</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">employee</span><span class="o">.</span><span class="na">getPhones</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="k">this</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">employee</span><span class="o">.</span><span class="na">getPhones</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<p>The code is similar for bi-directional <code>OneToOne</code> and <code>ManyToMany</code> relationships.</p>
<p>Some expect the JPA provider to have magic that automatically maintains relationships. This was actually part of the EJB CMP 2 specification. However the issue is if the objects are detached or serialized to another VM, or new objects are related before being managed, or the object model is used outside the scope of JPA, then the magic is gone, and the application is left figuring things out, so in general it may be better to add the code to the object model. However some JPA providers do have support for automatically maintaining relationships.</p>
<p>In some cases it is undesirable to instantiate a large collection when adding a child object. One solution is to not map the bi-directional relationship, and instead query for it as required. Also some JPA providers optimize their lazy collection objects to handle this case, so you can still add to the collection without instantiating it.</p>
<h4><span class="mw-headline" id="Poor_performance.2C_excessive_queries"><i>Poor performance, excessive queries</i></span></h4>
<p>This most common issue leading to poor performance is the usage of <code>EAGER</code> relationships. This requires the related objects to be read when the source objects are read. So for example reading the president of the company with <code>EAGER</code> <code>managedEmployees</code> will cause every <code>Employee</code> in the company to be read. The solution is to always make all relationships <code>LAZY</code>. By default <code>OneToMany</code> and <code>ManyToMany</code> are <code>LAZY</code> but <code>OneToOne</code> and <code>ManyToOne</code> are not, so make sure you configure them to be. See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Lazy_Fetching">Lazy Fetching</a>. Sometimes you have <code>LAZY</code> configured but it does not work, see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Lazy_is_not_working">Lazy is not working</a></p>
<p>Another common problems is the <i>n+1</i> issue. For example consider that you read all <code>Employee</code> objects then access their <code>Address</code>. Since each <code>Address</code> is accessed separately this will cause n+1 queries, which can be a major performance problem. This can be solved through <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Join_Fetching">Join Fetching</a> and <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Batch_Fetching">Batch Reading</a>.</p>
<h4><span class="mw-headline" id="Lazy_is_not_working"><i>Lazy is not working</i></span></h4>
<p>Lazy <code>OneToOne</code> and <code>ManyToOne</code> relationships typically require some form of weaving or byte-code generation. Normally when running in JSE an <code>agent</code> option is required to allow the byte-code weaving, so ensure you have the agent configured correctly. Some JPA providers perform dynamic subclass generation, so do not require an agent.</p>
<p><b>Example agent</b></p>
<pre>   java -javaagent:eclipselink.jar ...
</pre>
<p>Some JPA providers also provide static weaving instead, or in addition to dynamic weaving. For static weaving some preprocessor must be run on your JPA classes.</p>
<p>When running in JEE lazy should normally work, as the class loader hook is required by the EJB specification. However some JEE providers may not support this, so static weaving may be required.</p>
<p>Also ensure that you are not accessing the relationship when you shouldn't be. For example if you use property access, and in your set method access the related lazy value, this will cause it to be loaded. Either remove the set method side-effects, or use field access.</p>
<h4><span class="mw-headline" id="Broken_relationships_after_serialization"><i>Broken relationships after serialization</i></span></h4>
<p>If your relationship is marked as <code>lazy</code> then if it has not been instantiated before the object is serialized, then it may not get serialized. This may cause an error, or return <code>null</code> if it is accessed after deserialization.</p>
<p>See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Serialization.2C_and_Detaching">Serialization, and Detaching</a></p>
<h4><span class="mw-headline" id="Dependent_object_removed_from_OneToMany_collection_is_not_deleted"><i>Dependent object removed from OneToMany collection is not deleted</i></span></h4>
<p>When you remove an object from a collection, if you also want the object deleted from the database you must call <code>remove()</code> on the object. In JPA 1.0 even if your relationship is <code>cascade REMOVE</code>, you still must call <code>remove()</code>, only the remove of the parent object is cascaded, not removal from the collection.</p>
<p>JPA 2.0 will provide an option for having removes from the collection trigger deletion. Some JPA providers support an option for this in JPA 1.0.</p>
<p>See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Cascading">Cascading</a></p>
<h4><span class="mw-headline" id="My_relationship_target_is_an_interface"><i>My relationship target is an interface</i></span></h4>
<p>If your relationship field's type is a public interface of your class, and only has a single implementer, then this is simple to solve, you just need to set a <code>targetEntity</code> on your mapping. See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Target_Entity">Target Entity</a>.</p>
<p>If your interface has multiple implementers, then this is more complex. JPA does not directly support mapping interfaces. One solution is to convert the interface to an abstract class and use inheritance to map it. You could also keep the interface, create the abstract class and make sure each implementer extends it, and set the <code>targetEntity</code> to be the abstract class.</p>
<p>Another solution is to define virtual attributes using get/set methods for each possible implementer, and map these separately, and mark the interface get/set as <code>transient</code>. You could also not map the attribute, and instead query for it as required.</p>
<p>See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Variable_and_Heterogeneous_Relationships">Variable and Heterogeneous Relationships</a></p>
<p>Some JPA providers have support for interfaces and variable relationships.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support variable relationships through their <code>@VariableOneToOne</code> annotation and XML. Mapping to and querying interfaces are also supported through their <code>ClassDescriptor</code>'s <code>InterfacePolicy</code> API.</dd>
</dl>
<h1><span class="mw-headline" id="Advanced_7">Advanced</span></h1>
<h2><span class="mw-headline" id="Advanced_Relationships">Advanced Relationships</span></h2>
<h3><span class="mw-headline" id="JPA_2.0_Relationship_Enhancements">JPA 2.0 Relationship Enhancements</span></h3>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ElementCollection" title="Java Persistence/ElementCollection">ElementCollection</a> - A <code>Collection</code> or <code>Map</code> of <code>Embeddable</code> or <code>Basic</code> values.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Map_Key_Columns_.28JPA_2.0.29">Map Columns</a> - A <code>OneToMany</code> or <code>ManyToMany</code> or <code>ElementCollection</code> that has a <code>Basic</code>, <code>Embeddable</code> or <code>Entity</code> key not part of the target object.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Order_Column_.28JPA_2.0.29">Order Columns</a> - A <code>OneToMany</code> or <code>ManyToMany</code> or <code>ElementCollection</code> can now have a <code>OrderColumn</code> that defines the order of the collection when a <code>List</code> is used.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany#Undirectional_OneToMany.2C_No_Inverse_ManyToOne.2C_No_Join_Table_.28JPA_2.0.29" title="Java Persistence/OneToMany">Unidirectional OneToMany</a> - A <code>OneToMany</code> no longer requires the <code>ManyToOne</code> inverse relationship to be defined.</li>
</ul>
<h3><span class="mw-headline" id="Other_Types_of_Relationships">Other Types of Relationships</span></h3>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Variable_and_Heterogeneous_Relationships">Variable</a> OneToOne, ManyToOne - A reference to an interface or common unmapped inheritance class that has multiple distinct implementors.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Variable_and_Heterogeneous_Relationships">Variable</a> OneToMany, ManyToMany - A <code>Collection</code> or <code>Map</code> of heterogeneous objects that share an interface or common unmapped inheritance class that has multiple distinct implementers.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Nested_Collections.2C_Maps_and_Matrices">Nested collection relationships</a>, such as an array of arrays, <code>List</code> of <code>List</code>s, or <code>Map</code> of <code>Map</code>s, or other such combinations.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#Structured_Object-Relational_Data_Types" title="Java Persistence/Advanced Topics">Object-Relational Data Type</a> - Relationships stored in the database using <code>STRUCT</code>, <code>VARRAY</code>, <code>REF</code>, or <code>NESTEDTABLE</code> types.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#XML_Data_Types" title="Java Persistence/Advanced Topics">XML relationships</a> - Relationships stored as XML documents.</li>
</ul>
<h2><span class="mw-headline" id="Maps">Maps</span></h2>
<p>Java defines the <code>Map</code> interface to represent collections whose values are indexed on a key. There are several <code>Map</code> implementations, the most common is <code>HashMap</code>, but also <code>Hashtable</code> and <code>TreeMap</code>.</p>
<p>JPA allows a <code>Map</code> to be used for any collection mapping including, <code>OneToMany</code>, <code>ManyToMany</code> and <code>ElementCollection</code>. JPA requires that the <code>Map</code> interface be used as the attribute type, although some JPA providers may also support using <code>Map</code> implementations.</p>
<p>In JPA 1.0 the map key must be a mapped attribute of the collection values. The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/MapKey.html" target="_blank"><code>@MapKey</code></a> annotation or <code>&lt;map-key&gt;</code> XML element is used to define a map relationship. If the <code>MapKey</code> is not specified it defaults to the target object's <code>Id</code>.</p>
<h4><span class="mw-headline" id="Example_of_a_map_key_relationship_annotation">Example of a map key relationship annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"owner"</span><span class="o">)</span>
  <span class="nd">@MapKey</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"type"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PhoneNumber</span><span class="o">&gt;</span> <span class="n">phoneNumbers</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhoneNumber</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="nd">@Basic</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>  <span class="c1">// Either "home", "work", or "fax".</span>
  <span class="o">...</span>
  <span class="nd">@ManyToOne</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_a_map_key_relationship_XML">Example of a map key relationship XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phoneNumbers"</span> <span class="na">mapped-by=</span><span class="s">"owner"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map-key</span> <span class="na">name=</span><span class="s">"type"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"PhoneNumber"</span> <span class="na">class=</span><span class="s">"org.acme.PhoneNumber"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"type"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">name=</span><span class="s">"owner"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Map_Key_Columns_.28JPA_2.0.29">Map Key Columns (JPA 2.0)</span></h3>
<p>JPA 2.0 allows for a <code>Map</code> where the key is not part of the target object to be persisted. The <code>Map</code> key can be any of the following:</p>
<ul>
<li>A <code>Basic</code> value, stored in the target's table or join table.</li>
<li>An <code>Embedded</code> object, stored in the target's table or join table.</li>
<li>A foreign key to another <code>Entity</code>, stored in the target's table or join table.</li>
</ul>
<p>Map columns can be used for any collection mapping including, <code>OneToMany</code>, <code>ManyToMany</code> and <code>ElementCollection</code>.</p>
<p>This allows for great flexibility and complexity in the number of different models that can be mapped. The type of mapping used is always determined by the value of the <code>Map</code>, not the key. So if the key is a <code>Basic</code> but the value is an <code>Entity</code> a <code>OneToMany</code> mapping is still used. But if the value is a <code>Basic</code> but the key is an <code>Entity</code> a <code>ElementCollection</code> mapping is used.</p>
<p>This allows some very sophisticated database schemas to be mapped. Such as a three way join table, can be mapped using a <code>ManyToMany</code> with a <code>MapKeyJoinColumn</code> for the third foreign key. For a <code>ManyToMany</code> the key is always stored in the <code>JoinTable</code>. For a <code>OneToMany</code> it is stored in the <code>JoinTable</code> if defined, otherwise it is stored in the target <code>Entity</code>'s table, even though the target <code>Entity</code> does not map this column. For an <code>ElementCollection</code> the key is stored in the element's table.</p>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/MapKeyColumn.html" target="_blank"><code>@MapKeyColumn</code></a> annotation or <code>&lt;map-key-column&gt;</code> XML element is used to define a map relationship where the key is a <code>Basic</code> value, the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/MapKeyEnumerated.html" target="_blank"><code>@MapKeyEnumerated</code></a> and <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/MapKeyTemporal.html" target="_blank"><code>@MapKeyTemporal</code></a> can also be used with this for <code>Enum</code> or <code>Calendar</code> types. The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/MapKeyJoinColumn.html" target="_blank"><code>@MapKeyJoinColumn</code></a> annotation or <code>&lt;map-key-join-column&gt;</code> XML element is used to define a map relationship where the key is an <code>Entity</code> value, the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/MapKeyJoinColumns.html" target="_blank"><code>@MapKeyJoinColumns</code></a> can also be used with this for composite foreign keys. The annotation <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/MapKeyClass.html" target="_blank"><code>@MapKeyClass</code></a> or <code>&lt;map-key-class&gt;</code> XML element can be used when the key is an <code>Embeddable</code> or to specify the target class or type if generics are not used.</p>
<h4><span class="mw-headline" id="Example_of_a_map_key_column_relationship_database">Example of a map key column relationship database</span></h4>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
<td>SALARY</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
<td>60000</td>
</tr>
</tbody></table>
<p>PHONE(table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>OWNER_ID</td>
<td>PHONE_TYPE</td>
<td>AREACODE</td>
<td>NUMBER</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>home</td>
<td>613</td>
<td>792-7777</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>cell</td>
<td>613</td>
<td>798-6666</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>home</td>
<td>416</td>
<td>792-9999</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>fax</td>
<td>416</td>
<td>798-5555</td>
</tr>
</tbody></table>
<h4><span class="mw-headline" id="Example_of_a_map_key_column_relationship_annotation">Example of a map key column relationship annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"owner"</span><span class="o">)</span>
  <span class="nd">@MapKeyColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PHONE_TYPE"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ManyToOne</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_a_map_key_column_relationship_XML">Example of a map key column relationship XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phones"</span> <span class="na">mapped-by=</span><span class="s">"owner"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map-key-column</span> <span class="na">name=</span><span class="s">"PHONE_TYPE"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Phone"</span> <span class="na">class=</span><span class="s">"org.acme.Phone"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">name=</span><span class="s">"owner"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_a_map_key_join_column_relationship_database">Example of a map key join column relationship database</span></h4>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
<td>SALARY</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
<td>60000</td>
</tr>
</tbody></table>
<p>PHONE(table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>OWNER_ID</td>
<td>PHONE_TYPE_ID</td>
<td>AREACODE</td>
<td>NUMBER</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>613</td>
<td>792-7777</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>2</td>
<td>613</td>
<td>798-6666</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>1</td>
<td>416</td>
<td>792-9999</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>3</td>
<td>416</td>
<td>798-5555</td>
</tr>
</tbody></table>
<p>PHONETYPE(table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>TYPE</td>
</tr>
<tr>
<td>1</td>
<td>home</td>
</tr>
<tr>
<td>2</td>
<td>cell</td>
</tr>
<tr>
<td>3</td>
<td>fax</td>
</tr>
<tr>
<td>4</td>
<td>work</td>
</tr>
</tbody></table>
<h4><span class="mw-headline" id="Example_of_a_map_key_join_column_relationship_annotation">Example of a map key join column relationship annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"owner"</span><span class="o">)</span>
  <span class="nd">@MapKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PHONE_TYPE_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PhoneType</span><span class="o">,</span> <span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ManyToOne</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhoneType</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@Basic</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_a_map_key_join_column_relationship_XML">Example of a map key join column relationship XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phones"</span> <span class="na">mapped-by=</span><span class="s">"owner"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map-key-join-column</span> <span class="na">name=</span><span class="s">"PHONE_TYPE_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Phone"</span> <span class="na">class=</span><span class="s">"org.acme.Phone"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">name=</span><span class="s">"owner"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"PhoneType"</span> <span class="na">class=</span><span class="s">"org.acme.PhoneType"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"type"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<p><br></p>
<h4><span class="mw-headline" id="Example_of_a_map_key_class_embedded_relationship_database">Example of a map key class embedded relationship database</span></h4>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
<td>SALARY</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
<td>60000</td>
</tr>
</tbody></table>
<p>EMPLOYEE_PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMPLOYEE_ID</td>
<td>PHONE_ID</td>
<td>TYPE</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>home</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>cell</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>home</td>
</tr>
<tr>
<td>2</td>
<td>4</td>
<td>fax</td>
</tr>
</tbody></table>
<p>PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>AREACODE</td>
<td>NUMBER</td>
</tr>
<tr>
<td>1</td>
<td>613</td>
<td>792-7777</td>
</tr>
<tr>
<td>2</td>
<td>613</td>
<td>798-6666</td>
</tr>
<tr>
<td>3</td>
<td>416</td>
<td>792-9999</td>
</tr>
<tr>
<td>4</td>
<td>416</td>
<td>798-5555</td>
</tr>
</tbody></table>
<h4><span class="mw-headline" id="Example_of_a_map_key_class_embedded_relationship_annotation">Example of a map key class embedded relationship annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span>
  <span class="nd">@MapKeyClass</span><span class="o">(</span><span class="n">PhoneType</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PhoneType</span><span class="o">,</span> <span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhoneType</span> <span class="o">{</span>
  <span class="nd">@Basic</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_a_map_key_class_embedded_relationship_XML">Example of a map key class embedded relationship XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phones"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map-key-class&gt;</span>PhoneType<span class="nt">&lt;/map-key-class&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Phone"</span> <span class="na">class=</span><span class="s">"org.acme.Phone"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">name=</span><span class="s">"owner"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;embeddable</span> <span class="na">name=</span><span class="s">"PhoneType"</span> <span class="na">class=</span><span class="s">"org.acme.PhoneType"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"type"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/embeddable&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Join_Fetching">Join Fetching</span></h2>
<p>Join fetching is a query optimization technique for reading multiple objects in a single database query. It involves joining the two object's tables in SQL and selecting both object's data. Join fetching is commonly used for <code>OneToOne</code> relationships, but also can be used for any relationship including <code>OneToMany</code> and <code>ManyToMany</code>.</p>
<p>Join fetching is one solution to the classic ORM <i>n+1</i> performance problem. The issue is if you select <i>n</i> <code>Employee</code> objects, and access each of their addresses, in basic ORM (including JPA) you will get <i>1</i> database select for the <code>Employee</code> objects, and then <i>n</i> database selects, one for each <code>Address</code> object. Join fetching solves this issue by only requiring one select, and selecting both the <code>Employee</code> and its <code>Address</code>.</p>
<p>JPA supports join fetching through JPQL using the <code>JOIN FETCH</code> syntax.</p>
<h4><span class="mw-headline" id="Example_of_JPQL_Join_Fetch">Example of JPQL Join Fetch</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">emp</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">emp</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">emp</span><span class="p">.</span><span class="n">address</span>
</pre></div>
<p>This causes both the <code>Employee</code> and <code>Address</code> data to be selected in a single query.</p>
<h3><span class="mw-headline" id="Outer_Joins">Outer Joins</span></h3>
<p>Using the JPQL <code>JOIN FETCH</code> syntax a normal <code>INNER</code> join is performed. This has the side effect of filtering any <code>Employee</code> from the result set that did not have an address. An <code>OUTER</code> join in SQL is one that does not filter absent rows on the join, but instead joins a row of all <code>null</code> values. If your relationship allows <code>null</code> or an empty collection for collection relationships, then you can use an <code>OUTER</code> join fetch, this is done in JPQL using the <code>LEFT</code> syntax.</p>
<p>Note that <code>OUTER</code> joins can be less efficient on some databases, so avoid using an <code>OUTER</code> if it is not required.</p>
<h4><span class="mw-headline" id="Example_of_JPQL_Outer_Join_Fetch">Example of JPQL Outer Join Fetch</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">emp</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">emp</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">emp</span><span class="p">.</span><span class="n">address</span>
</pre></div>
<h3><span class="mw-headline" id="Mapping_Level_Join_Fetch_and_EAGER">Mapping Level Join Fetch and EAGER</span></h3>
<p>JPA has no way to specify that a join fetch always be used for a relationship. Normally it is better to specify the join fetch at the query level, as some use cases may require the related objects, and other use cases may not. JPA does support an <code>EAGER</code> option on mappings, but this means that the relationship will be loaded, not that it will be joined. It may be desirable to mark all relationships as <code>EAGER</code> as everything is desired to be loaded, but join fetching everything in one huge select could result in a inefficient, overly complex, or invalid join on the database.</p>
<p>Some JPA providers do interpret <code>EAGER</code> as join fetch, so this may work on some JPA providers. Some JPA providers support a separate option for always join fetching a relationship.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support a <code>@JoinFetch</code> annotation and XML on a mapping to define that the relationship always be join fetched.</dd>
</dl>
<h3><span class="mw-headline" id="Nested_Joins">Nested Joins</span></h3>
<p>JPA 1.0 does not allow nested join fetches in JPQL, although this may be supported by some JPA providers. You can join fetch multiple relationships, but not nested relationships.</p>
<h4><span class="mw-headline" id="Example_of_Multiple_JPQL_Join_Fetch">Example of Multiple JPQL Join Fetch</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">emp</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">emp</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">emp</span><span class="p">.</span><span class="n">address</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">emp</span><span class="p">.</span><span class="n">phoneNumbers</span>
</pre></div>
<h3><span class="mw-headline" id="Duplicate_Data_and_Huge_Joins">Duplicate Data and Huge Joins</span></h3>
<p>One issue with join fetching is that duplicate data can be returned. For example consider join fetching an <code>Employee</code>'s phoneNumbers relationship. If each <code>Employee</code> has 3 <code>Phone</code> objects in its phoneNumbers collection, the join will require to bring back <i>n</i>*3 rows. As there are 3 phone rows for each employee row, the employee row will be duplicated 3 times. So you are reading more data than if you have selected the objects in <i>n+1</i> queries. Normally the fact that your executing fewer queries makes up for the fact that you may be reading duplicate data, but if you consider joining multiple collection relationships you can start to get back <i>j*i</i> duplicate data which can start to become an issue. Even with <code>ManyToOne</code> relationships you can be selecting duplicate data. Consider join fetching an <code>Employee</code>'s manager: if all or most employee's have the same manager, you will end up selecting this manager's data many times. In this case you would be better off not using join fetch, and allowing a single query for the manager.</p>
<p>If you start join fetching every relationship, you can start to get some pretty huge joins. This can sometimes be an issue for the database, especially with huge outer joins.</p>
<p>One alternative solution to join fetch that does not suffer from duplicate data is using <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Batch_Fetching">Batch Fetching</a>.</p>
<h2><span class="mw-headline" id="Batch_Fetching">Batch Fetching</span></h2>
<p>Batch fetching is a query optimization technique for reading multiple related objects in a finite set of database queries. It involves executing the query for the root objects as normal. But for the related objects the original query is joined with the query for the related objects, allowing all of the related objects to be read in a single database query. Batch fetching can be used for any type of relationship.</p>
<p>Batch fetching is one solution to the classic ORM <i>n+1</i> performance problem. The issue is if you select <i>n</i> <code>Employee</code> objects, and access each of their addresses, in basic ORM (including JPA) you will get <i>1</i> database select for the <code>Employee</code> objects, and then <i>n</i> database selects, one for each <code>Address</code> object. Batch fetching solves this issue by requiring one select for the <code>Employee</code> objects and one select for the <code>Address</code> objects.</p>
<p>Batch fetching is more optimal for reading collection relationships and multiple relationships as it does not require selecting duplicate data as in join fetching.</p>
<p>JPA does not support batch reading, but some JPA providers do.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support a <code>@BatchFetch</code> annotation and xml element and a <code>"eclipselink.batch"</code> query hint to enable batch reading. Three forms of batch fetching are supported, <code>JOIN</code>, <code>EXISTS</code>, and <code>IN</code>.</dd>
</dl>
<p>See also,</p>
<ul>
<li><a rel="nofollow" class="external text" href="http://java-persistence-performance.blogspot.com/2010/08/batch-fetching-optimizing-object-graph.html" target="_blank">Batch fetching - optimizing object graph loading</a></li>
</ul>
<h2><span class="mw-headline" id="Filtering.2C_Complex_Joins">Filtering, Complex Joins</span></h2>
<p>Normally a relationship is based on a foreign key in the database, but on occasion it is always based on other conditions. Such as <code>Employee</code> having many <code>PhoneNumber</code>s but also a single home phone, or one of his phones that has the <code>"home"</code> type, or a collection of "active" projects, or other such condition.</p>
<p>JPA does not support mapping these types of relationships, as it only supports mappings defined by foreign keys, not based on other columns, constant values, or functions. Some JPA providers may support this. Workarounds include, mapping the foreign key part of the relationship, then filtering the results in your get/set methods of your object. You could also query for the results, instead of defining a relationship.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support filtering and complex relationships through several mechanisms. You can use a <code>DescriptorCustomizer</code> to define a <code>selectionCriteria</code> on any mapping using the <code>Expression</code> criteria API. This allows for any condition to be applied including constants, functions, or complex joins. You can also use a <code>DescriptorCustomizer</code> to define the SQL or define a <code>StoredProcedureCall</code> for the mapping's <code>selectionQuery</code>.</dd>
</dl>
<h2><span class="mw-headline" id="Variable_and_Heterogeneous_Relationships">Variable and Heterogeneous Relationships</span></h2>
<p>It is sometimes desirable to define a relationship where the type of the relationship can be one of several unrelated, heterogeneous values. This could either be a OneToOne, ManyToOne, OneToMany or ManyToMany relationship. The related values may share a common interface, or may share nothing in common other than subclassing <code>Object</code>. It is also possible to conceive of a relationship that could also be any <code>Basic</code> value, or even an <code>Embeddable</code>.</p>
<p>In general JPA does not support variable, interface, or heterogeneous relationships. JPA does support relationships to inheritance classes, so the easiest workaround is normally to define a common superclass for the related values.</p>
<p>Another solution is to define virtual attributes using get/set methods for each possible implementer, and map these separately, and mark the heterogeneous get/set as <code>transient</code>. You could also not map the attribute, and instead query for it as required.</p>
<p>For heterogeneous <code>Basic</code> or <code>Embeddable</code> relationships one solution is to serialize the value to a binary field. You could also convert the value to a <code>String</code> representation that you can restore the value from, or store the value to two columns, one storing the <code>String</code> value and the other the class name or type.</p>
<p>Some JPA providers have support for interfaces, variable relationships, and/or heterogeneous relationships.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>, <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support variable relationships through their <code>@VariableOneToOne</code> annotation and XML. Mapping to and querying interfaces are also supported through their <code>ClassDescriptor</code>'s <code>InterfacePolicy</code> API.</dd>
</dl>
<h2><span class="mw-headline" id="Nested_Collections.2C_Maps_and_Matrices">Nested Collections, Maps and Matrices</span></h2>
<p>It is somewhat common in an object model to have complex collection relationships such as a <code>List</code> of <code>List</code>s (i.e. a matrix), or a <code>Map</code> of <code>Map</code>s, or a <code>Map</code> of <code>List</code>s, and so on. Unfortunately these types of collections map very poorly to a relational database.</p>
<p>JPA does not support nested collection relationships, and normally it is best to change your object model to avoid them to make persistence and querying easier. One solution is to create an object that wraps the nested collection.</p>
<p>For example if an <code>Employee</code> had a <code>Map</code> of <code>Project</code>s keyed by a <code>String</code> project-type and the value a <code>List</code> or <code>Project</code>s. To map this a new <code>ProjectType</code> class could be created to store the project-type and a <code>OneToMany</code> to <code>Project</code>.</p>
<h4><span class="mw-headline" id="Example_nested_collection_model_.28original.29">Example nested collection model (original)</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Project</span><span class="o">&gt;&gt;</span> <span class="n">projects</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_nested_collection_model_.28modified.29">Example nested collection model (modified)</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@GeneratedValue</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"employee"</span><span class="o">)</span>
  <span class="nd">@MapKey</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"type"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ProjectType</span><span class="o">&gt;</span> <span class="n">projects</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectType</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@GeneratedValue</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="nd">@ManyToOne</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">employee</span><span class="o">;</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PROJ_TYPE"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
  <span class="nd">@ManyToMany</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Project</span><span class="o">&gt;</span> <span class="n">projects</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_nested_collection_database">Example nested collection database</span></h4>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
<td>SALARY</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
<td>60000</td>
</tr>
</tbody></table>
<p>PROJECTTYPE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>EMPLOYEE_ID</td>
<td>PROJ_TYPE</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>small</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>medium</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>large</td>
</tr>
</tbody></table>
<p>PROJECTTYPE_PROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>PROJECTTYPE_ID</td>
<td>PROJECT_ID</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
</tr>
</tbody></table>
<h1><span class="mw-headline" id="OneToOne">OneToOne</span></h1>
<p><a href="https://commons.wikimedia.org/wiki/File:ObjectRelational-OneToOne.jpg" class="image"><img alt="ObjectRelational-OneToOne.jpg" src="./JPA_Wikibooks_files/ObjectRelational-OneToOne.jpg" width="522" height="406" data-file-width="522" data-file-height="406"></a></p>
<p>A <code>OneToOne</code> relationship in Java is where the source object has an attribute that references another target object and (if) that target object had the inverse relationship back to the source object it would also be a <code>OneToOne</code> relationship. All relationships in Java and JPA are unidirectional, in that if a source object references a target object there is no guarantee that the target object also has a relationship to the source object. This is different than a relational database, in which relationships are defined through foreign keys and querying such that the inverse query always exists.</p>
<p>JPA also defines a <code><a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToOne" title="Java Persistence/ManyToOne">ManyToOne</a></code> relationship, which is similar to a <code>OneToOne</code> relationship except that the inverse relationship (if it were defined) is a <code>OneToMany</code> relationship. The main difference between a <code>OneToOne</code> and a <code>ManyToOne</code> relationship in JPA is that a <code>ManyToOne</code> always contains a foreign key from the source object's table to the target object's table, where as a <code>OneToOne</code> relationship the foreign key may either be in the source object's table or the target object's table. If the foreign key is in the target object's table JPA requires that the relationship be bi-directional (must be defined in both objects), and the source object must use the <code>mappedBy</code> attribute to define the mapping.</p>
<p>In JPA a <code>OneToOne</code> relationship is defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/OneToOne.html" target="_blank">@OneToOne</a></code> annotation or the <code>&lt;one-to-one&gt;</code> element. A <code>OneToOne</code> relationship typically requires a <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/JoinColumn.html" target="_blank">@JoinColumn</a></code> or <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/JoinColumns.html" target="_blank">@JoinColumns</a></code> if a composite primary key.</p>
<h4><span class="mw-headline" id="Example_of_a_OneToOne_relationship_database">Example of a OneToOne relationship database</span></h4>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
<td>SALARY</td>
<td>ADDRESS_ID</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
<td>6</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
<td>60000</td>
<td>7</td>
</tr>
</tbody></table>
<p>ADDRESS (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ADDRESS_ID</td>
<td>STREET</td>
<td>CITY</td>
<td>PROVINCE</td>
<td>COUNTRY</td>
<td>P_CODE</td>
</tr>
<tr>
<td>6</td>
<td>17 Bank St</td>
<td>Ottawa</td>
<td>ON</td>
<td>Canada</td>
<td>K2H7Z5</td>
</tr>
<tr>
<td>7</td>
<td>22 Main St</td>
<td>Toronto</td>
<td>ON</td>
<td>Canada</td>
<td>L5H2D5</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_a_OneToOne_relationship_annotations">Example of a OneToOne relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ADDRESS_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_OneToOne_relationship_XML">Example of a OneToOne relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"EMP_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;one-to-one</span> <span class="na">name=</span><span class="s">"address"</span> <span class="na">fetch=</span><span class="s">"LAZY"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"ADDRESS_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/one-to-one&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Inverse_Relationships.2C_Target_Foreign_Keys_and_Mapped_By">Inverse Relationships, Target Foreign Keys and Mapped By</span></h2>
<p>A typical object centric perspective of a <code>OneToOne</code> relationship has the data model mirror the object model, in that the <i>source</i> object has a pointer to the <i>target</i> object, so the database <i>source</i> table has a foreign key to the <i>target</i> table. This is not how things always work out in the database though, in fact many database developers would think having the foreign key in the <i>target</i> table to be logical, as this enforces the uniqueness of the <code>OneToOne</code> relationship. Personally I prefer the object perspective, however you will most likely encounter both.</p>
<p>To start considering a bi-directional <code>OneToOne</code> relationship, you do not require two foreign keys, one in each table, so a single foreign key in the <i>owning</i> side of the relationship is sufficient. In JPA the <i>inverse</i> <code>OneToOne</code> <i>must</i> use the <code>mappedBy</code> attribute (<a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Target_Foreign_Keys.2C_Primary_Key_Join_Columns.2C_Cascade_Primary_Keys">with some exceptions</a>), this makes the JPA provider use the foreign key and mapping information in the <i>source</i> mapping to define the <i>target</i> mapping.</p>
<p>See also, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Target_Foreign_Keys.2C_Primary_Key_Join_Columns.2C_Cascade_Primary_Keys">Target Foreign Keys, Primary Key Join Columns, Cascade Primary Keys</a>.</p>
<p>The following gives an example of what the inverse <code>address</code> relationship would look like.</p>
<h3><span class="mw-headline" id="Example_of_an_inverse_OneToOne_relationship_annotations">Example of an inverse OneToOne relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"ADDRESS_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">mappedBy</span><span class="o">=</span><span class="s">"address"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_an_inverse_OneToOne_relationship_XML">Example of an inverse OneToOne relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Address"</span> <span class="na">class=</span><span class="s">"org.acme.Address"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-one</span> <span class="na">name=</span><span class="s">"owner"</span> <span class="na">fetch=</span><span class="s">"LAZY"</span> <span class="na">mapped-by=</span><span class="s">"address"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="See_Also_2">See Also</span></h2>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships" title="Java Persistence/Relationships">Relationships</a>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Cascading" title="Java Persistence/Relationships">Cascading</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Lazy_Fetching" title="Java Persistence/Relationships">Lazy Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Target_Entity" title="Java Persistence/Relationships">Target Entity</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Join_Fetching" title="Java Persistence/Relationships">Join Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Batch_Reading" title="Java Persistence/Relationships">Batch Reading</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Common_Problems" title="Java Persistence/Relationships">Common Problems</a></li>
</ul>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToOne" title="Java Persistence/ManyToOne">ManyToOne</a></li>
</ul>
<h2><span class="mw-headline" id="Common_Problems_12">Common Problems</span></h2>
<h5><span class="mw-headline" id="Foreign_key_is_also_part_of_the_primary_key."><i>Foreign key is also part of the primary key.</i></span></h5>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Identity_and_Sequencing#Primary_Keys_through_OneToOne_and_ManyToOne_Relationships" title="Java Persistence/Identity and Sequencing">Primary Keys through OneToOne Relationships</a>.</dd>
</dl>
<h5><span class="mw-headline" id="Foreign_key_is_also_mapped_as_a_basic."><i>Foreign key is also mapped as a basic.</i></span></h5>
<dl>
<dd>If you use the same field in two different mappings, you typically require to make one of them read-only using <code>insertable, updatable = false</code>.</dd>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Target_Foreign_Keys.2C_Primary_Key_Join_Columns.2C_Cascade_Primary_Keys">Target Foreign Keys, Primary Key Join Columns, Cascade Primary Keys</a>.</dd>
</dl>
<h5><span class="mw-headline" id="Constraint_error_on_insert."><i>Constraint error on insert.</i></span></h5>
<dl>
<dd>This typically occurs because you have incorrectly mapped the foreign key in a <code>OneToOne</code> relationship.
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Target_Foreign_Keys.2C_Primary_Key_Join_Columns.2C_Cascade_Primary_Keys">Target Foreign Keys, Primary Key Join Columns, Cascade Primary Keys</a>.</dd>
</dl>
</dd>
</dl>
<dl>
<dd>It can also occur if your JPA provider does not support referential integrity, or does not resolve bi-directional constraints. In this case you may either need to remove the constraint, or use <code>EntityManager</code> <code>flush()</code> to ensure the order your objects are written in.</dd>
</dl>
<h5><span class="mw-headline" id="Foreign_key_value_is_null"><i>Foreign key value is null</i></span></h5>
<dl>
<dd>Ensure you set the value of the object's <code>OneToOne</code>, if the <code>OneToOne</code> is part of a bi-directional <code>OneToOne</code> relationship, ensure you set <code>OneToOne</code> in both objects, JPA does not maintain bi-directional relationships for you.</dd>
<dd>Also check that you defined the <code>JoinColumn</code> correctly, ensure you did not set <code>insertable, updatable = false</code> or use a <code>PrimaryKeyJoinColumn</code>, or <code>mappedBy</code>.</dd>
</dl>
<h1><span class="mw-headline" id="Advanced_8">Advanced</span></h1>
<h2><span class="mw-headline" id="Target_Foreign_Keys.2C_Primary_Key_Join_Columns.2C_Cascade_Primary_Keys">Target Foreign Keys, Primary Key Join Columns, Cascade Primary Keys</span></h2>
<p>If a <code>OneToOne</code> relationship uses a <i>target foreign key</i> (the foreign key is in the target table, not the source table), then JPA requires that you define a <code>OneToOne</code> mapping in both directions, and that the <i>target foreign key</i> mapping use the <code>mappedBy</code> attribute. The reason for this, is the mapping in the source object only affects the row the JPA writes to the source table, if the foreign key is in the target table, JPA has no easy way to write this field.</p>
<p>There are other ways around this problem however. In JPA the <code>JoinColumn</code> defines an <code>insertable</code> and <code>updatable</code> attribute, these can be used to instruct the JPA provider that the foreign key is actually in the target object's table. With these enabled JPA will not write anything to the source table, most JPA providers will also infer that the foreign key constraint is in the target table to preserve referential integrity on insertion. JPA also defines the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/PrimaryKeyJoinColumn.html" target="_blank">@PrimaryKeyJoinColumn</a></code> that can be used to define the same thing. You still must map the foreign key in the target object in some fashion though, but could just use a <code>Basic</code> mapping to do this.</p>
<p>Some JPA providers may support an option for a unidirectional <code>OneToOne</code> mapping for target foreign keys.</p>
<p>Target foreign keys can be tricky to understand, so you might want to read this section twice. They can get even more complex though. If you have a data model that cascades primary keys then you can end up with a single <code>OneToOne</code> that has both a logical foreign key, but has some fields in it that are logically target foreign keys.</p>
<p>For example consider <code>Company</code>, <code>Department</code>, <code>Employee</code>. <code>Company</code>'s id is <code>COM_ID</code>, <code>Department</code>'s id is a composite primary key of <code>COM_ID</code> and <code>DEPT_ID</code>, and <code>Employee</code>'s id is a composite primary key of <code>COM_ID</code>, <code>DEP_ID</code>, and <code>EMP_ID</code>. So for an <code>Employee</code> its relationship to <code>company</code> uses a normal <code>ManyToOne</code> with a foreign key, but its relationship to <code>department</code> uses a <code>ManyToOne</code> with a foreign key, but the <code>COM_ID</code> uses <code>insertable, updatable = false</code> or <code>PrimaryKeyJoinColumn</code>, because it is actually mapped through the <code>company</code> relationship. The <code>Employee</code>'s relationship to its <code>address</code> then uses a normal foreign key for <code>ADD_ID</code> but a target foreign key for <code>COM_ID</code>, <code>DEP_ID</code>, and <code>EMP_ID</code>.</p>
<p>This may work in some JPA providers, others may require different configuration, or not support this type of data model.</p>
<h4><span class="mw-headline" id="Example_of_cascaded_primary_keys_database">Example of cascaded primary keys database</span></h4>
<p>COMPANY(table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>COM_ID</td>
<td>NAME</td>
</tr>
<tr>
<td>1</td>
<td>ACME</td>
</tr>
<tr>
<td>2</td>
<td>Wikimedia</td>
</tr>
</tbody></table>
<p>DEPARTMENT(table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>COM_ID</td>
<td>DEP_ID</td>
<td>NAME</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>Billing</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>Research</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>Accounting</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>Research</td>
</tr>
</tbody></table>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>COM_ID</td>
<td>DEP_ID</td>
<td>EMP_ID</td>
<td>NAME</td>
<td>MNG_ID</td>
<td>ADD_ID</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>Bob Way</td>
<td>null</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>2</td>
<td>Joe Smith</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>1</td>
<td>Sarah Way</td>
<td>null</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>2</td>
<td>John Doe</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>1</td>
<td>Jane Doe</td>
<td>null</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>1</td>
<td>Alice Smith</td>
<td>null</td>
<td>1</td>
</tr>
</tbody></table>
<p>ADDRESS(table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>COM_ID</td>
<td>DEP_ID</td>
<td>ADD_ID</td>
<td>ADDRESS</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>17 Bank, Ottawa, ONT</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>2</td>
<td>22 Main, Ottawa, ONT</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>1</td>
<td>255 Main, Toronto, ONT</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>2</td>
<td>12 Main, Winnipeg, MAN</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>1</td>
<td>72 Riverside, Winnipeg, MAN</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>1</td>
<td>82 Riverside, Winnipeg, MAN</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_cascaded_primary_keys_and_mixed_OneToOne_and_ManyToOne_mapping_annotations">Example of cascaded primary keys and mixed OneToOne and ManyToOne mapping annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@IdClass</span><span class="o">(</span><span class="n">EmployeeId</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">employeeId</span><span class="o">;</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DEP_ID"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">departmentId</span><span class="o">;</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">companyId</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Company</span> <span class="n">company</span><span class="o">;</span>
  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumns</span><span class="o">({</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DEP_ID"</span><span class="o">),</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
  <span class="o">})</span>
  <span class="kd">private</span> <span class="n">Department</span> <span class="n">department</span><span class="o">;</span>
  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumns</span><span class="o">({</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"MNG_ID"</span><span class="o">),</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DEP_ID"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">),</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
  <span class="o">})</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">manager</span><span class="o">;</span>
  <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumns</span><span class="o">({</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ADD_ID"</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DEP_ID"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">),</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
  <span class="o">})</span>
  <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_cascaded_primary_keys_and_mixed_OneToOne_and_ManyToOne_mapping_annotations_using_PrimaryKeyJoinColumn">Example of cascaded primary keys and mixed OneToOne and ManyToOne mapping annotations using PrimaryKeyJoinColumn</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@IdClass</span><span class="o">(</span><span class="n">EmployeeId</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">employeeId</span><span class="o">;</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DEP_ID"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">departmentId</span><span class="o">;</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">companyId</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Company</span> <span class="n">company</span><span class="o">;</span>
  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DEP_ID"</span><span class="o">)</span>
  <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Department</span> <span class="n">department</span><span class="o">;</span>
  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"MNG_ID"</span><span class="o">)</span>
  <span class="nd">@PrimaryKeyJoinColumns</span><span class="o">({</span>
    <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DEP_ID"</span><span class="o">)</span>
    <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">)</span>
  <span class="o">})</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">manager</span><span class="o">;</span>
  <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ADD_ID"</span><span class="o">)</span>
  <span class="nd">@PrimaryKeyJoinColumns</span><span class="o">({</span>
    <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DEP_ID"</span><span class="o">)</span>
    <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COM_ID"</span><span class="o">)</span>
  <span class="o">})</span>
  <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Mapping_a_OneToOne_Using_a_Join_Table">Mapping a OneToOne Using a Join Table</span></h2>
<p>In some data models, you may have a <code>OneToOne</code> relationship defined through a <i>join table</i>. For example consider you had existing <code>EMPLOYEE</code> and <code>ADDRESS</code> tables with no foreign key, and wanted to define a <code>OneToOne</code> relationship without changing the existing tables. To do this you could define an intermediate table that contained the primary key of both objects. This is similar to a <code>ManyToMany</code> relationship, but if you add a unique constraint to each foreign key you can enforce that it is <code>OneToOne</code> (or even <code>OneToMany</code>).</p>
<p>JPA defines a join table using the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/JoinTable.html" target="_blank">@JoinTable</a></code> annotation and <code>&lt;join-table&gt;</code> XML element. A <code>JoinTable</code> can be used on a <code>ManyToMany</code> or <code>OneToMany</code> mappings, but the JPA 1.0 specification is vague whether it can be used on a <code>OneToOne</code>. The <code>JoinTable</code> documentation does not state that it can be used in a <code>OneToOne</code>, but the XML schema for <code>&lt;one-to-one&gt;</code> does allow a nested <code>&lt;join-table&gt;</code> element. Some JPA providers may support this, and others may not.</p>
<p>If your JPA provider does not support this, you can workaround the issue by instead defining a <code>OneToMany</code> or <code>ManyToMany</code> relationship and just define a get/set method that returns/sets the first element on the collection.</p>
<h4><span class="mw-headline" id="Example_of_a_OneToOne_using_a_JoinTable_database">Example of a OneToOne using a JoinTable database</span></h4>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
<td>SALARY</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
<td>60000</td>
</tr>
</tbody></table>
<p>EMP_ADD(table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>ADDR_ID</td>
</tr>
<tr>
<td>1</td>
<td>6</td>
</tr>
<tr>
<td>2</td>
<td>7</td>
</tr>
</tbody></table>
<p>ADDRESS (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ADDRESS_ID</td>
<td>STREET</td>
<td>CITY</td>
<td>PROVINCE</td>
<td>COUNTRY</td>
<td>P_CODE</td>
</tr>
<tr>
<td>6</td>
<td>17 Bank St</td>
<td>Ottawa</td>
<td>ON</td>
<td>Canada</td>
<td>K2H7Z5</td>
</tr>
<tr>
<td>7</td>
<td>22 Main St</td>
<td>Toronto</td>
<td>ON</td>
<td>Canada</td>
<td>L5H2D5</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_a_OneToOne_using_a_JoinTable">Example of a OneToOne using a JoinTable</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre>  <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinTable</span><span class="o">(</span>
      <span class="n">name</span><span class="o">=</span><span class="s">"EMP_ADD"</span><span class="o">,</span>
      <span class="n">joinColumns</span><span class="o">=</span>
        <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">),</span>
      <span class="n">inverseJoinColumns</span><span class="o">=</span>
        <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ADDR_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ADDRESS_ID"</span><span class="o">))</span>
  <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">...</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_simulating_a_OneToOne_using_a_OneToMany_JoinTable">Example of simulating a OneToOne using a OneToMany JoinTable</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre>  <span class="nd">@OneToMany</span>
  <span class="nd">@JoinTable</span><span class="o">(</span>
      <span class="n">name</span><span class="o">=</span><span class="s">"EMP_ADD"</span>
      <span class="n">joinColumns</span><span class="o">=</span>
        <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">),</span>
      <span class="n">inverseJoinColumns</span><span class="o">=</span>
        <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ADDR_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ADDRESS_ID"</span><span class="o">))</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addresses</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getAddress</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">addresses</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">addresses</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAddress</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">addresses</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">addresses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">addresses</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="o">...</span>
</pre></div>
<h1><span class="mw-headline" id="ManyToOne">ManyToOne</span></h1>
<p><a href="https://commons.wikimedia.org/wiki/File:ObjectRelational-ManyToOne2.jpg" class="image"><img alt="ObjectRelational-ManyToOne2.jpg" src="./JPA_Wikibooks_files/ObjectRelational-ManyToOne2.jpg" width="572" height="376" data-file-width="572" data-file-height="376"></a></p>
<p>A <code>ManyToOne</code> relationship in Java is where the source object has an attribute that references another target object and (if) that target object had the inverse relationship back to the source object it would be a <code>OneToMany</code> relationship. All relationships in Java and JPA are unidirectional, in that if a source object references a target object there is no guarantee that the target object also has a relationship to the source object. This is different than a relational database, in which relationships are defined through foreign keys and querying such that the inverse query always exists.</p>
<p>JPA also defines a <code><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToOne" title="Java Persistence/OneToOne">OneToOne</a></code> relationship, which is similar to a <code>ManyToOne</code> relationship except that the inverse relationship (if it were defined) is a <code>OneToOne</code> relationship. The main difference between a <code>OneToOne</code> and a <code>ManyToOne</code> relationship in JPA is that a <code>ManyToOne</code> always contains a foreign key from the source object's table to the target object's table, where as a <code>OneToOne</code> relationship the foreign key may either be in the source object's table or the target object's table.</p>
<p>In JPA a <code>ManyToOne</code> relationship is defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/ManyToOne.html" target="_blank">@ManyToOne</a></code> annotation or the <code>&lt;many-to-one&gt;</code> element.</p>
<p>In JPA a <code>ManyToOne</code> relationship is always (well almost always) required to define a <code><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany" title="Java Persistence/OneToMany">OneToMany</a></code> relationship, the <code>ManyToOne</code> always defines the foreign key (<code>JoinColumn</code>) and the <code>OneToMany</code> must use a <code>mappedBy</code> to define its inverse <code>ManyToOne</code>.</p>
<h4><span class="mw-headline" id="Example_of_a_ManyToOne_relationship_database">Example of a ManyToOne relationship database</span></h4>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
<td>SALARY</td>
<td>MANAGER_ID</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
<td>75000</td>
<td>null</td>
</tr>
</tbody></table>
<p>PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>TYPE</td>
<td>AREA_CODE</td>
<td>P_NUMBER</td>
<td>OWNER_ID</td>
</tr>
<tr>
<td>1</td>
<td>home</td>
<td>613</td>
<td>792-0000</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>work</td>
<td>613</td>
<td>896-1234</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>work</td>
<td>416</td>
<td>123-4444</td>
<td>2</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_a_ManyToOne_relationship_annotations">Example of a ManyToOne relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_ManyToOne_relationship_XML">Example of a ManyToOne relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Phone"</span> <span class="na">class=</span><span class="s">"org.acme.Phone"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">name=</span><span class="s">"owner"</span> <span class="na">fetch=</span><span class="s">"LAZY"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/many-to-one&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="See_Also_3">See Also</span></h2>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships" title="Java Persistence/Relationships">Relationships</a>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Cascading" title="Java Persistence/Relationships">Cascading</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Lazy_Fetching" title="Java Persistence/Relationships">Lazy Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Target_Entity" title="Java Persistence/Relationships">Target Entity</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Join_Fetching" title="Java Persistence/Relationships">Join Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Batch_Reading" title="Java Persistence/Relationships">Batch Reading</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Common_Problems" title="Java Persistence/Relationships">Common Problems</a></li>
</ul>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToOne" title="Java Persistence/OneToOne">OneToOne</a>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToOne#Mapping_a_OneToOne_Using_a_Join_Table" title="Java Persistence/OneToOne">Mapping a OneToOne Using a Join Table</a></li>
</ul>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany" title="Java Persistence/OneToMany">OneToMany</a></li>
</ul>
<h2><span class="mw-headline" id="Common_Problems_13">Common Problems</span></h2>
<h5><span class="mw-headline" id="Foreign_key_is_also_part_of_the_primary_key._2"><i>Foreign key is also part of the primary key.</i></span></h5>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Identity_and_Sequencing#Primary_Keys_through_OneToOne_Relationships" title="Java Persistence/Identity and Sequencing">Primary Keys through OneToOne Relationships</a>.</dd>
</dl>
<h5><span class="mw-headline" id="Foreign_key_is_also_mapped_as_a_basic._2"><i>Foreign key is also mapped as a basic.</i></span></h5>
<dl>
<dd>If you use the same field in two different mappings, you typically require to make one of them read-only using <code>insertable, updateable = false</code>.</dd>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Target_Foreign_Keys.2C_Primary_Key_Join_Columns.2C_Cascade_Primary_Keys">Target Foreign Keys, Primary Key Join Columns, Cascade Primary Keys</a>.</dd>
</dl>
<h5><span class="mw-headline" id="Constraint_error_on_insert._2"><i>Constraint error on insert.</i></span></h5>
<dl>
<dd>This typically occurs because you have incorrectly mapped the foreign key in a <code>OneToOne</code> relationship.
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Target_Foreign_Keys.2C_Primary_Key_Join_Columns.2C_Cascade_Primary_Keys">Target Foreign Keys, Primary Key Join Columns, Cascade Primary Keys</a>.</dd>
</dl>
</dd>
</dl>
<dl>
<dd>It can also occur if your JPA provider does not support referential integrity, or does not resolve bi-directional constraints. In this case you may either need to remove the constraint, or use <code>EntityManager</code> <code>flush()</code> to ensure the order your objects are written in.</dd>
</dl>
<h5><span class="mw-headline" id="Foreign_key_value_is_null_2"><i>Foreign key value is null</i></span></h5>
<dl>
<dd>Ensure you set the value of the object's <code>OneToOne</code>, if the <code>OneToOne</code> is part of a bi-directional <code>OneToMany</code> relationship, ensure you set the object's <code>OneToOne</code> when adding an object to the <code>OneToMany</code>, JPA does not maintain bi-directional relationships for you.</dd>
<dd>Also check that you defined the <code>JoinColumn</code> correctly, ensure you did not set <code>insertable, updateable = false</code> or use a <code>PrimaryKeyJoinColumn</code>.</dd>
</dl>
<h1><span class="mw-headline" id="Advanced_9">Advanced</span></h1>
<h2><span class="mw-headline" id="Target_Foreign_Keys.2C_Primary_Key_Join_Columns.2C_Cascade_Primary_Keys_2">Target Foreign Keys, Primary Key Join Columns, Cascade Primary Keys</span></h2>
<p>In complex data models it may be required to use a target foreign key, or read-only <code>JoinColumn</code> in mapping a <code>ManyToOne</code> if the foreign key/<code>JoinColumn</code> is shared with other <code>ManyToOne</code> or <code>Basic</code> mappings.</p>
<p>See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToOne#Target_Foreign_Keys.2C_Primary_Key_Join_Columns.2C_Cascade_Primary_Keys" title="Java Persistence/OneToOne">Target Foreign Keys, Primary Key Join Columns, Cascade Primary Keys</a></p>
<h1><span class="mw-headline" id="OneToMany">OneToMany</span></h1>
<p><a href="https://commons.wikimedia.org/wiki/File:ObjectRelational-ManyToOne2.jpg" class="image"><img alt="ObjectRelational-ManyToOne2.jpg" src="./JPA_Wikibooks_files/ObjectRelational-ManyToOne2.jpg" width="572" height="376" data-file-width="572" data-file-height="376"></a></p>
<p>A <code>OneToMany</code> relationship in Java is where the source object has an attribute that stores a collection of target objects and <i>if</i> those target objects had the inverse relationship back to the source object it would be a <code>ManyToOne</code> relationship. All relationships in Java and JPA are unidirectional, in that if a source object references a target object there is no guarantee that the target object also has a relationship to the source object. This is different than a relational database, in which relationships are defined through foreign keys and querying such that the inverse query always exists.</p>
<p>JPA also defines a <code><a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToMany" title="Java Persistence/ManyToMany">ManyToMany</a></code> relationship, which is similar to a <code>OneToMany</code> relationship except that the inverse relationship (if it were defined) is a <code>ManyToMany</code> relationship. The main difference between a <code>OneToMany</code> and a <code>ManyToMany</code> relationship in JPA is that a <code>ManyToMany</code> always makes use of an intermediate relational join table to store the relationship, whereas a <code>OneToMany</code> can either use a join table, or a foreign key in target object's table referencing the source object table's primary key. If the <code>OneToMany</code> uses a foreign key in the target object's table JPA requires that the relationship be bi-directional (inverse <code>ManyToOne</code> relationship must be defined in the target object), and the source object must use the <code>mappedBy</code> attribute to define the mapping.</p>
<p>In JPA a <code>OneToMany</code> relationship is defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/OneToMany.html" target="_blank">@OneToMany</a></code> annotation or the <code>&lt;one-to-many&gt;</code> element.</p>
<h3><span class="mw-headline" id="Example_of_a_OneToMany_relationship_database">Example of a OneToMany relationship database</span></h3>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
<td>SALARY</td>
<td>MANAGER_ID</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
<td>75000</td>
<td>null</td>
</tr>
</tbody></table>
<p>PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>TYPE</td>
<td>AREA_CODE</td>
<td>P_NUMBER</td>
<td>OWNER_ID</td>
</tr>
<tr>
<td>1</td>
<td>home</td>
<td>613</td>
<td>792-0000</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>work</td>
<td>613</td>
<td>896-1234</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>work</td>
<td>416</td>
<td>123-4444</td>
<td>2</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_a_OneToMany_relationship_and_inverse_ManyToOne_annotations">Example of a OneToMany relationship and inverse ManyToOne annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"owner"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_OneToMany_relationship_and_inverse_ManyToOne_XML">Example of a OneToMany relationship and inverse ManyToOne XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phones"</span> <span class="na">target-entity=</span><span class="s">"org.acme.Phone"</span> <span class="na">mapped-by=</span><span class="s">"owner"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Phone"</span> <span class="na">class=</span><span class="s">"org.acme.Phone"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">name=</span><span class="s">"owner"</span> <span class="na">fetch=</span><span class="s">"LAZY"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/many-to-one&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<p>Note this <code>@OneToMany</code> mapping requires an inverse <code>@ManyToOne</code> mapping to be complete, see <a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToOne" title="Java Persistence/ManyToOne">ManyToOne</a>.</p>
<h3><span class="mw-headline" id="Getters_and_Setters">Getters and Setters</span></h3>
<p>As the relationship is bi-directional so as the application updates one side of the relationship, the other side should also get updated, and be in synch. In JPA, as in Java in general it is the responsibility of the application, or the object model to maintain relationships. If your application adds to one side of a relationship, then it must add to the other side.</p>
<p>This can be resolved through add or set methods in the object model that handle both sides of the relationships, so the application code does not need to worry about it. There are two ways to go about this, you can either only add the relationship maintenance code to one side of the relationship, and only use the setter from one side (such as making the other side protected), or add it to both sides and ensure you avoid an infinite loop.</p>
<p>For example:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">List</span> <span class="n">phones</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addPhone</span><span class="o">(</span><span class="n">Phone</span> <span class="n">phone</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">phones</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">phone</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">phone</span><span class="o">.</span><span class="na">getOwner</span><span class="o">()</span> <span class="o">!=</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">phone</span><span class="o">.</span><span class="na">setOwner</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Employee</span> <span class="n">owner</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOwner</span><span class="o">(</span><span class="n">Employee</span> <span class="n">employee</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">employee</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">employee</span><span class="o">.</span><span class="na">getPhones</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="k">this</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">employee</span><span class="o">.</span><span class="na">getPhones</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<p>Some expect the JPA provider to have magic that automatically maintains relationships. This was actually part of the EJB CMP 2 specification. However the issue is if the objects are detached or serialized to another VM, or new objects are related before being managed, or the object model is used outside the scope of JPA, then the magic is gone, and the application is left figuring things out, so in general it may be better to add the code to the object model. However some JPA providers do have support for automatically maintaining relationships.</p>
<p>In some cases it is undesirable to instantiate a large collection when adding a child object. One solution is to not map the bi-directional relationship, and instead query for it as required. Also some JPA providers optimize their lazy collection objects to handle this case, so you can still add to the collection without instantiating it.</p>
<h2><span class="mw-headline" id="Join_Table">Join Table</span></h2>
<p>A common mismatch between objects and relational tables is that a <code>OneToMany</code> does not require a back reference in Java, but requires a back reference foreign key in the database. Normally it is best to define the <code>ManyToOne</code> back reference in Java, if you cannot or don't want to do this, then you can use an intermediate join table to store the relationship. This is similar to a <code>ManyToMany</code> relationship, but if you add a unique constraint to the target foreign key you can enforce that it is <code>OneToMany</code>.</p>
<p>JPA defines a join table using the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/JoinTable.html" target="_blank">@JoinTable</a></code> annotation and <code>&lt;join-table&gt;</code> XML element. A <code>JoinTable</code> can be used on a <code>ManyToMany</code> or <code>OneToMany</code> mappings.</p>
<p>See also, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Undirectional_OneToMany.2C_No_Inverse_ManyToOne.2C_No_Join_Table_.28JPA_2.0.29">Undirectional OneToMany</a></p>
<h3><span class="mw-headline" id="Example_of_a_OneToMany_using_a_JoinTable_database">Example of a OneToMany using a JoinTable database</span></h3>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
</tr>
</tbody></table>
<p>EMP_PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>PHONE_ID</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
</tr>
</tbody></table>
<p>PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>TYPE</td>
<td>AREA_CODE</td>
<td>P_NUMBER</td>
</tr>
<tr>
<td>1</td>
<td>home</td>
<td>613</td>
<td>792-0000</td>
</tr>
<tr>
<td>2</td>
<td>work</td>
<td>613</td>
<td>896-1234</td>
</tr>
<tr>
<td>3</td>
<td>work</td>
<td>416</td>
<td>123-4444</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_a_OneToMany_using_a_JoinTable_annotation">Example of a OneToMany using a JoinTable annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span>
  <span class="nd">@JoinTable</span>
  <span class="o">(</span>
      <span class="n">name</span><span class="o">=</span><span class="s">"EMP_PHONE"</span><span class="o">,</span>
      <span class="n">joinColumns</span><span class="o">={</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span> <span class="o">},</span>
      <span class="n">inverseJoinColumns</span><span class="o">={</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PHONE_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_OneToMany_using_a_JoinTable_XML">Example of a OneToMany using a JoinTable XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"EMP_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">name=</span><span class="s">"phones"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;join-table</span> <span class="na">name=</span><span class="s">"EMP_PHONE"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"EMP_ID"</span> <span class="na">referenced-column-name=</span><span class="s">"EMP_ID"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;inverse-join-column</span> <span class="na">name=</span><span class="s">"PHONE_ID"</span> <span class="na">referenced-column-name=</span><span class="s">"ID"</span> <span class="na">unique=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/join-table&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="See_Also_4">See Also</span></h2>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships" title="Java Persistence/Relationships">Relationships</a>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Cascading" title="Java Persistence/Relationships">Cascading</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Lazy_Fetching" title="Java Persistence/Relationships">Lazy Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Target_Entity" title="Java Persistence/Relationships">Target Entity</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Collections" title="Java Persistence/Relationships">Collections</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Maps" title="Java Persistence/Relationships">Maps</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Join_Fetching" title="Java Persistence/Relationships">Join Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Batch_Reading" title="Java Persistence/Relationships">Batch Reading</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Common_Problems" title="Java Persistence/Relationships">Common Problems</a></li>
</ul>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToOne" title="Java Persistence/ManyToOne">ManyToOne</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToMany" title="Java Persistence/ManyToMany">ManyToMany</a></li>
</ul>
<h2><span class="mw-headline" id="Common_Problems_14">Common Problems</span></h2>
<h5><span class="mw-headline" id="Object_not_in_collection_after_refresh."><i>Object not in collection after refresh.</i></span></h5>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Object_corruption.2C_one_side_of_the_relationship_is_not_updated_after_updating_the_other_side" title="Java Persistence/Relationships">Object corruption</a>.</dd>
</dl>
<h1><span class="mw-headline" id="Advanced_10">Advanced</span></h1>
<h2><span class="mw-headline" id="Unidirectional_OneToMany.2C_No_Inverse_ManyToOne.2C_No_Join_Table_.28JPA_2.0_ONLY.29">Unidirectional OneToMany, No Inverse ManyToOne, No Join Table <b>(JPA 2.0 ONLY)</b></span></h2>
<p>JPA 1.0 does not support a unidirectional <code>OneToMany</code> relationship without a <code>JoinTable</code>. JPA 2.0 will have support for a unidirectional <code>OneToMany</code>. In JPA 2.0 a <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/JoinColumn.html" target="_blank">@JoinColumn</a></code> can be used on a <code>OneToMany</code> to define the foreign key, some JPA providers may support this already.</p>
<p>The main issue with an unidirectional <code>OneToMany</code> is that the foreign key is owned by the target object's table, so if the target object has no knowledge of this foreign key, inserting and updating the value is difficult. In a unidirectional <code>OneToMany</code> the source object take ownership of the foreign key field, and is responsible for updating its value.</p>
<p>The target object in a unidirectional <code>OneToMany</code> is an independent object, so it should not rely on the foreign key in any way, i.e. the foreign key cannot be part of its primary key, nor generally have a not null constraint on it. You can model a collection of objects where the target has no foreign key mapped, but uses it as its primary key, or has no primary key using a <code>Embeddable</code> collection mapping, see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Embeddables#Collections" title="Java Persistence/Embeddables">Embeddable Collections</a>.</p>
<p>If your JPA provider does not support unidirectional <code>OneToMany</code> relationships, then you will need to either add a back reference <code>ManyToOne</code> or a <code>JoinTable</code>. In general it is best to use a <code>JoinTable</code> if you truly want to model a unidirectional <code>OneToMany</code> on the database.</p>
<p>There are some creative workarounds to defining a unidirectional <code>OneToMany</code>. One is to map it using a <code>JoinTable</code>, but make the target table the <code>JoinTable</code>. This will cause an extra join, but work for the most part for reads, writes of course will not work correctly, so this is only a read-only solution and a hacky one at that.</p>
<h3><span class="mw-headline" id="Example_of_a_JPA_2.0_unidirectional_OneToMany_relationship_database">Example of a JPA 2.0 unidirectional OneToMany relationship database</span></h3>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
</tr>
</tbody></table>
<p>PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>TYPE</td>
<td>AREA_CODE</td>
<td>P_NUMBER</td>
<td>OWNER_ID</td>
</tr>
<tr>
<td>1</td>
<td>home</td>
<td>613</td>
<td>792-0000</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>work</td>
<td>613</td>
<td>896-1234</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>work</td>
<td>416</td>
<td>123-4444</td>
<td>2</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_a_JPA_2.0_unidirectional_OneToMany_relationship_annotations">Example of a JPA 2.0 unidirectional OneToMany relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h1><span class="mw-headline" id="ManyToMany">ManyToMany</span></h1>
<p>A <code>ManyToMany</code> relationship in Java is where the source object has an attribute that stores a collection of target objects and (if) those target objects had the inverse relationship back to the source object it would also be a <code>ManyToMany</code> relationship. All relationships in Java and JPA are unidirectional, in that if a source object references a target object there is no guarantee that the target object also has a relationship to the source object. This is different than a relational database, in which relationships are defined through foreign keys and querying such that the inverse query always exists.</p>
<p>JPA also defines a <code><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany" title="Java Persistence/OneToMany">OneToMany</a></code> relationship, which is similar to a <code>ManyToMany</code> relationship except that the inverse relationship (if it were defined) is a <code>ManyToOne</code> relationship. The main difference between a <code>OneToMany</code> and a <code>ManyToMany</code> relationship in JPA is that a <code>ManyToMany</code> always makes use of a intermediate relational join table to store the relationship, where as a <code>OneToMany</code> can either use a join table, or a foreign key in target object's table referencing the source object table's primary key.</p>
<p>In JPA a <code>ManyToMany</code> relationship is defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/ManyToMany.html" target="_blank">@ManyToMany</a></code> annotation or the <code>&lt;many-to-many&gt;</code> element.</p>
<p>All <code>ManyToMany</code> relationships require a <code>JoinTable</code>. The <code>JoinTable</code> is defined using the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/JoinTable.html" target="_blank">@JoinTable</a></code> annotation and <code>&lt;join-table&gt;</code> XML element. The <code>JoinTable</code> defines a foreign key to the source object's primary key (<code>joinColumns</code>), and a foreign key to the target object's primary key (<code>inverseJoinColumns</code>). Normally the primary key of the <code>JoinTable</code> is the combination of both foreign keys.</p>
<h3><span class="mw-headline" id="Example_of_a_ManyToMany_relationship_database">Example of a ManyToMany relationship database</span></h3>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
</tr>
</tbody></table>
<p>EMP_PROJ (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>PROJ_ID</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
</tbody></table>
<p>PROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>NAME</td>
</tr>
<tr>
<td>1</td>
<td>GIS</td>
</tr>
<tr>
<td>2</td>
<td>SIG</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_a_ManyToMany_relationship_annotation">Example of a ManyToMany relationship annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ManyToMany</span>
  <span class="nd">@JoinTable</span><span class="o">(</span>
      <span class="n">name</span><span class="o">=</span><span class="s">"EMP_PROJ"</span><span class="o">,</span>
      <span class="n">joinColumns</span><span class="o">={</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)},</span>
      <span class="n">inverseJoinColumns</span><span class="o">={</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PROJ_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)})</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Project</span><span class="o">&gt;</span> <span class="n">projects</span><span class="o">;</span>
  <span class="o">.....</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_ManyToMany_relationship_XML">Example of a ManyToMany relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;attributes&gt;</span>
		<span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"EMP_ID"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;/id&gt;</span>
		<span class="nt">&lt;set</span> <span class="na">name=</span><span class="s">"projects"</span> <span class="na">table=</span><span class="s">"EMP_PROJ"</span> <span class="na">lazy=</span><span class="s">"true"</span> <span class="na">cascade=</span><span class="s">"none"</span> <span class="na">sort=</span><span class="s">"natural"</span> <span class="na">optimistic-lock=</span><span class="s">"false"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;key</span> <span class="na">column=</span><span class="s">"EMP_ID"</span> <span class="na">not-null=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
			<span class="nt">&lt;many-to-many</span> <span class="na">class=</span><span class="s">"com.flipswap.domain.Project"</span> <span class="na">column=</span><span class="s">"PROJ_ID"</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;/set&gt;</span>
	<span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Bi-directional_Many_to_Many">Bi-directional Many to Many</span></h2>
<p>Although a <code>ManyToMany</code> relationship is always bi-directional on the database, the object model can choose if it will be mapped in both directions, and in which direction it will be mapped in. If you choose to map the relationship in both directions, then one direction must be defined as the <i>owner</i> and the other must use the <code>mappedBy</code> attribute to define its mapping. This also avoids having to duplicate the <code>JoinTable</code> information in both places.</p>
<p>If the <code>mappedBy</code> is not used, then the persistence provider will assume there are two independent relationships, and you will end up getting duplicate rows inserted into the join table. If you have a conceptual bi-directional relationship, but have two different join tables in the database, then you must not use the <code>mappedBy</code>, as you need to maintain two independent tables.</p>
<p>As with all bi-directional relationships it is your object model's and application's responsibility to maintain the relationship in both direction. There is no <i>magic</i> in JPA, if you add or remove to one side of the collection, you must also add or remove from the other side, see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Object_corruption.2C_one_side_of_the_relationship_is_not_updated_after_updating_the_other_side" title="Java Persistence/Relationships">object corruption</a>. Technically the database will be updated correctly if you only add/remove from the <i>owning</i> side of the relationship, but then your object model will be out of synch, which can cause issues.</p>
<h3><span class="mw-headline" id="Example_of_an_inverse_ManyToMany_relationship_annotation">Example of an inverse ManyToMany relationship annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Project</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"projects"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">employees</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="See_Also_5">See Also</span></h2>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships" title="Java Persistence/Relationships">Relationships</a>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Cascading" title="Java Persistence/Relationships">Cascading</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Lazy_Fetching" title="Java Persistence/Relationships">Lazy Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Target_Entity" title="Java Persistence/Relationships">Target Entity</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Collections" title="Java Persistence/Relationships">Collections</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Maps" title="Java Persistence/Relationships">Maps</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Join_Fetching" title="Java Persistence/Relationships">Join Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Batch_Reading" title="Java Persistence/Relationships">Batch Reading</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Common_Problems" title="Java Persistence/Relationships">Common Problems</a></li>
</ul>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany" title="Java Persistence/OneToMany">OneToMany</a></li>
</ul>
<h2><span class="mw-headline" id="Common_Problems_15">Common Problems</span></h2>
<h5><span class="mw-headline" id="Object_not_in_collection_after_refresh._2"><i>Object not in collection after refresh.</i></span></h5>
<dl>
<dd>If you have a bi-directional <code>ManyToMany</code> relationship, ensure that you add to both sides of the relationship.</dd>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Object_corruption.2C_one_side_of_the_relationship_is_not_updated_after_updating_the_other_side" title="Java Persistence/Relationships">Object corruption</a>.</dd>
</dl>
<h5><span class="mw-headline" id="Additional_columns_in_join_table."><i>Additional columns in join table.</i></span></h5>
<dl>
<dd>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Mapping_a_Join_Table_with_Additional_Columns">Mapping a Join Table with Additional Columns</a></dd>
</dl>
<h5><span class="mw-headline" id="Duplicate_rows_inserted_into_the_join_table."><i>Duplicate rows inserted into the join table.</i></span></h5>
<dl>
<dd>If you have a bidirectional <code>ManyToMany</code> relationship, you must use <code>mappedBy</code> on one side of the relationship, otherwise it will be assumed to be two difference relationships and you will get duplicate rows inserted into the join table.</dd>
</dl>
<h1><span class="mw-headline" id="Advanced_11">Advanced</span></h1>
<h2><span class="mw-headline" id="Mapping_a_Join_Table_with_Additional_Columns">Mapping a Join Table with Additional Columns</span></h2>
<p>A frequent problem is that two classes have a <code>ManyToMany</code> relationship, but the relational join table has additional data. For example if <code>Employee</code> has a <code>ManyToMany</code> with <code>Project</code> but the PROJ_EMP join table also has an <code>IS_PROJECT_LEAD</code> column. In this case the best solution is to create a class that models the join table. So a <code>ProjectAssociation</code> class would be created. It would have a <code>ManyToOne</code> to <code>Employee</code> and <code>Project</code>, and attributes for the additional data. <code>Employee</code> and <code>Project</code> would have a <code>OneToMany</code> to the <code>ProjectAssociation</code>. Some JPA providers also provide additional support for mapping to join tables with additional data.</p>
<p>Unfortunately mapping this type of model becomes more <a href="https://en.wikibooks.org/wiki/Java_Persistence/Identity_and_Sequencing#Primary_Keys_through_OneToOne_and_ManyToOne_Relationships" title="Java Persistence/Identity and Sequencing">complicated</a> in JPA because it requires a composite primary key. The association object's <code>Id</code> is composed of the <code>Employee</code> and <code>Project</code> ids. The JPA 1.0 spec does not allow an <code>Id</code> to be used on a <code>ManyToOne</code> so the association class must have two duplicate attributes to also store the ids, and use an <code>IdClass</code>, these duplicate attributes must be kept in synch with the <code>ManyToOne</code> attributes. Some JPA providers may allow a <code>ManyToOne</code> to be part of an <code>Id</code>, so this may be simpler with some JPA providers. To make your life simpler, I would recommend adding a generated <code>Id</code> attribute to the association class. This will give the object a simpler <code>Id</code> and not require duplicating the <code>Employee</code> and <code>Project</code> ids.</p>
<p>This same pattern can be used no matter what the additional data in the join table is. Another usage is if you have a <code>Map</code> relationship between two objects, with a third unrelated object or data representing the <code>Map</code> key. The JPA spec requires that the <code>Map</code> key be an attribute of the <code>Map</code> value, so the <i>association object</i> pattern can be used to model the relationship.</p>
<p>If the additional data in the join table is only required on the database and not used in Java, such as auditing information, it may also be possible to use database triggers to automatically set the data.</p>
<h3><span class="mw-headline" id="Example_join_table_association_object_database">Example join table association object database</span></h3>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>FIRSTNAME</td>
<td>LASTNAME</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
</tr>
<tr>
<td>2</td>
<td>Sarah</td>
<td>Smith</td>
</tr>
</tbody></table>
<p>PROJ_EMP (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMPLOYEEID</td>
<td>PROJECTID</td>
<td>IS_PROJECT_LEAD</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>true</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>false</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>false</td>
</tr>
</tbody></table>
<p>PROJECT (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>ID</td>
<td>NAME</td>
</tr>
<tr>
<td>1</td>
<td>GIS</td>
</tr>
<tr>
<td>2</td>
<td>SIG</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_join_table_association_object_annotations">Example join table association object annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"employee"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ProjectAssociation</span><span class="o">&gt;</span> <span class="n">projects</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Project</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"project"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ProjectAssociation</span><span class="o">&gt;</span> <span class="n">employees</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="c1">// Add an employee to the project.</span>
  <span class="c1">// Create an association object for the relationship and set its data.</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addEmployee</span><span class="o">(</span><span class="n">Employee</span> <span class="n">employee</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">teamLead</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ProjectAssociation</span> <span class="n">association</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProjectAssociation</span><span class="o">();</span>
    <span class="n">association</span><span class="o">.</span><span class="na">setEmployee</span><span class="o">(</span><span class="n">employee</span><span class="o">);</span>
    <span class="n">association</span><span class="o">.</span><span class="na">setProject</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">association</span><span class="o">.</span><span class="na">setEmployeeId</span><span class="o">(</span><span class="n">employee</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="n">association</span><span class="o">.</span><span class="na">setProjectId</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="n">association</span><span class="o">.</span><span class="na">setIsTeamLead</span><span class="o">(</span><span class="n">teamLead</span><span class="o">);</span>

    <span class="k">this</span><span class="o">.</span><span class="na">employees</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">association</span><span class="o">);</span>
    <span class="c1">// Also add the association object to the employee.</span>
    <span class="n">employee</span><span class="o">.</span><span class="na">getProjects</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">association</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PROJ_EMP"</span><span class="o">)</span>
<span class="nd">@IdClass</span><span class="o">(</span><span class="n">ProjectAssociationId</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectAssociation</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">employeeId</span><span class="o">;</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">projectId</span><span class="o">;</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"IS_PROJECT_LEAD"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isProjectLead</span><span class="o">;</span>
  <span class="nd">@ManyToOne</span>
  <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMPLOYEEID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
  <span class="cm">/* if this JPA model doesn't create a table for the "PROJ_EMP" entity,</span>
<span class="cm">  *  please comment out the @PrimaryKeyJoinColumn, and use the ff:</span>
<span class="cm">  *  @JoinColumn(name = "employeeId", updatable = false, insertable = false)</span>
<span class="cm">  * or @JoinColumn(name = "employeeId", updatable = false, insertable = false, referencedColumnName = "id")</span>
<span class="cm">  */</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">employee</span><span class="o">;</span>
  <span class="nd">@ManyToOne</span>
  <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PROJECTID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
  <span class="cm">/* the same goes here:</span>
<span class="cm">  *  if this JPA model doesn't create a table for the "PROJ_EMP" entity,</span>
<span class="cm">  *  please comment out the @PrimaryKeyJoinColumn, and use the ff:</span>
<span class="cm">  *  @JoinColumn(name = "projectId", updatable = false, insertable = false)</span>
<span class="cm">  * or @JoinColumn(name = "projectId", updatable = false, insertable = false, referencedColumnName = "id")</span>
<span class="cm">  */</span>
  <span class="kd">private</span> <span class="n">Project</span> <span class="n">project</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectAssociationId</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kt">long</span> <span class="n">employeeId</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kt">long</span> <span class="n">projectId</span><span class="o">;</span>
  <span class="o">...</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">employeeId</span> <span class="o">+</span> <span class="n">projectId</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="k">instanceof</span> <span class="n">ProjectAssociationId</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ProjectAssociationId</span> <span class="n">otherId</span> <span class="o">=</span> <span class="o">(</span><span class="n">ProjectAssociationId</span><span class="o">)</span> <span class="n">object</span><span class="o">;</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">otherId</span><span class="o">.</span><span class="na">employeeId</span> <span class="o">==</span> <span class="k">this</span><span class="o">.</span><span class="na">employeeId</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">otherId</span><span class="o">.</span><span class="na">projectId</span> <span class="o">==</span> <span class="k">this</span><span class="o">.</span><span class="na">projectId</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<ul>
<li>If the given examples won't suit your expectations, try the solution indicated in this link:</li>
</ul>
<p><a rel="nofollow" class="external free" href="http://giannigar.wordpress.com/2009/09/04/mapping-a-many-to-many-join-table-with-extra-column-using-jpa/" target="_blank">http://giannigar.wordpress.com/2009/09/04/mapping-a-many-to-many-join-table-with-extra-column-using-jpa/</a></p>
<h1><span class="mw-headline" id="ElementCollection">ElementCollection</span></h1>
<p><a href="https://en.wikibooks.org/wiki/File:ObjectRelational-ElementCollection.jpg" class="image"><img alt="ObjectRelational-ElementCollection.jpg" src="./JPA_Wikibooks_files/ObjectRelational-ElementCollection.jpg" width="572" height="376" data-file-width="572" data-file-height="376"></a></p>
<p>JPA 2.0 defines an <code>ElementCollection</code> mapping. It is meant to handle several non-standard relationship mappings. An <code>ElementCollection</code> can be used to define a one-to-many relationship to an <code>Embeddable</code> object, or a <code>Basic</code> value (such as a collection of <code>String</code>s). An <code>ElementCollection</code> can also be used in combination with a <a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Map_Key_Columns_.28JPA_2.0.29" title="Java Persistence/Relationships"><code>Map</code></a> to define relationships where the key can be any type of object, and the value is an <code>Embeddable</code> object or a <code>Basic</code> value.</p>
<p>In JPA an <code>ElementCollection</code> relationship is defined through the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/ElementCollection.html" target="_blank">@ElementCollection</a></code> annotation or the <code>&lt;element-collection&gt;</code> element.</p>
<p>The <code>ElementCollection</code> values are always stored in a separate table. The table is defined through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/CollectionTable.html" target="_blank"><code>@CollectionTable</code></a> annotation or the <code>&lt;collection-table&gt;</code> element. The <code>CollectionTable</code> defines the table's <code>name</code> and <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/JoinColumn.html" target="_blank">@JoinColumn</a></code> or <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/JoinColumns.html" target="_blank">@JoinColumns</a></code> if a composite primary key.</p>
<h2><span class="mw-headline" id="Embedded_Collections">Embedded Collections</span></h2>
<p>An <code>ElementCollection</code> mapping can be used to define a collection of <code>Embeddable</code> objects. This is not a typical usage of <code>Embeddable</code> objects as the objects are not <i>embedded</i> in the source object's table, but stored in a separate collection table. This is similar to a <code>OneToMany</code>, except the target object is an <code>Embeddable</code> instead of an <code>Entity</code>. This allows collections of simple objects to be easily defined, without requiring the simple objects to define an <code>Id</code> or <code>ManyToOne</code> inverse mapping. <code>ElementCollection</code> can also override the mappings, or table for their collection, so you can have multiple entities reference the same <code>Embeddable</code> class, but have each store their dependent objects in a separate table.</p>
<p>The limitations of using an <code>ElementCollection</code> instead of a <code>OneToMany</code> is that the target objects cannot be queried, persisted, merged independently of their parent object. They are strictly privately-owned (dependent) objects, the same as an <code>Embedded</code> mapping. There is no <code>cascade</code> option on an <code>ElementCollection</code>, the target objects are always persisted, merged, removed with their parent. <code>ElementCollection</code> still can use a <code>fetch</code> type and defaults to <code>LAZY</code> the same as other collection mappings.</p>
<h3><span class="mw-headline" id="Example_of_an_ElementCollection_relationship_database">Example of an ElementCollection relationship database</span></h3>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>F_NAME</td>
<td>L_NAME</td>
<td>SALARY</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
</tr>
<tr>
<td>2</td>
<td>Joe</td>
<td>Smith</td>
<td>35000</td>
</tr>
</tbody></table>
<p>PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>OWNER_ID</td>
<td>TYPE</td>
<td>AREA_CODE</td>
<td>P_NUMBER</td>
</tr>
<tr>
<td>1</td>
<td>home</td>
<td>613</td>
<td>792-0001</td>
</tr>
<tr>
<td>1</td>
<td>work</td>
<td>613</td>
<td>494-1234</td>
</tr>
<tr>
<td>2</td>
<td>work</td>
<td>416</td>
<td>892-0005</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_an_ElementCollection_relationship_annotations">Example of an ElementCollection relationship annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ElementCollection</span>
  <span class="nd">@CollectionTable</span><span class="o">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s">"PHONE"</span><span class="o">,</span>
        <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">areaCode</span><span class="o">;</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"P_NUMBER"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">number</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_an_ElementCollection_relationship_XML">Example of an ElementCollection relationship XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"EMP_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;element-collection</span> <span class="na">name=</span><span class="s">"phones"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;collection-table</span> <span class="na">name=</span><span class="s">"PHONE"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/collection-table&gt;</span>
        <span class="nt">&lt;/element-collection&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;embeddable</span> <span class="na">name=</span><span class="s">"Phone"</span> <span class="na">class=</span><span class="s">"org.acme.Phone"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;basic</span> <span class="na">name=</span><span class="s">"number"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"P_NUMBER"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/basic&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/embeddable&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="Basic_Collections">Basic Collections</span></h2>
<p>An <code>ElementCollection</code> mapping can be used to define a collection of <code>Basic</code> objects. The <code>Basic</code> values are stored in a separate collection table. This is similar to a <code>OneToMany</code>, except the target is a <code>Basic</code> value instead of an <code>Entity</code>. This allows collections of simple values to be easily defined, without requiring defining a class for the value.</p>
<p>There is no <code>cascade</code> option on an <code>ElementCollection</code>, the target objects are always persisted, merged, removed with their parent. <code>ElementCollection</code> still can use a <code>fetch</code> type and defaults to <code>LAZY</code> the same as other collection mappings.</p>
<h3><span class="mw-headline" id="Example_of_an_ElementCollection_relationship_to_a_basic_value_database">Example of an ElementCollection relationship to a basic value database</span></h3>
<p>EMPLOYEE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>EMP_ID</td>
<td>F_NAME</td>
<td>L_NAME</td>
<td>SALARY</td>
</tr>
<tr>
<td>1</td>
<td>Bob</td>
<td>Way</td>
<td>50000</td>
</tr>
<tr>
<td>2</td>
<td>Joe</td>
<td>Smith</td>
<td>35000</td>
</tr>
</tbody></table>
<p>PHONE (table)</p>
<table cellspacing="0" border="1" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>OWNER_ID</td>
<td>PHONE_NUMBER</td>
</tr>
<tr>
<td>1</td>
<td>613-792-0001</td>
</tr>
<tr>
<td>1</td>
<td>613-494-1234</td>
</tr>
<tr>
<td>2</td>
<td>416-892-0005</td>
</tr>
</tbody></table>
<h3><span class="mw-headline" id="Example_of_a_ElementCollection_relationship_to_a_basic_value_annotations">Example of a ElementCollection relationship to a basic value annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@ElementCollection</span>
  <span class="nd">@CollectionTable</span><span class="o">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s">"PHONE"</span><span class="o">,</span>
        <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"OWNER_ID"</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PHONE_NUMBER"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">phones</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_a_ElementCollection_relationship_to_a_basic_value_XML">Example of a ElementCollection relationship to a basic value XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"EMP_ID"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;element-collection</span> <span class="err">nam</span>
            <span class="err">&lt;column</span> <span class="na">name=</span><span class="s">"PHONE_NUMBER"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;collection-table</span> <span class="na">name=</span><span class="s">"PHONE"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;join-column</span> <span class="na">name=</span><span class="s">"OWNER_ID"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/collection-table&gt;</span>
        <span class="nt">&lt;/element-collection&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h2><span class="mw-headline" id="See_Also_6">See Also</span></h2>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships" title="Java Persistence/Relationships">Relationships</a>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Lazy_Fetching" title="Java Persistence/Relationships">Lazy Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Target_Entity" title="Java Persistence/Relationships">Target Entity</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Collections" title="Java Persistence/Relationships">Collections</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Maps" title="Java Persistence/Relationships">Maps</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Join_Fetching" title="Java Persistence/Relationships">Join Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Batch_Reading" title="Java Persistence/Relationships">Batch Reading</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Common_Problems" title="Java Persistence/Relationships">Common Problems</a></li>
</ul>
</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToOne" title="Java Persistence/ManyToOne">OneToMany</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ManyToMany" title="Java Persistence/ManyToMany">ManyToMany</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Embeddables" title="Java Persistence/Embeddables">Embeddables</a></li>
</ul>
<h2><span class="mw-headline" id="Common_Problems_16">Common Problems</span></h2>
<h5><span class="mw-headline" id="Primary_keys_in_CollectionTable"><i>Primary keys in CollectionTable</i></span></h5>
<dl>
<dd>The JPA 2.0 specification does not provide a way to define the <code>Id</code> in the <code>Embeddable</code>. However, to delete or update a element of the <code>ElementCollection</code> mapping, some unique <i>key</i> is normally required. Otherwise, on every update the JPA provider would need to delete everything from the <code>CollectionTable</code> for the <code>Entity</code>, and then insert the values back. So, the JPA provider will most likely assume that the combination of all of the fields in the <code>Embeddable</code> are unique, in combination with the foreign key (<code>JoinColumn</code>(s)). This however could be inefficient, or just not feasible if the <code>Embeddable</code> is big, or complex.</dd>
</dl>
<dl>
<dd>Some JPA providers may allow the <code>Id</code> to be specified in the <code>Embeddable</code>, to resolve this issue. Note in this case the <code>Id</code> only needs to be unique for the collection, not the table, as the foreign key is included. Some may also allow the <code>unique</code> option on the <code>CollectionTable</code> to be used for this. Otherwise, if your <code>Embeddable</code> is complex, you may consider making it an <code>Entity</code> and use a <code>OneToMany</code> instead.</dd>
</dl>
<h1><span class="mw-headline" id="Advanced_Topics">Advanced Topics</span></h1>
<h2><span class="mw-headline" id="Events">Events</span></h2>
<p>A event is a hook into a system that allows the execution of some code when the event occurs. Events can be used to extend, integrate, debug, audit or monitor a system.</p>
<p>JPA defines several events for the persistent life-cycle of <code>Entity</code> objects. JPA events are defined through annotations or in the orm.xml. Any method of a persistent class can be annotated with an event annotation to be called for all instances of that class. An event listener can also be configured for a class using the <a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/EntityListeners.html" target="_blank"><code>EntityListeners</code></a> annotation or <code>&lt;entity-listeners&gt;</code> XML element. The specified listener class does not need to implement any interface (JPA does not use the Java event model), it only needs to annotate its methods with the desired event annotation.</p>
<p>JPA defines the following events:</p>
<ul>
<li><a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/PostLoad.html" target="_blank"><code>PostLoad</code></a> - Invoked after an <code>Entity</code> is loaded into the persistence context (<code>EntityManager</code>), or after a <code>refresh</code> operation.</li>
<li><a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/PrePersist.html" target="_blank"><code>PrePersist</code></a> - Invoked before the <code>persist</code> operation is invoked on an <code>Entity</code>. Also invoked on <code>merge</code> for new instances, and on cascade of a <code>persist</code> operation. The <code>Id</code> of the object may not have been assigned, and code be assigned by the event.</li>
<li><a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/PostPersist.html" target="_blank"><code>PostPersist</code></a> - Invoked after a new instance is persisted to the database. This occurs during a <code>flush</code> or <code>commit</code> operation after the database <code>INSERT</code> has occurred, but before the transaction is committed. It does not occur during the <code>persist</code> operation. The <code>Id</code> of the object should be assigned.</li>
<li><a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/PreUpdate.html" target="_blank"><code>PreUpdate</code></a> - Invoked before an instance is updated in the database. This occurs during a <code>flush</code> or <code>commit</code> operation after the database <code>UPDATE</code> has occurred, but before the transaction is committed. It does not occur during the <code>merge</code> operation.</li>
<li><a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/PostUpdate.html" target="_blank"><code>PostUpdate</code></a> - Invoked after an instance is updated in the database. This occurs during a <code>flush</code> or <code>commit</code> operation after the database <code>UPDATE</code> has occurred, but before the transaction is committed. It does not occur during the <code>merge</code> operation.</li>
<li><a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/PreRemove.html" target="_blank"><code>PreRemove</code></a> - Invoked before the <code>remove</code> operation is invoked on an <code>Entity</code>. Also invoked for cascade of a <code>remove</code> operation. It is also invoked during a <code>flush</code> or <code>commit</code> for <code>orphanRemoval</code> in JPA 2.0.</li>
<li><a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/PostRemove.html" target="_blank"><code>PostRemove</code></a> - Invoked after an instance is deleted from the database. This occurs during a <code>flush</code> or <code>commit</code> operation after the database <code>DELETE</code> has occurred, but before the transaction is committed. It does not occur during the <code>remove</code> operation.</li>
</ul>
<h3><span class="mw-headline" id="Example_of_Entity_event_annotations">Example of Entity event annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">uid</span><span class="o">;</span>
  <span class="nd">@Basic</span>
  <span class="kd">private</span> <span class="n">Calendar</span> <span class="n">lastUpdated</span><span class="o">;</span>
  <span class="o">...</span>

  <span class="nd">@PrePersist</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prePersist</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">uid</span> <span class="o">=</span> <span class="n">UIDGenerator</span><span class="o">.</span><span class="na">newUUI</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lastUpdated</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@PreUpdate</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">preUpdate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lastUpdated</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_EntityListener_event_annotations">Example of EntityListener event annotations</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@EntityListeners</span><span class="o">(</span><span class="n">EmployeeEventListener</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">uid</span><span class="o">;</span>
  <span class="nd">@Basic</span>
  <span class="kd">private</span> <span class="n">Calendar</span> <span class="n">lastUpdated</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<p><br></p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeeEventListener</span> <span class="o">{</span>
  <span class="nd">@PrePersist</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prePersist</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="o">(</span><span class="n">Employee</span><span class="o">)</span><span class="n">object</span><span class="o">;</span>
    <span class="n">employee</span><span class="o">.</span><span class="na">setUID</span><span class="o">(</span><span class="n">UIDGenerator</span><span class="o">.</span><span class="na">newUUI</span><span class="o">());</span>
    <span class="n">employee</span><span class="o">.</span><span class="na">setLastUpdated</span><span class="o">(</span><span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@PreUpdate</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">preUpdate</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="o">(</span><span class="n">Employee</span><span class="o">)</span><span class="n">object</span><span class="o">;</span>
    <span class="n">employee</span><span class="o">.</span><span class="na">setLastUpdated</span><span class="o">(</span><span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_Entity_event_xml">Example of Entity event xml</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;pre-persist</span> <span class="na">method-name=</span><span class="s">"prePersist"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;pre-update</span> <span class="na">method-name=</span><span class="s">"preUpdate"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"uid"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_EntityListener_event_xml">Example of EntityListener event xml</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;entity-listeners&gt;</span>
        <span class="nt">&lt;entity-listener</span> <span class="na">class=</span><span class="s">"org.acme.EmployeeEventListener"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;pre-persist</span> <span class="na">method-name=</span><span class="s">"prePersist"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;pre-update</span> <span class="na">method-name=</span><span class="s">"preUpdate"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/entity-listener&gt;</span>
    <span class="nt">&lt;/entity-listeners&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"uid"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
<span class="nt">&lt;/entity&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Default_Entity_Listeners">Default Entity Listeners</span></h3>
<p>It is also possible to configure a default Entity listener. This listener will receive events for all of the Entity classes in the persistence unit. Default listeners can only be defined through XML.</p>
<p>If a default Entity listener is defined, and a class wants to define its own listener, or does not want the default listener, this can be disabled using the <a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/ExcludeDefaultListeners.html" target="_blank"><code>ExcludeDefaultListeners</code></a> annotation or <code>&lt;exclude-default-listeners&gt;</code> XML element.</p>
<h4><span class="mw-headline" id="Example_default_Entity_listener_xml">Example default Entity listener xml</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;entity-mappings</span> <span class="na">version=</span><span class="s">"2.0"</span>
        <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/persistence/orm"</span>
        <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/persistence/orm orm_2_0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;persistence-unit-metadata&gt;</span>
        <span class="nt">&lt;persistence-unit-defaults&gt;</span>
            <span class="nt">&lt;entity-listeners&gt;</span>
                <span class="nt">&lt;entity-listener</span> <span class="na">class=</span><span class="s">"org.acme.ACMEEventListener"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;pre-persist</span> <span class="na">method-name=</span><span class="s">"prePersist"</span><span class="nt">/&gt;</span>
                    <span class="nt">&lt;pre-update</span> <span class="na">method-name=</span><span class="s">"preUpdate"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/entity-listener&gt;</span>
            <span class="nt">&lt;/entity-listeners&gt;</span>
        <span class="nt">&lt;/persistence-unit-defaults&gt;</span>
    <span class="nt">&lt;/persistence-unit-metadata&gt;</span>
<span class="nt">&lt;/entity-mappings&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Events_and_Inheritance">Events and Inheritance</span></h3>
<p>Entity listeners are inherited. If a subclass does not wish to inherit a superclass Entity listener, then it must define the <a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/ExcludeSuperclassListeners.html" target="_blank"><code>ExcludeSuperclassListeners</code></a> annotation or <code>&lt;exclude-superclass-listeners&gt;</code> XML element.</p>
<h3><span class="mw-headline" id="Events_and_Embeddables">Events and Embeddables</span></h3>
<p>JPA does not define any events for <code>Embeddable</code>s. Some JPA providers may allow defining events for <code>Embeddable</code> objects.</p>
<h3><span class="mw-headline" id="Extended_Events">Extended Events</span></h3>
<p>The JPA events are only defined for the Entity life-cycle. There are no EntityMangager events, or system level events.</p>
<p>Some JPA providers may provide additional events.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Provide an extended event mechanism. Additional <code>Entity</code> level events are defined through the <code>DescriptorEventListener</code> API. A session level event mechanism is also provided through the <code>SessionEventListener</code> API. The event objects also provide additional information including the database row and set of object changes.</dd>
</dl>
<h2><span class="mw-headline" id="Views">Views</span></h2>
<p>A database <code>VIEW</code> is a virtual view of a table or query. Views are useful for hiding the complexity of a table, set of tables, or data-set.</p>
<p>In JPA you can map to a <code>VIEW</code> the same as a table, using the <code>@Table</code> annotation. You can then map each column in the view to your object's attributes. Views are normally read-only, so object's mapping to views are normally also read-only. In most databases views can also be updatable depending on how complex to query is that they encapsulate. Even for complex queries database triggers can normally be used to update into the view.</p>
<p>Views can often be used in JPA to workaround mapping limitations. For example if a table join is not supported by JPA, or a database function is desired to be called to transform data, this can normally be done inside a view, so JPA can just map to the simplified data.</p>
<p>Using views does require database expertise, and the definition of views can be database dependent.</p>
<h2><span class="mw-headline" id="Interfaces">Interfaces</span></h2>
<p>Interfaces can be used for two main purposes in a model. The first is as a public interface that defines the public API for the class. The second is as a common type that allows multiple distinct implementers.</p>
<h3><span class="mw-headline" id="Public_Interfaces">Public Interfaces</span></h3>
<p>If you have a public interface in JPA, you just need to map the implementation class and are fine for the most part. One issue is that you need to use the implementation class for queries, as JPA does not know about the interface. For JPQL the default alias is also the implementation class, but you could redefine this to be the public interface by setting the <code>name</code> of the <code>Entity</code> to be the public interface.</p>
<p>Some JPA providers allow interfaces to be defined.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support defining and querying on public interfaces using a <code>DescriptorCustomizer</code> and the <code>InterfacePolicy</code>.</dd>
</dl>
<h4><span class="mw-headline" id="Example_public_interface_alias">Example public interface alias</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Employee"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeeImpl</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<p>If you have a relationship that uses the public interface, instead of the implementation, then JPA will not know how to map this correctly. You can using the <code>targetEntity</code> attribute to define that the relationship is too the implementation class (see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Target_Entity" title="Java Persistence/Relationships">Target Entity</a>).</p>
<h4><span class="mw-headline" id="Example_public_interface_relationship">Example public interface relationship</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Employee"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeeImpl</span> <span class="o">{</span>
  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">targetEntity</span><span class="o">=</span><span class="n">EmployeeImpl</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Employee</span> <span class="n">manager</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Interface_Types">Interface Types</span></h3>
<p>If you have a common interfaces with multiple distinct implementers, this can have some issues. If you use the interface to define a variable relationship, then this is difficult to map. JPA has no direct support for interfaces or variable relationships. You could change the interface to be a <code>abstract</code> class, then use <code>TABLE_PER_CLASS</code> inheritance to map it. Otherwise, you could split the relationship into multiple relationships, one per each implementer, or you could just remove the relationship and query for the related objects instead. Querying on an interface is also difficult, you would need to query on each implementer of the interface, and then union the results in memory.</p>
<p>Some JPA providers have support for mapping interfaces, and for variable relationships.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support mapping interfaces using a <code>SessionCustomizer</code> and a <code>RelationalDescriptor</code> and <code>InterfacePolicy</code>. Variable relationships can be defined using the <code>@VariableOneToOne</code> annotation or XML.</dd>
</dl>
<h2><span class="mw-headline" id="Stored_Procedures">Stored Procedures</span></h2>
<p>A stored procedure is a procedure or function that resides on the database. Stored procedures are typically written in some database specific language that is similar to SQL, such as PL/SQL on Oracle. Some databases such as Oracle also support stored procedures written in Java.</p>
<p>Stored procedures can be useful to perform batch data processing tasks. By writing the task in the database, it avoids the cost of sending the data to and from the database client, so can operate much more efficiently. Stored procedures can also be used to access database specific functionality that can only be accessed on the server. Stored procedures can also be used if strict security requirements as required, to avoid giving users access to the raw tables or unverified SQL operations. Some legacy application have also been written in database procedural languages, and need to be integrated with.</p>
<p>The disadvantages of using stored procedures is they are less flexible than using SQL, and require developing and maintaining functionality that is often written in a different language than the application developers may be used to, and difficult to develop and debug, and typically using a limited procedural programming language. There is also a general misconception that using stored procedures will improve performance, in that if you put the same SQL the application is executing inside a stored procedure it will somehow become faster. This is a false, and normally the opposite is true, as stored procedures restrict the dynamic ability of the persistence layer to optimize data retrieval. Stored procedures only improve performance when they use more optimal SQL than the application, typically when they perform an entire task on the database. To achieve optimal performance from SQL generated in an application you must use prepared statements - otherwise the database will have to create a new execution plan each time you submit a query.</p>
<h3><span class="mw-headline" id="JPA_2.1_StoredProcedureQuery">JPA 2.1 StoredProcedureQuery</span></h3>
<p>JPA 2.1 supports calling database stored procedures using the <code>StoredProcedureQuery</code>, and <code>@NamedStoredProcedureQuery</code> annotation or <code>&lt;named-stored-procedure-query&gt;</code> XML element. JPA supports both named stored procedures calls defined in meta-data and created through <code>EntityManager.createNamedStoredProcedureQuery()</code>, and dynamic stored procedure calls created through <code>EntityManager.createStoredProcedureQuery()</code>.</p>
<p><code>StoredProcedureQuery</code> is a JPA Query that provides additional API for setting the stored procedure parameters, and for accessing output parameters and multiple result sets. A <code>StoredProcedureQuery</code> can return entity objects, or data, similar to native SQL queries. A <code>ResultSetMapping</code> can be used to map the returned fields to the entity columns.</p>
<p>Some databases such as MySQL, SQL Server and Sybase support stored procedure that return result sets. Some databases such as Oracle do not, but do support output parameters that return cursors. If the stored procedure returns a result set, or a cursor output parameter, <code>getResultList()</code> or <code>getSingleResult()</code> can be used. If the stored procedure has multiple result sets, or multiple cursor output parameters, then calling <code>getResultList()</code> again will return the next result set or cursor output parameter. If the stored procedure does not return anything, <code>executeUpdate()</code> can be used. <code>StoredProcedureQuery</code> also defines an <code>execute()</code> API, that executes the procedure and returns a <code>boolean</code> indicating if a result set was returned. After execution, any of the stored procedures output parameters can be accessed using <code>getOutputParameterValue()</code>.</p>
<p>The stored procedure parameters are defined through the <code>@StoredProcedureParameter</code> annotation or <code>&lt;stored-procedure-parameter&gt;</code> XML element, or for dynamic stored procedure calls through the <code>StoredProcedureQuery.registerStoredProcedureParameter()</code> API. Parameters can be named or by index, define the corresponding Java type for the parameter, and define the parameter directional mode through <code>ParameterMode</code>. The mode can be one of <code>IN</code>, <code>INOUT</code>, <code>OUT</code>, <code>REF_CURSOR</code>. A type of <code>void.class</code> can be used for ref cursors.</p>
<h4><span class="mw-headline" id="Example_named_stored_procedure_annotation">Example named stored procedure annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="c1">// This stored procedure returns a result set and has one input parameter.</span>
<span class="nd">@NamedStoredProcedureQuery</span><span class="o">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"ReadAddressById"</span><span class="o">,</span>
    <span class="n">resultClasses</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
    <span class="n">procedureName</span> <span class="o">=</span> <span class="s">"READ_ADDRESS"</span><span class="o">,</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="o">{</span>
        <span class="nd">@StoredProcedureParameter</span><span class="o">(</span><span class="n">mode</span><span class="o">=</span><span class="n">IN</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"P_ADDRESS_ID"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">)</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_calling_a_named_stored_procedure">Example calling a named stored procedure</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">StoredProcedureQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNamedStoredProcedureQuery</span><span class="o">(</span><span class="s">"ReadAddressById"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"P_ADDRESS_ID"</span><span class="o">,</span> <span class="mi">12345</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></div>
<h4><span class="mw-headline" id="Example_named_cursored_stored_procedure_annotation">Example named cursored stored procedure annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="c1">// This stored procedure returns a cursor output parameter, and has one input parameter.</span>
<span class="nd">@NamedStoredProcedureQuery</span><span class="o">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"ReadAddressById"</span><span class="o">,</span>
    <span class="n">resultClasses</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
    <span class="n">procedureName</span> <span class="o">=</span> <span class="s">"READ_ADDRESS"</span><span class="o">,</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="o">{</span>
        <span class="nd">@StoredProcedureParameter</span><span class="o">(</span><span class="n">mode</span><span class="o">=</span><span class="n">IN</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"P_ADDRESS_ID"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@StoredProcedureParameter</span><span class="o">(</span><span class="n">mode</span><span class="o">=</span><span class="n">REF_CURSOR</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"CUR_ADDRESS"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="kt">void</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">)</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_calling_a_named_stored_procedure_with_a_cursor_output_parameter">Example calling a named stored procedure with a cursor output parameter</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">StoredProcedureQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNamedStoredProcedureQuery</span><span class="o">(</span><span class="s">"ReadAddressById"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"P_ADDRESS_ID"</span><span class="o">,</span> <span class="mi">12345</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;)</span><span class="n">query</span><span class="o">.</span><span class="na">getOutputParameterValue</span><span class="o">(</span><span class="s">"CUR_ADDRESS"</span><span class="o">);</span>
</pre></div>
<h4><span class="mw-headline" id="Example_calling_a_dynamic_stored_procedure">Example calling a dynamic stored procedure</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">StoredProcedureQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createStoredProcedureQuery</span><span class="o">(</span><span class="s">"VALIDATE_ADDRESS"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">registerStoredProcedureParameter</span><span class="o">(</span><span class="s">"P_COUNTRY"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ParameterMode</span><span class="o">.</span><span class="na">IN</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">registerStoredProcedureParameter</span><span class="o">(</span><span class="s">"P_PROVINCE"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ParameterMode</span><span class="o">.</span><span class="na">IN</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">registerStoredProcedureParameter</span><span class="o">(</span><span class="s">"P_CITY"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ParameterMode</span><span class="o">.</span><span class="na">IN</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">registerStoredProcedureParameter</span><span class="o">(</span><span class="s">"P_STREET"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ParameterMode</span><span class="o">.</span><span class="na">IN</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">registerStoredProcedureParameter</span><span class="o">(</span><span class="s">"P_POSTAL_CD"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ParameterMode</span><span class="o">.</span><span class="na">IN</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">registerStoredProcedureParameter</span><span class="o">(</span><span class="s">"OUT_VALID"</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ParameterMode</span><span class="o">.</span><span class="na">OUT</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">registerStoredProcedureParameter</span><span class="o">(</span><span class="s">"OUT_ID"</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ParameterMode</span><span class="o">.</span><span class="na">OUT</span><span class="o">);</span>

<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"P_COUNTRY"</span><span class="o">,</span> <span class="s">"Canada"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"P_PROVINCE"</span><span class="o">,</span> <span class="s">"ON"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"P_CITY"</span><span class="o">,</span> <span class="s">"Ottawa"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"P_STREET"</span><span class="o">,</span> <span class="s">"99 Bank"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"P_POSTAL_CD"</span><span class="o">,</span> <span class="s">"K2H8L2"</span><span class="o">);</span>

<span class="n">query</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
<span class="n">Boolean</span> <span class="n">isValid</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span><span class="n">query</span><span class="o">.</span><span class="na">getOutputParameterValue</span><span class="o">(</span><span class="s">"OUT_VALID"</span><span class="o">);</span>
<span class="n">Long</span> <span class="n">id</span> <span class="o">=</span> <span class="o">(</span><span class="n">Long</span><span class="o">)</span><span class="n">query</span><span class="o">.</span><span class="na">getOutputParameterValue</span><span class="o">(</span><span class="s">"OUT_ID"</span><span class="o">);</span>
</pre></div>
<h3><span class="mw-headline" id="Stored_Procedures_in_JPA_2.0">Stored Procedures in JPA 2.0</span></h3>
<p>JPA 2.0 does not have any direct support for stored procedures. Some types of stored procedures can be executed in JPA through using native queries. Native queries in JPA allow any SQL that returns nothing, or returns a database result set to be executed. The syntax to execute a stored procedure depends on the database. JPA native SQL queries do not support stored procedures that use <code>OUTPUT</code> or <code>INOUT</code> parameters. Some databases such as DB2, Sybase and SQL Server allow for stored procedures to return result sets. Oracle does not allow results sets to be returned, only <code>OUTPUT</code> parameters, but does define a <code>CURSOR</code> type that can be returned as an <code>OUTPUT</code> parameter. Oracle also supports stored functions, that can return a single value. A stored function can normally be executed using a native SQL query by selecting the function value from the Oracle <code>DUAL</code> table.</p>
<p>Some JPA providers have extended support for stored procedures, some also support overriding any CRUD operation for an <code>Entity</code> with a stored procedure or custom SQL. Some JPA providers have support for <code>CURSOR</code> <code>OUTPUT</code> parameters.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support stored procedures and stored functions using the <code>@NamedStoredProcedureQuery, @NamedStoredFunctionQuery</code> annotations or XML, or the <code>StoredProcedureCall, StoredFunctionCall</code> classes. Overriding any CRUD operation for a class or relationship are also supported using a <code>DescriptorCustomizer</code> and the <code>DescriptorQueryManager</code> class. IN, OUT, INOUT, and <code>CURSOR</code> <code>OUTPUT</code> parameters are supported.</dd>
</dl>
<h4><span class="mw-headline" id="Example_executing_a_stored_procedure_on_Oracle">Example executing a stored procedure on Oracle</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"BEGIN VALIDATE_EMP(P_EMP_ID=&gt;?); END;"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">empId</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
</pre></div>
<h3><span class="mw-headline" id="PL.2FSQL_Stored_Procedures">PL/SQL Stored Procedures</span></h3>
<p>In Oracle stored procedures are typically written in Oracle's PL/SQL language. PL/SQL in Oracle supports some additional data-types, that Oracle does not support through SQL or JDBC. These include types such as <code>BOOLEAN</code>, <code>TABLE</code> and <code>RECORD</code>. Accessing these types or procedures is difficult from Java, as these types are not supported by JDBC. One workaround is to wrap the PL/SQL stored procedures with normal stored procedures that transform the PL/SQL types to standard SQL/JDBC types, such as <code>INT</code>, <code>VARRAY</code> (<code>Array</code>), and <code>OBJECT TYPE</code> (<code>Struct</code>). Some JPA providers have extended support for calling PL/SQL stored procedures.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support PL/SQL stored procedures and functions using the <code>@NamedPLSQLStoredProcedureQuery, @NamedPLSQLStoredFunctionQuery</code> annotations or XML, or the <code>PLSQLStoredProcedureCall, PLSQLStoredFunctionCall</code> classes.</dd>
</dl>
<h2><span class="mw-headline" id="Structured_Object-Relational_Data_Types">Structured Object-Relational Data Types</span></h2>
<p>At the peak of object-oriented databases (OODBMS) many of the relational database vendors decided to add object-oriented concepts to relational data. These new <i>hybrid</i> databases were then called Object-Relational in that they could store both object and relational data. These object-relational data-types were standardized as part of SQL3 and support was added for them from Java in the JDBC 2.0 API. Although there was lots of hype around the new forms of data, object-relational data never caught on much, as people seemed to prefer their standard relational data. One would not normally recommend the use of object-relational data, as relational data is much more standard, but if dealing with really complex data, it may be something to investigate.</p>
<p>Some common object-relational database features include:</p>
<ul>
<li>Object types (structures)</li>
<li>Arrays and array types</li>
<li>Nested tables</li>
<li>Inheritance</li>
<li>Object ids (OIDs)</li>
<li>Refs</li>
</ul>
<p>Databases that support object-relational data include:</p>
<ul>
<li>Oracle</li>
<li>DB2</li>
<li>PostgreSQL</li>
</ul>
<p>The basic model allows you to define Structs or Object-types to represent your data, the structures can have nested structures, arrays of basic data or other structures, and refs to other structures. You can then store a structure in a normal relational table column, or create a special table to store the structures directly. Querying is basic SQL, with a few extensions to handle traversing the special types.</p>
<p>JPA does not support object-relational data-types, but some JPA providers may offer some support.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support object-relational data-types through their <code>@Struct, @Structure, @Array</code> annotations and XML, or their <code>ObjectRelationalDataTypeDescriptor</code> and mapping classes. Custom support is also offered for Oracle spatial database JGeometry structures and other structured data-types using the <code>@StructConverter</code> annotation or XML.</dd>
</dl>
<p>See also,</p>
<ul>
<li><a rel="nofollow" class="external text" href="http://ronaldoblanc.blogspot.com/2011/11/jpa-eclipselink-e-stored-procedures-com.html" target="_blank">Complex data stored procedures (Blog)</a></li>
</ul>
<h2><span class="mw-headline" id="XML_Data_Types">XML Data Types</span></h2>
<p>With the advent of XML databases, many relational database decided to add enhanced XML support. Although it was always possible to store XML in a relational database just using a <code>VARCHAR</code> or <code>CLOB</code> column, having the database aware of the XML data does have its advantages. The main advantage is databases that offer XML support allow querying of the XML data using XPath or XQuery syntax. Some databases also allow the XML data to be stored more efficiently than in Lob storage.</p>
<p>Databases with XML support include:</p>
<ul>
<li>Oracle (XDB)</li>
<li>DB2</li>
<li>PostgreSQL</li>
</ul>
<p>JPA has no extended support for XML data, although it is possible to store an XML String into the database, just mapped as a <code>Basic</code>. Some JPA provider may offer extended XML data support. Such as query extensions, or allow mapping an XML DOM.</p>
<p>If you wish to map the XML data into objects, you could make use of the JAXB specification. You may even be able to integrate this with your JPA objects.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support Oracle XDB XMLType columns using their <code>DirectToXMLTypeMapping</code>. XMLTypes can be mapped either as String or as an XML DOM (Document). Query extensions are provided for XPath queries within <code>Expression</code> queries. EclipseLink also includes a JAXB implementation for object-XML mapping.</dd>
</dl>
<h2><span class="mw-headline" id="Filters">Filters</span></h2>
<p>Some times it is desirable to filter some of the contents of a table from all queries. This is normally because the table is shared, either by multiple types, applications, tenants, or districts, and the JPA application is only interested in a subset of the rows. It may also be that the table includes historical or archive rows that should be ignored by the JPA application.</p>
<p>JPA does not provide any specific support for filtering data, but there are some options available. Inheritance can be used to include a type check on the rows for a class. For example, if you had a <code>STATUS</code> column in an <code>EMPLOYEE</code> table, you could define an <code>Employee</code> and a <code>CurrentEmployee</code> subclass whose discriminator <code>STATUS</code> was <code>ACTIVE</code>, and always use <code>CurrentEmployee</code> in the application. Similarly you could define an <code>ACMEEmployee</code> subclass that used the <code>TENANT</code> column as its class discriminator of value <code>ACME</code>. Another solution is to use database views to filter the data and map the entities to the views.</p>
<p>These solutions do not work with dynamic filtering, where the filter criteria parameters are not know until runtime (such as tenant, or district). Also complex criteria cannot be modeled through inheritance, although database views should still work. One solution is to always append the criteria to any query, such as appending a JPQL string, or JPA Criteria in the application code.</p>
<p>Virtual Private Database (VPD) support may also provide a solution. Some databases such as Oracle support VPD, allow context based filtering of rows based on the connected user or proxy certificate.</p>
<p>Some JPA providers have specific support for filtering data.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support filtering data through their <code>@AdditionalCriteria</code> annotation and XML. This allows an arbitrary JPQL fragment to be appended to all queries for the entity. The fragment can contain parameters that can be set through persistence unit or context properties at runtime. Oracle VPD is also supported, include Oracle proxy authentication and isolated data.</dd>
</dl>
<h2><span class="mw-headline" id="History">History</span></h2>
<p>A common desire in database applications is to maintain a record and history of the database changes. This can be used for tracking and auditing purposes, or to allow undoing of changes, or to keep a record of the system's data over time. Many database have auditing functionality that allows some level of tracking changes made to the data. Some databases such as Oracle's <i>Flashback</i> feature allow the automatic tracking of history at the row level, and even allow querying on past versions of the data.</p>
<p>It is also possible for an application to maintain its own history through its data model. All that is required is to add a <code>START</code> and <code>END</code> timestamp column to the table. The <i>current</i> row is then the one in which the <code>END</code> timestamp is null. When a row is inserted its <code>START</code> timestamp will be set to the current time. When a row is updated, instead of updating the row a new row will be inserted with the same id and data, but a different <code>START</code> timestamp, and the old row will be updated to set its <code>END</code> timestamp to the current time. The primary key of the table will need to have the <code>START</code> timestamp added to it.</p>
<p>History can also be used to avoid deletion. Instead of deleting a row, the <code>END</code> timestamp can just be set to the current time. Another solution is to add a <code>DELETED</code> boolean column to the table, and record when a row is deleted.</p>
<p>The history data could either be stored in-place in the altered table, or the table could be left to only contain the current version of the data, and a mirror history table could be added to store the data. In the mirror case, database triggers could be used to write to the history table. For the in-place case a database view could be used to give a view of the table as of the current time.</p>
<p>To query the current data from a history table, any query must include the clause where the <code>END</code> is <code>NULL</code>. To query as of a point in time, the where clause must include where the point in time is between the <code>START</code> and <code>END</code> timestamps.</p>
<p>JPA does not define any specific history support.</p>
<p>Oracle flashback can be used with JPA, but any queries for historical data will need to use native SQL.</p>
<p>If a mirror history table is used with triggers, JPA can still be used to query to current data. A subclass or sibling class could also be mapped to the history table to allow querying of history data.</p>
<p>If a database view is used, the JPA could be used by mapping the <code>Entity</code> to the view.</p>
<p>If a history table is used JPA could still be used to map to the table, and a <code>start</code> and <code>end</code> attribute could be added to the object. Queries for the current data could append the current time to the query. Relationships are more difficult, as JPA requires relationships to be by primary key, and historical relationships would not be.</p>
<p>Some JPA providers have support for history.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support Oracle flashback querying as well as application specific history. Historical queries can be defined using the query hint <code>"eclipselink.history.as-of"</code> or <code>Expression</code> queries. Automatic tracking of history is also supported using the <code>HistoryPolicy</code> API that supports maintaining and querying a mirror history table.</dd>
</dl>
<h2><span class="mw-headline" id="Logical_Deletes">Logical Deletes</span></h2>
<h2><span class="mw-headline" id="Auditing">Auditing</span></h2>
<p>See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Auditing_and_Security" title="Java Persistence/Auditing and Security">Auditing and Security</a>.</p>
<h2><span class="mw-headline" id="Replication">Replication</span></h2>
<p>Data replication can be used to backup data, for fault tolerance and fail-over, or for load balancing and scaling the database.</p>
<p>For replication, changes are written to multiple databases, either by the application, JPA provider, or database back-end. For fail-over, if one of the databases goes down, the other can be used without loss of data or application downtime. For load-balancing, read requests can be load balanced across the replicated databases to reduce the load on each database, and improve the scalability of the application.</p>
<p>Most enterprise database support some form of automatic backup or replication. Clustered database such as Oracle RAC also allow for load balancing, fail-over and high availability. If your database supports replication or clustering, then it is normally transparent to JPA. A specialize DataSource (such as Oracle UCP, or WebLogic GridLink) may need to be used to handle load-balancing and fail-over.</p>
<p>JPA does not define any specific support for data replication, but some JPA provider provide replication support. If your database does not support replication, you can implement it yourself through having multiple persistence units, and persisting and merging your objects to both databases.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support replication, load-balancing and fail-over. Replication and load balancing is supported through EclipseLink's partitioning support using the <code>@ReplicationPartitioning</code>, and <code>@RoundRobinPartitioning</code> annotations and XML.</dd>
</dl>
<h2><span class="mw-headline" id="Partitioning">Partitioning</span></h2>
<p>Data partitioning can be used to scale an application across multiple database machines, or with a clustered database such as Oracle RAC.</p>
<p>Partitioning splits your data across each of the database nodes. There is horizontal partitioning, and vertical partitioning. Vertical partitioning is normally the easiest to implement. You can just put half of your classes on one database, and the other half on another. Ideally the two sets would be isolated from each other and not have any cross database relationships. This can be done directly in JPA, by having two different persistence units, one for each database.</p>
<p>For horizontal partitioning you need to split your data across multiple database nodes. Each database node will have the same tables, but each node's table will only store part of the data. You can partition the data by the data values, such as range partitioning, value partitioning, hash partitioning, or even round robin. JPA does not define any data partitioning support, so you either need to define a different class per partition, or use JPA vendor specific functionality.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support both horizontal and vertical data partitioning. Hash, value, range, pinned and custom partitioning is supported at the Session, Entity, and Query level. Partitioning is support through the <code>@Partitioning, @HashPartitioning, @RangePartitioning, @ValuePartitioning, @PinnedPartitioning</code>, and <code>@Partitioned</code> annotations and XML.</dd>
</dl>
<p>See also,</p>
<ul>
<li><a rel="nofollow" class="external text" href="http://java-persistence-performance.blogspot.com/2011/05/data-partitioning-scaling-database.html" target="_blank">Data Partitioning - Scaling the Database (Blog)</a></li>
</ul>
<h2><span class="mw-headline" id="Data_Integration">Data Integration</span></h2>
<h2><span class="mw-headline" id="NoSQL_.28and_EIS.2C_legacy.2C_XML.2C_and_non-relational_data.29">NoSQL (and EIS, legacy, XML, and non-relational data)</span></h2>
<p>See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/NoSQL" title="Java Persistence/NoSQL">NoSQL</a></p>
<h2><span class="mw-headline" id="Multi-Tenancy">Multi-Tenancy</span></h2>
<h2><span class="mw-headline" id="Dynamic_Data">Dynamic Data</span></h2>
<h1><span class="mw-headline" id="Runtime"><b>Runtime</b></span></h1>
<p>Once you have mapped your object model the second step in persistence development is to access and process your objects from your application, this is referred to as the runtime usage of persistence. Various persistence specifications have had various runtime models. The most common model is to have a runtime API; a runtime API typically will define API for connecting to a data-source, querying and transactions.</p>
<h1><span class="mw-headline" id="Entity_Manager">Entity Manager</span></h1>
<p>JPA provides a runtime API defined by the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/package-summary.html" target="_blank">javax.persistence</a></code> package. The main runtime class is the <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html" target="_blank">EntityManager</a></code> class. The EntityManager provides API for creating queries, accessing transactions, and finding, persisting, merging and deleting objects. The JPA API can be used in any Java environment including JSE and JEE.</p>
<p>An EntityManager can be created through an <code><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManagerFactory.html" target="_blank">EntityManagerFactory</a></code>, or can be <i>injected</i> into an instance variable in an EJB SessionBean, or can be looked up in JNDI in a JEE server.</p>
<p>JPA is used differently in Java Standard Edition (JSE) versus Java Enterprise Edition (JEE).</p>
<h2><span class="mw-headline" id="Java_Standard_Edition">Java Standard Edition</span></h2>
<p>In JSE an <code>EntityManager</code> is accessed from the JPA <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Persistence.html" target="_blank"><code>Persistence</code></a> class through the <code>createEntityManagerFactory</code> API. The <i>persistent unit name</i> is passed to the <code>createEntityManagerFactory</code>, this is the name given in the persistence unit's <code>persistence.xml</code> file. All JSE JPA applications must define a <code>persistence.xml</code> file. The file defines the persistence unit including the name, classes, orm files, datasource, vendor specific properties.</p>
<p>JPA 1.0 does not define a standard way of specifying how to connect to the database in JSE. Each JPA provider defines their own persistence properties for setting the JDBC driver manager class, URL, user and password. JPA has a standard way of setting the <code>DataSource</code> JNDI name, but this is mainly used in JEE.</p>
<p>JPA 2.0 does define standard persistence unit properties for connecting to JDBC in JSE. These include, <code>"javax.persistence.jdbc.driver", "javax.persistence.jdbc.url", javax.persistence.jdbc.user", javax.persistence.jdbc.password"</code>.</p>
<p>The JPA application is typically required to be packaged into a persistence unit jar file. This is a normal jar, that has the <code>persistence.xml</code> file in the <code>META-INF</code> directory. Typically a JPA provider will require something special be done in JSE to enable certain features such as lazy fetching, such as static weaving (byte-code processing) of the jar, or using a Java agent JVM option.</p>
<p>In JSE the <code>EntityManager</code> must be closed when your application is done with it. The life-cycle of the <code>EntityManager</code> is typically per client, or per request. The <code>EntityManagerFactory</code> can be shared among multiple threads or users, but the <code>EntityManager</code> should not be shared.</p>
<h3><span class="mw-headline" id="Example_JPA_1.0_persistence.xml_file">Example JPA 1.0 persistence.xml file</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;persistence</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/persistence"</span>
                <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
                <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/persistence persistence_1_0.xsd"</span>
                <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">"acme"</span> <span class="na">transaction-type=</span><span class="s">"RESOURCE_LOCAL"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- EclipseLink --&gt;</span>
        <span class="nt">&lt;provider&gt;</span>org.eclipse.persistence.jpa.PersistenceProvider<span class="nt">&lt;/provider&gt;</span>

        <span class="c">&lt;!-- Hibernate --&gt;</span>
        <span class="c">&lt;!--provider&gt;org.hibernate.ejb.HibernatePersistence&lt;/provider--&gt;</span>

        <span class="c">&lt;!-- TopLink Essentials --&gt;</span>
        <span class="c">&lt;!--provider&gt;oracle.toplink.essentials.PersistenceProvider&lt;/provider--&gt;</span>

        <span class="c">&lt;!-- Apache OpenJPA --&gt;</span>
        <span class="c">&lt;!--provider&gt;org.apache.openjpa.persistence.PersistenceProviderImpl&lt;/provider--&gt;</span>

        <span class="c">&lt;!-- DataNucleus--&gt;</span>
        <span class="c">&lt;!--provider&gt;org.datanucleus.jpa.PersistenceProviderImpl&lt;/provider--&gt;</span>

        <span class="nt">&lt;exclude-unlisted-classes&gt;</span>false<span class="nt">&lt;/exclude-unlisted-classes&gt;</span>
        <span class="nt">&lt;properties&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"eclipselink.jdbc.driver"</span> <span class="na">value=</span><span class="s">"org.acme.db.Driver"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"eclipselink.jdbc.url"</span> <span class="na">value=</span><span class="s">"jdbc:acmedb://localhost/acme"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"eclipselink.jdbc.user"</span> <span class="na">value=</span><span class="s">"wile"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"eclipselink.jdbc.password"</span> <span class="na">value=</span><span class="s">"elenberry"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;/persistence-unit&gt;</span>
<span class="nt">&lt;/persistence&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Example_JPA_2.0_persistence.xml_file">Example JPA 2.0 persistence.xml file</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;persistence</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/persistence"</span>
                <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
                <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/persistence persistence_2_0.xsd"</span>
                <span class="na">version=</span><span class="s">"2.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">"acme"</span> <span class="na">transaction-type=</span><span class="s">"RESOURCE_LOCAL"</span><span class="nt">&gt;</span>
         <span class="c">&lt;!-- EclipseLink --&gt;</span>
        <span class="nt">&lt;provider&gt;</span>org.eclipse.persistence.jpa.PersistenceProvider<span class="nt">&lt;/provider&gt;</span>

        <span class="c">&lt;!-- Hibernate --&gt;</span>
        <span class="c">&lt;!--provider&gt;org.hibernate.ejb.HibernatePersistence&lt;/provider--&gt;</span>

        <span class="c">&lt;!-- TopLink Essentials --&gt;</span>
        <span class="c">&lt;!--provider&gt;oracle.toplink.essentials.PersistenceProvider&lt;/provider--&gt;</span>

        <span class="c">&lt;!-- Apache OpenJPA --&gt;</span>
        <span class="c">&lt;!--provider&gt;org.apache.openjpa.persistence.PersistenceProviderImpl&lt;/provider--&gt;</span>

        <span class="c">&lt;!-- DataNucleus --&gt;</span>
        <span class="c">&lt;!--provider&gt;org.datanucleus.jpa.PersistenceProviderImpl&lt;/provider--&gt;</span>

        <span class="nt">&lt;exclude-unlisted-classes&gt;</span>false<span class="nt">&lt;/exclude-unlisted-classes&gt;</span>
        <span class="nt">&lt;properties&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"javax.persistence.jdbc.driver"</span> <span class="na">value=</span><span class="s">"org.acme.db.Driver"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"javax.persistence.jdbc.url"</span> <span class="na">value=</span><span class="s">"jdbc:acmedb://localhost/acme"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"javax.persistence.jdbc.user"</span> <span class="na">value=</span><span class="s">"wile"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"javax.persistence.jdbc.password"</span> <span class="na">value=</span><span class="s">"elenberry"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;/persistence-unit&gt;</span>
<span class="nt">&lt;/persistence&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Example_of_accessing_an_EntityManager_from_an_EntityManagerFactory">Example of accessing an EntityManager from an EntityManagerFactory</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManagerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"acme"</span><span class="o">);</span>
<span class="n">EntityManager</span> <span class="n">entityManager</span> <span class="o">=</span>  <span class="n">factory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
<span class="o">...</span>
<span class="n">entityManager</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</pre></div>
<h2><span class="mw-headline" id="Java_Enterprise_Edition">Java Enterprise Edition</span></h2>
<p>In JEE the <code>EntityManager</code> or <code>EntityManagerFactory</code> can either be looked up in JNDI, or <i>injected</i> into a <code>SessionBean</code>. To look up the <code>EntityManager</code> in JNDI it must be published in JNDI such as through a <code>&lt;persistence-context-ref&gt;</code> in a <code>SessionBean</code>'s <code>ejb-jar.xml</code> file. To inject an <code>EntityManager</code> or <code>EntityManagerFactory</code> the annotation <code>@PersistenceContext</code> or <code>@PersistenceUnit</code> are used.</p>
<p>In JEE an <code>EntityManager</code> can either be <i>managed</i> (container-managed) or <i>non-managed</i> (application-managed). A managed <code>EntityManager</code> has a different life-cycle than an <code>EntityManager</code> managed by the application. A managed <code>EntityManager</code> should never be closed, and integrates with JTA transactions so local transaction cannot be used. Across each JTA transaction boundary all of the entities read or persisted through a managed <code>EntityManager</code> become detached. Outside of a JTA transaction a managed <code>EntityManager</code>'s behavoir is sometimes odd, so typically should be used inside a JTA transaction.</p>
<p>A non-managed <code>EntityManager</code> is one that is created by the application through a <code>EntityManagerFactory</code> or directly from <code>Persistence</code>. A non-managed <code>EntityManager</code> must be closed, and typically does not integrate with JTA, but this is possible through the <a href="https://en.wikibooks.org/wiki/Java_Persistence/Transactions#Join_Transaction" title="Java Persistence/Transactions"><code>joinTransaction</code></a> API. The entities in a non-managed <code>EntityManager</code> do not become detached after a transaction completes, and can continue to be used in subsequent transactions.</p>
<h3><span class="mw-headline" id="Example_JEE_JPA_persistence.xml_file">Example JEE JPA persistence.xml file</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;persistence</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/persistence"</span>
                <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
                <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/persistence persistence_1_0.xsd"</span>
                <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">"acme"</span> <span class="na">transaction-type=</span><span class="s">"JTA"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jta-data-source&gt;</span>jdbc/ACMEDataSource<span class="nt">&lt;/jta-data-source&gt;</span>
    <span class="nt">&lt;/persistence-unit&gt;</span>
<span class="nt">&lt;/persistence&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Example_SessionBean_ejb-jar.xml_file_with_persistence_context">Example SessionBean ejb-jar.xml file with persistence context</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;ejb-jar</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/javaee"</span>
          <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
          <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/javaee</span>
<span class="s">          http://java.sun.com/xml/ns/javaee/ejb-jar_3_0.xsd"</span>
          <span class="na">version=</span><span class="s">"3.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;enterprise-beans&gt;</span>
        <span class="nt">&lt;session&gt;</span>
            <span class="nt">&lt;ejb-name&gt;</span>EmployeeService<span class="nt">&lt;/ejb-name&gt;</span>
            <span class="nt">&lt;business-remote&gt;</span>org.acme.EmployeeService<span class="nt">&lt;/business-remote&gt;</span>
            <span class="nt">&lt;ejb-class&gt;</span>org.acme.EmployeeServiceBean<span class="nt">&lt;/ejb-class&gt;</span>
            <span class="nt">&lt;session-type&gt;</span>Stateless<span class="nt">&lt;/session-type&gt;</span>
            <span class="nt">&lt;persistence-context-ref&gt;</span>
                <span class="nt">&lt;persistence-context-ref-name&gt;</span>persistence/acme/entity-manager<span class="nt">&lt;/persistence-context-ref-name&gt;</span>
                <span class="nt">&lt;persistence-unit-name&gt;</span>acme<span class="nt">&lt;/persistence-unit-name&gt;</span>
            <span class="nt">&lt;/persistence-context-ref&gt;</span>
            <span class="nt">&lt;persistence-unit-ref&gt;</span>
                <span class="nt">&lt;persistence-unit-ref-name&gt;</span>persistence/acme/factory<span class="nt">&lt;/persistence-unit-ref-name&gt;</span>
                <span class="nt">&lt;persistence-unit-name&gt;</span>acme<span class="nt">&lt;/persistence-unit-name&gt;</span>
            <span class="nt">&lt;/persistence-unit-ref&gt;</span>
        <span class="nt">&lt;/session&gt;</span>
    <span class="nt">&lt;/enterprise-beans&gt;</span>
<span class="nt">&lt;/ejb-jar&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_looking_up_an_EntityManager_in_JNDI_from_a_SessionBean">Example of looking up an EntityManager in JNDI from a SessionBean</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">InitialContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">(</span><span class="n">properties</span><span class="o">);</span>
<span class="n">EntityManager</span> <span class="n">entityManager</span> <span class="o">=</span>  <span class="o">(</span><span class="n">EntityManager</span><span class="o">)</span><span class="n">context</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">"java:comp/env/persistence/acme/entity-manager"</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_looking_up_an_EntityManagerFactory_in_JNDI_from_a_SessionBean">Example of looking up an EntityManagerFactory in JNDI from a SessionBean</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">InitialContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">(</span><span class="n">properties</span><span class="o">);</span>
<span class="n">EntityManagerFactory</span> <span class="n">factory</span> <span class="o">=</span>  <span class="o">(</span><span class="n">EntityManagerFactory</span><span class="o">)</span><span class="n">context</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">"java:comp/env/persistence/acme/factory"</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_injecting_an_EntityManager_and_EntityManagerFactory_in_a_SessionBean">Example of injecting an EntityManager and EntityManagerFactory in a SessionBean</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Stateless</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EmployeeService"</span><span class="o">,</span> <span class="n">mappedName</span><span class="o">=</span><span class="s">"acme/EmployeeService"</span><span class="o">)</span>
<span class="nd">@Remote</span><span class="o">(</span><span class="n">EmployeeService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeeServiceBean</span> <span class="kd">implements</span> <span class="n">EmployeeService</span> <span class="o">{</span>
    
    <span class="nd">@PersistenceContext</span><span class="o">(</span><span class="n">unitName</span><span class="o">=</span><span class="s">"acme"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span>

    <span class="nd">@PersistenceUnit</span><span class="o">(</span><span class="n">unitName</span><span class="o">=</span><span class="s">"acme"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">EntityManagerFactory</span> <span class="n">factory</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_of_lookup_an_EJBContext_in_an_Entity">Example of lookup an EJBContext in an Entity</span></h4>
<p>(Useful for <a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#Auditing" title="Java Persistence/Advanced Topics">Audit</a>)</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">protected</span> <span class="n">EJBContext</span> <span class="nf">getContext</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">InitialContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">EJBContext</span><span class="o">)</span><span class="n">context</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">"java:comp/EJBContext"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">EJBException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Stateless_SessionBeans">Stateless SessionBeans</span></h3>
<h3><span class="mw-headline" id="Stateful_SessionBeans">Stateful SessionBeans</span></h3>
<h1><span class="mw-headline" id="Querying_2">Querying</span></h1>
<p>Querying is a fundamental part of persistence. Being able to persist something is not very useful without being able to query it back. There are many querying languages and frameworks; the most common query language is SQL used in relational databases.</p>
<p>JPA provides several querying mechanisms:</p>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/JPQL" title="Java Persistence/JPQL">JPQL</a>&nbsp;: (<a href="https://en.wikibooks.org/wiki/Java_Persistence/JPQL_BNF" title="Java Persistence/JPQL BNF">BNF</a>)</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Criteria" title="Java Persistence/Criteria">Criteria API</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Native_SQL_Queries">Native SQL Queries</a></li>
</ul>
<p>JPA primarily uses the Java Persistence Querying Language (JPQL), which is based on the SQL language and evolved from the EJB Query Language (EJBQL). It basically provides the SQL syntax at the object level instead of at the data level. JPQL is similar in syntax to SQL and can be defined through its <a href="https://en.wikibooks.org/wiki/Java_Persistence/JPQL_BNF" title="Java Persistence/JPQL BNF">BNF</a> definition.</p>
<p>JPA also provides the Criteria API that allows dynamic queries to be easily built using a Java API. The Criteria API mirrors the JPQL syntax, but provides Java API for each operation/function instead of using a separate query language.</p>
<p>JPA provides querying through the <code>Query</code> interface, and the <code>@NamedQuery</code> and <code>@NamedNativeQuery</code> annotations and the <code>&lt;named-query&gt;</code> and <code>&lt;named-native-query&gt;</code> XML elements.</p>
<p>Other querying languages and frameworks include:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/SQL" class="extiw" title="w:SQL" target="_blank">SQL</a></li>
<li>EJBQL</li>
<li>JDOQL</li>
<li><a rel="nofollow" class="external text" href="http://wiki.eclipse.org/EclipseLink/UserGuide/JPA/Basic_JPA_Development/Querying/JPQL#EclipseLink_Extensions_.28EQL.29" target="_blank">EQL</a> (EclipseLink Query Language)</li>
<li>Query By Example (QBE)</li>
<li>TopLink Expressions</li>
<li>Hibernate Criteria</li>
<li><a href="https://en.wikipedia.org/wiki/Object_Query_Language" class="extiw" title="w:Object Query Language" target="_blank">Object Query Language (OQL)</a></li>
<li><a rel="nofollow" class="external text" href="http://www.querydsl.com/" target="_blank">Query DSL</a></li>
</ul>
<h2><span class="mw-headline" id="Named_Queries">Named Queries</span></h2>
<p>There are two main types of queries in JPA, named queries and dynamic queries. A named query is used for a static query that will be used many times in the application. The advantage of a named query is that it can be defined once, in one place, and reused in the application. Most JPA providers also pre-parse/compile named queries, so they are more optimized than dynamic queries which typically must be parsed/compiled every time they are executed. Since named queries are part of the persistence meta-data they can also be optimized or overridden in the orm.xml without changing the application code.</p>
<p>Named queries are defined through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/NamedQuery.html" target="_blank"><code>@NamedQuery</code></a> and <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/NamedQueries.html" target="_blank"><code>@NamedQueries</code></a> annotations, or <code>&lt;named-query&gt;</code> XML element. Named queries are accessed through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#createNamedQuery(java.lang.String)" target="_blank"><code>EntityManager.createNamedQuery</code></a> API, and executed through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html" target="_blank"><code>Query</code></a> interface.</p>
<p>Named queries can be defined on any annotated class, but are typically defined on the <code>Entity</code> that they query for. The name of the named query must be unique for the entire persistence unit, they name is not local to the <code>Entity</code>. In the orm.xml named queries can be defined either on the <code>&lt;entity-mappings&gt;</code> or on any <code>&lt;entity&gt;</code>.</p>
<p>Named queries are typically parametrized, so they can be executed with different parameter values. Parameters are defined in JPQL using the <code>:&lt;name&gt;</code> syntax for named parameters, or the <code>?</code> syntax for positional parameters.</p>
<p>A collection of query hints can also be provided to a named query. Query hints can be used to optimize or to provide special configuration to a query. Query hints are specific to the JPA provider. Query hints are defined through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/QueryHint.html" target="_blank"><code>@QueryHint</code></a> annotation or <code>query-hint</code> XML element.</p>
<h3><span class="mw-headline" id="Example_named_query_annotation">Example named query annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@NamedQuery</span><span class="o">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s">"findAllEmployeesInCity"</span><span class="o">,</span>
  <span class="n">query</span><span class="o">=</span><span class="s">"Select emp from Employee emp where emp.address.city = :city"</span>
  <span class="n">hints</span><span class="o">={</span><span class="nd">@QueryHint</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"acme.jpa.batch"</span><span class="o">,</span> <span class="n">value</span><span class="o">=</span><span class="s">"emp.address"</span><span class="o">)}</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="Example_named_query_XML">Example named query XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity-mappings&gt;</span>
  <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;named-query</span> <span class="na">name=</span><span class="s">"findAllEmployeesInCity"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;query&gt;</span>Select emp from Employee emp where emp.address.city = :city<span class="nt">&lt;/query&gt;</span>
      <span class="nt">&lt;hint</span> <span class="na">name=</span><span class="s">"acme.jpa.batch"</span> <span class="na">value=</span><span class="s">"emp.address"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/named-query&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
  <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/entity-mappings&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Example_named_query_execution">Example named query execution</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNamedQuery</span><span class="o">(</span><span class="s">"findAllEmployeesInCity"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"Ottawa"</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">...</span>
</pre></div>
<h2><span class="mw-headline" id="Dynamic_Queries">Dynamic Queries</span></h2>
<p>Dynamic queries are normally used when the query depends on the context. For example, depending on which items in the query form were filled in, the query may have different parameters. Dynamic queries are also useful for uncommon queries, or prototyping.</p>
<p>JPA provides two main options for dynamic queries, JPQL and the Criteria API.</p>
<p>Dynamic queries can use parameters, and query hints the same as named queries.</p>
<p>Dynamic queries are accessed through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#createQuery(java.lang.String)" target="_blank"><code>EntityManager.createQuery</code></a> API, and executed through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html" target="_blank"><code>Query</code></a> interface.</p>
<h4><span class="mw-headline" id="Example_dynamic_query_execution">Example dynamic query execution</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"Select emp from Employee emp where emp.address.city = :city"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"Ottawa"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setHint</span><span class="o">(</span><span class="s">"acme.jpa.batch"</span><span class="o">,</span> <span class="s">"emp.address"</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">...</span>
</pre></div>
<h3><span class="mw-headline" id="Criteria_API_.28JPA_2.0.29">Criteria API (JPA 2.0)</span></h3>
<p>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Criteria" title="Java Persistence/Criteria">Criteria API</a>.</p>
<h2><span class="mw-headline" id="JPQL">JPQL</span></h2>
<p>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/JPQL" title="Java Persistence/JPQL">JPQL</a>.</p>
<h2><span class="mw-headline" id="Parameters">Parameters</span></h2>
<p>Parameters are defined in JPQL using the <code>:&lt;param&gt;</code> syntax, i.e. <code>"Select e from Employee e where e.id =&nbsp;:id"</code>. The parameter values are set on the <code>Query</code> using the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html#setParameter(java.lang.String,%20java.lang.Object)" target="_blank"><code>Query.setParameter</code></a> API.</p>
<p>Parameters can also be defined using the <code>?</code>, mainly for native SQL queries. You can also use <code>?&lt;int&gt;</code>. These are positional parameters, not named parameters and are set using the <code>Query</code> API <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html#setParameter(int,%20java.lang.Object)" target="_blank"><code>Query.setParameter</code></a>. The <code>int</code> is the index of the parameter in the SQL. Positional parameters start a 1 (not 0). Some JPA providers also allow the <code>:&lt;param&gt;</code> syntax for native queries.</p>
<p>For temporal parameters (<code>Date</code>, <code>Calendar</code>) you can also pass the temporal type, depending on if you want the <code>Date</code>, <code>Time</code> or <code>Timestamp</code> from the value.</p>
<p>Parameters are normally basic values, but you can also reference objects if comparing on their <code>Id</code>, i.e., <code>"Select e from Employee e where e.address =&nbsp;:address"</code> can take the <code>Address</code> object as a parameter. The parameter values are always at the object level when comparing to a mapped attribute, for example if comparing a mapped <code>enum</code> the <code>enum</code> value is used, not the database value.</p>
<p>Parameters are always set on the <code>Query</code>, no matter what type of query it is (JPQL, Criteria, native SQL, NamedQuery).</p>
<p>Named Parameter:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"Select e from Employee e where e.name = :name"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"Bob Smith"</span><span class="o">);</span>
</pre></div>
<p>Positional Parameter:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"SELECT * FROM EMPLOYEE WHERE NAME = ?"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Bob Smith"</span><span class="o">);</span>
</pre></div>
<h2><span class="mw-headline" id="Query_Results">Query Results</span></h2>
<p>Normally JPA queries return your persistent <code>Entity</code> objects. The returned objects will be managed by the persistent context (<code>EntityManager</code>) and changes made to the objects will be tracked as part of the current transaction. In some cases, more complex queries can be built that just return data instead of <code>Entity</code> objects, or even perform <i>update</i> or <i>deletion</i> operations.</p>
<p>There are three methods to execute a <code>Query</code>, each returning different results:</p>
<ul>
<li><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html#getResultList()" target="_blank"><code>Query.getResultList</code></a></li>
<li><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html#getSingleResult()" target="_blank"><code>Query.getSingleResult</code></a></li>
<li><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html#executeUpdate()" target="_blank"><code>Query.executeUpdate</code></a></li>
</ul>
<p><code>getResultList</code> returns a <code>List</code> of the results. This is normally a <code>List</code> of <code>Entity</code> objects, but could also be a list of data, or arrays.</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>JPQL / SQL</td>
<td>Result</td>
</tr>
<tr>
<td><code>SELECT e FROM Employee e</code></td>
<td>This returns a <code>List&lt;Employee&gt;</code> (List of Employee objects). The objects will be managed.</td>
</tr>
<tr>
<td><code>SELECT e.firstName FROM Employee e</code></td>
<td>This returns a <code>List&lt;String&gt;</code> (List of String values). The data is not managed.</td>
</tr>
<tr>
<td><code>SELECT e.firstName, e.lastName FROM Employee e</code></td>
<td>This returns a <code>List&lt;Object[String, String]&gt;</code> (List of object arrays each with two String values). The data is not managed.</td>
</tr>
<tr>
<td><code>SELECT e, e.address FROM Employee e</code></td>
<td>This returns a <code>List&lt;Object[Employee, Address]&gt;</code> (List of object arrays each with an Employee and Address objects). The objects will be managed.</td>
</tr>
<tr>
<td><code>SELECT EMP_ID, F_NAME, L_NAME FROM EMP</code></td>
<td>This returns a <code>List&lt;Object[BigDecimal, String, String]&gt;</code> (List of object arrays each with the row data). The data is not managed.</td>
</tr>
</tbody></table>
<p><br>
<code>getSingleResult</code> returns the results. This is normally an <code>Entity</code> object, but could also be data, or an object array. If the query returns nothing, an exception is thrown. This is unfortunate, as typically just returning <code>null</code> would be desired. Some JPA providers may have an option to return <code>null</code> instead of throwing an exception if nothing is returned. An exception is also thrown if the query returns more than just a single row. This is also unfortunate, as typically just returning the first result is desired. Some JPA providers may have an option to return the first result instead of throwing an exception, otherwise you need to call <code>getResultList</code> and get the first element.</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr style="background:#ffdead">
<td>JPQL / SQL</td>
<td>Result</td>
</tr>
<tr>
<td><code>SELECT e FROM Employee e</code></td>
<td>This returns an <code>Employee</code>. The object will be managed.</td>
</tr>
<tr>
<td><code>SELECT e.firstName FROM Employee e</code></td>
<td>This returns a <code>String</code>. The data is not managed.</td>
</tr>
<tr>
<td><code>SELECT e.firstName, e.lastName FROM Employee e</code></td>
<td>This returns an <code>Object[String, String]</code> (object array with two String values). The data is not managed.</td>
</tr>
<tr>
<td><code>SELECT e, e.address FROM Employee e</code></td>
<td>This returns an <code>Object[Employee, Address]</code> (object array with an Employee and Address object). The objects will be managed.</td>
</tr>
<tr>
<td><code>SELECT EMP_ID, F_NAME, L_NAME FROM EMP</code></td>
<td>This returns an <code>Object[BigDecimal, String, String]</code> (object array with the row data). The data is not managed.</td>
</tr>
</tbody></table>
<p><br>
<code>executeUpdate</code> returns the database row count. This can be used for <code>UPDATE</code> <code>DELETE</code> JPQL queries, or any native SQL (DML or DDL) query that does not return a result.</p>
<h2><span class="mw-headline" id="Common_Queries">Common Queries</span></h2>
<h3><span class="mw-headline" id="Joining.2C_querying_on_a_OneToMany_relationship"><i>Joining, querying on a OneToMany relationship</i></span></h3>
<p>To query <i>all employees with a phone number in 613 area code</i> a <i>join</i> is used.</p>
<p>JPQL:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">JOIN</span> <span class="n">e</span><span class="p">.</span><span class="n">phoneNumbers</span> <span class="n">p</span> <span class="k">where</span> <span class="n">p</span><span class="p">.</span><span class="n">areaCode</span> <span class="o">=</span> <span class="s1">'613'</span>
</pre></div>
<p>Criteria:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">CriteriaBuilder</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Root</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">employee</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Join</span><span class="o">&lt;</span><span class="n">PhoneNumber</span><span class="o">&gt;</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">employee</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"phoneNumbers"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">phone</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"areaCode"</span><span class="o">),</span> <span class="s">"613"</span><span class="o">));</span>
</pre></div>
<h3><span class="mw-headline" id="Subselect.2C_querying_all_of_a_to_many_relationship"><i>Subselect, querying all of a to many relationship</i></span></h3>
<p>To query <i>all employees whose projects are all in trouble</i> a <i>subselect</i> with a double negation is used.</p>
<p>JPQL:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">JOIN</span> <span class="n">e</span><span class="p">.</span><span class="n">projects</span> <span class="n">p</span> <span class="k">where</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">t</span> <span class="k">from</span> <span class="n">Project</span> <span class="n">t</span> <span class="k">where</span> <span class="n">p</span> <span class="o">=</span> <span class="n">t</span> <span class="k">AND</span> <span class="n">t</span><span class="p">.</span><span class="n">status</span> <span class="o">&lt;&gt;</span> <span class="s1">'In trouble'</span><span class="p">)</span>
</pre></div>
<p>Criteria:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">CriteriaBuilder</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Root</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">employee</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Join</span><span class="o">&lt;</span><span class="n">Project</span><span class="o">&gt;</span> <span class="n">project</span> <span class="o">=</span> <span class="n">employee</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"projects"</span><span class="o">);</span>
<span class="n">Subquery</span><span class="o">&lt;</span><span class="n">Project</span><span class="o">&gt;</span> <span class="n">subquery</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">subquery</span><span class="o">(</span><span class="n">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Root</span><span class="o">&lt;</span><span class="n">Project</span><span class="o">&gt;</span> <span class="n">subProject</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">subquery</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">project</span><span class="o">,</span> <span class="n">subProject</span><span class="o">),</span> <span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">subProject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"status"</span><span class="o">),</span> <span class="s">"In trouble"</span><span class="o">)));</span>
<span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">not</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">subquery</span><span class="o">));</span>
</pre></div>
<h3><span class="mw-headline" id="Subselect.2C_querying_a_to_many_relationship_where_all_of_the_relations_are_in_a_list"><i>Subselect, querying a to many relationship where all of the relations are in a list</i></span></h3>
<p>To query <i>all employees who are in all the list of projects</i> a <i>subselect</i> with a count is used. First collect the project ids from the projects (using the objects may work as well). Then get the size of the list. Your query will need two arguments, one of the list of ids, and one for the size of the list.</p>
<p>JPQL:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">where</span> <span class="p">:</span><span class="k">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">from</span> <span class="n">Project</span> <span class="n">p</span><span class="p">,</span> <span class="n">Employee</span> <span class="n">e2</span> <span class="k">join</span> <span class="n">e2</span><span class="p">.</span><span class="n">projects</span> <span class="n">p2</span> <span class="k">where</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p2</span> <span class="k">AND</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e2</span> <span class="k">AND</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span> <span class="k">IN</span> <span class="p">:</span><span class="n">projects</span><span class="p">)</span>
</pre></div>
<h3><span class="mw-headline" id="Join_fetch.2C_read_both_employee_and_address_in_same_query"><i>Join fetch, read both employee and address in same query</i></span></h3>
<p>To query <i>all employees and their address</i> a <i>join fetch</i> is used. This selects both the employee and address data in the same query. If the join fetch was not used, the employee address would still be available, but could cause a query for each employee for its address. This reduces <i>n+1</i> queries to <i>1</i> query.</p>
<p>Join fetch:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span>
</pre></div>
<p>Join fetch can also be used on collection relationships:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">e</span><span class="p">.</span><span class="n">phones</span>
</pre></div>
<p>Outer joins can be used to avoid <code>null</code> and empty relationships from filtering the results:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">e</span><span class="p">.</span><span class="n">phones</span>
</pre></div>
<p>You can also select multiple objects in a query, but note that this does not instantiate the relationship, so accessing the relationship could still trigger another query:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span><span class="p">,</span> <span class="n">a</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span><span class="p">,</span> <span class="n">Address</span> <span class="n">a</span> <span class="k">WHERE</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">a</span>
</pre></div>
<h3><span class="mw-headline" id="Inverse_ManyToMany.2C_all_employees_for_a_given_project"><i>Inverse ManyToMany, all employees for a given project</i></span></h3>
<p>To query <i>all employees for a given project</i> where the employee project relationship is a ManyToMany.</p>
<p>If the relationship is bi-directional you could use:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">p</span><span class="p">.</span><span class="n">employees</span> <span class="k">from</span> <span class="n">Project</span> <span class="n">p</span> <span class="k">where</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name</span>
</pre></div>
<p>If it is uni-directional you could use:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span><span class="p">,</span> <span class="n">Project</span> <span class="n">p</span> <span class="k">where</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name</span> <span class="k">and</span> <span class="n">p</span> <span class="n">member</span> <span class="k">of</span> <span class="n">e</span><span class="p">.</span><span class="n">projects</span>
</pre></div>
<p>or,</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">join</span> <span class="n">employee</span><span class="p">.</span><span class="n">projects</span> <span class="n">p</span> <span class="k">where</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name</span>
</pre></div>
<h3><span class="mw-headline" id="How_to_simulate_casting_to_a_subclass"><i>How to simulate casting to a subclass</i></span></h3>
<p>To query <i>all employees who have a large project with a budget greater than 1,000,000</i> where the employee only has a relationship to Project, not to the LargeProject subclass. JPA 1.0 JPQL does not define a cast operation (JPA 2.0 may define this), so querying on an attribute of a subclass is not obvious. This can be done indirectly however, if you add a secondary join to the subclass to the query.</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">join</span> <span class="n">employee</span><span class="p">.</span><span class="n">projects</span> <span class="n">p</span><span class="p">,</span> <span class="n">LargeProject</span> <span class="n">lproject</span> <span class="k">where</span> <span class="n">p</span> <span class="o">=</span> <span class="n">lproject</span> <span class="k">and</span> <span class="n">lproject</span><span class="p">.</span><span class="n">budget</span> <span class="o">&gt;</span> <span class="mi">1000000</span>
</pre></div>
<h3><span class="mw-headline" id="How_to_select_the_first_element_in_a_collection"><i>How to select the first element in a collection</i></span></h3>
<p>To query <i>the employees first project</i> for a particular employee. There are a few different ways to do this, some using straight JPQL, and some using the <code>Query</code> <code>setMaxResuls</code> API. If a JPA 2.0 indexed list is used to map the collection, then the <code>INDEX</code> function can be used.</p>
<p><b>setMaxResults:</b></p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"Select e.projects from Employee e where e.id = :id"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</pre></div>
<p><br></p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"Select p from Employee e join e.projects p where e.id = :id"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</pre></div>
<p><b>JPQL:</b></p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">p</span> <span class="k">from</span> <span class="n">Project</span> <span class="n">p</span> <span class="k">where</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="k">Select</span> <span class="k">MAX</span><span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">join</span> <span class="n">e</span><span class="p">.</span><span class="n">projects</span> <span class="n">p2</span> <span class="k">where</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span><span class="p">)</span>
</pre></div>
<p><b>JPA 2.0:</b></p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">p</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">join</span> <span class="n">e</span><span class="p">.</span><span class="n">projects</span> <span class="n">p</span> <span class="k">where</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span> <span class="k">and</span> <span class="k">INDEX</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
<h3><span class="mw-headline" id="How_to_order_by_the_size_of_a_collection"><i>How to order by the size of a collection</i></span></h3>
<p>To query <i>all employees ordered by the number of projects</i>. There are a few different ways to do this, some end up using sub selects in SQL, and some use group by. Depending on your JPA provider and database you solution may be limited to one or the other.</p>
<p><b>Using SIZE function (uses sub-select in SQL)</b></p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="k">order</span> <span class="k">by</span> <span class="k">SIZE</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">projects</span><span class="p">)</span> <span class="k">DESC</span>
</pre></div>
<p><b>Using SIZE function, also selects the size (uses group by)</b></p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">e</span><span class="p">,</span> <span class="k">SIZE</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">projects</span><span class="p">)</span> <span class="k">from</span> <span class="n">Employee</span> <span class="k">order</span> <span class="k">by</span> <span class="k">SIZE</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">projects</span><span class="p">)</span> <span class="k">DESC</span>
</pre></div>
<p><b>Using GROUP BY</b></p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">e</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">from</span> <span class="n">Employee</span> <span class="k">join</span> <span class="n">e</span><span class="p">.</span><span class="n">projects</span> <span class="n">p</span> <span class="k">order</span> <span class="k">by</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">DESC</span>
</pre></div>
<p><b>Using GROUP BY and alias</b></p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">e</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">as</span> <span class="n">pcount</span> <span class="k">from</span> <span class="n">Employee</span> <span class="k">join</span> <span class="n">e</span><span class="p">.</span><span class="n">projects</span> <span class="n">p</span> <span class="k">order</span> <span class="k">by</span> <span class="n">pcount</span> <span class="k">DESC</span>
</pre></div>
<h1><span class="mw-headline" id="Advanced_12">Advanced</span></h1>
<h2><span class="mw-headline" id="Join_Fetch_and_Query_Optimization">Join Fetch and Query Optimization</span></h2>
<p>There are several ways to optimize queries in JPA. The typical query performance issue is that an object is read first, then its related objects are read one by one. This can be optimized using <code>JOIN FETCH</code> in JPQL, otherwise by query hints specific for each JPA provider.</p>
<p>See,</p>
<ul>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Join_Fetching" title="Java Persistence/Relationships">Join Fetching</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships#Batch_Fetching" title="Java Persistence/Relationships">Batch Fetching</a></li>
</ul>
<h2><span class="mw-headline" id="Timeouts.2C_Fetch_Size_and_other_JDBC_Optimizations">Timeouts, Fetch Size and other JDBC Optimizations</span></h2>
<p>There are several JDBC options that can be used when executing a query. These JDBC options are not exposed by JPA, but some JPA providers may support query hints for them.</p>
<ul>
<li>Fetch size&nbsp;: Configures the number of rows to fetch from the database in each page. A larger fetch size is more efficient for large queries.</li>
<li>Timeout&nbsp;: Instructs the database to cancel the query if its execution takes too long.</li>
</ul>
<p><br></p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>/<a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>&nbsp;: Provide many query hints including:
<dl>
<dd>"eclipselink.jdbc.fetch-size" - Fetch size.</dd>
<dd>"eclipselink.jdbc.timeout" - Timeout.</dd>
<dd>"eclipselink.read-only" - The objects returned from the query are not managed by the persistence context, and not tracked for changes.</dd>
<dd>"eclipselink.query-type" - Defines the native type of query to use for the query.</dd>
<dd>"eclipselink.sql.hint" - Allows an SQL hint to be included in the SQL for the query.</dd>
<dd>"eclipselink.jdbc.bind-parameters" - Specifies if parameter binding should be used or not, (is used by default).</dd>
</dl>
</dd>
</dl>
<h2><span class="mw-headline" id="Update_and_Delete_Queries">Update and Delete Queries</span></h2>
<p>JPQL also allows for <code>UPDATE</code> and <code>DELETE</code> queries to be executed. This is not the recommend or normal way to modify objects in JPA. Normally in JPA you first read the object, then either modify it directly using its <code>set</code> methods to update it, or call the <code>EntityManager.remove()</code> method to delete it.</p>
<p><code>UPDATE</code> and <code>DELETE</code> queries in JPQL are for performing batch updates or deletions. There allow a set of objects to be updated or deleted in a single query. These queries are useful for performing batch operations, or clearing test data.</p>
<p><code>UPDATE</code> and <code>DELETE</code> queries have a <code>WHERE</code> the same as <code>SELECT</code> queries, and can use the same functions and operations, and traverse relationships and make use of <i>sub selects</i>. <code>UPDATE</code> and <code>DELETE</code> queries are executed using the <code>Query.executeUpdate()</code> method, and return the row count from the database. Note that some caution should be used in execute these queries in an active persistence context, as the queries may effect the objects that have already been registered in the <code>EntityManager</code>. Normally it is a good idea to <code>clear()</code> the <code>EntityManager</code> after executing the query, or to execute the query in a new <code>EntityManager</code> or transaction.</p>
<h3><span class="mw-headline" id="Example_update_query">Example update query</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">UPDATE</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">SET</span> <span class="n">e</span><span class="p">.</span><span class="n">salary</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">salary</span> <span class="o">+</span> <span class="mi">1000</span> <span class="k">WHERE</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="o">=</span> <span class="p">:</span><span class="n">city</span>
</pre></div>
<h3><span class="mw-headline" id="Example_delete_query">Example delete query</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">WHERE</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="o">=</span> <span class="p">:</span><span class="n">city</span>
</pre></div>
<h2><span class="mw-headline" id="Flush_Mode">Flush Mode</span></h2>
<p>Within a transaction context in JPA, changes made to the managed objects are normally not flushed (written) to the database until commit. So if a query were executed against the database directly, it would not see the changes made within the transaction, as these changes are only made in memory within the Java. This can cause issues if new objects have been persisted, or objects have been removed or changed, as the application may expect the query to return these results. Because of this JPA requires that the JPA provider performs a flush of all changes to the database before any query operation. This however can cause issues if the application is not expecting that a flush as a side effect of a query operation. If the application changes are not yet in a state to be flushed, a flush may not be desired. Flushing also can be expensive and causes the database transaction, and database locks are other resources to be held for the duration of the transaction, which can effect performance and concurrency.</p>
<p>JPA allows the flush mode for a query to be configured using the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/FlushModeType.html" target="_blank"><code>FlushModeType</code></a> enum and the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html#setFlushMode(javax.persistence.FlushModeType)" target="_blank"><code>Query.setFlushMode()</code></a> API. The flush mode is either <code>AUTO</code> the default which means flush before every query execution, or <code>COMMIT</code> which means only flush on commit. The flush mode can also be set on an <code>EntityManager</code> using the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#setFlushMode(javax.persistence.FlushModeType)" target="_blank"><code>EntityManager.setFlushMode()</code></a> API, to affect all queries executed with the <code>EntityManager</code>. The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#flush()" target="_blank"><code>EntityManager.flush()</code></a> API can be called directly on the <code>EntityManager</code> anytime that a flush is desired.</p>
<p>Some JPA providers also let the flush mode be configured through persistence unit properties, or offer alternatives to flushing, such as performing the query against the in memory objects.</p>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Allow the auto flush to be disabled using the persistence unit property <code>"eclipselink.persistence-context.flush-mode"="COMMIT"</code>.</dd>
</dl>
</dd>
</dl>
<h2><span class="mw-headline" id="Pagination.2C_Max.2FFirst_Results">Pagination, Max/First Results</span></h2>
<p>A common requirement is to allow the user to page through a large query result. Typically a web user is given the first page of <i>n</i> results after a query execution, and can click <i>next</i> to go to the next page, or <i>previous</i> to go back.</p>
<p>If you are not concerned about performance, or the results are not too big, the easiest way to implement this is to query all of the results, then access the sub-list from the result list to populate your page. However, you will then have to re-query the entire results on every page request.</p>
<p>One simple solution is to store the query results in a <i>stateful</i> <code>SessionBean</code> or an <i>http session</i>. This means the initial query make take a while, but paging will be fast. Some JPA providers also support the caching of query results, so you can cache the results in your JPA providers cache and just re-execute the query to obtain the cached results.</p>
<p>If the query result is quite large, then another solution may be required. JPA provides the <code>Query</code> API <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html#setFirstResult(int)" target="_blank"><code>setFirstResult</code></a>, <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/Query.html#setMaxResults(int)" target="_blank"><code>setMaxResults</code></a> to allow paging through a large query result. The <code>maxResults</code> can also be used as a safeguard to avoid letting users execute queries that return too many objects.</p>
<p>How these query properties are implemented depends on the JPA provider and database. JDBC allows the <code>maxResults</code> to be set, and most JDBC drivers support this, so it will normally work for most JPA providers and most databases. Support for <code>firstResult</code> can be less guaranteed to be efficient, as it normally requires database specific SQL. There is no standard SQL for pagination, so whether if this is supported depends on your database, and your JPA providers support.</p>
<p>When performing pagination, it is also important to <i>order</i> the result. If the query does not order the result, then each subsequent query could potentially return the results in a different order, and give a different page. Also if rows are insert/deleted in between the queries, the results can be slightly different.</p>
<h3><span class="mw-headline" id="Example_using_firstResult.2C_maxResults">Example using firstResult, maxResults</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"Select e from Employee e order by e.id"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setFirstResult</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></div>
<p><br>
An alternative to using <code>firstResult</code> is to filter the first result in the where clause based on the order by and the value from the previous page.</p>
<h3><span class="mw-headline" id="Example_using_maxResults_and_order_by">Example using maxResults and order by</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"Select e from Employee e where e.id &gt; :lastId order by e.id"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"lastId"</span><span class="o">,</span> <span class="n">prevousPage</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">prevousPage</span><span class="o">.</span><span class="na">size</span><span class="o">()-</span><span class="mi">1</span><span class="o">).</span><span class="na">getId</span><span class="o">());</span>
<span class="n">query</span><span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">nextPage</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></div>
<p><br>
Another alternative is to only query the <code>Id</code>s, and store this result in a <i>stateful</i> <code>SessionBean</code> or an <i>http session</i>. Then query for the set of <code>Id</code>s for each page.</p>
<h3><span class="mw-headline" id="Example_using_Ids_and_IN">Example using Ids and IN</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"Select e.id from Employee e"</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

<span class="n">Query</span> <span class="n">pageQuery</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"Select e from Employee e where e.id in :ids"</span><span class="o">);</span>
<span class="n">pageQuery</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"ids"</span><span class="o">,</span> <span class="n">ids</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="mi">200</span><span class="o">));</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">pageQuery</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></div>
<p><br>
Pagination can also be used for server processes, or batch jobs. On the server, it is normally used to avoid using too much memory upfront, and allow processing each batch one at a time. Any of these techniques can be used, also some JPA providers support returning a database <i>cursor</i> for the query results that allows scrolling through the results.</p>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support streams and scrollable cursors through the query hints <code>"eclipselink.cursor.scrollable"</code> and <code>"eclipselink.cursor"</code>, and <code>CursoredStream</code> and <code>ScrollableCursor</code> classes.</dd>
</dl>
</dd>
</dl>
<h2><span class="mw-headline" id="Native_SQL_Queries">Native SQL Queries</span></h2>
<p>Typically queries in JPA are defined through JPQL. JPQL allows the queries to be defined in terms of the object model, instead of the data model. Since developers are programming in Java using the object model, this is normally more intuitive. This also allows for data abstraction and database schema and database platform independence. JPQL supports much of the SQL syntax, but some aspects of SQL, or specific database extensions or functions may not be possible through JPQL, so native SQL queries are sometimes required. Also some developers have more experience with SQL than JPQL, so may prefer to use SQL queries. Native queries can also be used for calling some types of stored procedures or executing DML or DDL operations.</p>
<p>Native queries are defined through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/NamedNativeQuery.html" target="_blank"><code>@NamedNativeQuery</code></a> and <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/NamedNativeQueries.html" target="_blank"><code>@NamedNativeQueries</code></a> annotations, or <code>&lt;named-native-query&gt;</code> XML element. Native queries can also be defined dynamically using the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#createNativeQuery(java.lang.String)" target="_blank"><code>EntityManager.createNativeQuery()</code></a> API.</p>
<p>A native query can be for a query for instances of a class, a query for raw data, an update or DML or DDL operation, or a query for a complex query result. If the query is for a class, the <code>resultClass</code> attribute of the query must be set. If the query result is complex, a <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Result_Set_Mapping">Result Set Mapping</a> can be used.</p>
<p>Native queries can be parameterized, so they can be executed with different parameter values. Parameters are defined in SQL using the <code>?</code> syntax for positional parameters, JPA does not require native queries support named parameters, but some JPA providers may. For positional parameter the position starts a 1 (not 0).</p>
<p>A collection of query hints can also be provided to a native query. Query hints can be used to optimize or to provide special configuration to a query. Query hints are specific to the JPA provider. Query hints are defined through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/QueryHint.html" target="_blank"><code>@QueryHint</code></a> annotation or <code>query-hint</code> XML element.</p>
<h4><span class="mw-headline" id="Example_native_named_query_annotation">Example native named query annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@NamedNativeQuery</span><span class="o">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s">"findAllEmployeesInCity"</span><span class="o">,</span>
  <span class="n">query</span><span class="o">=</span><span class="s">"SELECT E.* from EMP E, ADDRESS A WHERE E.EMP_ID = A.EMP_ID AND A.CITY = ?"</span><span class="o">,</span>
  <span class="n">resultClass</span><span class="o">=</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h4><span class="mw-headline" id="Example_native_named_query_XML">Example native named query XML</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;entity-mappings&gt;</span>
  <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"Employee"</span> <span class="na">class=</span><span class="s">"org.acme.Employee"</span> <span class="na">access=</span><span class="s">"FIELD"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;named-native-query</span> <span class="na">name=</span><span class="s">"findAllEmployeesInCity"</span> <span class="na">result-class=</span><span class="s">"org.acme.Employee"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;query&gt;</span>SELECT E.* from EMP E, ADDRESS A WHERE E.EMP_ID = A.EMP_ID AND A.CITY = ?<span class="nt">&lt;/query&gt;</span>
    <span class="nt">&lt;/named-native-query&gt;</span>
    <span class="nt">&lt;attributes&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/attributes&gt;</span>
  <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/entity-mappings&gt;</span>
</pre></div>
<h4><span class="mw-headline" id="Example_native_named_query_execution">Example native named query execution</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNamedQuery</span><span class="o">(</span><span class="s">"findAllEmployeesInCity"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Ottawa"</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">...</span>
</pre></div>
<h4><span class="mw-headline" id="Example_dynamic_native_query_execution">Example dynamic native query execution</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"SELECT E.* from EMP E, ADDRESS A WHERE E.EMP_ID = A.EMP_ID AND A.CITY = ?"</span><span class="o">,</span> <span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Ottawa"</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">...</span>
</pre></div>
<h3><span class="mw-headline" id="Result_Set_Mapping">Result Set Mapping</span></h3>
<p>When a native SQL query returns objects, the SQL must ensure it returns the correct data to build the <code>resultClass</code> using the correct column names as specified in the mappings. If the SQL is more complex and returns different column names, or returns data for multiple objects then a <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/SqlResultSetMapping.html" target="_blank"><code>@SqlResultSetMapping</code></a> must be used.</p>
<p><code>@SqlResultSetMapping</code> is a fairly complex annotation containing an array of <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityResult.html" target="_blank"><code>@EntityResult</code></a>, <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/7/docs/api/javax/persistence/ConstructorResult.html" target="_blank"><code>@ConstructorResult</code></a>, and <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/ColumnResult.html" target="_blank"><code>@ColumnResult</code></a>. This allows multiple <code>Entity</code> objects in combination with raw data, and non-mapped classes, to be returned. The <code>@EntityResult</code> contains an array of <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/FieldResult.html" target="_blank"><code>@FieldResult</code></a>, which can be used to map the alias name used in the SQL to the column name required by the mapping. This is required if you need to return two different instances of the same class, or if the SQL needs to alias the columns differently for some reason. Note that in the <code>@FieldResult</code> the <code>name</code> is the name of the attribute in the object, not the column name in the mapping. This seems odd, because this would make mapping an <code>Embedded</code> or composite id relationship not possible.</p>
<p>Normally it is easiest to either select raw data or a single object with native SQL queries, so <code>@SqlResultSetMapping</code>s can normally be avoided, as they are quite complex. Also note that even if you select the <code>Employee</code> and its <code>Address</code> with the SQL, these are two unrelated objects, the employee's address is not set, and may trigger a query if accessed unless a cache hit occurs. Some JPA providers may provide a query hint to allow join fetching to be used with native SQL queries.</p>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support join fetching with native SQL queries through the <code>"eclipselink.join-fetch"</code> query hint.</dd>
</dl>
</dd>
</dl>
<h4><span class="mw-headline" id="Example_result_set_mapping_annotation">Example result set mapping annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@NamedNativeQuery</span><span class="o">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s">"findAllEmployeesInCity"</span><span class="o">,</span>
  <span class="n">query</span><span class="o">=</span><span class="s">"SELECT E.*, A.* from EMP E, ADDRESS A WHERE E.EMP_ID = A.EMP_ID AND A.CITY = ?"</span><span class="o">,</span>
  <span class="n">resultSetMapping</span><span class="o">=</span><span class="s">"employee-address"</span>
<span class="o">)</span>
<span class="nd">@SqlResultSetMapping</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"employee-address"</span><span class="o">,</span> 
  <span class="n">entities</span><span class="o">={</span> 
    <span class="nd">@EntityResult</span><span class="o">(</span><span class="n">entityClass</span><span class="o">=</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
    <span class="nd">@EntityResult</span><span class="o">(</span><span class="n">entityClass</span><span class="o">=</span><span class="n">Address</span><span class="o">.</span><span class="na">class</span><span class="o">)}</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h3><span class="mw-headline" id="ConstructorResult_.28JPA_2.1.29">ConstructorResult (JPA 2.1)</span></h3>
<p>JPA 2.1 defines a <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/7/docs/api/javax/persistence/ConstructorResult.html" target="_blank"><code>@ConstructorResult</code></a> annotation to allow the returning of non-mapped classes from native SQL queries. The <code>ConstructorResult</code> is similar to the JPQL <code>NEW</code> operator that allows the calling of a class constructor passing in the raw data. The <code>ConstructorResult</code> has a <code>targetClass</code> and <code>columns</code> array of <code>ColumnResults</code>. The target class must define a constructor taking the same number of arguments and types as defined by the <code>columns</code>.</p>
<h4><span class="mw-headline" id="Example_constructor_result_annotation">Example constructor result annotation</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@NamedNativeQuery</span><span class="o">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s">"findAllEmployeeDetails"</span><span class="o">,</span>
  <span class="n">query</span><span class="o">=</span><span class="s">"SELECT E.EMP_ID, E.F_NAME, E.L_NAME, A.CITY from EMP E, ADDRESS A WHERE E.EMP_ID = A.EMP_ID"</span><span class="o">,</span>
  <span class="n">resultSetMapping</span><span class="o">=</span><span class="s">"employee-details"</span>
<span class="o">)</span>
<span class="nd">@SqlResultSetMapping</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"employee-details"</span><span class="o">,</span> 
  <span class="n">classes</span><span class="o">={</span> 
    <span class="nd">@ConstructorResult</span><span class="o">(</span><span class="n">targetClass</span><span class="o">=</span><span class="n">EmployeeDetails</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">columns</span><span class="o">={</span>
        <span class="nd">@ColumnResult</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMP_ID"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@ColumnResult</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"F_NAME"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@ColumnResult</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"L_NAME"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@ColumnResult</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CITY"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">})</span>
  <span class="o">}</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Stored_Procedures_2">Stored Procedures</span></h2>
<p>See <a href="https://en.wikibooks.org/wiki/Java_Persistence/Advanced_Topics#Stored_Procedures" title="Java Persistence/Advanced Topics">Stored Procedures</a></p>
<h2><span class="mw-headline" id="Raw_JDBC">Raw JDBC</span></h2>
<p>It can sometimes be required to mix JDBC code with JPA code. This may be to access certain JDBC driver specific features, or to integrate with another application that uses JDBC instead of JPA.</p>
<p>If you just require a JDBC connection, you could access one from your JEE server's <code>DataSource</code>, or connect directly to <code>DriverManager</code> or a third party connection pool. If you need a JDBC connection in the same transaction context and your JPA application, you could use a JTA <code>DataSource</code> for JPA and your JDBC access to have them share the same global transaction. If you are not using JEE, or not using JTA, then you may be able to access the JDBC connection directly from your JPA provider.</p>
<p>Some JPA providers provide an API to access a raw JDBC connection from their internal connection pool, or from their transaction context. In JPA 2.0 this API is somewhat standardized by the <code>unwrap</code> API on <code>EntityManager</code>.</p>
<p>To access a JDBC connection from an <code>EntityManager</code>, some JPA 2.0 providers may support:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Connection</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
<p>This connection could then be used for raw JDBC access. It normally should not be close when finished, as the connection is being used by the <code>EntityManager</code> and will be released when the <code>EntityManager</code> is closed or transaction committed.</p>
<dl>
<dd>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support unwrapping the JDBC <code>Connection</code>.</dd>
</dl>
</dd>
</dl>
<h1><span class="mw-headline" id="JPQL_BNF">JPQL BNF</span></h1>
<p>The following defines the structure of the JPQL query language. For further examples and usage see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Querying" title="Java Persistence/Querying">Querying</a>.</p>
<pre> | = or
 [] = optional
 * = repeatable (zero or more times)
 {} = mandatory
</pre>
<p>QL_statement&nbsp;::= <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Select_Clause">select_statement</a> | <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Update">update_statement</a> | <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Delete">delete_statement</a></p>
<h2><span class="mw-headline" id="Select">Select</span></h2>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">Select</span> <span class="n">employee</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">employee</span> <span class="k">join</span> <span class="n">employee</span><span class="p">.</span><span class="n">address</span> <span class="n">address</span> 
<span class="k">where</span> <span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="o">=</span> <span class="p">:</span><span class="n">city</span> <span class="k">and</span> <span class="n">employee</span><span class="p">.</span><span class="n">firstName</span> <span class="k">like</span> <span class="p">:</span><span class="n">name</span> <span class="k">order</span> <span class="k">by</span> <span class="n">employee</span><span class="p">.</span><span class="n">firstName</span>
</pre></div>
<p>select_statement&nbsp;::= <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Select_Clause">select_clause</a> <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#From">from_clause</a> <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Where">[where_clause]</a> <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Group_By">[groupby_clause]</a> <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Group_By">[having_clause]</a> <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Order_By">[orderby_clause]</a></p>
<h3><span class="mw-headline" id="From">From</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">FROM</span> <span class="n">Employee</span> <span class="n">employee</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">employee</span><span class="p">.</span><span class="n">address</span> 
<span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="k">FETCH</span> <span class="n">employee</span><span class="p">.</span><span class="n">phones</span> <span class="k">JOIN</span> <span class="n">employee</span><span class="p">.</span><span class="n">manager</span> <span class="n">manager</span><span class="p">,</span> <span class="n">Employee</span> <span class="n">ceo</span>
</pre></div>
<p>from_clause&nbsp;::= FROM identification_variable_declaration {, {identification_variable_declaration | collection_member_declaration}}*</p>
<p>identification_variable_declaration&nbsp;::= range_variable_declaration { join | fetch_join }*</p>
<p>range_variable_declaration&nbsp;::= abstract_schema_name [AS] identification_variable</p>
<p>join&nbsp;::= join_spec join_association_path_expression [AS] identification_variable</p>
<p>fetch_join&nbsp;::= join_spec FETCH join_association_path_expression</p>
<p>association_path_expression&nbsp;::= collection_valued_path_expression | single_valued_association_path_expression</p>
<p>join_spec::= [ LEFT [OUTER] | INNER ] JOIN</p>
<p>join_association_path_expression&nbsp;::= join_collection_valued_path_expression | join_single_valued_association_path_expression</p>
<p>join_collection_valued_path_expression::= identification_variable.collection_valued_association_field</p>
<p>join_single_valued_association_path_expression::= identification_variable.single_valued_association_field</p>
<p>collection_member_declaration&nbsp;::= IN (collection_valued_path_expression) [AS] identification_variable</p>
<p>single_valued_path_expression&nbsp;::= state_field_path_expression | single_valued_association_path_expression</p>
<p>state_field_path_expression&nbsp;::= {identification_variable | single_valued_association_path_expression}.state_field</p>
<p>single_valued_association_path_expression&nbsp;::= identification_variable.{single_valued_association_field.}* single_valued_association_field</p>
<p>collection_valued_path_expression&nbsp;::= identification_variable.{single_valued_association_field.}*collection_valued_association_field</p>
<p>state_field&nbsp;::= {embedded_class_state_field.}*simple_state_field</p>
<h3><span class="mw-headline" id="Select_Clause">Select Clause</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">employee</span><span class="p">.</span><span class="n">phones</span>

<span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">employee</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span><span class="p">,</span> <span class="k">NEW</span> <span class="n">com</span><span class="p">.</span><span class="n">acme</span><span class="p">.</span><span class="n">EmployeeInfo</span><span class="p">(</span><span class="k">AVG</span><span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="n">salary</span><span class="p">),</span> <span class="k">MAX</span><span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="n">salary</span><span class="p">))</span>
</pre></div>
<p>select_clause&nbsp;::= SELECT [DISTINCT] select_expression {, select_expression}*</p>
<p>select_expression&nbsp;::= single_valued_path_expression | aggregate_expression | identification_variable | OBJECT(identification_variable) | constructor_expression</p>
<p>constructor_expression&nbsp;::= NEW constructor_name ( constructor_item {, constructor_item}* )</p>
<p>constructor_item&nbsp;::= single_valued_path_expression | aggregate_expression</p>
<p>aggregate_expression&nbsp;::= { AVG | MAX | MIN | SUM } ([DISTINCT] state_field_path_expression) | COUNT ([DISTINCT] identification_variable | state_field_path_expression | single_valued_association_path_expression)</p>
<h3><span class="mw-headline" id="Where">Where</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">WHERE</span> <span class="n">employee</span><span class="p">.</span><span class="n">firstName</span> <span class="o">=</span> <span class="p">:</span><span class="n">name</span> <span class="k">AND</span> <span class="n">employee</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="k">LIKE</span> <span class="s1">'Ott%'</span> <span class="k">ESCAPE</span> <span class="s1">'/'</span> 
<span class="k">OR</span> <span class="n">employee</span><span class="p">.</span><span class="n">id</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="n">salary</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40000</span>
</pre></div>
<p>where_clause&nbsp;::= WHERE conditional_expression</p>
<p>conditional_expression&nbsp;::= conditional_term | conditional_expression OR conditional_term</p>
<p>conditional_term&nbsp;::= conditional_factor | conditional_term AND conditional_factor</p>
<p>conditional_factor&nbsp;::= [ NOT ] conditional_primary</p>
<p>conditional_primary&nbsp;::= simple_cond_expression | (conditional_expression)</p>
<p>simple_cond_expression&nbsp;::= comparison_expression | between_expression | like_expression | in_expression | null_comparison_expression | empty_collection_comparison_expression | collection_member_expression | exists_expression</p>
<p>between_expression&nbsp;::= arithmetic_expression [NOT] BETWEEN arithmetic_expression AND arithmetic_expression | string_expression [NOT] BETWEEN string_expression AND string_expression | datetime_expression [NOT] BETWEEN datetime_expression AND datetime_expression</p>
<p>in_expression&nbsp;::= state_field_path_expression [NOT] IN ( in_item {, in_item}* | subquery)</p>
<p>in_item&nbsp;::= literal | input_parameter</p>
<p>like_expression&nbsp;::= string_expression [NOT] LIKE pattern_value [ESCAPE escape_character]</p>
<p>null_comparison_expression&nbsp;::= {single_valued_path_expression | input_parameter} IS [NOT] NULL</p>
<p>empty_collection_comparison_expression&nbsp;::= collection_valued_path_expression IS [NOT] EMPTY</p>
<p>collection_member_expression&nbsp;::= entity_expression [NOT] MEMBER [OF] collection_valued_path_expression</p>
<p>exists_expression::= [NOT] EXISTS (subquery)</p>
<p>all_or_any_expression&nbsp;::= { ALL | ANY | SOME} (subquery)</p>
<p>comparison_expression&nbsp;::= string_expression comparison_operator {string_expression | all_or_any_expression} | boolean_expression { =|&lt;&gt;} {boolean_expression | all_or_any_expression} | enum_expression { =|&lt;&gt;} {enum_expression | all_or_any_expression} | datetime_expression comparison_operator {datetime_expression | all_or_any_expression} | entity_expression { = | &lt;&gt; } {entity_expression | all_or_any_expression} | arithmetic_expression comparison_operator {arithmetic_expression | all_or_any_expression}</p>
<p>comparison_operator&nbsp;::= = | &gt; | &gt;= | &lt; | &lt;= | &lt;&gt;</p>
<p>arithmetic_expression&nbsp;::= simple_arithmetic_expression | (subquery)</p>
<p>simple_arithmetic_expression&nbsp;::= arithmetic_term | simple_arithmetic_expression { + | - } arithmetic_term</p>
<p>arithmetic_term&nbsp;::= arithmetic_factor | arithmetic_term { * | / } arithmetic_factor</p>
<p>arithmetic_factor&nbsp;::= [{ + | - }] arithmetic_primary</p>
<p>arithmetic_primary&nbsp;::= state_field_path_expression | numeric_literal | (simple_arithmetic_expression) | input_parameter | functions_returning_numerics | aggregate_expression</p>
<p>string_expression&nbsp;::= string_primary | (subquery)</p>
<p>string_primary&nbsp;::= state_field_path_expression | string_literal | input_parameter | functions_returning_strings | aggregate_expression</p>
<p>datetime_expression&nbsp;::= datetime_primary | (subquery)</p>
<p>datetime_primary&nbsp;::= state_field_path_expression | input_parameter | functions_returning_datetime | aggregate_expression</p>
<p>boolean_expression&nbsp;::= boolean_primary | (subquery)</p>
<p>boolean_primary&nbsp;::= state_field_path_expression | boolean_literal | input_parameter |</p>
<p>enum_expression&nbsp;::= enum_primary | (subquery)</p>
<p>enum_primary&nbsp;::= state_field_path_expression | enum_literal | input_parameter |</p>
<p>entity_expression&nbsp;::= single_valued_association_path_expression | simple_entity_expression</p>
<p>simple_entity_expression&nbsp;::= identification_variable | input_parameter</p>
<h3><span class="mw-headline" id="Functions">Functions</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">LENGTH</span><span class="p">(</span><span class="k">SUBSTRING</span><span class="p">(</span><span class="k">UPPER</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">'FOO'</span><span class="p">,</span> <span class="p">:</span><span class="n">bar</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
<p>functions_returning_numerics::= LENGTH(string_primary) | LOCATE(string_primary, string_primary[, simple_arithmetic_expression]) | ABS(simple_arithmetic_expression) | SQRT(simple_arithmetic_expression) | MOD(simple_arithmetic_expression, simple_arithmetic_expression) | SIZE(collection_valued_path_expression)</p>
<p>functions_returning_datetime&nbsp;::= CURRENT_DATE| CURRENT_TIME | CURRENT_TIMESTAMP</p>
<p>functions_returning_strings&nbsp;::= CONCAT(string_primary, string_primary) | SUBSTRING(string_primary, simple_arithmetic_expression, simple_arithmetic_expression)| TRIM([[trim_specification] [trim_character] FROM] string_primary) | LOWER(string_primary) | UPPER(string_primary)</p>
<p>trim_specification&nbsp;::= LEADING | TRAILING | BOTH</p>
<h3><span class="mw-headline" id="Group_By">Group By</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">GROUP</span> <span class="k">BY</span> <span class="n">employee</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">employee</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span>
</pre></div>
<p>groupby_clause&nbsp;::= GROUP BY groupby_item {, groupby_item}*</p>
<p>groupby_item&nbsp;::= single_valued_path_expression | identification_variable</p>
<p>having_clause&nbsp;::= HAVING conditional_expression</p>
<h3><span class="mw-headline" id="Order_By">Order By</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">employee</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">employee</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="k">DESC</span>
</pre></div>
<p>orderby_clause&nbsp;::= ORDER BY orderby_item {, orderby_item}*</p>
<p>orderby_item&nbsp;::= state_field_path_expression [ ASC | DESC ]</p>
<h3><span class="mw-headline" id="Subquery">Subquery</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">WHERE</span> <span class="n">employee</span><span class="p">.</span><span class="n">salary</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">MAX</span><span class="p">(</span><span class="n">wellPaid</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">wellPaid</span><span class="p">)</span>
</pre></div>
<p>subquery&nbsp;::= simple_select_clause subquery_from_clause [where_clause] [groupby_clause] [having_clause]</p>
<p>subquery_from_clause&nbsp;::= FROM subselect_identification_variable_declaration {, subselect_identification_variable_declaration}* subselect_identification_variable_declaration&nbsp;::= identification_variable_declaration | association_path_expression [AS] identification_variable | collection_member_declaration</p>
<p>simple_select_clause&nbsp;::= SELECT [DISTINCT] simple_select_expression</p>
<p>simple_select_expression::= single_valued_path_expression | aggregate_expression | identification_variable</p>
<h2><span class="mw-headline" id="Update">Update</span></h2>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">UPDATE</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">SET</span> <span class="n">e</span><span class="p">.</span><span class="n">salary</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">salary</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">WHERE</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="o">=</span> <span class="p">:</span><span class="n">city</span>
</pre></div>
<p>update_statement&nbsp;::= update_clause <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Where">[where_clause]</a></p>
<p>update_clause&nbsp;::= UPDATE abstract_schema_name [[AS] identification_variable] SET update_item {, update_item}*</p>
<p>update_item&nbsp;::= [identification_variable.]{state_field | single_valued_association_field} = new_value</p>
<p>new_value&nbsp;::= simple_arithmetic_expression | string_primary | datetime_primary | boolean_primary | enum_primary | simple_entity_expression | NULL</p>
<h2><span class="mw-headline" id="Delete">Delete</span></h2>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">WHERE</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="o">=</span> <span class="p">:</span><span class="n">city</span>
</pre></div>
<p>delete_statement&nbsp;::= delete_clause <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Where">[where_clause]</a></p>
<p>delete_clause&nbsp;::= DELETE FROM abstract_schema_name [[AS] identification_variable]</p>
<h2><span class="mw-headline" id="Literals">Literals</span></h2>
<p>It is normally best to define data values in a query using parameters, using the syntax <code>:parameter</code> or <code>?</code>. JPQL also allows for data values to be in-lined in the JPQL query using literals.</p>
<p>JPQL defines the following syntax for literals:</p>
<ul>
<li><code>String - 'string' - "Select e from Employee e where e.name = 'Bob'"</code>
<ul>
<li>To define a <b>'</b> (quote) character in a string, the quote is double quoted, i.e. <code>'Baie-D''Urfé'</code>.</li>
</ul>
</li>
<li><code>Integer - digits - "Select e from Employee e where e.id = 1234"</code></li>
<li><code>Long - +|-digitsL - "Select e from Employee e where e.id = 1234L"</code></li>
<li><code>Float - +|-digits.decimaleexponentF - "Select s from Stat s where s.ratio &gt; 3.14F"</code></li>
<li><code>Double - +|-digits.decimaleexponentD - "Select s from Stat s where s.ratio &gt; 3.14e32D"</code></li>
<li><code>Boolean - TRUE | FALSE - "Select e from Employee e where e.active = TRUE"</code></li>
<li><code>Date - {d'yyyy-mm-dd'} - "Select e from Employee e where e.startDate = {d'2012-01-03'}"</code></li>
<li><code>Time - {t'hh:mm:ss'} - "Select e from Employee e where e.startTime = {t'09:00:00'}"</code></li>
<li><code>Timestamp - {ts'yyy-mm-dd hh:mm:ss.nnnnnnnnn'} - "Select e from Employee e where e.version = {ts'2012-01-03 09:00:00.000000001'}"</code></li>
<li><code>Enum - package.class.enum - "Select e from Employee e where e.gender = org.acme.Gender.MALE"</code></li>
<li><code>null - NULL - "Update Employee e set e.manager = NULL where e.manager =&nbsp;:manager"</code></li>
</ul>
<h2><span class="mw-headline" id="New_in_JPA_2.0">New in JPA 2.0</span></h2>
<p>The following new syntax was added in JPA 2.0.</p>
<p><br>
type_discriminator&nbsp;::= TYPE(identification_variable | single_valued_object_path_expression | input_parameter)</p>
<dl>
<dd>Allows type/class of object to be queried.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">p</span> <span class="k">from</span> <span class="n">Project</span> <span class="n">p</span> <span class="k">where</span> <span class="k">TYPE</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">in</span> <span class="p">(</span><span class="n">LargeProject</span><span class="p">,</span> <span class="n">SmallProject</span><span class="p">)</span>
</pre></div>
<p><br>
qualified_identification_variable&nbsp;::= KEY(identification_variable) | VALUE(identification_variable) | ENTRY(identification_variable)</p>
<dl>
<dd>Allows selecting on Map keys, values and Map Entry.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">ENTRY</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">contactInfo</span><span class="p">)</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span>
</pre></div>
<p><br>
general_identification_variable&nbsp;::= identification_variable | KEY(identification_variable) | VALUE(identification_variable)</p>
<dl>
<dd>Allows querying on Map keys and values.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">join</span> <span class="n">e</span><span class="p">.</span><span class="n">contactInfo</span> <span class="k">c</span> <span class="k">where</span> <span class="k">KEY</span><span class="p">(</span><span class="k">c</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'Email'</span> <span class="k">and</span> <span class="n">VALUE</span><span class="p">(</span><span class="k">c</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'joe@gmail.com'</span>
</pre></div>
<p><br>
in_item&nbsp;::= literal | single_valued_input_parameter</p>
<dl>
<dd>Allows collection parameters for IN.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">where</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span> <span class="k">in</span> <span class="p">:</span><span class="n">param</span>
</pre></div>
<p><br>
functions_returning_strings&nbsp;::= CONCAT(string_primary, string_primary {, string_primary}*)</p>
<dl>
<dd>Allows CONCAT with multiple arguments.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">where</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">street</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">province</span><span class="p">)</span> <span class="o">=</span> <span class="p">:</span><span class="n">address</span>
</pre></div>
<p><br>
SUBSTRING(string_primary, simple_arithmetic_expression [, simple_arithmetic_expression])</p>
<dl>
<dd>Allows SUBSTRING with single argument.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">where</span> <span class="k">SUBSTRING</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'Mac'</span>
</pre></div>
<p><br>
case_expression&nbsp;::= general_case_expression | simple_case_expression |coalesce_expression | nullif_expression general_case_expression::= CASE when_clause {when_clause}* ELSE scalar_expression END when_clause::= WHEN conditional_expression THEN scalar_expression simple_case_expression::= CASE case_operand simple_when_clause {simple_when_clause}* ELSE scalar_expression END case_operand::= state_field_path_expression | type_discriminator simple_when_clause::= WHEN scalar_expression THEN scalar_expression coalesce_expression::= COALESCE(scalar_expression {, scalar_expression}+) nullif_expression::= NULLIF(scalar_expression, scalar_expression)</p>
<dl>
<dd>Allows CASE, COALESCE and NULLIF functions.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salary</span> <span class="o">&gt;=</span> <span class="mi">100000</span><span class="p">)</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">WHEN</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salary</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">)</span> <span class="k">THEN</span> <span class="mi">2</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span>
</pre></div>
<p><br>
functions_returning_numerics::= ... | INDEX(identification_variable)</p>
<dl>
<dd>Allows querying in indexed List mapping's index.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">join</span> <span class="n">e</span><span class="p">.</span><span class="n">phones</span> <span class="n">p</span> <span class="k">where</span> <span class="k">INDEX</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">and</span> <span class="n">p</span><span class="p">.</span><span class="n">areaCode</span> <span class="o">=</span> <span class="s1">'613'</span>
</pre></div>
<p><br>
join_collection_valued_path_expression::= identification_variable. {single_valued_embeddable_object_field.}* collection_valued_field join_single_valued_path_expression::= variable.{single_valued_embeddable_object_field.}*single_valued_object_field</p>
<dl>
<dd>Allows nested dot notation on joins.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">p</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">join</span> <span class="n">e</span><span class="p">.</span><span class="n">employeeDetails</span><span class="p">.</span><span class="n">phones</span> <span class="n">p</span> <span class="k">where</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
</pre></div>
<p><br>
select_item&nbsp;::= select_expression [[AS] result_variable]</p>
<dl>
<dd>Allows AS option in select.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span> <span class="k">AS</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">group</span> <span class="k">by</span> <span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">city</span> <span class="k">order</span> <span class="k">by</span> <span class="n">s</span>
</pre></div>
<p><br>
literalTemporal = DATE_LITERAL | TIME_LITERAL | TIMESTAMP_LITERAL</p>
<dl>
<dd>Allows JDBC date/time escape syntax.</dd>
</dl>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="k">SELECT</span> <span class="n">e</span> <span class="k">from</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">where</span> <span class="n">e</span><span class="p">.</span><span class="n">startDate</span> <span class="o">&gt;</span> <span class="err">{</span><span class="n">d</span><span class="s1">'1990-01-01'</span><span class="err">}</span>
</pre></div>
<h1><span class="mw-headline" id="Persisting">Persisting</span></h1>
<p>JPA uses the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html" target="_blank"><code>EntityManager</code></a> API for runtime usage. The <code>EntityManager</code> represents the application session or dialog with the database. Each request, or each client will use its own <code>EntityManager</code> to access the database. The <code>EntityManager</code> also represents a transaction context, and in a typical stateless model a new <code>EntityManager</code> is created for each transaction. In a stateful model, an <code>EntityManager</code> may match the lifecycle of a client's session.</p>
<p>The <code>EntityManager</code> provides an API for all required persistence operations. These include the following CRUD operations:</p>
<ul>
<li><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#persist(java.lang.Object)" target="_blank"><code>persist</code></a> (INSERT)</li>
<li><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#merge(java.lang.Object)" target="_blank"><code>merge</code></a> (UPDATE)</li>
<li><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#remove(java.lang.Object)" target="_blank"><code>remove</code></a> (DELETE)</li>
<li><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#find(java.lang.Class,%20java.lang.Object)" target="_blank"><code>find</code></a> (SELECT)</li>
</ul>
<p>The <code>EntityManager</code> is an object-oriented API, so does not map directly onto database SQL or DML operations. For example to update an object, you just need to read the object and change its state through its <code>set</code> methods, and then call <code>commit</code> on the transaction. The <code>EntityManager</code> figures out which objects you changed and performs the correct updates to the database, there is no explicit update operation in JPA.</p>
<h3><span class="mw-headline" id="Detached_vs_Managed">Detached vs Managed</span></h3>
<p>JPA defines two main states for an object for a given persistence context, <i>managed</i> and <i>detached</i>.</p>
<p>A managed object is one that was read in the current persistence context (EntityManager/JTA transaction). A managed object is registered with the persistence context and the persistence context will track changes to that object and maintain its object identity. If the same object is read again, in the same persistence context, or traversed through another managed object's relationship, the same identical (<code>==</code>) object will be returned. Calling <code>persist</code> on a new object will also make it become managed. Calling merge on a detached object will <i>return</i> the managed copy of the object. An object should never be managed by more than one persistence context. An object will be managed by its persistence context until the persistence context is cleared through <code>clear</code>, or the object is forced to be detached through <code>detach</code>. A removed object will no longer be managed after a <code>flush</code> or <code>commit</code>. On a <code>rollback</code>, all managed objects will become detached. In a JTA managed <code>EntityManager</code> all managed objects will be detached on any JTA commit or rollback.</p>
<p>A detached object is one that is not managed in the current persistence context. This could be an object read through a different persistence context, or an object that was cloned or serialized. A new object is also considered detached until <code>persist</code> is called on it. An object that was removed and flushed or committed, will become detached. An object could be considered both managed in the context of one persistence context, and detached in the context of another persistence context.</p>
<p>A managed object should only ever reference other managed objects, and a detached object should only reference other detached objects. Avoid relating or mixing detached and managed objects, this will normally lead to issues, as your application could access two copies of the same object causing loss of changes or stale data. Incorrectly relating managed and detached objects is probably one of the most common issues users run into in JPA.</p>
<h2><span class="mw-headline" id="Persist">Persist</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#persist(java.lang.Object)" target="_blank"><code>EntityManager.persist()</code></a> operation is used to insert a new object into the database. <code>persist</code> does not directly insert the object into the database, it just registers it as new in the persistence context (transaction). When the transaction is committed, or if the persistence context is <i>flushed</i>, then the object will be inserted into the database.</p>
<p>If the object uses a generated <code>Id</code>, the <code>Id</code> will normally be assigned to the object when <code>persist</code> is called, so <code>persist</code> can also be used to have an object's <code>Id</code> assigned. The one exception is if <code>IDENTITY</code> sequencing is used, in this case the <code>Id</code> is only assigned on <code>commit</code> or <code>flush</code> because the database will only assign the <code>Id</code> on <code>INSERT</code>. If the object does not use a generated <code>Id</code>, you should normally assign its <code>Id</code> before calling <code>persist</code>.</p>
<p>The <code>persist</code> operation can only be called within a transaction, an exception will be thrown outside of a transaction. The <code>persist</code> operation is in-place, in that the object being persisted will become part of the persistence context. The state of the object at the point of the commit of the transaction will be persisted, not its state at the point of the <code>persist</code> call.</p>
<p><code>persist</code> should normally only be called on new objects. It is allowed to be called on existing objects if they are part of the persistence context, this is only for the purpose of cascading persist to any possible related new objects. If <code>persist</code> is called on an existing object that is not part of the persistence context, then an exception may be thrown, or it may be attempted to be inserted and a database constraint error may occur, or if no constraints are defined, it may be possible to have duplicate data inserted.</p>
<p><code>persist</code> can only be called on <code>Entity</code> objects, not on <code>Embeddable</code> objects, or collections, or non-persistent objects. <code>Embeddable</code> objects are automatically persisted as part of their owning <code>Entity</code>.</p>
<p>Calling <code>persist</code> is not always required. If you related a new object to an existing object that is part of the persistence context, and the relationship is cascade persist, then it will be automatically inserted when the transaction is committed, or when the persistence context is flushed.</p>
<h4><span class="mw-headline" id="Example_persist">Example persist</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>

<span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Employee</span><span class="o">();</span>
<span class="n">employee</span><span class="o">.</span><span class="na">setFirstName</span><span class="o">(</span><span class="s">"Bob"</span><span class="o">);</span>
<span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Address</span><span class="o">();</span>
<span class="n">address</span><span class="o">.</span><span class="na">setCity</span><span class="o">(</span><span class="s">"Ottawa"</span><span class="o">);</span>
<span class="n">employee</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>

<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">employee</span><span class="o">);</span>

<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
</pre></div>
<h3><span class="mw-headline" id="Cascading_Persist">Cascading Persist</span></h3>
<p>Calling <code>persist</code> on an object will also cascade the <code>persist</code> operation to across any relationship that is marked as cascade persist. If a relationship is not cascade persist, and a related object is new, then an exception may be thrown if you do not first call <code>persist</code> on the related object. Intuitively you may consider marking every relationship as cascade persist to avoid having to worry about calling persist on every objects, but this can also lead to issues.</p>
<p>One issue with marking all relationships cascade persist is performance. On each persist call all of the related objects will need to be traversed and checked if they reference any new objects. This can actually lead to <code>O(n²)</code> performance issues if you mark all relationships cascade persist, and persist a large new graph of objects. If you just call <code>persist</code> on the root object, this is ok. However, if you call <code>persist</code> on each object in the graph, then you will traverse the entire graph for each object in the graph, and this can lead to a major performance issue. The JPA spec should probably define <code>persist</code> to only apply to new objects, not already part of the persistence context, but it requires <code>persist</code> apply to all objects, whether new, existing, or already persisted, so can have this issue.</p>
<p>A second issue is that if you <code>remove</code> an object to have it deleted, if you then call <code>persist</code> on the object, it will resurrect the object, and it will become persistent again. This may be desired if it is intentional, but the JPA spec also requires this behavior for cascade persist. So if you <code>remove</code> an object, but forget to remove a reference to it from a cascade persist relationship, the <code>remove</code> will be ignored.</p>
<p>I would recommend only marking relationships that are composite or privately owned as cascade persist.</p>
<h2><span class="mw-headline" id="Merge">Merge</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#merge(java.lang.Object)" target="_blank"><code>EntityManager.merge()</code></a> operation is used to merge the changes made to a detached object into the persistence context. <code>merge</code> does not directly update the object into the database, it merges the changes into the persistence context (transaction). When the transaction is committed, or if the persistence context is <i>flushed</i>, then the object will be updated in the database.</p>
<p>Normally <code>merge</code> is not required, although it is frequently misused. To update an object you simply need to read it, then change its state through its <code>set</code> methods, then commit the transaction. The <code>EntityManager</code> will figure out everything that has been changed and update the database. <code>merge</code> is only required when you have a detached copy of a persistence object. A <i>detached</i> object is one that was read through a different <code>EntityManager</code> (or in a different transaction in a JEE managed <code>EntityManager</code>), or one that was cloned, or serialized. A common case is a <code>stateless</code> <code>SessionBean</code> where the object is read in one transaction, then updated in another transaction. Since the update is processed in a different transaction, with a different <code>EntityManager</code>, it must first be merged. The <code>merge</code> operation will look-up/find the managed object for the detached object, and copy each of the detached objects attributes that changed into the managed object, as well as cascading any related objects marked as cascade merge.</p>
<p>The <code>merge</code> operation can only be called within a transaction, an exception will be thrown outside of a transaction. The <code>merge</code> operation is not in-place, in that the object being merged will never become part of the persistence context. Any further changes must be made to the managed object returned by the <code>merge</code>, not the detached object.</p>
<p><code>merge</code> is normally called on existing objects, but can also be called on new objects. If the object is new, a new copy of the object will be made and registered with the persistence context, the detached object will not be persisted itself.</p>
<p><code>merge</code> can only be called on <code>Entity</code> objects, not on <code>Embeddable</code> objects, or collections, or non-persistent objects. <code>Embeddable</code> objects are automatically merged as part of their owning <code>Entity</code>.</p>
<h4><span class="mw-headline" id="Example_merge">Example merge</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">createEntityManager</span><span class="o">();</span>
<span class="n">Employee</span> <span class="n">detached</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">...</span>
<span class="n">em</span> <span class="o">=</span> <span class="n">createEntityManager</span><span class="o">();</span>
<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>
<span class="n">Employee</span> <span class="n">managed</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">detached</span><span class="o">);</span>
<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
</pre></div>
<h3><span class="mw-headline" id="Cascading_Merge">Cascading Merge</span></h3>
<p>Calling <code>merge</code> on an object will also cascade the <code>merge</code> operation across any relationship that is marked as cascade merge. Even if the relationship is not cascade merge, the reference will still be merged. If the relationship is cascade merge the relationship and each related object will be merged. Intuitively you may consider marking every relationship as cascade merge to avoid having to worry about calling merge on every objects, but this is normally a bad idea.</p>
<p>One issue with marking all relationships cascade merge is performance. If you have an object with a lot of relationships, then each <code>merge</code> call can require to traverse a large graph of objects.</p>
<p>Another issues arises if your detached object is corrupt in some way. For example say you have an <code>Employee</code> who has a <code>manager</code>, but that manager has a different copy of the detached <code>Employee</code> object as its <code>managedEmployee</code>. This may cause the same object to be merged twice, or at least may not be consistent which object will be merged, so you may not get the changes you expect merged. The same is true if you didn't change an object at all, but some other user did, if <code>merge</code> cascades to this unchanged object, it will revert the other user's changes, or throw an <code>OptimisticLockException</code> (depending on your locking policy). This is normally not desirable.</p>
<p>I would recommend only marking relationships that are composite or privately owned as cascade merge.</p>
<h3><span class="mw-headline" id="Transient_Variables">Transient Variables</span></h3>
<p>Another issue with <code>merge</code> is transient variables. Since <code>merge</code> is normally used with object serialization, if a relationship was marked as <code>transient</code> (Java transient, not JPA transient), then the detached object will contain <code>null</code>, and <code>null</code> will be merged into the object, even though it is not desired. This will occur even if the relationship was not cascade merge, as <code>merge</code> always merges the references to related objects. Normally transient is required when using serialization to avoid serializing the entire database when only a single, or small set of objects are required.</p>
<p>One solution is to avoid marking anything <code>transient</code>, and instead use <code>LAZY</code> relationships in JPA to limit what is serialized (lazy relationships that have not been accessed, will normally not be serialized). Another solution is to manually merge in your own code.</p>
<p>Some JPA providers provide extended <code>merge</code> operations, such as allowing a <i>shallow</i> merge or <i>deep</i> merge, or merging without merging references.</p>
<h2><span class="mw-headline" id="Remove">Remove</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#remove(java.lang.Object)" target="_blank"><code>EntityManager.remove()</code></a> operation is used to delete an object from the database. <code>remove</code> does not directly delete the object from the database, it marks the object to be deleted in the persistence context (transaction). When the transaction is committed, or if the persistence context is <i>flushed</i>, then the object will be deleted from the database.</p>
<p>The <code>remove</code> operation can only be called within a transaction, an exception will be thrown outside of a transaction. The <code>remove</code> operation must be called on a managed object, not on a detached object. Generally you must first <code>find</code> the object before removing it, although it is possible to call <code>EntityManager.getReference()</code> on the object's <code>Id</code> and call remove on the reference. Depending on how you JPA provider optimizes <code>getReference</code> and <code>remove</code>, it may not require reading the object from the database.</p>
<p><code>remove</code> can only be called on <code>Entity</code> objects, not on <code>Embeddable</code> objects, or collections, or non-persistent objects. <code>Embeddable</code> objects are automatically removed as part of their owning <code>Entity</code>.</p>
<h4><span class="mw-headline" id="Example_remove">Example remove</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>
<span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="n">em</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">employee</span><span class="o">);</span>
<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
</pre></div>
<h3><span class="mw-headline" id="Cascading_Remove">Cascading Remove</span></h3>
<p>Calling <code>remove</code> on an object will also cascade the <code>remove</code> operation across any relationship that is marked as cascade remove.</p>
<p>Note that cascade remove only effects the <code>remove</code> call. If you have a relationship that is cascade remove, and remove an object from the collection, or dereference an object, it will <i>not</i> be removed. You must explicitly call <code>remove</code> on the object to have it deleted. Some JPA providers provide an extension to provide this behavior, and in JPA 2.0 there will be an <code>orphanRemoval</code> option on <code>OneToMany</code> and <code>OneToOne</code> mappings to provide this.</p>
<h3><span class="mw-headline" id="Reincarnation">Reincarnation</span></h3>
<p>Normally an object that has been removed, stays removed, but in some cases you may need to bring the object back to life. This normally occurs with natural ids, not generated ones, where a new object would always get an new id. Generally the desire to reincarnate an object occurs from a bad object model design, normally the desire to change the class type of an object (which cannot be done in Java, so a new object must be created). Normally the best solution is to change your object model to have your object hold a <i>type</i> object which defines its type, instead of using inheritance. But sometimes reincarnation is desirable.</p>
<p>When done in two separate transactions, this is normally fine, first you <code>remove</code> the object, then you <code>persist</code> it back. This can be more complex if you wish to <code>remove</code> and <code>persist</code> an object with the same <code>Id</code> in the same transaction. If you call <code>remove</code> on an object, then call <code>persist</code> on the same object, it will simply no longer be removed. If you call <code>remove</code> on an object, then call <code>persist</code> on a different object with the same <code>Id</code> the behavior may depend on your JPA provider, and probably will not work. If you call <code>flush</code> after calling <code>remove</code>, then call <code>persist</code>, then the object should be successfully reincarnated. Note that it will be a different row, the existing row will have been deleted, and a new row inserted. If you wish the same row to be updated, you may need to resort to using a native SQL update query.</p>
<h1><span class="mw-headline" id="Advanced_13">Advanced</span></h1>
<h2><span class="mw-headline" id="Refresh">Refresh</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#refresh(java.lang.Object)" target="_blank"><code>EntityManager.refresh()</code></a> operation is used to refresh an object's state from the database. This will revert any non-flushed changes made in the current transaction to the object, and refresh its state to what is currently defined on the database. If a <code>flush</code> has occurred, it will refresh to what was flushed. Refresh must be called on a managed object, so you may first need to <code>find</code> the object with the active <code>EntityManager</code> if you have a non-managed instance.</p>
<p>Refresh will cascade to any relationships marked <code>cascade</code> refresh, although it may be done lazily depending on your fetch type, so you may need to access the relationship to trigger the refresh. <code>refresh</code> can only be called on <code>Entity</code> objects, not on <code>Embeddable</code> objects, or collections, or non-persistent objects. <code>Embeddable</code> objects are automatically refreshed as part of their owning <code>Entity</code>.</p>
<p>Refresh can be used to revert changes, or if your JPA provider supports caching, it can be used to refresh stale cached data. Sometimes it is desirable to have a <code>Query</code> or <code>find</code> operation refresh the results. Unfortunately JPA 1.0 does not define how this can be done. Some JPA providers offer query hints to allow refreshing to be enabled on a query.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Define a query hint <code>"eclipselink.refresh"</code> to allow refreshing to be enabled on a query.</dd>
</dl>
<p>JPA 2.0 defines a set of standard query hints for refeshing, see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Caching#JPA_2.0_Cache_APIs" title="Java Persistence/Caching">JPA 2.0 Cache APIs</a>.</p>
<h4><span class="mw-headline" id="Example_refresh">Example refresh</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">em</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="n">employee</span><span class="o">);</span>
</pre></div>
<h2><span class="mw-headline" id="Lock">Lock</span></h2>
<p>See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Locking#Read_and_Write_Locking" title="Java Persistence/Locking">Read and Write Locking</a>.</p>
<h2><span class="mw-headline" id="Get_Reference">Get Reference</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#getReference(java.lang.Class,%20java.lang.Object)" target="_blank"><code>EntityManager.getReference()</code></a> operation is used to obtain a handle to an object without requiring it to be loaded. It is similar to the <code>find</code> operation, but may return a <i>proxy</i> or <i>unfetched</i> object. JPA does not require that <code>getReference</code> avoid loading the object, so some JPA providers may not support it and just perform a normal find operation. The object returned by <code>getReference</code> should appear to be a normal object, if you access any method or attribute other than its <code>Id</code> it will trigger itself to be refreshed from the database.</p>
<p>The intention of <code>getReference</code> is that it could be used on an insert or update operation as a stand-in for a related object, if you only have its <code>Id</code> and want to avoid loading the object. Note that <code>getReference</code> does not verify the existence of the object as <code>find</code> does. If the object does not exist and you try to use the <i>unfetched</i> object in an insert or update you may get a foreign key constraint violation, or if you access the object it may trigger an exception.</p>
<h4><span class="mw-headline" id="Example_getReference">Example getReference</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">Employee</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">managerId</span><span class="o">);</span>
<span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Employee</span><span class="o">();</span>
<span class="o">...</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">employee</span><span class="o">);</span>
<span class="n">employee</span><span class="o">.</span><span class="na">setManager</span><span class="o">(</span><span class="n">manager</span><span class="o">);</span>
<span class="n">em</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</pre></div>
<h2><span class="mw-headline" id="Flush">Flush</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#flush()" target="_blank"><code>EntityManager.flush()</code></a> operation can be used to write all changes to the database before the transaction is committed. By default JPA does not normally write changes to the database until the transaction is committed. This is normally desirable as it avoids database access, resources and locks until required. It also allows database writes to be ordered, and batched for optimal database access, and to maintain integrity constraints and avoid deadlocks. This means that when you call <code>persist</code>, <code>merge</code>, or <code>remove</code> the database DML <code>INSERT, UPDATE, DELETE</code> is not executed, until commit, or until a flush is triggered.</p>
<p>Flush has several usages:</p>
<ul>
<li>Flush changes before a query execution to enable the query to return new objects and changes made in the persistence unit.</li>
<li>Insert persisted objects to ensure their <code>Id</code>s are assigned and accessible to the application if using <code>IDENTITY</code> sequencing.</li>
<li>Write all changes to the database to allow error handling of any database errors (useful when using JTA or SessionBeans).</li>
<li>To flush and clear a batch for batch processing in a single transaction.</li>
<li>Avoid constraint errors, or reincarnate an object.</li>
</ul>
<h4><span class="mw-headline" id="Example_flush">Example flush</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kt">long</span> <span class="nf">createOrder</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ACMEException</span> <span class="o">{</span>
  <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
  <span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">em</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PersistenceException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">ACMEException</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Clear">Clear</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#clear()" target="_blank"><code>EntityManager.clear()</code></a> operation can be used to clear the persistence context. This will clear all objects read, changed, persisted, or removed from the current <code>EntityManager</code> or transaction. Changes that have already been written to the database through <code>flush</code>, or any changes made to the database will not be cleared. Any object that was read or persisted through the <code>EntityManager</code> is detached, meaning any changes made to it will not be tracked, and it should no longer be used unless merged into the new persistence context.</p>
<p><code>clear</code> can be used similar to a <i>rollback</i> to abandon changes and restart a persistence context. If a transaction commit fails, or a rollback is performed the persistence context will automatically be cleared.</p>
<p><code>clear</code> is similar to closing the <code>EntityManager</code> and creating a new one, the main difference being that <code>clear</code> can be called while a transaction is in progress. <code>clear</code> can also be used to free the objects and memory consumed by the <code>EntityManager</code>. It is important to note that an <code>EntityManager</code> is responsible for tracking and managing all objects read within its persistence context. In an application managed <code>EntityManager</code> this includes every objects read since the <code>EntityManager</code> was created, including <i>every</i> transaction the <code>EntityManager</code> was used for. If a long lived <code>EntityManager</code> is used, this is an intrinsic memory leak, so calling <code>clear</code> or closing the <code>EntityManager</code> and creating a new one is an important application design consideration. For JTA managed <code>EntityManager</code>s the persistence context is automatically cleared across each JTA transaction boundary.</p>
<p>Clearing is also important on large batch jobs, even if they occur in a single transaction. The batch job can be slit into smaller batches within the same transaction and <code>clear</code> can be called in between each batch to avoid the persistence context from getting too big.</p>
<h4><span class="mw-headline" id="Example_clear">Example clear</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processAllOpenOrders</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">openOrderIds</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT o.id from Order o where o.isOpen = true"</span><span class="o">);</span>
  <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">batch</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&lt;</span> <span class="n">openOrderIds</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">batch</span> <span class="o">+=</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">batch</span> <span class="o">+</span> <span class="n">index</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">openOrderIds</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">index</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">Long</span> <span class="n">id</span> <span class="o">=</span> <span class="n">openOrderIds</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">batch</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
        <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
        <span class="n">order</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">em</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">em</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
      <span class="n">em</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">isActive</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Close">Close</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#close()" target="_blank"><code>EntityManager.close()</code></a> operation is used to release an application managed <code>EntityManager</code>'s resources. JEE JTA managed <code>EntityManager</code>s cannot be closed, as they are managed by the JTA transaction and JEE server.</p>
<p>The life-cycle of an <code>EntityManager</code> can last either a transaction, request, or a users session. Typically the life-cycle is per request, and the <code>EntityManager</code> is closed at the end of the request. The objects obtained from an <code>EntityManager</code> become detached when the <code>EntityManager</code> is closed, and any <code>LAZY</code> relationships may no longer be accessible if they were not accessed before the <code>EntityManager</code> was closed. Some JPA providers allow <code>LAZY</code> relationships to be accessed after close.</p>
<h4><span class="mw-headline" id="Example_close">Example close</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="n">Order</span> <span class="nf">findOrder</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
  <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
  <span class="n">order</span><span class="o">.</span><span class="na">getOrderLines</span><span class="o">().</span><span class="na">size</span><span class="o">();</span>
  <span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="k">return</span> <span class="n">order</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Get_Delegate">Get Delegate</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#getDelegate()" target="_blank"><code>EntityManager.getDelegate()</code></a> operation is used to access the JPA provider's <code>EntityManager</code> implementation class in a JEE managed <code>EntityManager</code>. A JEE managed <code>EntityManager</code> will be wrapped by a <i>proxy</i> <code>EntityManager</code> by the JEE server that forwards requests to the <code>EntityManager</code> active for the current JTA transaction. If a JPA provider specific API is desired the <code>getDelegate()</code> API allows the JPA implementation to be accessed to call the API.</p>
<p>In JEE a managed <code>EntityManager</code> will typically create a new <code>EntityManager</code> per JTA transaction. Also the behavior is somewhat undefined outside of a JTA transaction context. Outside a JTA transaction context, a JEE managed <code>EntityManager</code> may create a new <code>EntityManager</code> per method, so <code>getDelegate()</code> may return a temporary <code>EntityManager</code> or even <code>null</code>. Another way to access the JPA implementation is through the <code>EntityManagerFactory</code>, which is typically not wrapped with a <i>proxy</i>, but may be in some servers.</p>
<p>In JPA 2.0 the <code>getDelegate()</code> API has been replaced by the <code>unwrap()</code> API which is more generic.</p>
<h4><span class="mw-headline" id="Example_getDelegate">Example getDelegate</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearCache</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
  <span class="o">((</span><span class="n">JpaEntityManager</span><span class="o">)</span><span class="n">em</span><span class="o">.</span><span class="na">getDelegate</span><span class="o">()).</span><span class="na">getServerSession</span><span class="o">().</span><span class="na">getIdentityMapAccessor</span><span class="o">().</span><span class="na">initializeAllIdentityMaps</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<h2><span class="mw-headline" id="Unwrap_.28JPA_2.0.29">Unwrap (JPA 2.0)</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/EntityManager.html#unwrap(java.lang.Class)" target="_blank"><code>EntityManager.unwrap()</code></a> operation is used to access the JPA provider's <code>EntityManager</code> implementation class in a JEE managed <code>EntityManager</code>. A JEE managed <code>EntityManager</code> will be wrapped by a <i>proxy</i> <code>EntityManager</code> by the JEE server that forwards requests to the <code>EntityManager</code> active for the current JTA transaction. If a JPA provider specific API is desired the <code>unwrap()</code> API allows the JPA implementation to be accessed to call the API.</p>
<p>In JEE a managed <code>EntityManager</code> will typically create a new <code>EntityManager</code> per JTA transaction. Also the behavior is somewhat undefined outside of a JTA transaction context. Outside a JTA transaction context, a JEE managed <code>EntityManager</code> may create a new <code>EntityManager</code> per method, so <code>getDelegate()</code> may return a temporary <code>EntityManager</code> or even <code>null</code>. Another way to access the JPA implementation is through the <code>EntityManagerFactory</code>, which is typically not wrapped with a <i>proxy</i>, but may be in some servers.</p>
<h4><span class="mw-headline" id="Example_unwrap">Example unwrap</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearCache</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
  <span class="n">em</span><span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="n">JpaEntityManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getServerSession</span><span class="o">().</span><span class="na">getIdentityMapAccessor</span><span class="o">().</span><span class="na">initializeAllIdentityMaps</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<h1><span class="mw-headline" id="Transactions">Transactions</span></h1>
<p>A <a href="https://en.wikipedia.org/wiki/Database_transaction" class="extiw" title="w:Database transaction" target="_blank">transaction</a> is a set of operations that either fail or succeed as a unit. Transactions are a fundamental part of persistence. A database transaction consists of a set of SQL <a href="https://en.wikipedia.org/wiki/Data_Manipulation_Language" class="extiw" title="w:Data Manipulation Language" target="_blank">DML</a> (Data Manipulation Language) operations that are committed or rolled back as a single unit. An object level transaction is one in which a set of changes made to a set of objects are committed to the database as a single unit.</p>
<p>JPA provides two mechanisms for transactions. When used in <a href="https://en.wikipedia.org/wiki/Java_Enterprise_Edition" class="extiw" title="w:Java Enterprise Edition" target="_blank">Java EE</a> JPA provides integration with <a href="https://en.wikipedia.org/wiki/Java_Transaction_API" class="extiw" title="w:Java Transaction API" target="_blank">JTA</a> (Java Transaction API). JPA also provides its own <code>EntityTransaction</code> implementation for <a href="https://en.wikipedia.org/wiki/Java_Standard_Edition" class="extiw" title="w:Java Standard Edition" target="_blank">Java SE</a> and for use in a non-managed mode in Java EE. Transactions in JPA are always at the object level, this means that all changes made to all persistent objects in the persistence context are part of the transaction.</p>
<h2><span class="mw-headline" id="Resource_Local_Transactions">Resource Local Transactions</span></h2>
<p>Resource local transactions are used in JSE, or in application managed (non-managed) mode in Java EE. To use resource local transactions the <code>transaction-type</code> attribute in the <code>persistence.xml</code> is set to <code>RESOURCE_LOCAL</code>. If resource local transactions are used with a <code>DataSource</code>, the <code>&lt;non-jta-data-source&gt;</code> element should be used to reference a server <code>DataSource</code> that has been configure to not be JTA managed.</p>
<p>Local JPA transactions are defined through the <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityTransaction.html" target="_blank"><code>EntityTransaction</code></a> class. It contains basic transaction API including <code>begin</code>, <code>commit</code> and <code>rollback</code>.</p>
<p>Technically in JPA the <code>EntityManager</code> is in a transaction from the point it is created. So <code>begin</code> is somewhat redundant. Until <code>begin</code> is called, certain operations such as <code>persist</code>, <code>merge</code>, <code>remove</code> cannot be called. Queries can still be performed, and objects that were queried can be changed, although this is somewhat unspecified what will happen to these changes in the JPA spec, normally they will be committed, however it is best to call <code>begin</code> before making any changes to your objects. Normally it is best to create a new <code>EntityManager</code> for each transaction to avoid have stale objects remaining in the persistence context, and to allow previously managed objects to garbage collect.</p>
<p>After a successful <code>commit</code> the <code>EntityManager</code> can continue to be used, and all of the managed objects remain managed. However it is normally best to <code>close</code> or <code>clear</code> the <code>EntityManager</code> to allow garbage collection and avoid stale data. If the commit fails, then the managed objects are considered detached, and the <code>EntityManager</code> is cleared. This means that commit failures cannot be caught and retried, if a failure occurs, the entire transaction must be performed again. The previously managed object may also be left in an inconsistent state, meaning some of the objects locking version may have been incremented. Commit will also fail if the transaction has been marked for rollback. This can occur either explicitly by calling <code>setRollbackOnly</code> or is required to be set if <i>any</i> query or find operation fails. This can be an issue, as some queries may fail, but may not be desired to cause the entire transaction to be rolled back.</p>
<p>The <code>rollback</code> operation will rollback the database transaction <i>only</i>. The managed objects in the persistence context will become detached and the <code>EntityManager</code> is cleared. This means any object previously read, should no longer be used, and is no longer part of the persistence context. The changes made to the objects will be left as is, the object changes will <i>not</i> be reverted.</p>
<h3><span class="mw-headline" id="Example_resource_local_transaction_persistence.xml">Example resource local transaction persistence.xml</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;persistence</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/persistence"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> 
<span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/persistence persistence_1_0.xsd"</span> <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">"acme"</span> <span class="na">transaction-type=</span><span class="s">"RESOURCE_LOCAL"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;non-jta-data-source&gt;</span>amce<span class="nt">&lt;/non-jta-data-source&gt;</span>
    <span class="nt">&lt;/persistence-unit&gt;</span>
<span class="nt">&lt;/persistence&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Example_resource_local_transaction">Example resource local transaction</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">createEntityManager</span><span class="o">();</span>
<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>
<span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="n">employee</span><span class="o">.</span><span class="na">setSalary</span><span class="o">(</span><span class="n">employee</span><span class="o">.</span><span class="na">getSalary</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="o">);</span>
<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
<span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</pre></div>
<h2><span class="mw-headline" id="JTA_Transactions">JTA Transactions</span></h2>
<p>JTA transactions are used in Java EE, in managed mode (<a href="https://en.wikibooks.org/wiki/Java_Persistence/Runtime#Java_Enterprise_Edition" title="Java Persistence/Runtime">EJB</a>). To use JTA transactions the <code>transaction-type</code> attribute in the <code>persistence.xml</code> is set to <code>JTA</code>. If JTA transactions are used with a <code>DataSource</code>, the <code>&lt;jta-datasource&gt;</code> element should be used to reference a server <code>DataSource</code> that has been configure to be JTA managed.</p>
<p>JTA transactions are defined through the JTA <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/transaction/UserTransaction.html" target="_blank"><code>UserTransaction</code></a> class, or more likely implicitly defined through <code>SessionBean</code> usage/methods. In a <code>SessionBean</code> normally each <code>SessionBean</code> method invocation defines a JTA transaction. <code>UserTransaction</code> can be obtained through a JNDI lookup in most application servers, or from the <code>EJBContext</code> in EJB 2.0 style <code>SessionBean</code>s.</p>
<p>JTA transactions can be used in two modes in Java EE. In Java EE managed mode, such as an <code>EntityManager</code> injected into a <code>SessionBean</code>, the <code>EntityManager</code> reference, represents a new persistence context for each transaction. This means objects read in one transaction become detached after the end of the transaction, and should no longer be used, or need to be merged into the next transaction. In managed mode, you never create or close an <code>EntityManager</code>.</p>
<p>The second mode allows the <code>EntityManager</code> to be application managed, (normally obtained from an injected <code>EntityManagerFactory</code>, or directly from JPA <code>Persistence</code>). This allows the persistence context to survive transaction boundaries, and follow the normal <code>EntityManager</code> life-cycle similar to resource local. If the <code>EntityManager</code> is created in the context of an active JTA transaction, it will automatically be part of the JTA transaction and commit/rollback with the JTA transaction. Otherwise it must join a JTA transaction to commit/rollback using <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#joinTransaction()" target="_blank"><code>EntityManager.joinTransaction()</code></a></p>
<h3><span class="mw-headline" id="Example_JTA_transaction_persistence.xml">Example JTA transaction persistence.xml</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;persistence</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/persistence"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/persistence persistence_1_0.xsd"</span> <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">"acme"</span> <span class="na">transaction-type=</span><span class="s">"JTA"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jta-data-source&gt;</span>acme<span class="nt">&lt;/jta-data-source&gt;</span>
    <span class="nt">&lt;/persistence-unit&gt;</span>
<span class="nt">&lt;/persistence&gt;</span>
</pre></div>
<h3><span class="mw-headline" id="Example_JTA_transaction">Example JTA transaction</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">UserTransaction</span> <span class="n">transaction</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserTransaction</span><span class="o">)</span><span class="k">new</span> <span class="n">InitialContext</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="s">"java:comp/UserTransaction"</span><span class="o">);</span>
<span class="n">transaction</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
<span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">();</span>
<span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="n">employee</span><span class="o">.</span><span class="na">setSalary</span><span class="o">(</span><span class="n">employee</span><span class="o">.</span><span class="na">getSalary</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="o">);</span>
<span class="n">transaction</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</pre></div>
<h1><span class="mw-headline" id="Advanced_14">Advanced</span></h1>
<h2><span class="mw-headline" id="Join_Transaction">Join Transaction</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#joinTransaction()" target="_blank"><code>EntityManager.joinTransaction()</code></a> API allows an application managed <code>EntityManager</code> to join the active JTA transaction context. This allows an <code>EntityManager</code> to be created outside the JTA transaction scope and commit its changes as part of the current transaction. This is normally used with a <code>stateful SessionBean</code>, or with a JSP or Servlet where an <code>EXTENDED EntityManager</code> is used in a <i>stateful</i> architecture. A <i>stateful</i> architecture is one where the server stores information on a client connection until the client's session is over, it differs from a <i>stateless</i> architecture where nothing is stored on the server in between client requests (each request is processed on its own).</p>
<p>There are pros and cons with both <i>stateful</i> and <i>stateless</i> architectures. One of the advantages with using a <i>stateful</i> architecture and and <code>EXTENDED EntityManager</code>, is that you do not have to worry about merging objects. You can read your objects in one request, let the client modify them, and then commit them as part of a new transaction. This is where <code>joinTransaction</code> would be used. One issue with this is that you normally want to create the <code>EntityManager</code> when there is no active JTA transaction, otherwise it will commit as part of that transaction. However, even if it does commit, you can still continue to use it and join a future transaction. You do have to avoid using transactional API such as <code>merge</code> or <code>remove</code> until you are ready to commit the transaction.</p>
<p><code>joinTransaction</code> is only used with JTA managed <code>EntityManager</code>s (JTA transaction-type in persistence.xml). For <code>RESOURCE_LOCAL</code> <code>EntityManager</code>s you can just commit the JPA transaction whenever you desire.</p>
<h3><span class="mw-headline" id="Example_joinTransaction_usage">Example joinTransaction usage</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">getEntityManagerFactory</span><span class="o">().</span><span class="na">createEntityManager</span><span class="o">();</span>
<span class="n">Employee</span> <span class="n">employee</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="n">employee</span><span class="o">.</span><span class="na">setSalary</span><span class="o">(</span><span class="n">employee</span><span class="o">.</span><span class="na">getSalary</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="o">);</span>

<span class="n">UserTransaction</span> <span class="n">transaction</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserTransaction</span><span class="o">)</span><span class="k">new</span> <span class="n">InitialContext</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="s">"java:comp/UserTransaction"</span><span class="o">);</span>
<span class="n">transaction</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
<span class="n">em</span><span class="o">.</span><span class="na">joinTransaction</span><span class="o">();</span>
<span class="n">transaction</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</pre></div>
<h2><span class="mw-headline" id="Retrying_Transactions.2C_Handling_Commit_Failures">Retrying Transactions, Handling Commit Failures</span></h2>
<p>Sometimes it is desirable to handle persistence errors, and recover and retry transactions. This normally requires a lot of application knowledge to know what failed, what state the system is in, and how to fix it.</p>
<p>Unfortunately JPA does not provide a direct way of handling commit failures or error handling. When a transaction commit fails, the transaction is automatically rolled back, and the persistence context cleared, and all managed objects detached. Not only is there no way to handle a commit failure, but if any error occurs in an query before the commit, the transaction will be marked for rollback, so there is no real way to handle any error. This is because any query could potentially change the state of the database, so JPA does not know if the database is in an invalid or inconsistent state so must rollback the transaction. As well if the commit fails, the state of the objects registered in the persistence context may also be inconsistent (such as partially committed objects having their optimistic lock versions incremented), so the persistence context is cleared to avoid further errors.</p>
<p>Some JPA providers may provide extended API to allow handling commit failures, or handling errors on queries.</p>
<p>There are some methods to generically handle commit failures and other errors. Error handling in general is normally easier when using <code>RESOURCE_LOCAL</code> transactions, and not when using JTA transactions.</p>
<p>One method of error handling is to call <code>merge</code> for each managed object after the commit fails into a new <code>EntityManager</code>, then try to commit the new <code>EntityManager</code>. One issue may be that any ids that were assigned, or optimistic lock versions that were assigned or incremented may need to be reset. Also, if the original <code>EntityManager</code> was <code>EXTENDED</code>, any objects that were in use would still become detached, and need to be reset.</p>
<p>Another more involved method to error handling is to always work with a non-transactional <code>EntityManager</code>. When it's time to commit, a new <code>EntityManager</code> is created, the non-transactional objects are merged into it, and the new <code>EntityManager</code> is committed. If the commit fails, only the state of the new <code>EntityManager</code> may be inconsistent, the original <code>EntityManager</code> will be unaffected. This can allow the problem to be corrected, and the <code>EntityManager</code> re-merged into another new <code>EntityManager</code>. If the commit is successful any commit changes can be merged back into the original <code>EntityManager</code>, which can then continue to be used as normal. This solution requires a fair bit of overhead, so should only be used if error handling is really required, and the JPA provider provides no alternatives.</p>
<h2><span class="mw-headline" id="Nested_Transactions">Nested Transactions</span></h2>
<p>JPA and JTA do not support nested transactions.</p>
<p>A nested transaction is used to provide a transactional guarantee for a subset of operations performed within the scope of a larger transaction. Doing this allows you to commit and abort the subset of operations independently of the larger transaction.</p>
<p>The rules to the usage of a nested transaction are as follows:</p>
<p>While the nested (child) transaction is active, the parent transaction may not perform any operations other than to commit or abort, or to create more child transactions.</p>
<p>Committing a nested transaction has no effect on the state of the parent transaction. The parent transaction is still uncommitted. However, the parent transaction can now see any modifications made by the child transaction. Those modifications, of course, are still hidden to all other transactions until the parent also commits.</p>
<p>Likewise, aborting the nested transaction has no effect on the state of the parent transaction. The only result of the abort is that neither the parent nor any other transactions will see any of the database modifications performed under the protection of the nested transaction.</p>
<p>If the parent transaction commits or aborts while it has active children, the child transactions are resolved in the same way as the parent. That is, if the parent aborts, then the child transactions abort as well. If the parent commits, then whatever modifications have been performed by the child transactions are also committed.</p>
<p>The locks held by a nested transaction are not released when that transaction commits. Rather, they are now held by the parent transaction until such a time as that parent commits.</p>
<p>Any database modifications performed by the nested transaction are not visible outside of the larger encompassing transaction until such a time as that parent transaction is committed.</p>
<p>The depth of the nesting that you can achieve with nested transaction is limited only by memory.</p>
<h2><span class="mw-headline" id="Transaction_Isolation">Transaction Isolation</span></h2>
<h1><span class="mw-headline" id="Caching">Caching</span></h1>
<p>Caching is the most important performance optimization technique. There are many things that can be cached in persistence, objects, data, database connections, database statements, query results, meta-data, relationships, to name a few. Caching in object persistence normally refers to the caching of objects or their data. Caching also influences object identity, that is that if you read an object, then read the same object again you should get the identical object back (same reference).</p>
<p>JPA 1.0 does not define a shared object cache, JPA providers can support a shared object cache or not, however most do. Caching in JPA is required within a transaction or within an extended persistence context to preserve object identity, but JPA does not require that caching be supported across transactions or persistence contexts.</p>
<p>JPA 2.0 defines the concept of a shared cache. The <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/Cacheable.html" target="_blank"><code>@Cacheable</code></a> annotation or <code>cacheable</code> XML attribute can be used to enable or disable caching on a class.</p>
<h3><span class="mw-headline" id="Example_JPA_2.0_Cacheable_annotation">Example JPA 2.0 Cacheable annotation</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nd">@Entity</span>
<span class="nd">@Cacheable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<p>The <a rel="nofollow" class="external text" href="http://download.oracle.com/javaee/6/api/javax/persistence/SharedCacheMode.html" target="_blank"><code>SharedCacheMode</code></a> enum can also be set in the <code>&lt;shared-cache-mode&gt;</code> XML element in the persistence.xml to configure the default cache mode for the entire persistence unit.</p>
<h3><span class="mw-headline" id="Example_JPA_2.0_SharedCacheMode_XML">Example JPA 2.0 SharedCacheMode XML</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">"ACME"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;shared-cache-mode&gt;</span>NONE<span class="nt">&lt;/shared-cache-mode&gt;</span>
<span class="nt">&lt;/persistence-unit&gt;</span>
</pre></div>
<p>There are two types of caching. You can cache the objects themselves including all of their structure and relationships, or you can cache their database row data. Both provide a benefit, however just caching the row data is missing a huge part of the caching benefit as the retrieval of each relationship typically involves a database query, and the bulk of the cost of reading an object is spent in retrieving its relationships.</p>
<h2><span class="mw-headline" id="Object_Identity">Object Identity</span></h2>
<p>Object identity in Java means if two variables (<code>x, y</code>) refer to the same logical object, then <code>x == y</code> returns <code>true</code>. Meaning that both reference the same thing (both a pointer to the same memory location).</p>
<p>In JPA object identity is maintained within a transaction, and (normally) within the same <code>EntityManager</code>. The exception is in a JEE managed <code>EntityManager</code>, object identity is only maintained inside of a transaction.</p>
<p>So the following is true in JPA:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Employee</span> <span class="n">employee1</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">123</span><span class="o">);</span>
<span class="n">Employee</span> <span class="n">employee2</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">123</span><span class="o">);</span>
<span class="k">assert</span> <span class="o">(</span><span class="n">employee1</span> <span class="o">==</span> <span class="n">employee2</span><span class="o">);</span>
</pre></div>
<p>This holds true no matter how the object is accessed:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Employee</span> <span class="n">employee1</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">123</span><span class="o">);</span>
<span class="n">Employee</span> <span class="n">employee2</span> <span class="o">=</span> <span class="n">employee1</span><span class="o">.</span><span class="na">getManagedEmployees</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getManager</span><span class="o">();</span>
<span class="k">assert</span> <span class="o">(</span><span class="n">employee1</span> <span class="o">==</span> <span class="n">employee2</span><span class="o">);</span>
</pre></div>
<p>In JPA object identity is <i>not</i> maintained across <code>EntityManager</code>s. Each <code>EntityManager</code> maintains its own persistence context, and its own transactional state of its objects.</p>
<p>So the following is true in JPA:</p>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">EntityManager</span> <span class="n">entityManager1</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
<span class="n">EntityManager</span> <span class="n">entityManager2</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
<span class="n">Employee</span> <span class="n">employee1</span> <span class="o">=</span> <span class="n">entityManager1</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">123</span><span class="o">);</span>
<span class="n">Employee</span> <span class="n">employee2</span> <span class="o">=</span> <span class="n">entityManager2</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">123</span><span class="o">);</span>
<span class="k">assert</span> <span class="o">(</span><span class="n">employee1</span> <span class="o">!=</span> <span class="n">employee2</span><span class="o">);</span>
</pre></div>
<p>Object identity is normally a good thing, as it avoids having your application manage multiple copies of objects, and avoids the application changing one copy, but not the other. The reason different <code>EntityManager</code>s or transactions (in JEE) don't maintain object identity is that each transaction must isolate its changes from other users of the system. This is also normally a good thing, however it does require the application to be aware of copies, detached objects and merging.</p>
<p>Some JPA products may have a concept of <i>read-only</i> objects, in which object identity may be maintained across <code>EntityManager</code>s through a shared object cache.</p>
<h2><span class="mw-headline" id="Object_Cache">Object Cache</span></h2>
<p>An object cache is where the Java objects (entities) are themselves cached. The advantage of an object cache is that the data is cached in the same format that it is used in Java. Everything is stored at the object-level and no conversion is required when obtaining a cache hit. With JPA the <code>EntityManager</code> must still copy the objects to and from the cache, as it must maintain its transaction isolation, but that is all that is required. The objects do not need to be re-built, and the relationships are already available.</p>
<p>With an object cache, transient data may also be cached. This may occur automatically, or may require some effort. If transient data is not desired, you may also need to clear the data when the object gets cached.</p>
<p>Some JPA products allow <i>read-only</i> queries to access the object cache directly. Some products only allow object caching of read-only data. Obtaining a cache hit on read-only data is extremely efficient as the object does not need to be copied, other than the look-up, no work is required.</p>
<p>It is possible to create your own object cache for your read-only data by loading objects from JPA into your own object cache or <code>JCache</code> implementation. The main issue, which is always the main issue in caching in general, is how to handle updates and stale cached data, but if the data is read-only, this may not be an issue.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support an object cache. The object cache is on by default, but can be globally or selectively enabled or configured per class. The persistence unit property <code>"eclipselink.cache.shared.default"</code> can be set to <code>"false"</code> to disable the cache. Read-only queries are supported through the <code>"eclipselink.read-only"</code> query hint, entities can also be marked to always be read-only using the <code>@ReadOnly</code> annotation.</dd>
</dl>
<h2><span class="mw-headline" id="Data_Cache">Data Cache</span></h2>
<p>A data cache, caches the object's data, not the objects themselves. The data is normally a representation of the object's database row. The advantage of a data cache is that it is easier to implement as you do not have to worry about relationships, object identity, or complex memory management. The disadvantage of a data cache is that it does not store the data as it is used in the application, and does not store relationships. This means that on a cache hit, the object must still be built from the data, and the relationships fetched from the database. Some products that support a data cache, also support a <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Caching_Relationships">relationship cache</a>, or <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Query_Cache">query cache</a> to allow caching of relationships.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/Hibernate" title="Java Persistence/Hibernate">Hibernate</a>&nbsp;: Supports integration with a third party data cache. Caching is not enabled by default and a third party caching product such as Ehcache must be used to enable caching.</dd>
</dl>
<h3><span class="mw-headline" id="Caching_Relationships">Caching Relationships</span></h3>
<p>Some products support a separate cache for caching relationships. This is normally required for <code>OneToMany</code> and <code>ManyToMany</code> relationships. <code>OneToOne</code> and <code>ManyToOne</code> relationships normally do not need to be cached, as they reference the object's <code>Id</code>. However an inverse <code>OneToOne</code> will require the relationship to be cached, as it references the foreign key, not primary key.</p>
<p>For a relationship cache, the results normally only store the related object's <code>Id</code>, not the object, or its data (to avoid duplicate and stale data). The key of the relationship cache is the source object's <code>Id</code> and the relationship name. Sometimes the relationship is cached as part of the data cache, if the data cache stores a structure instead of a database row. When a cache hit occurs on a relationship, the related objects are looked up in the data cache one by one. A potential issue with this, is that if the related object is not in the data cache, it will need to be selected from the database. This could result in very poor database performance as the objects can be loaded one by one. Some product that support caching relationships also support batching the selects to attempt to alleviate this issue.</p>
<h2><span class="mw-headline" id="Cache_Types">Cache Types</span></h2>
<p>There are many different caching types. The most common is a LRU cache, or one that ejects the Least Recently Used objects and maintains a fixed size number of MRU (Most Recently Used) objects.</p>
<p>Some cache types include:</p>
<ul>
<li>LRU - Keeps X number of recently used objects in the cache.</li>
<li>Full - Caches everything read, forever. (not always the best idea if the database is large)</li>
<li>Soft - Uses Java garbage collection hints to release objects from the cache when memory is low.</li>
<li>Weak - Normally relevant with object caches, keeps any objects currently in use in the cache.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#1st_Level_Cache">L1</a> - This refers to the transactional cache that is part of every <code>EntityManager</code>, this is not a shared cache.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#2nd_Level_Cache">L2</a> - This is a shared cache, conceptually stored in the <code>EntityManagerFactory</code>, so accessible to all <code>EntityManager</code>s.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Data_Cache">Data cache</a> - The data representing the objects is cached (database rows).</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Object_Cache">Object cache</a> - The objects are cached directly.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Caching_Relationships">Relationship cache</a> - The object's relationships are cached.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Query_Cache">Query cache</a> - The result set from a query is cached.</li>
<li>Read-only - A cache that only stores, or only allows read-only objects.</li>
<li>Read-write - A cache that can handle insert, updates and deletes (non read-only).</li>
<li>Transactional - A cache that can handle insert, updates and deletes (non read-only), and obeys transactional ACID properties.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Caching_in_a_Cluster">Clustered</a> - Typically refers to a cache that uses JMS, JGroups or some other mechanism to broadcast invalidation messages to other servers in the cluster when an object is updated or deleted.</li>
<li>Replicated - Typically refers to a cache that uses JMS, JGroups or some other mechanism to broadcast objects to all servers when read into any of the servers cache.</li>
<li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Distributed_Caching">Distributed</a> - Typically refers to a cache that spreads the cached objects across several servers in a cluster, and can look-up an object in another server's cache.</li>
</ul>
<p><br></p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support an L1 and L2 object cache. LRU, Soft, Full and Weak cache types are supported. A query cache is supported. The object cache is read-write and always transactional. Support for cache coordination through RMI and JMS is provided for clustering. The <a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> product includes a <i>Grid</i> component that integrates with Oracle Coherence to provide a distributed cache.</dd>
</dl>
<h2><span class="mw-headline" id="Query_Cache">Query Cache</span></h2>
<p>A query cache caches query results instead of objects. Object caches cache the object by its <code>Id</code>, so are generally not very useful for queries that are not by <code>Id</code>. Some object caches support secondary indexes, but even indexed caches are not very useful for queries that can return multiple objects, as you always need to access the database to ensure you have all of the objects. This is where query caches are useful, instead of storing objects by <code>Id</code>, the query results are cached. The cache key is based on the query name and parameters. So if you have a <code>NamedQuery</code> that is commonly executed, you can cache its results, and only need to execute the query the first time.</p>
<p>The main issue with query caches, as with caching in general is stale data. Query caches normally interact with an object cache to ensure the objects are at least as up to date as in the object cache. Query caches also typically have invalidation options similar to object caches.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support query cache enabled through the query hint <code>"eclipselink.query-results-cache"</code>. Several configuration options including invalidation are supported.</dd>
</dl>
<h2><span class="mw-headline" id="Stale_Data">Stale Data</span></h2>
<p>The main issue with caching anything is the possibility of the cache version getting out of synch with the original. This is referred to as <i>stale</i> or <i>out of synch</i> data. For <i>read-only</i> data, this is not an issue, but for data that changes in-frequently or frequently this can be a major issue. There are many techniques for dealing with stale data and out of synch data.</p>
<h3><span class="mw-headline" id="1st_Level_Cache">1st Level Cache</span></h3>
<p>Caching the object's state for the duration of a transaction or request is normally not an issue. This is normally called a 1st level cache, or the <code>EntityManager</code> cache, and is required by JPA for proper transaction semantics. If you read the same object twice, you must get the identical object, with the same in-memory changes. The only issues occur with querying and DML.</p>
<p>For queries that access the database, the query may not reflect the un-written state of the objects. For example you have persisted a new object, but JPA has not yet inserted this object in the database as it generally only writes to the database on the commit of the transaction. So your query will not return this new object, as it is querying the database, not the 1st level cache. This is normally solved in JPA by the user first calling <code>flush()</code>, or the <code>flushMode</code> automatically triggering a flush. The default <code>flushMode</code> on an <code>EntityManager</code> or <code>Query</code> is to trigger a flush, but this can be disabled if a write to the database before every query is not desired (normally it isn't, as it can be expensive and lead to poor concurrency). Some JPA providers also support <i>conforming</i> the database query results with the object changes in memory, which can be used to get consistent data without triggering a flush. This can work for simple queries, but for complex queries this typically gets very complex to impossible. Applications normally query data at the start of a request before they start making changes, or don't query for objects they have already found, so this is normally not an issue.</p>
<p>If you bypass JPA and execute DML directly on the database, either through native SQL queries, JDBC, or JPQL <code>UPDATE</code> or <code>DELETE</code> queries, then the database can be out of synch with the 1st level cache. If you had accessed objects before executing the DML, they will have the old state and not include the changes. Depending on what you are doing this may be ok, otherwise you may want to refresh the affected objects from the database.</p>
<p>The 1st level, or <code>EntityManager</code> cache can also span transaction boundaries in JPA. A JTA managed <code>EntityManager</code> will only exist for the duration of the JTA transaction in JEE. Typically the JEE server will inject the application with a proxy to an <code>EntityManager</code>, and after each JTA transaction a new <code>EntityManager</code> will be created automatically or the <code>EntityManager</code> will be cleared, clearing the 1st level cache. In an application managed <code>EntityManager</code>, the 1st level cache will exist for the duration of the <code>EntityManager</code>. This can lead to stale data, or even memory leaks and poor performance if the <code>EntityManager</code> is held too long. This is why it is generally a good idea to create a new <code>EntityManager</code> per request, or per transaction. The 1st level cache can also be cleared using the <code>EntityManager.clear()</code> method, or an object can be refreshed using the <code>EntityManager.refresh()</code> method.</p>
<h3><span class="mw-headline" id="2nd_Level_Cache">2nd Level Cache</span></h3>
<p>The 2nd level cache spans transactions and <code>EntityManager</code>s, and is not required as part of JPA. Most JPA providers support a 2nd level cache, but the implementation and semantics vary. Some JPA providers default to enabling a 2nd level cache, and some do not use a 2nd level cache by default.</p>
<p>If the application is the only application and server accessing the database there is little issue with the 2nd level cache, as it should always be up to date. The only issue is with DML, if the application executes DML directly to the database through native SQL queries, JDBC, or JPQL <code>UPDATE</code> or <code>DELETE</code> queries. JPQL queries should automatically invalidate the 2nd level cache, but this may depend on the JPA provider. If you use native DML queries or JDBC directly, you may need to invalidate, refresh or clear the objects affected by the DML.</p>
<p>If there are other applications, or other application servers accessing the same database, then stale data can become a bigger issue. Read-only objects, and inserting new objects should not be an issue. New objects should get picked up by other servers even when using caching as queries typically still access the database. It is normally only <code>find()</code> operations and relationships that hit the cache. Updated and deleted objects by other applications or servers can cause the 2nd level cache to become stale.</p>
<p>For deleted objects, the only issue is with <code>find()</code> operations, as queries that access the database will not return the deleted objects. A <code>find()</code> by the object's <code>Id</code> could return the object if it is cached, even if it does not exist. This could lead to constraint issues if you add relations to this object from other objects, or failed updates, if you try to update the object. Note that these can both occur without caching, even with a single application and server accessing the database. During a transaction, another user of the application could always delete the object being used by another transaction, and the second transaction will fail in the same way. The difference is the potential for this concurrency issue to occur increases.</p>
<p>For updated objects, any query for the objects can return stale data. This can trigger optimistic lock exceptions on updates, or cause one user to overwrite another user's changes if not using locking. Again note that these can both occur without caching, even with a single application and server accessing the database. This is why it is normally always important to use optimistic locking. Stale data could also be returned to the user.</p>
<h3><span class="mw-headline" id="Refreshing">Refreshing</span></h3>
<p>Refreshing is the most common solution to stale data. Most application users are familiar with the concept of a cache, and know when they need fresh data and are willing to click a refresh button. This is very common in an Internet browser, most browsers have a cache of web pages that have been accessed, and will avoid loading the same page twice, unless the user clicks the refresh button. This same concept can be used in building JPA applications. JPA provides several refreshing options, see <a href="https://en.wikibooks.org/wiki/Java_Persistence/Persisting#Refresh" title="Java Persistence/Persisting">refreshing</a>.</p>
<p>Some JPA providers also support refreshing options in their 2nd level cache. One option is to always refresh on any query to the database. This means that <code>find()</code> operations will still access the cache, but if the query accesses the database and brings back data, the 2nd level cache will be refreshed with the data. This avoids queries returning stale data, but means there will be less benefit from caching. The cost is not just in refreshing the objects, but in refreshing their relationships. Some JPA providers support this option in combination with optimistic locking. If the version value in the row from the database is newer than the version value from the object in the cache, then the object is refreshed as it is stale, otherwise the cache value is returned. This option provides optimal caching, and avoids stale data on queries. However objects returned through <code>find()</code> or through relationships can still be stale. Some JPA providers also allow <code>find()</code> operation to be configured to first check the database, but this general defeats the purpose of caching, so you are better off not using a 2nd level cache at all. If you want to use a 2nd level cache, then you must have some level of tolerance to stale data.</p>
<h3><span class="mw-headline" id="JPA_2.0_Cache_APIs">JPA 2.0 Cache APIs</span></h3>
<p>JPA 2.0 provides a set of standard query hints to allow refreshing or bypassing the cache. The query hints are defined on the two enum classes <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/CacheRetrieveMode.html" target="_blank">CacheRetrieveMode</a> and <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/CacheStoreMode.html" target="_blank">CacheStoreMode</a>.</p>
<p>Query hints:</p>
<ul>
<li><code>javax.persistence.cache.retrieveMode</code>&nbsp;: <code>CacheRetrieveMode</code>
<ul>
<li><code>BYPASS</code>&nbsp;: Ignore the cache, and build the object directly from the database result.</li>
<li><code>USE</code>&nbsp;: Allow the query to use the cache. If the object/data is already in the cache, the cached object/data will be used.</li>
</ul>
</li>
<li><code>javax.persistence.cache.storeMode</code>&nbsp;: <code>CacheStoreMode</code>
<ul>
<li><code>BYPASS</code>&nbsp;: Do not cache the database results.</li>
<li><code>REFRESH</code>&nbsp;: If the object/data is already in the cache, then refresh/replace it with the database results.</li>
<li><code>USE</code>&nbsp;: Cache the objects/data returned from the query.</li>
</ul>
</li>
</ul>
<h4><span class="mw-headline" id="Cache_hints_example">Cache hints example</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"Select e from Employee e"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setHint</span><span class="o">(</span><span class="s">"javax.persistence.cache.storeMode"</span><span class="o">,</span> <span class="n">CacheStoreMode</span><span class="o">.</span><span class="na">REFRESH</span><span class="o">);</span>
</pre></div>
<p><br>
JPA 2.0 also provides a <a rel="nofollow" class="external text" href="https://java.sun.com/javaee/6/docs/api/javax/persistence/Cache.html" target="_blank">Cache</a> interface. The <code>Cache</code> interface can be obtained from the <code>EntityManagerFactory</code> using the <code>getCache()</code> API. The <code>Cache</code> can be used to manually evict/invalidate entities in the cache. Either a specific entity, an entire class, or the entire cache can be evicted. The <code>Cache</code> can also be checked to see if it contains an entity.</p>
<p>Some JPA providers may extend the <code>getCache()</code> interface to provide additional API.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Provide an extended <code>Cache</code> interface <code>JpaCache</code>. It provides additional API for invalidation, query cache, access and clearing.</dd>
</dl>
<h4><span class="mw-headline" id="Cache_evict_example">Cache evict example</span></h4>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="n">Cache</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getCache</span><span class="o">();</span>
<span class="n">cache</span><span class="o">.</span><span class="na">evict</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
</pre></div>
<h3><span class="mw-headline" id="Cache_Invalidation">Cache Invalidation</span></h3>
<p>A common way to deal with stale cached data is to use cache invalidation. Cache invalidation removes or invalidates data or objects in the cache after a certain amount of time, or at a certain time of day. Time to live invalidation guarantees that the application will never read cached data that is older than a certain amount of time. The amount of the time can be configured with respect to the application's requirements. Time of day invalidation allows the cache to be invalidated at a certain time of day, typically done in the night, this ensures data is never older than a day old. This can also be used if it is know that a batch job updates the database a night, the invalidation time can be set after this batch job is scheduled to run. Data can also be invalidated manually, such as using the JPA 2.0 <code>evict()</code> API.</p>
<p>Most cache implementations support some form of invalidation, JPA does not define any configurable invalidation options, so this depends on the JPA and cache provider.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Provide support for time to live and time of day cache invalidation using the <code>@Cache</code> annotation and <code>&lt;cache&gt;</code> orm.xml element. Cache invalidation is also supported through API, and can be used in a cluster to invalidate objects changed on other machines.</dd>
</dl>
<h3><span class="mw-headline" id="Caching_in_a_Cluster">Caching in a Cluster</span></h3>
<p>Caching in a clustered environment is difficult because each machine will update the database directly, but not update the other machine's caches, so each machines cache can become out of date. This does not mean that caching cannot be used in a cluster, but you must be careful in how it is configured.</p>
<p>For read-only objects caching can still be used. For read mostly objects, caching can be used, but some mechanism should be used to avoid stale data. If stale data is only an issue for writes, then using optimistic locking will avoid writes occurring on stale data. When an optimistic lock exception occurs, some JPA providers will automatically refresh or invalidate the object in the cache, so if the user or application retries the transaction the next write will succeed. Your application could also catch the lock exception and refresh or invalidate the object, and potentially retry the transaction if the user does not need to be notified of the lock error (be careful doing this though, as normally the user should be aware of the lock error). Cache invalidation can also be used to decrease the likelyhood of stale data by setting a time to live on the cache. The size of the cache can also affect the occurrence of stale data.</p>
<p>Although returning stale data to a user may be an issue, normally returning stale data to a user that just updated the data is a bigger issue. This can normally be solved through session affinity, but ensuring the user interacts with the same machine in the cluster for the duration of their session. This can also improve cache usage, as the same user will typically access the same data. It is normally also useful to add a <i>refresh</i> button to the UI, this will allow the user to refresh their data if they think their data is stale, or they wish to ensure they have data that is up to date. The application can also choose the refresh the objects in places where up to date data is important, such as using the cache for read-only queries, but refreshing when entering a transaction to update an object.</p>
<p>For write mostly objects, the best solution may be to disable the cache for those objects. Caching provides no benefit to inserts, and the cost of avoiding stale data on updates may mean there is no benefit to caching objects that are always updated. Caching will add some overhead to writes, as the cache must be updated, having a large cache also affects garbage collection, so if the cache is not providing any benefit it should be turned off to avoid this overhead. This can depend on the complexity of the object though, if the object has a lot of complex relationships, and only part of the object is updated, then caching may still be worth it.</p>
<h4><span class="mw-headline" id="Cache_Coordination">Cache Coordination</span></h4>
<p>One solution to caching in a clustered environment is to use a messaging framework to coordinate the caches between the machines in the cluster. JMS or JGroups can be used in combination with JPA or application events to broadcast messages to invalidate the caches on other machines when an update occurs. Some JPA and cache providers support cache coordination in a clustered environment.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Support cache coordination in a clustered environment using JMS or RMI. Cache coordination is configured through the <code>@Cache</code> annotation or <code>&lt;cache&gt;</code> orm.xml element, and using the persistence unit property <code>eclipselink.cache.coordination.protocol</code>.</dd>
</dl>
<h4><span class="mw-headline" id="Distributed_Caching">Distributed Caching</span></h4>
<p>A distributed cache is one where the cache is distributed across each of the machines in the cluster. Each object will only live on one or a set number of the machines. This avoids stale data, because when the cache is accessed or updated the object is always retrieved from the same location, so is always up to date. The draw back to this solution is that cache access now potentially requires a network access. This solution works best when the machines in the cluster are connected together on the same high speed network, and when the database machine is not as well connected, or is under load. A distributed cache reduces database access, so allows the application to be scaled to a larger cluster without the database becoming a bottleneck. Some distributed cache providers also provide a local cache, and offer cache coordination between the caches.</p>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a>&nbsp;: Supports integration with the Oracle Coherence distributed cache.</dd>
</dl>
<h2><span class="mw-headline" id="Cache_Transaction_Isolation">Cache Transaction Isolation</span></h2>
<p>When caching is used, the consistency and isolation of the cache becomes as important as the database transaction isolation. For basic cache isolation it is important that changes are not committed into the cache until after the database transaction has been committed, otherwise uncommitted data could be accessed by other users.</p>
<p>Caches can be either transactional, or non-transactional. In a transactional cache, the changes from a transaction are committed to the cache as a single atomic unit. This means the objects/data are first locked in the cache (preventing other threads/users from accessing the objects/data), then updated in the cache, then the locks are released. Ideally the locks are obtained before committing the database transaction, to ensure consistency with the database. In a non-transactional cache the objects/data are updated one by one without any locking. This means there will be a brief period where the data in the cache is not consistent with the database. This may or may not be an issue, and is a complex issue to think about and discuss, and gets into the issue of locking, and the application's isolation requirements.</p>
<p>Optimistic locking is another important consideration in cache isolation. If optimistic locking is used, the cache should avoid replacing new data, with older data. This is important when reading, and when updating the cache.</p>
<p>Some JPA providers may allow for configuration of their cache isolation, or different caches may define different levels of isolation. Although the defaults should normally be used, it can be important to understand how the usage of caching is affecting your transaction isolation, as well as your performance and concurrency.</p>
<h2><span class="mw-headline" id="Common_Problems_17">Common Problems</span></h2>
<h4><span class="mw-headline" id="I_can.27t_see_changes_made_directly_on_the_database.2C_or_from_another_server"><i>I can't see changes made directly on the database, or from another server</i></span></h4>
<dl>
<dd>This means you have either enabled caching in your JPA configuration, or your JPA provider caches by default. You can either disable the 2nd level cache in your JPA configuration, or refresh the object or invalidate the cache after changing the database directly. See, <a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#Stale_Data">Stale Data</a>
<dl>
<dd><a href="https://en.wikibooks.org/wiki/Java_Persistence/TopLink" title="Java Persistence/TopLink">TopLink</a> / <a href="https://en.wikibooks.org/wiki/Java_Persistence/EclipseLink" title="Java Persistence/EclipseLink">EclipseLink</a>&nbsp;: Caching is enabled by default. To disable caching set the persistence property <code>"eclipselink.cache.shared.default"</code> to <code>false</code> in your persistence.xml or persistence properties. You can also configure this on a per class basis if you want to allow caching in some classes and not in others. See, <a rel="nofollow" class="external text" href="http://wiki.eclipse.org/EclipseLink/FAQ/How_to_disable_the_shared_cache%3F" target="_blank">EclipseLink FAQ</a>.</dd>
</dl>
</dd>
</dl>
<h1><span class="mw-headline" id="Spring">Spring</span></h1>
<p><a href="https://en.wikipedia.org/wiki/Spring_Framework" class="extiw" title="w:Spring Framework" target="_blank">Spring</a> is an application framework for Java. Spring is an <a href="https://en.wikipedia.org/wiki/Inversion_of_Control" class="extiw" title="w:Inversion of Control" target="_blank">IoC</a> container that allows for a different programming model. Spring is similar to a JEE server, in that it provides a transaction service, XML deployment, annotation processing, byte-code weaving, and JPA integration.</p>
<h2><span class="mw-headline" id="Persistence">Persistence</span></h2>
<p>Persistence in Spring in normally done through a DAO (Data Access Object) layer. The Spring DAO layer is meant to encapsulate the persistence mechanism, so the same application data access API would be given no matter if JDBC, JPA or a native API were used.</p>
<p>Spring also defines a transaction manager implementation that is similar to JTA. Spring also supports transactional annotations and beans similar to SessionBeans.</p>
<h2><span class="mw-headline" id="JPA">JPA</span></h2>
<p>Spring has specific support for JPA and can emulate some of the functionality of a JEE container with respect to JPA. Spring allows a JPA persistence unit to be deployed in container managed mode. If the spring-agent is used to start the JVM, Spring can deploy a JPA persistence unit with weaving similar to a JEE server. Spring can also pass a Spring DataSource and integrate its transaction service with JPA. Spring allows the <code>@PersistenceUnit</code> and <code>@PersistenceContext</code> annotations to be used in any Spring bean class, to have an <code>EntityManager</code> or <code>EntityManagerFactory</code> injected. Spring supports a managed transactional <code>EntityManager</code> similar to JEE, where the <code>EntityManager</code> binds itself as a new persistence context to each new transaction and commits as part of the transaction. Spring supports both JTA integration, and its own transaction manager.</p>
<h3><span class="mw-headline" id="Example_Spring_JPA_Deployment">Example Spring JPA Deployment</span></h3>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"</span>
<span class="s">  			http://www.springframework.org/schema/beans</span>
<span class="s">    		http://www.springframework.org/schema/beans/spring-beans-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"entityManagerFactory"</span> <span class="na">class=</span><span class="s">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"persistenceUnitName"</span> <span class="na">value=</span><span class="s">"acme"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"persistenceUnitManager"</span> <span class="na">ref=</span><span class="s">"persistenceUnitManager"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"persistenceUnitManager"</span> <span class="na">class=</span><span class="s">"org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"defaultDataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSources"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry&gt;</span>
                    <span class="nt">&lt;key&gt;</span>
                        <span class="nt">&lt;value&gt;</span>jdbc/__default<span class="nt">&lt;/value&gt;</span>
                    <span class="nt">&lt;/key&gt;</span>
                    <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
                <span class="nt">&lt;entry&gt;</span>
                    <span class="nt">&lt;key&gt;</span>
                        <span class="nt">&lt;value&gt;</span>jdbc/jta<span class="nt">&lt;/value&gt;</span>
                    <span class="nt">&lt;/key&gt;</span>
                    <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"loadTimeWeaver"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.instrument.classloading.InstrumentationLoadTimeWeaver"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"oracle.jdbc.OracleDriver"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"jdbc:oracle:thin:@localhost:1521:orcl"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"scott"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"tiger"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.orm.jpa.JpaTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"entityManagerFactory"</span> <span class="na">ref=</span><span class="s">"entityManagerFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"entityManager"</span> <span class="na">class=</span><span class="s">"org.springframework.orm.jpa.support.SharedEntityManagerBean"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"entityManagerFactory"</span> <span class="na">ref=</span><span class="s">"entityManagerFactory"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"AcmeDao"</span> <span class="na">class=</span><span class="s">"org.acme.dao.AcmeDao"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"entityManager"</span> <span class="na">ref=</span><span class="s">"entityManager"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
<h1><span class="mw-headline" id="Databases"><b>Databases</b></span></h1>
<h1><span class="mw-headline" id="MySQL">MySQL</span></h1>
<p>Using MySQL with Java Persistence API is quite straightforward as the JDBC driver is available directly from MySQL web site <a rel="nofollow" class="external autonumber" href="http://dev.mysql.com/" target="_blank">[2]</a>.</p>
<p>MySQL Connector/J is the official JDBC driver for MySQL and has a good documentation available directly on the web site.</p>
<p>In this page we will see some aspects of managing MySQL using the Persistence API.</p>
<h2><span class="mw-headline" id="Installing">Installing</span></h2>
<p>Installation is straightforward and consists in making the .jar file downloaded from MySQL web site visible to the JVM. It can be already installed if you are using Apache or JBOSS.</p>
<h2><span class="mw-headline" id="Configuration_tips">Configuration tips</span></h2>
<p>You can learn a lot from the documentation on MySQL web site <a rel="nofollow" class="external autonumber" href="http://dev.mysql.com/doc/refman/5.0/en/connector-j-reference-configuration-properties.html" target="_blank">[3]</a>.</p>
<h3><span class="mw-headline" id="Creating_the_database_automatically">Creating the database automatically</span></h3>
<p>If you intend to create table and a database automatically , you will need to have the correct user rights but also inform the Persistence API about the name of the Database you want to create. For example with TopLink, if you used:</p>
<pre> &lt;property name="toplink.ddl-generation" value="create-tables"/&gt;
</pre>
<p>in the property.xml, you will be likely need to create a new database. To create the database "NewDB" automatically, you need to give the following URL to the jdbc connection:</p>
<pre> &lt;property name="toplink.jdbc.url" value="jdbc:mysql://localhost:3306/NewDB?createDatabaseIfNotExist=true"/&gt;
</pre>
<p>If not, the persistence API will complain that the database does not exist.</p>
<hr>
<h1><span class="mw-headline" id="References">References</span></h1>
<table cellspacing="10">
<tbody><tr>
<td valign="top">
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Crystal_Clear_app_reminders.png" class="image"><img alt="Crystal Clear app reminders.png" src="./JPA_Wikibooks_files/25px-Crystal_Clear_app_reminders.png" width="25" height="25" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/1/13/Crystal_Clear_app_reminders.png/38px-Crystal_Clear_app_reminders.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/1/13/Crystal_Clear_app_reminders.png/50px-Crystal_Clear_app_reminders.png 2x" data-file-width="128" data-file-height="128"></a></div>
<h3><span class="mw-headline" id="Resources_2">Resources</span></h3>
<ul>
<li><a rel="nofollow" class="external text" href="http://jcp.org/aboutJava/communityprocess/final/jsr220/index.html" target="_blank">EJB 3.0 JPA 1.0 Spec</a></li>
<li><a rel="nofollow" class="external text" href="http://jcp.org/en/jsr/detail?id=317" target="_blank">JPA 2.0 Spec</a></li>
<li><a rel="nofollow" class="external text" href="http://java.sun.com/xml/ns/persistence/orm_1_0.xsd" target="_blank">JPA 1.0 ORM XML Schema</a></li>
<li><a rel="nofollow" class="external text" href="http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd" target="_blank">JPA 1.0 Persistence XML Schema</a></li>
<li><a rel="nofollow" class="external text" href="https://java.sun.com/javaee/5/docs/api/javax/persistence/package-summary.html" target="_blank">JPA 1.0 JavaDoc</a></li>
<li><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version/JPQL_BNF&action=edit&redlink=1" class="new" title="Java Persistence/Print version/JPQL BNF (does not exist)">JPQL BNF</a></li>
<li><a rel="nofollow" class="external text" href="http://wiki.eclipse.org/EclipseLink/Development/JPA" target="_blank">JPA 2.0 Reference Implementation Development</a></li>
<li><a href="https://en.wikibooks.org/wiki/Java_Programming" title="Java Programming">Java Programming</a></li>
</ul>
</td>
<td valign="top">
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Wikipedia.png" class="image"><img alt="Wikipedia.png" src="./JPA_Wikibooks_files/25px-Wikipedia.png" width="25" height="29" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/1/12/Wikipedia.png/38px-Wikipedia.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/1/12/Wikipedia.png/50px-Wikipedia.png 2x" data-file-width="135" data-file-height="155"></a></div>
<h3><span class="mw-headline" id="Wikis">Wikis</span></h3>
<ul>
<li><a rel="nofollow" class="external text" href="http://wiki.eclipse.org/EclipseLink" target="_blank">EclipseLink Wiki</a></li>
<li><a rel="nofollow" class="external text" href="http://wiki.oracle.com/page/TopLink" target="_blank">Oracle TopLink Wiki</a></li>
<li><a rel="nofollow" class="external text" href="http://wiki.glassfish.java.net/Wiki.jsp?page=TopLinkEssentials" target="_blank">Glassfish TopLink Essentials Wiki</a></li>
<li><a rel="nofollow" class="external text" href="http://www.hibernate.org/37.html" target="_blank">Hibernate Wiki</a></li>
<li><a class="external text" href="http://en.wikipedia.org/wiki/Java_Persistence_API" target="_blank">JPA on Wikipedia</a></li>
<li><a rel="nofollow" class="external text" href="http://wiki.java.net/bin/view/Javapedia/JPA" target="_blank">JPA on Javapedia</a></li>
<li><a rel="nofollow" class="external text" href="http://www.freebase.com/view/guid/9202a8c04000641f8000000004666d33" target="_blank">JPA on freebase</a></li>
<li><a rel="nofollow" class="external text" href="http://www.dmoz.org/Computers/Programming/Languages/Java/Databases_and_Persistence/Object_Persistence/JPA/" target="_blank">JPA on DMOZ (Open Directory)</a></li>
</ul>
</td>
</tr>
<tr>
<td valign="top">
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Nuvola_apps_edu_languages.svg" class="image"><img alt="Nuvola apps edu languages.svg" src="./JPA_Wikibooks_files/25px-Nuvola_apps_edu_languages.svg.png" width="25" height="25" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/2/23/Nuvola_apps_edu_languages.svg/38px-Nuvola_apps_edu_languages.svg.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/2/23/Nuvola_apps_edu_languages.svg/50px-Nuvola_apps_edu_languages.svg.png 2x" data-file-width="128" data-file-height="128"></a></div>
<h3><span class="mw-headline" id="Forums">Forums</span></h3>
<ul>
<li><a rel="nofollow" class="external text" href="http://forum.java.sun.com/forum.jspa?forumID=13" target="_blank">Sun EJB Forum</a></li>
<li><a rel="nofollow" class="external text" href="http://saloon.javaranch.com/cgi-bin/ubb/ultimatebb.cgi?ubb=forum&f=78" target="_blank">JavaRanch ORM Forum</a></li>
<li><a rel="nofollow" class="external text" href="http://www.nabble.com/JPA-f27109.html" target="_blank">Nabble JPA Forum</a></li>
<li><a rel="nofollow" class="external text" href="http://www.nabble.com/EclipseLink-f26430.html" target="_blank">EclipseLink Forum</a></li>
<li><a rel="nofollow" class="external text" href="http://www.eclipse.org/newsportal/thread.php?group=eclipse.rt.eclipselink" target="_blank">EclipseLink Newsgroup</a></li>
<li><a rel="nofollow" class="external text" href="http://forums.oracle.com/forums/forum.jspa?forumID=48" target="_blank">Oracle TopLink Forum</a></li>
<li><a rel="nofollow" class="external text" href="http://forum.hibernate.org/" target="_blank">Hibernate Forum</a></li>
<li><a rel="nofollow" class="external text" href="http://www.nabble.com/java.net---glassfish-persistence-f13455.html" target="_blank">TopLink Essentials Mailing List (Glassfish persistence)</a></li>
</ul>
</td>
<td valign="top">
<div class="floatleft"><a href="https://commons.wikimedia.org/wiki/File:Crystal_Clear_app_desktopshare.png" class="image"><img alt="Crystal Clear app desktopshare.png" src="./JPA_Wikibooks_files/25px-Crystal_Clear_app_desktopshare.png" width="25" height="25" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Crystal_Clear_app_desktopshare.png/38px-Crystal_Clear_app_desktopshare.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Crystal_Clear_app_desktopshare.png/50px-Crystal_Clear_app_desktopshare.png 2x" data-file-width="128" data-file-height="128"></a></div>
<h3><span class="mw-headline" id="Products">Products</span></h3>
<ul>
<li><a rel="nofollow" class="external text" href="http://www.oracle.com/technology/products/ias/toplink/index.html" target="_blank">Oracle TopLink Home</a></li>
<li><a rel="nofollow" class="external text" href="http://www.eclipse.org/eclipselink/" target="_blank">EclipseLink Home</a></li>
<li><a rel="nofollow" class="external text" href="https://glassfish.dev.java.net/javaee5/persistence/" target="_blank">TopLink Essentials Home</a></li>
<li><a rel="nofollow" class="external text" href="http://www.hibernate.org/" target="_blank">Hibernate Home</a></li>
<li><a rel="nofollow" class="external text" href="http://openjpa.apache.org/" target="_blank">Open JPA Home</a></li>
<li><a rel="nofollow" class="external text" href="http://objectgeneration.com/eclipse/" target="_blank">HiberObjects</a></li>
</ul>
</td>
</tr>
<tr>
<td valign="top">
<h3><span class="mw-headline" id="Blogs">Blogs</span></h3>
<ul>
<li><a rel="nofollow" class="external text" href="http://java-persistence.blogspot.com/" target="_blank">Java Persistence</a> (Doug Clarke)</li>
<li><a rel="nofollow" class="external text" href="http://jroller.com/mkeith/" target="_blank">System.out</a> (Mike Keith)</li>
<li><a rel="nofollow" class="external text" href="http://ontoplink.blogspot.com/" target="_blank">On TopLink</a> (Shaun Smith)</li>
<li><a rel="nofollow" class="external text" href="http://eclipselink.blogspot.com/" target="_blank">EclipseLink</a></li>
<li><a rel="nofollow" class="external text" href="http://blog.hibernate.org/" target="_blank">Hibernate Blog</a></li>
</ul>
</td>
<td valign="top">
<h3><span class="mw-headline" id="Books">Books</span></h3>
<ul>
<li><a rel="nofollow" class="external text" href="http://www.amazon.com/gp/product/1590596455/102-2412923-9620152?v=glance&n=283155" target="_blank">Pro EJB 3</a></li>
</ul>
</td>
</tr>
</tbody></table>


<!-- 
NewPP limit report
Parsed by mw1004
CPU time usage: 1.087 seconds
Real time usage: 8.087 seconds
Preprocessor visited node count: 3234/1000000
Preprocessor generated node count: 0/1500000
Post‐expand include size: 436148/2097152 bytes
Template argument size: 878/2097152 bytes
Highest expansion depth: 12/40
Expensive parser function count: 0/500
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00% 7267.240      1 - -total
 18.33% 1332.197      1 - Java_Persistence/Inheritance
 15.37% 1117.272      1 - Java_Persistence/Querying
 11.80%  857.563      1 - Java_Persistence/Relationships
 11.79%  856.492      1 - Java_Persistence/Identity_and_Sequencing
 11.49%  834.837      1 - Java_Persistence/Embeddables
  8.26%  600.277      1 - Java_Persistence/Advanced_Topics
  8.21%  596.631      1 - Java_Persistence/OneToOne
  5.29%  384.334      1 - Java_Persistence/ManyToMany
  2.88%  208.976      1 - Java_Persistence/OneToMany
-->

<!-- Saved in parser cache with key enwikibooks:pcache:idhash:203612-0!*!0!!*!4!* and timestamp 20150711204418 and revision id 2503078
 -->
<noscript>&lt;img src="//en.wikibooks.org/wiki/Special:CentralAutoLogin/start?type=1x1" alt="" title="" width="1" height="1" style="border: none; position: absolute;" /&gt;</noscript></div>					<div class="printfooter">
						Retrieved from "<a dir="ltr" href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&oldid=2503078">https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&amp;oldid=2503078</a>"					</div>
				<div id="catlinks" class="catlinks"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="https://en.wikibooks.org/wiki/Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="https://en.wikibooks.org/wiki/Category:Java_Persistence" title="Category:Java Persistence">Java Persistence</a></li><li><a href="https://en.wikibooks.org/wiki/Category:Java_Persistence/What_is_Java_persistence" title="Category:Java Persistence/What is Java persistence">Java Persistence/What is Java persistence</a></li><li><a href="https://en.wikibooks.org/wiki/Category:Java_Persistence/Persistence_Products" title="Category:Java Persistence/Persistence Products">Java Persistence/Persistence Products</a></li><li><a href="https://en.wikibooks.org/wiki/Category:Java_Persistence/Mapping" title="Category:Java Persistence/Mapping">Java Persistence/Mapping</a></li><li><a href="https://en.wikibooks.org/wiki/Category:Java_Persistence/Runtime" title="Category:Java Persistence/Runtime">Java Persistence/Runtime</a></li></ul></div></div>				<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>

			<div id="mw-head">
									<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
						<h3 id="p-personal-label">Personal tools</h3>
						<ul>
							<li id="pt-createaccount"><a href="https://en.wikibooks.org/w/index.php?title=Special:UserLogin&returnto=Java+Persistence%2FPrint+version&type=signup" title="You are encouraged to create an account and log in; however, it is not mandatory">Create account</a></li><li id="pt-login"><a href="https://en.wikibooks.org/w/index.php?title=Special:UserLogin&returnto=Java+Persistence%2FPrint+version" title="You are encouraged to log in; however, it is not mandatory [alt-shift-o]" accesskey="o">Log in</a></li>						</ul>
					</div>
									<div id="left-navigation">
										<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
						<h3 id="p-namespaces-label">Namespaces</h3>
						<ul>
															<li id="ca-nstab-main" class="selected"><span><a href="./JPA_Wikibooks_files/JPA_Wikibooks.html" title="View the content page [alt-shift-c]" accesskey="c">Book</a></span></li>
															<li id="ca-talk" class="new"><span><a href="https://en.wikibooks.org/w/index.php?title=Talk:Java_Persistence/Print_version&action=edit&redlink=1" title="Discussion about the content page [alt-shift-t]" accesskey="t" rel="discussion">Discussion</a></span></li>
													</ul>
					</div>
										<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
												<h3 id="p-variants-label" tabindex="0">
							<span>Variants</span><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#" tabindex="-1"></a>
						</h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
									</div>
				<div id="right-navigation">
										<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
						<h3 id="p-views-label">Views</h3>
						<ul>
															<li id="ca-view" class="collapsible"><span><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&stable=1">Read</a></span></li>
															<li id="ca-current" class="collapsible collapsible selected"><span><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&stable=0&redirect=no" title="View this page with the pending changes [alt-shift-v]" accesskey="v">Latest draft</a></span></li>
															<li id="ca-edit"><span><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&action=edit" title="Edit this page [alt-shift-e]" accesskey="e">Edit</a></span></li>
															<li id="ca-history" class="collapsible"><span><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&action=history" title="Past revisions of this page [alt-shift-h]" accesskey="h">View history</a></span></li>
													</ul>
					</div>
										<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label">
						<h3 id="p-cactions-label" tabindex="0"><span>More</span><a href="https://en.wikibooks.org/wiki/Java_Persistence/Print_version#" tabindex="-1"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
										<div id="p-search" role="search">
						<h3>
							<label for="searchInput">Search</label>
						</h3>

						<form action="https://en.wikibooks.org/w/index.php" id="searchform">
							<div id="simpleSearch">
							<input type="search" name="search" placeholder="Search" title="Search Wikibooks [alt-shift-f]" accesskey="f" id="searchInput" tabindex="1" autocomplete="off"><input type="hidden" value="Special:Search" name="title"><input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchButton" class="searchButton">							</div>
						</form>
					</div>
									</div>
			</div>
			<div id="mw-panel">
				<div id="p-logo" role="banner"><a class="mw-wiki-logo" href="https://en.wikibooks.org/wiki/Main_Page" title="Visit the main page"></a></div>
						<div class="portal" role="navigation" id="p-Navigation" aria-labelledby="p-Navigation-label">
			<h3 id="p-Navigation-label">Navigation</h3>

			<div class="body">
									<ul>
						<li id="n-mainpage"><a href="https://en.wikibooks.org/wiki/Main_Page" title="Visit the main page [alt-shift-z]" accesskey="z">Main Page</a></li><li id="n-help"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Contents" title="Find help on how to use and edit Wikibooks">Help</a></li><li id="n-Browse"><a href="https://en.wikibooks.org/wiki/Wikibooks:Card_Catalog_Office" title="Check out what Wikibooks has to offer">Browse wiki</a></li><li id="n-Cookbook"><a href="https://en.wikibooks.org/wiki/Cookbook:Table_of_Contents" title="Learn recipes from around the world">Cookbook</a></li><li id="n-Wikijunior"><a href="https://en.wikibooks.org/wiki/Wikijunior" title="Books for children">Wikijunior</a></li><li id="n-Featured-books"><a href="https://en.wikibooks.org/wiki/Wikibooks:Featured_books" title="The best of Wikibooks">Featured books</a></li><li id="n-recentchanges"><a href="https://en.wikibooks.org/wiki/Special:RecentChanges" title="A list of recent changes in the wiki [alt-shift-r]" accesskey="r">Recent changes</a></li><li id="n-sitesupport"><a href="https://donate.wikimedia.org/wiki/Special:FundraiserRedirector?utm_source=donate&utm_medium=sidebar&utm_campaign=C13_en.wikibooks.org&uselang=en" title="Support Wikibooks">Donations</a></li><li id="n-randomrootpage"><a href="https://en.wikibooks.org/wiki/Special:RandomRootpage">Random book</a></li><li id="n-Using-Wikibooks"><a href="https://en.wikibooks.org/wiki/Using_Wikibooks">Using Wikibooks</a></li>					</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id="p-Community" aria-labelledby="p-Community-label">
			<h3 id="p-Community-label">Community</h3>

			<div class="body">
									<ul>
						<li id="n-Reading-room"><a href="https://en.wikibooks.org/wiki/Wikibooks:Reading_room" title="Discuss Wikibooks-related questions and concerns with others">Reading room</a></li><li id="n-portal"><a href="https://en.wikibooks.org/wiki/Wikibooks:Community_Portal" title="Find your way around the Wikibooks community">Community portal</a></li><li id="n-currentevents"><a href="https://en.wikibooks.org/wiki/Wikibooks:Reading_room/Bulletin_Board" title="Important community news">Bulletin Board</a></li><li id="n-maintenance"><a href="https://en.wikibooks.org/wiki/Wikibooks:Maintenance" title="Frequent tasks that you can help with">Help out!</a></li><li id="n-Policies-and-guidelines"><a href="https://en.wikibooks.org/wiki/Wikibooks:Policies_and_guidelines" title="Pages detailing important rules and procedures">Policies and guidelines</a></li><li id="n-contact"><a href="https://en.wikibooks.org/wiki/Wikibooks:Contact_us" title="Alternative methods of communication">Contact us</a></li>					</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id="p-tb" aria-labelledby="p-tb-label">
			<h3 id="p-tb-label">Tools</h3>

			<div class="body">
									<ul>
						<li id="t-whatlinkshere"><a href="https://en.wikibooks.org/wiki/Special:WhatLinksHere/Java_Persistence/Print_version" title="A list of all wiki pages that link here [alt-shift-j]" accesskey="j">What links here</a></li><li id="t-recentchangeslinked"><a href="https://en.wikibooks.org/wiki/Special:RecentChangesLinked/Java_Persistence/Print_version" title="Recent changes in pages linked from this page [alt-shift-k]" accesskey="k">Related changes</a></li><li id="t-upload"><a href="https://commons.wikimedia.org/wiki/Special:UploadWizard" title="Upload files [alt-shift-u]" accesskey="u">Upload file</a></li><li id="t-specialpages"><a href="https://en.wikibooks.org/wiki/Special:SpecialPages" title="A list of all special pages [alt-shift-q]" accesskey="q">Special pages</a></li><li id="t-permalink"><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&oldid=2503078" title="Permanent link to this revision of the page">Permanent link</a></li><li id="t-info"><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&action=info" title="More information about this page">Page information</a></li><li id="t-cite"><a href="https://en.wikibooks.org/w/index.php?title=Special:CiteThisPage&page=Java_Persistence%2FPrint_version&id=2503078" title="Information on how to cite this page">Cite this page</a></li>					</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id="p-lang" aria-labelledby="p-lang-label"><span class="uls-settings-trigger" tabindex="0" role="button" aria-haspopup="true" original-title="Language settings"></span>
			<h3 id="p-lang-label">In other languages</h3>

			<div class="body">
									<ul>
						<li class="interlanguage-link interwiki-kk"><a href="https://kk.wikibooks.org/wiki/Java_Persistence" title="Java Persistence – Kazakh" lang="kk" hreflang="kk">Қазақша</a></li>					</ul>
				<div class="after-portlet after-portlet-lang"><span class="wb-langlinks-add wb-langlinks-link"><a href="https://www.wikidata.org/wiki/Special:NewItem?site=enwikibooks&page=Java+Persistence%2FPrint+version" title="Add interlanguage links" class="wbc-editpage">Add links</a></span></div>			</div>
		</div>
			<div class="portal" role="navigation" id="p-Sister_projects" aria-labelledby="p-Sister_projects-label">
			<h3 id="p-Sister_projects-label">Sister projects</h3>

			<div class="body">
									<ul>
						<li id="n-Wikipedia"><a href="https://en.wikipedia.org/wiki/Main_Page">Wikipedia</a></li><li id="n-Wikiversity"><a href="https://en.wikiversity.org/wiki/Wikiversity:Main_Page">Wikiversity</a></li><li id="n-Wiktionary"><a href="https://en.wiktionary.org/wiki/Wiktionary:Main_Page">Wiktionary</a></li><li id="n-Wikiquote"><a href="https://en.wikiquote.org/wiki/Main_Page">Wikiquote</a></li><li id="n-Wikisource"><a href="https://en.wikisource.org/wiki/Main_Page">Wikisource</a></li><li id="n-Wikinews"><a href="https://en.wikinews.org/wiki/Main_Page">Wikinews</a></li><li id="n-Wikivoyage"><a href="https://en.wikivoyage.org/wiki/Main_Page">Wikivoyage</a></li><li id="n-Commons"><a href="https://commons.wikimedia.org/wiki/Main_Page">Commons</a></li><li id="n-Wikidata"><a href="https://www.wikidata.org/wiki/Wikidata:Main_Page">Wikidata</a></li>					</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id="p-coll-print_export" aria-labelledby="p-coll-print_export-label">
			<h3 id="p-coll-print_export-label">Print/export</h3>

			<div class="body">
									<ul>
						<li id="coll-create_a_book"><a href="https://en.wikibooks.org/w/index.php?title=Special:Book&bookcmd=book_creator&referer=Java+Persistence%2FPrint+version">Create a collection</a></li><li id="coll-download-as-rdf2latex"><a href="https://en.wikibooks.org/w/index.php?title=Special:Book&bookcmd=render_article&arttitle=Java+Persistence%2FPrint+version&oldid=2503078&writer=rdf2latex">Download as PDF</a></li><li id="t-print"><a href="https://en.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&printable=yes" title="Printable version of this page [alt-shift-p]" accesskey="p">Printable version</a></li>					</ul>
							</div>
		</div>
				</div>
		</div>
		<div id="footer" role="contentinfo">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 18 March 2013, at 13:20.</li>
											<li id="footer-info-copyright">Text is available under the <a href="https://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike License.</a>; additional terms may apply.  By using this site, you agree to the <a href="https://wikimediafoundation.org/wiki/Terms_of_Use">Terms of Use</a> and <a href="https://wikimediafoundation.org/wiki/Privacy_policy">Privacy Policy.</a></li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="https://wikimediafoundation.org/wiki/Privacy_policy" title="wikimedia:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="https://en.wikibooks.org/wiki/Wikibooks:Welcome" title="Wikibooks:Welcome">About Wikibooks</a></li>
											<li id="footer-places-disclaimer"><a href="https://en.wikibooks.org/wiki/Wikibooks:General_disclaimer" title="Wikibooks:General disclaimer">Disclaimers</a></li>
											<li id="footer-places-developers"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/How_to_contribute">Developers</a></li>
											<li id="footer-places-mobileview"><a href="https://en.m.wikibooks.org/w/index.php?title=Java_Persistence/Print_version&mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
											<li id="footer-copyrightico">
							<a href="https://wikimediafoundation.org/"><img src="./JPA_Wikibooks_files/wikimedia-button.png" srcset="/static/images/wikimedia-button-1.5x.png 1.5x, /static/images/wikimedia-button-2x.png 2x" width="88" height="31" alt="Wikimedia Foundation"></a>						</li>
											<li id="footer-poweredbyico">
							<a href="https://www.mediawiki.org/"><img src="./JPA_Wikibooks_files/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="//en.wikibooks.org/static/1.26wmf13/resources/assets/poweredby_mediawiki_132x47.png 1.5x, //en.wikibooks.org/static/1.26wmf13/resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31"></a>						</li>
									</ul>
						<div style="clear:both"></div>
		</div>
		<script>if(window.jQuery)jQuery.ready();</script><script>if(window.mw){
mw.loader.state({"ext.globalCssJs.site":"ready","ext.globalCssJs.user":"ready","site":"loading","user":"ready","user.groups":"ready"});
}</script>
<link rel="stylesheet" href="https://en.wikibooks.org/w/load.php?debug=false&lang=en&modules=ext.cite.styles%7Cext.gadget.extlinks%7Cext.wikimediaBadges&only=styles&skin=vector&*">
<script>if(window.mw){
mw.loader.load(["ext.cite.a11y","mediawiki.action.view.postEdit","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest","ext.cirrusSearch.loggingSchema","mmv.bootstrap.autostart","ext.imageMetrics.loader","ext.eventLogging.subscriber","ext.wikimediaEvents","ext.wikimediaEvents.statsd","ext.navigationTiming","ext.gadget.extlinks","ext.visualEditor.targetLoader","schema.UniversalLanguageSelector","ext.uls.eventlogger","ext.uls.interlanguage","ext.flaggedRevs.advanced"],null,true);
}</script>
<script src="./JPA_Wikibooks_files/index(14).php"></script>
<script src="./JPA_Wikibooks_files/index(15).php"></script>
<script>if(window.mw){
document.write("\u003Cscript src=\"//en.wikibooks.org/w/load.php?debug=false\u0026amp;lang=en\u0026amp;modules=site\u0026amp;only=scripts\u0026amp;skin=vector\u0026amp;*\"\u003E\u003C/script\u003E");
}</script><script src="./JPA_Wikibooks_files/load(2).php"></script><div class="suggestions" style="display: none; font-size: 13px;"><div class="suggestions-results"></div><div class="suggestions-special"></div></div>
<script>if(window.mw){
mw.config.set({"wgBackendResponseTime":191,"wgHostname":"mw1063"});
}</script>
	

</body></html>